import http from '@ohos.net.http';
import preferences from '@ohos.data.preferences';
import { formBindingData, formProvider } from '@kit.FormKit';
import { AppStorageV2 } from '@kit.ArkUI'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM } from '../common/ActiveFormatState'

import notificationManager from '@ohos.notificationManager'
import notification from '@ohos.notification'
import { RuleEngine, NotifyRuleLite } from '../service/RuleEngine'
import wantAgent from '@ohos.wantAgent'

const DOMAIN = 0x0000
const TAG: string = 'HarmonyStock'


// å‰ç«¯ç»Ÿä¸€çš„è¡Œæƒ…å¯¹è±¡ï¼ˆæŒ‡æ•°/è‚¡ç¥¨å…±ç”¨ï¼ŒUI/ç¼“å­˜/Kçº¿éƒ½ç”¨å®ƒï¼‰
interface Quote {
  code: string
  name: string
  price: number
  change: number
  changePercent: number
  type: 'index' | 'stock' // ç”¨æ¥åŒºåˆ†æŒ‡æ•°/è‚¡ç¥¨
}

// åç«¯åŸå§‹è¿”å›ç»“æ„ï¼ˆå­—æ®µåæŒ‰åç«¯æ¥ï¼Œç”¨ mapBackendQuote è½¬æˆ Quoteï¼‰
interface BackendQuote {
  code: string
  name: string
  price: number
  change: number
  change_percent: number // åç«¯ç”¨ä¸‹åˆ’çº¿å‘½åï¼›å‰ç«¯æ˜ å°„åˆ° changePercent
}

// è‡ªé€‰é¡µå±•ç¤ºç”¨çš„ç®€åŒ–è¡Œæƒ…ç»“æ„ï¼ˆä¸ä¸€å®šæ¯å¤„éƒ½è¦ç”¨ï¼Œä½†ä¿ç•™æ–¹ä¾¿ï¼‰
interface StockQuote {
  name: string
  code: string
  price: number
  change: number
  changePercent: number
}

// é€šçŸ¥è§„åˆ™é‡Œç”¨åˆ°çš„æ ‡çš„ç±»å‹ï¼ˆå†³å®š RuleEngine è¯·æ±‚å“ªä¸ª typeï¼‰
type QuoteType = 'index' | 'stock'

// é€šçŸ¥è§„åˆ™ï¼ˆå­˜æœ¬åœ° + RuleEngine è½®è¯¢åˆ¤æ–­å‘½ä¸­ï¼‰
interface NotifyRule {
  id: number
  quoteType: QuoteType      // è§„åˆ™é’ˆå¯¹æŒ‡æ•°è¿˜æ˜¯è‚¡ç¥¨ï¼ˆä¸åŠ è¿™ä¸ªä¼šæœ‰åŒç å†²çªé—®é¢˜ï¼‰
  stockCode: string         // 6ä½ä»£ç ï¼ˆ
  stockName: string
  conditionText: string     // ä¾‹å¦‚ "ä»·æ ¼ â‰¥ 25.00"ï¼ˆRuleEngine ä¼šè§£æè¿™ä¸ªå­—ç¬¦ä¸²ï¼‰
  enabled: boolean
}

// Kçº¿ç‚¹ï¼ˆåç«¯è¿”å›çš„OHLCVï¼‰
interface KLinePoint {
  date: string
  open: number
  high: number
  low: number
  close: number
  volume: number
}

// Kçº¿æ¸²æŸ“ç”¨çš„å‡ ä½•ä¿¡æ¯ï¼ˆæŠŠâ€œä»·æ ¼â€é¢„å¤„ç†æˆâ€œé«˜åº¦/åç§»â€ï¼ŒUIç›´æ¥ç”»Rectï¼‰
interface KlineGeom {
  upperWick: number
  bodyHeight: number
  lowerWick: number
  topGap: number
  isUp: boolean // close >= open
}

// è‡ªé€‰é‡Œå­˜çš„â€œè‚¡ç¥¨å¼•ç”¨â€ï¼ˆåªå­˜codeï¼Œnameå¯é€‰ï¼‰
interface StockRef {
  code: string
  name?: string
}

// ä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼ˆstockså˜åŒ–æ—¶ version +1ï¼Œç”¨æ¥å¼ºåˆ¶Liståˆ·æ–°ï¼‰
interface StockGroup {
  id: number
  name: string
  stocks: StockRef[]
  createdAt: number
  version: number // ç”¨äºè§¦å‘ UI è¯†åˆ«ç»“æ„å˜åŒ–ï¼ˆå°¤å…¶æ˜¯ List/ForEach åœºæ™¯ï¼‰
}

// åˆ†ç»„ç»Ÿè®¡ï¼ˆæ•°å€¼ç‰ˆï¼Œé€‚åˆè®¡ç®—ï¼‰
interface GroupStats {
  groupId: number
  stockCount: number
  upCount: number
  downCount: number
  avgChangePercent: number
}

// åˆ†ç»„ç»Ÿè®¡ï¼ˆå±•ç¤ºç‰ˆï¼Œç›´æ¥ç»™Textç”¨ï¼›ç¼ºæ•°æ®æ—¶ç”¨ '--'ï¼‰
interface ActiveGroupStats {
  stockCount: string
  up: string
  down: string
  avgPct: string // ä¾‹å¦‚ "0.52%" æˆ– "--"
}

// æ¡Œé¢å¡ç‰‡ç»‘å®šæ•°æ®ï¼ˆupdateFormç”¨ï¼›å¤šæ•°æ˜¯å·²ç»æ ¼å¼åŒ–å¥½çš„å­—ç¬¦ä¸²ï¼‰
interface WidgetBindData {
  formId: string
  title: string
  code: string
  name: string
  priceText: string
  changeText: string
  pctText: string
  tsText: string
  hasPrev: boolean
  hasNext: boolean
}


// é¡µé¢ç»„ä»¶
@Entry
@Component
struct HarmonyStockPage {
  // é¡¶éƒ¨ Tabï¼š0 å¸‚åœº / 1 è‡ªé€‰ / 2 é€šçŸ¥ï¼ˆTabs.onChange ä¼šæ”¹å®ƒï¼‰
  @State currentTabIndex: number = 0

  // å½“å‰è¡Œæƒ…æ¨¡å¼ï¼šæŒ‡æ•° or è‚¡ç¥¨ï¼ˆå½±å“è¡Œæƒ…åˆ—è¡¨ã€æœç´¢ã€Kçº¿è¯·æ±‚ typeï¼‰
  @State currentMode: 'index' | 'stock' = 'index'

  // è¡Œæƒ…æ¨ªå‘ strip çš„åŠ è½½/æŠ¥é”™çŠ¶æ€ï¼ˆåªç®¡â€œå¸‚åœºé¡µâ€çš„é‚£ä¸€æ¡ï¼‰
  @State listLoading: boolean = false
  @State listError: string = ''

  // æœç´¢è¾“å…¥ä¸çŠ¶æ€ï¼ˆè¾“å…¥æ¡† + æŸ¥è¯¢æŒ‰é’®é‚£å—ï¼‰
  @State searchCode: string = ''          // è¾“å…¥çš„ 6 ä½ä»£ç 
  @State searchLoading: boolean = false
  @State searchError: string = ''

  // è¡Œæƒ…å¡ç‰‡æ•°æ®ï¼šå®æ—¶åˆ—è¡¨ + æœç´¢ç»“æœï¼ˆéƒ½æ˜¾ç¤ºåœ¨åŒä¸€ä¸ªæ¨ªå‘ strip é‡Œï¼‰
  @State marketQuotes: Quote[] = []       // åç«¯æ‰¹é‡è¿”å›çš„å®æ—¶å¡ç‰‡
  @State searchedQuotes: Quote[] = []     // æŸ¥è¯¢å‡ºæ¥çš„å¡ç‰‡ï¼ˆç½®é¡¶ã€å»é‡ï¼‰

  // å½“å‰é€‰ä¸­çš„æ ‡çš„ï¼ˆå†³å®š K çº¿å±•ç¤ºçš„æ˜¯è°ï¼Œä¹Ÿç”¨äºæ¡Œé¢å¡ç‰‡å›å†™ï¼‰
  @State selectedQuoteCode: string = ''   // 6 ä½ä»£ç 
  @State selectedQuoteName: string = ''   // UI æ ‡é¢˜ç”¨
  @State selectedQuoteType: 'index' | 'stock' = 'index' // Kçº¿è¯·æ±‚ type / ç¼“å­˜keyç”¨

  // å½“å‰ K çº¿å‘¨æœŸï¼š0 æ—¥K / 1 å‘¨K / 2 æœˆKï¼ˆåˆ‡æ¢æŒ‰é’®ç”¨ï¼‰
  @State klinePeriodIndex: number = 0

  // K çº¿è¯·æ±‚çŠ¶æ€ï¼ˆåŠ è½½/é”™è¯¯/æ•°æ®ï¼‰
  @State klineLoading: boolean = false
  @State klineError: string = ''
  @State klinePoints: KLinePoint[] = []  // åç«¯è¿”å›çš„ OHLCV ç‚¹

  // K çº¿æ¸²æŸ“ç”¨çš„â€œé¢„è®¡ç®—â€ç»“æœï¼ˆæŠŠç‚¹ç®—æˆé«˜åº¦/åç§»ï¼ŒUIç›´æ¥ç”»ï¼‰
  @State klineGeoms: KlineGeom[] = []
  @State klineMinPrice: number = 0       // yè½´ä¸‹è¾¹ç•Œï¼ˆæ˜¾ç¤ºåˆ»åº¦ç”¨ï¼‰
  @State klineMaxPrice: number = 0       // yè½´ä¸Šè¾¹ç•Œï¼ˆæ˜¾ç¤ºåˆ»åº¦ç”¨ï¼‰
  @State klineXLabels: string[] = []     // xè½´æ ‡ç­¾ï¼ˆæœ€å¤šå–å‡ æ®µï¼‰

  // K çº¿å¸ƒå±€å¸¸é‡ï¼ˆè®¡ç®—å’Œ UI é«˜åº¦å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™ä¼šæº¢å‡º/å‹ç¼©ï¼‰
  private readonly KLINE_PLOT_H: number = 180     // èœ¡çƒ›ç»˜å›¾åŒºé«˜åº¦
  private readonly KLINE_LABEL_H: number = 24     // x è½´æ ‡ç­¾åŒºåŸŸé«˜åº¦
  // private readonly KLINE_CARD_INNER_PAD: number = 16 // Kçº¿å¡ç‰‡å†…éƒ¨ paddingï¼ˆç•™ç€ç»Ÿä¸€æ”¹ï¼‰

  // å½“å‰é€‰ä¸­çš„é‚£æ ¹ K çº¿ï¼ˆç‚¹æŸæ ¹èœ¡çƒ›åï¼Œè¯¦æƒ…æ¡æ˜¾ç¤ºè¿™äº›å€¼ï¼‰
  @State selectedKlineIndex: number = -1
  @State selectedKlineDate: string = ''
  @State selectedKlineOpen: number = 0
  @State selectedKlineHigh: number = 0
  @State selectedKlineLow: number = 0
  @State selectedKlineClose: number = 0

  // èœ¡çƒ›å®½åº¦ä¸é—´è·ï¼ˆå½±å“æ€»å®½åº¦ä¸æ»šåŠ¨æ‰‹æ„Ÿï¼‰
  private candleBodyWidth: number = 8
  private candleGap: number = 4

  // expandedKeys ç»Ÿä¸€æ§åˆ¶å±•å¼€é¡¹ï¼ˆç°åœ¨å¯ä¸ç”¨ï¼‰
  @State expandedKeys: string[] = []

  // è®°å½•æ¯å¼ è¡Œæƒ…å¡ç‰‡æ˜¯å¦å±•å¼€ï¼škey = `${type}-${code}`ï¼ˆè§£å†³åŒç /ä¸åŒç±»å‹çš„å†²çªï¼‰
  @State cardExpandedMap: Map<string, boolean> = new Map<string, boolean>()

  // ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼ˆè¡Œæƒ…/Kçº¿/å•åªæŸ¥è¯¢éƒ½ç”¨è¿™å¥—ï¼‰
  private readonly HTTP_CONNECT_TIMEOUT: number = 55000
  private readonly HTTP_READ_TIMEOUT: number = 55000

  // è‡ªé€‰åˆ†ç»„æœ¬åœ°å­˜å‚¨ï¼ˆpreferences æ–‡ä»¶å + keyï¼‰
  private readonly PREF_FILE: string = 'harmonystock_watchlist'
  private readonly PREF_KEY_GROUPS: string = 'groups_json'
  private nextGroupId: number = 1         // æ–°å»ºåˆ†ç»„ç”¨çš„è‡ªå¢ id

  // è‡ªé€‰é¡µå½“å‰åˆ†ç»„ä¸è¾“å…¥çŠ¶æ€
  @State activeGroupId: number = -1       // å½“å‰é€‰ä¸­çš„åˆ†ç»„ id
  @State watchlistMsg: string = ''        // è‡ªé€‰é¡µ/æ“ä½œåé¦ˆçš„æç¤ºæ–‡æ¡ˆ
  @State newGroupName: string = ''        // æ–°å»ºåˆ†ç»„è¾“å…¥æ¡†
  @State addStockCodeInput: string = ''   // æ·»åŠ è‚¡ç¥¨è¾“å…¥æ¡†

  // è¡Œæƒ…ç¼“å­˜ï¼škey = `${type}-${code}`ï¼ˆè‡ªé€‰ç»Ÿè®¡/åç§°/æ¶¨è·Œä¾èµ–å®ƒï¼‰
  @State quoteCache: Map<string, Quote> = new Map<string, Quote>()
  @State quoteCacheVer: number = 0        // å¼ºåˆ¶è§¦å‘ä¾èµ–ç¼“å­˜çš„ UI é‡æ–°è®¡ç®—

  // å½“å‰ active åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆä» groups æ´¾ç”Ÿå‡ºæ¥ï¼Œå•ç‹¬å­˜ä¸€ä»½æ–¹ä¾¿ List æ¸²æŸ“ï¼‰
  @State activeStocks: StockRef[] = []
  @State activeStocksVer: number = 0      // å¼ºåˆ¶ List é‡æ–°åˆ›å»º/åˆ·æ–°ç”¨

  // è‡ªé€‰ç»Ÿè®¡å¡ä¸Šçš„å±•ç¤ºå€¼ï¼ˆè¿™é‡Œç›´æ¥å­˜ stringï¼Œé¿å… UI é‡Œåˆ°å¤„ toFixed/æ‹¼%ï¼‰
  @State activeStatStockCount: string = '0'
  @State activeStatUp: string = '0'
  @State activeStatDown: string = '0'
  @State activeStatAvgPct: string = '--'
  @State activeStatsVer: number = 0       // é…åˆ keyï¼Œç”¨æ¥è®©ç»Ÿè®¡å¡ç¨³å®šåˆ·æ–°

  // ä»æ¡Œé¢å¡ç‰‡æ‹‰èµ· App æ—¶çš„ formIdï¼ˆç”¨äºæŠŠâ€œå½“å‰é€‰æ‹©â€å›å†™åˆ°æ¡Œé¢å¡ç‰‡ï¼‰
  @State activeFormId: string = ''

  // é€šçŸ¥é¡µï¼šæ–°å¢è§„åˆ™è¾“å…¥åŒºï¼ˆè‚¡ç¥¨ä»£ç /æ“ä½œç¬¦/é˜ˆå€¼/æç¤ºï¼‰
  @State ruleStockCodeInput: string = ''  // è§„åˆ™ä»£ç è¾“å…¥
  @State ruleOpIndex: number = 0          // 0: â‰¥  1: â‰¤ï¼ˆä½ ç°åœ¨åªåšè¿™ä¿©å°±å¤Ÿç¨³ï¼‰
  @State rulePriceInput: string = ''      // ä»·æ ¼é˜ˆå€¼è¾“å…¥
  @State ruleMsg: string = ''             // æ–°å¢è§„åˆ™æ—¶çš„æç¤º/æ ¡éªŒä¿¡æ¯
  @State ruleQuoteType: QuoteType = 'stock' // è§„åˆ™é’ˆå¯¹æŒ‡æ•°è¿˜æ˜¯è‚¡ç¥¨ï¼ˆé»˜è®¤è‚¡ç¥¨æ›´ç¬¦åˆä¹ æƒ¯ï¼‰

  // é€šçŸ¥è§„åˆ™åˆ—è¡¨ç‰ˆæœ¬å·ï¼ˆæ¯æ¬¡å¢åˆ /åˆ‡æ¢ enabled éƒ½ ++ï¼Œç”¨æ¥åˆ·æ–° Listï¼‰
  @State notifyRulesVer: number = 0

  onPageShow() {
    // é¡µé¢å›åˆ°å‰å°æ—¶è§¦å‘ï¼šå…ˆæ‹¿åˆ°æ¡Œé¢å¡ç‰‡ä¼ æ¥çš„ formIdï¼Œå†ï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ ‡çš„ï¼‰é¡ºæ‰‹æŠŠå½“å‰è¡Œæƒ…å›å†™åˆ°å¡ç‰‡
    hilog.error(0x0000, 'INDEX_DEBUG', 'ğŸ”¥ Index onPageShow CALLED')

    // ä» AppStorageV2 æ¶ˆè´¹ formIdï¼ˆç”¨äºåç»­æ›´æ–°æ¡Œé¢å¡ç‰‡ï¼‰
    this.consumeFormIdFromAppStorageV2('onPageShow')

    // å¦‚æœæ˜¯ä»å¡ç‰‡æ‰“å¼€çš„ï¼Œå¹¶ä¸”å½“å‰å·²ç»é€‰ä¸­äº†ä¸€åªæ ‡çš„ï¼šåŒæ­¥æ›´æ–°å¡ç‰‡å±•ç¤º
    if (this.activeFormId.length > 0 && this.selectedQuoteCode.length > 0) {
      const q: Quote | null = this.findQuoteInCaches(this.selectedQuoteCode)
      if (q !== null) {
        this.updateWidgetIfLaunchedFromForm(q)
      }
    }
  }

  // ===== è‡ªé€‰ / é€šçŸ¥å‡æ•°æ®ï¼ˆä¿æŒåŸæ ·ï¼‰ =====
  @State groups: StockGroup[] = [
    {
      id: 1,
      name: 'ç§‘æŠ€è‚¡',
      stocks: [
        { name: 'å®å¾·æ—¶ä»£', code: '300750' },
        { name: 'ä¸­èŠ¯å›½é™…', code: '688981' }
      ],
      createdAt: Date.now(),
      version: 0
    },
    {
      id: 2,
      name: 'æ–°èƒ½æº',
      stocks: [
        { name: 'éš†åŸºç»¿èƒ½', code: '601012' }
      ],
      createdAt: Date.now(),
      version: 0
    }
  ];

  // é€šçŸ¥è§„åˆ™åˆ—è¡¨ï¼šUI é‡Œå±•ç¤ºã€RuleEngine è½®è¯¢æ—¶ä¹Ÿä»è¿™é‡Œå–ï¼ˆä¼šæŒä¹…åŒ–åˆ° prefsï¼‰
  @State notifyRules: NotifyRule[] = [
    // ç¤ºä¾‹è§„åˆ™ï¼šå®å¾·æ—¶ä»£ï¼Œè‚¡ç¥¨ç±»å‹ï¼›å½“ä»·æ ¼è¾¾åˆ°/è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘é€šçŸ¥
    { id: 999, quoteType: 'stock', stockCode: '300750', stockName: 'å®å¾·æ—¶ä»£', conditionText: 'ä»·æ ¼ â‰¥ 1.00', enabled: true },

    // ç¤ºä¾‹è§„åˆ™ï¼šéš†åŸºç»¿èƒ½ï¼Œè‚¡ç¥¨ç±»å‹ï¼›å½“ä»·æ ¼ä½äº/ç­‰äºé˜ˆå€¼æ—¶è§¦å‘é€šçŸ¥ï¼ˆè¿™é‡Œå…ˆå…³æ‰ï¼‰
    { id: 2, quoteType: 'stock', stockCode: '601012', stockName: 'éš†åŸºç»¿èƒ½', conditionText: 'ä»·æ ¼ â‰¤ 28.00', enabled: true }
  ]

  // ä¸‹ä¸€æ¡è§„åˆ™çš„è‡ªå¢ id èµ·ç‚¹ï¼šä» prefs è¯»å®Œè§„åˆ™åä¼šç”¨ recomputeNextRuleId() é‡æ–°æ ¡å‡†ï¼Œé¿å…é‡å¤
  private nextRuleId: number = 1000

  // é€šçŸ¥è§„åˆ™åœ¨ preferences é‡Œä¿å­˜ç”¨çš„ keyï¼ˆå¯¹åº” PREF_FILE é‡Œçš„ä¸€ä¸ªå­—æ®µåï¼‰
  private readonly PREF_KEY_RULES: string = 'notify_rules_json'

  private refreshActiveGroupStats(): void {
    // é‡æ–°æ ¹æ®å½“å‰åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆactiveStocksï¼‰è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼šæ•°é‡/æ¶¨è·Œ/å‡æ¶¨è·Œ
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)

    // å†™å›åˆ°å‡ ä¸ª @State å­—æ®µï¼ŒUI é‡Œç»Ÿè®¡å¡ç‰‡ä¼šç›´æ¥ç»‘å®šè¿™äº›å€¼
    this.activeStatStockCount = st.stockCount
    this.activeStatUp = st.up
    this.activeStatDown = st.down
    this.activeStatAvgPct = st.avgPct

    // ç‰ˆæœ¬å·æ‰‹åŠ¨ +1ï¼šæœ‰äº›åœ°æ–¹ç”¨ key ä¾èµ–å®ƒï¼Œç¡®ä¿ç»Ÿè®¡åŒºåŸŸèƒ½ç¨³å®šåˆ·æ–°
    this.activeStatsVer += 1

    // è°ƒè¯•ç”¨ï¼šçœ‹ä¸€ä¸‹æ¯æ¬¡åˆ·æ–°åçš„ç»Ÿè®¡ç»“æœ
    console.info(
      `[DBG] stats=${this.activeStatStockCount}, up=${this.activeStatUp}, down=${this.activeStatDown}, avg=${this.activeStatAvgPct}, ver=${this.activeStatsVer}`
    )
  }


  // åç«¯è¡Œæƒ… -> å‰ç«¯ Quote
  private mapBackendQuote(raw: BackendQuote, type: 'index' | 'stock'): Quote {
    return {
      code: raw.code,
      name: raw.name,
      price: raw.price,
      change: raw.change,
      changePercent: raw.change_percent,
      type: type
    };
  }

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    // é¡µé¢å³å°†æ˜¾ç¤ºï¼šæ‰“ä¸ªè°ƒè¯•ç‚¹ï¼Œæ–¹ä¾¿çœ‹ç”Ÿå‘½å‘¨æœŸæ˜¯å¦æ­£å¸¸èµ°åˆ°è¿™
    this.dbg('aboutToAppear:enter')

    // å…ˆæŠŠæœ¬åœ°æŒä¹…åŒ–çš„æ•°æ®æ¢å¤å‡ºæ¥ï¼ˆåˆ†ç»„/è§„åˆ™/è‡ªé€‰é¢„çƒ­/æ‹‰è¡Œæƒ…ï¼‰
    // è¿™é‡Œç”¨ then æ˜¯ä¸ºäº†ç¡®ä¿é¡ºåºï¼šåˆ†ç»„ -> è§„åˆ™ -> é¢„çƒ­ -> æ‹‰åˆ—è¡¨
    this.loadGroupsFromPrefs().then(async () => {
      await this.loadNotifyRulesFromPrefs()   // è¯»å–æœ¬åœ°ä¿å­˜çš„é€šçŸ¥è§„åˆ™ï¼ˆnotify_rules_jsonï¼‰
      await this.preloadActiveGroupQuotes()   // é¢„çƒ­å½“å‰åˆ†ç»„çš„è‚¡ç¥¨è¡Œæƒ…åˆ°ç¼“å­˜ï¼Œåé¢ç»Ÿè®¡/åˆ—è¡¨èƒ½ç«‹åˆ»æ˜¾ç¤º
      this.fetchQuotes(this.currentMode)      // æ‹‰å–å½“å‰æ¨¡å¼ï¼ˆæŒ‡æ•°/è‚¡ç¥¨ï¼‰çš„å¸‚åœºåˆ—è¡¨
    })

    // å¯åŠ¨è§„åˆ™å¼•æ“ï¼šå†…éƒ¨ä¼šå®šæ—¶è½®è¯¢è¡Œæƒ…å¹¶åˆ¤æ–­è§„åˆ™æ˜¯å¦å‘½ä¸­
    // è¿™é‡Œä¼ çš„æ˜¯ä¸€ä¸ª providerï¼šæ¯æ¬¡ tick éƒ½ä»é¡µé¢æœ€æ–°çš„ notifyRules é‡Œå–ä¸€ä»½è½»é‡è§„åˆ™
    RuleEngine.start((): NotifyRuleLite[] => {
      const out: NotifyRuleLite[] = []

      for (let i: number = 0; i < this.notifyRules.length; i++) {
        const r: NotifyRule = this.notifyRules[i]

        // æ³¨æ„ï¼šRuleEngine åªè®¤è¯† NotifyRuleLiteï¼Œæ‰€ä»¥è¦æŠŠé¡µé¢è§„åˆ™â€œæ˜ å°„â€è¿‡å»
        // quoteType å¿…é¡»å¸¦ä¸Šï¼ˆè‚¡ç¥¨/æŒ‡æ•°ï¼‰ï¼Œä¸ç„¶ä¼šå‡ºç°ä½ ä¹‹å‰çš„ç¼ºå­—æ®µæŠ¥é”™
        out.push({
          id: r.id,
          quoteType: r.quoteType,      // stock / indexï¼ˆå†³å®šåç«¯æ‹‰ä»·æ—¶ type=stock è¿˜æ˜¯ type=indexï¼‰
          stockCode: r.stockCode,
          stockName: r.stockName,
          conditionText: r.conditionText,
          enabled: r.enabled
        })
      }
      return out
    }, 5000, 10000) // intervalMs=5000ï¼šæ¯ 5s æ£€æŸ¥ä¸€æ¬¡ï¼›cooldownMs=10000ï¼šå‘½ä¸­å 10s å†…ä¸é‡å¤é€šçŸ¥
  }

  aboutToDisappear(): void {
    // é¡µé¢ç¦»å¼€æ—¶åœæ­¢è½®è¯¢ï¼Œé¿å…åå°ä¸€ç›´è·‘ï¼ˆçœç”µ/çœæµé‡ï¼Œä¹Ÿé¿å…é‡å¤é€šçŸ¥ï¼‰
    RuleEngine.stop()
  }


  // æ‹‰å–è¡Œæƒ…åˆ—è¡¨ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰
  // type ä¼  'index' æˆ– 'stock'ï¼ŒåŒä¸€å¥—æ¥å£èµ°ä¸¤ç§æ•°æ®
  private async fetchQuotes(type: 'index' | 'stock'): Promise<void> {
    // åªæœ‰â€œè¯·æ±‚çš„ç±»å‹â€åˆšå¥½æ˜¯å½“å‰é¡µé¢æ¨¡å¼æ—¶ï¼Œæ‰æ›´æ–° loading / error / åˆ—è¡¨ UI
    // è¿™æ ·ä½ ä»¥åå¦‚æœåå°å·å·æ‹‰å¦ä¸€ç§ç±»å‹çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šæŠŠç”¨æˆ·æ­£åœ¨çœ‹çš„ç•Œé¢åˆ·ä¹±
    const affectUI: boolean = (type === this.currentMode)

    if (affectUI) {
      this.listLoading = true     // é¡µé¢ä¸Šçš„â€œè¡Œæƒ…åŠ è½½ä¸­â€¦â€çŠ¶æ€
      this.listError = ''         // æ¸…ç©ºä¸Šä¸€æ¬¡é”™è¯¯
    }

    const httpRequest = http.createHttp()
    try {
      // åç«¯æ ¹æ® type è¿”å›æŒ‡æ•°åˆ—è¡¨æˆ–è‚¡ç¥¨åˆ—è¡¨
      const url: string = `http://101.43.185.73:8000/api/quote?type=${type}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        // åç«¯å­—æ®µæ˜¯ change_percentï¼Œè¿™é‡Œç»Ÿä¸€æ˜ å°„æˆå‰ç«¯ Quote ç»“æ„
        const raw: BackendQuote[] = JSON.parse(res.result as string) as BackendQuote[]
        const mapped: Quote[] = raw.map((it: BackendQuote): Quote => this.mapBackendQuote(it, type))

        // åªåœ¨â€œå½“å‰æ¨¡å¼â€ä¸‹æ‰æ›´æ–°å¸‚åœºå¡ç‰‡åˆ—è¡¨
        if (affectUI) {
          this.marketQuotes = mapped
        }

        // ä¸ç®¡å½“å‰ UI åœ¨çœ‹å“ªç§æ¨¡å¼ï¼Œéƒ½æŠŠæ•°æ®å†™è¿›ç¼“å­˜ï¼š
        // è‡ªé€‰åˆ†ç»„ç»Ÿè®¡ / è‡ªé€‰åˆ—è¡¨è¡Œæ˜¾ç¤º éƒ½ä¾èµ– quoteCache
        this.mergeQuotesToCache(mapped)

        // ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢ï¼šé»˜è®¤é€‰ä¸­ç¬¬ä¸€æ¡ï¼Œå¹¶æ‹‰ä¸€ä»½ K çº¿
        // åªå¯¹å½“å‰æ¨¡å¼ç”Ÿæ•ˆï¼Œé¿å…åˆ‡åˆ°å¦ä¸€æ¨¡å¼æ—¶è¯¯è§¦å‘
        if (affectUI && this.selectedQuoteCode === '' && mapped.length > 0) {
          const first: Quote = mapped[0]
          this.selectedQuoteCode = first.code
          this.selectedQuoteName = first.name
          this.selectedQuoteType = first.type

          const period: string = this.getKlinePeriodParam()
          this.fetchKline(first.type, first.code, period) // è¿™é‡Œä¸ awaitï¼ŒK çº¿è‡ªå·±èµ° loading
        }
      } else {
        // HTTP é 200ï¼šåªåœ¨å½“å‰æ¨¡å¼ä¸‹æç¤ºé”™è¯¯ï¼Œé¿å…â€œåå°è¯·æ±‚å¤±è´¥â€å½±å“ç”¨æˆ·æ­£åœ¨çœ‹çš„ç•Œé¢
        if (affectUI) {
          this.listError = `HTTP ${res.responseCode}`
          this.marketQuotes = []
        }
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸/è§£æå¼‚å¸¸ï¼šåŒæ ·åªå½±å“å½“å‰æ¨¡å¼ UI
      if (affectUI) {
        this.listError = `${e}`
        this.marketQuotes = []
      }
    } finally {
      // é‡Šæ”¾ request å¯¹è±¡ï¼Œé¿å…èµ„æºæ³„æ¼
      httpRequest.destroy()

      // åªåœ¨å½“å‰æ¨¡å¼ä¸‹å…³é—­ loading
      if (affectUI) {
        this.listLoading = false
      }
    }
  }

  // æ‹‰å– K çº¿æ•°æ®ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰
  // type: 'index' / 'stock'ï¼Œcode: 6ä½ä»£ç ï¼Œperiod: day/week/month
  private async fetchKline(
    type: 'index' | 'stock',
    code: string,
    period: string
  ): Promise<void> {
    // è¿›å…¥åŠ è½½æ€ï¼šK çº¿å¡ç‰‡åŒºåŸŸä¼šæ˜¾ç¤ºâ€œåŠ è½½ä¸­â€¦â€
    this.klineLoading = true
    this.klineError = '' // æ¸…ç©ºä¸Šä¸€æ¬¡é”™è¯¯

    const httpRequest = http.createHttp()
    try {
      // limit=60ï¼šæœ€å¤šå–æœ€è¿‘ 60 æ ¹Kçº¿ï¼Œå‰ç«¯èœ¡çƒ›å›¾å®½åº¦ä¹ŸæŒ‰è¿™ä¸ªé‡æ¥ç®—
      const url: string =
        `http://101.43.185.73:8000/api/kline` +
          `?type=${type}&code=${code}&period=${period}&limit=60`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        // åç«¯è¿”å›çš„å°±æ˜¯ KLinePoint æ•°ç»„ï¼ˆdate/open/high/low/close/volumeï¼‰
        const raw: KLinePoint[] = JSON.parse(res.result as string) as KLinePoint[]
        this.klinePoints = raw

        // ä½“éªŒä¸Šä¸€èˆ¬é»˜è®¤çœ‹â€œæœ€æ–°ä¸€æ ¹â€ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æœ€åä¸€ä¸ªç‚¹
        // åŒæ—¶ä¼šæŠŠè¯¦ç»†ä¿¡æ¯æ¡ï¼ˆå¼€é«˜ä½æ”¶ï¼‰æ›´æ–°åˆ°å¯¹åº”çš„ @State å­—æ®µé‡Œ
        if (this.klinePoints.length > 0) {
          const lastIndex: number = this.klinePoints.length - 1
          this.onKlineSelected(lastIndex)
        } else {
          // æ²¡æ•°æ®å°±æ¸…æ‰é€‰ä¸­æ€ï¼Œé¿å…è¿˜æ˜¾ç¤ºæ—§çš„é«˜äº®/è¯¦æƒ…
          this.selectedKlineIndex = -1
        }

        // points æ›´æ–°åï¼Œé‡æ–°è®¡ç®—æ¯æ ¹èœ¡çƒ›çš„å‡ ä½•ä¿¡æ¯ï¼ˆä¸Šä¸‹å½±çº¿/å®ä½“é«˜åº¦/é¡¶éƒ¨ç©ºç™½ï¼‰
        // è¿™ä¸€æ­¥ä¼šåŒæ­¥æ›´æ–°ï¼šklineGeoms / klineMinPrice / klineMaxPrice / klineXLabels
        this.recomputeKlineGeom()
      } else {
        // HTTP é 200ï¼šè®°å½•é”™è¯¯ï¼Œå¹¶æŠŠå›¾è¡¨ç›¸å…³æ•°æ®æ¸…ç©ºï¼ˆé¿å…æ®‹ç•™æ—§å›¾ï¼‰
        this.klineError = `HTTP ${res.responseCode}`
        this.klinePoints = []
        this.klineGeoms = []
        this.klineXLabels = []
        this.selectedKlineIndex = -1
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸ / JSON è§£æå¼‚å¸¸ï¼šåŒæ ·æ¸…ç©ºå›¾è¡¨æ•°æ®ï¼Œç»™ UI ä¸€ä¸ªå¯é¢„æœŸçš„çŠ¶æ€
      this.klineError = `${e}`
      this.klinePoints = []
      this.klineGeoms = []
      this.klineXLabels = []
      this.selectedKlineIndex = -1
    } finally {
      // é‡Šæ”¾ request å¯¹è±¡
      httpRequest.destroy()

      // é€€å‡ºåŠ è½½æ€
      this.klineLoading = false
    }
  }


  // æ ¹æ®å½“å‰çš„å‘¨æœŸé€‰æ‹©ï¼ˆklinePeriodIndexï¼‰æ‹¼å‡ºåç«¯éœ€è¦çš„ period å‚æ•°
  // çº¦å®šï¼š0=æ—¥Kï¼Œ1=å‘¨Kï¼Œ2=æœˆKï¼ˆå’Œ UI ä¸Šçš„â€œæ—¥K/å‘¨K/æœˆKâ€æŒ‰é’®å¯¹åº”ï¼‰
  private getKlinePeriodParam(): string {
    if (this.klinePeriodIndex === 1) {
      return 'week'   // å‘¨Kï¼šç”¨äºè¯·æ±‚ ?period=week
    }
    if (this.klinePeriodIndex === 2) {
      return 'month'  // æœˆKï¼šç”¨äºè¯·æ±‚ ?period=month
    }
    return 'day'      // é»˜è®¤æ—¥Kï¼šç”¨äºè¯·æ±‚ ?period=day
  }

  // ===== è®¡ç®— K çº¿å‡ ä½•ä¿¡æ¯ & åæ ‡è½´ =====
  private recomputeKlineGeom(): void {
    // pointsï¼šåç«¯è¿”å›çš„åŸå§‹ K çº¿æ•°æ®ï¼ˆå¼€é«˜ä½æ”¶ + æ—¥æœŸï¼‰
    const points: KLinePoint[] = this.klinePoints;
    // geomsï¼šæŠŠâ€œä»·æ ¼â€æ¢ç®—æˆâ€œåƒç´ é«˜åº¦â€ï¼ŒUI æ¸²æŸ“èœ¡çƒ›å›¾åªç”¨å®ƒ
    const geoms: KlineGeom[] = [];
    // labelsï¼šx è½´æ˜¾ç¤ºçš„æ—¥æœŸï¼ˆåšäº†æŠ½æ ·ï¼Œä¸ä¼šæ¯æ ¹éƒ½ç”»ï¼‰
    const labels: string[] = [];

    // æ²¡æ•°æ®å°±æ¸…ç©º UI å¯¹åº”çŠ¶æ€
    if (points.length === 0) {
      this.klineGeoms = geoms;
      this.klineXLabels = labels;
      return;
    }

    // 1) æ‰«ä¸€éï¼Œæ‹¿åˆ°è¿™ä¸€å± K çº¿çš„æœ€é«˜ä»· / æœ€ä½ä»·ï¼ˆç”¨äºåš y è½´æ˜ å°„ï¼‰
    let minPrice: number = points[0].low;
    let maxPrice: number = points[0].high;

    for (let i: number = 1; i < points.length; i++) {
      const p: KLinePoint = points[i];
      if (p.low < minPrice) {
        minPrice = p.low;
      }
      if (p.high > maxPrice) {
        maxPrice = p.high;
      }
    }

    // æç«¯æƒ…å†µé˜²å¾¡ï¼šå¦‚æœæœ€é«˜ä»·=æœ€ä½ä»·ï¼Œrange=0ï¼Œä¼šå¯¼è‡´é™¤é›¶
    let range: number = maxPrice - minPrice;
    if (range <= 0) {
      range = 1.0;
      maxPrice = minPrice + range;
    }

    // è®°å½•ç»™ y è½´åˆ»åº¦æ˜¾ç¤ºç”¨
    this.klineMinPrice = minPrice;
    this.klineMaxPrice = maxPrice;

    // 2) ç»Ÿä¸€ä½¿ç”¨å›ºå®šç»˜å›¾é«˜åº¦ï¼ˆè¿™å¿…é¡»å’Œ UI èœ¡çƒ›åŒºåŸŸ height ä¿æŒä¸€è‡´ï¼‰
    const fullHeight: number = this.KLINE_PLOT_H;

    // å¤ªæ‰çš„èœ¡çƒ›çœ‹ä¸è§ï¼šç»™å®ä½“/å½±çº¿ä¸€ä¸ªæœ€å°åƒç´ é«˜åº¦
    const minBody: number = 4;
    const minWick: number = 2;

    // æŠŠâ€œä»·æ ¼â€æ˜ å°„åˆ°â€œy åƒç´ åæ ‡â€
    // y=0 åœ¨æœ€ä¸Šé¢ï¼›ä»·æ ¼è¶Šé«˜ï¼Œy è¶Šå°
    const priceToY = (price: number): number => {
      const y: number = (maxPrice - price) / range * fullHeight;
      if (y < 0) {
        return 0;
      }
      if (y > fullHeight) {
        return fullHeight;
      }
      return y;
    };

    // 3) æŠŠæ¯æ ¹ K çº¿è½¬æˆ UI å¯ç›´æ¥ç”»çš„å‡ ä½•æ•°æ®
    for (let i: number = 0; i < points.length; i++) {
      const pt: KLinePoint = points[i];

      // æŠŠå¼€é«˜ä½æ”¶éƒ½æ˜ å°„æˆ y åæ ‡ï¼ˆåé¢ç”¨è¿™äº›æ¥ç®—å®ä½“/å½±çº¿é«˜åº¦ï¼‰
      const yHigh: number = priceToY(pt.high);
      const yLow: number = priceToY(pt.low);
      const yOpen: number = priceToY(pt.open);
      const yClose: number = priceToY(pt.close);

      // å®ä½“çš„ä¸Šè¾¹/ä¸‹è¾¹ï¼šopen å’Œ close è°é«˜è°åœ¨ä¸Š
      let yTopBody: number = Math.min(yOpen, yClose);
      let yBottomBody: number = Math.max(yOpen, yClose);

      // å®ä½“å¤ªè–„æ—¶å¼ºåˆ¶æ‹‰åˆ°æœ€å°é«˜åº¦ï¼ˆå¦åˆ™ç”¨æˆ·ç‚¹é€‰æ—¶åƒâ€œæ²¡ä¸œè¥¿â€ï¼‰
      if (yBottomBody - yTopBody < minBody) {
        const mid: number = (yTopBody + yBottomBody) / 2.0;
        yTopBody = mid - minBody / 2.0;
        yBottomBody = mid + minBody / 2.0;

        // æ‹‰ä¼¸åå¯èƒ½è¶…å‡ºç»˜å›¾åŒºï¼Œåšä¸€æ¬¡è£å‰ª
        if (yTopBody < 0) {
          yTopBody = 0;
          yBottomBody = minBody;
        }
        if (yBottomBody > fullHeight) {
          yBottomBody = fullHeight;
          yTopBody = fullHeight - minBody;
        }
      }

      // ä¸Šå½±çº¿é«˜åº¦ï¼šhigh -> å®ä½“ä¸Šè¾¹ï¼ˆy è¶Šå°è¶Šé ä¸Šï¼Œæ‰€ä»¥ç”¨ yTopBody - yHighï¼‰
      let upperWick: number = yTopBody - yHigh;
      if (upperWick < minWick) {
        upperWick = minWick;
      }

      // ä¸‹å½±çº¿é«˜åº¦ï¼šå®ä½“ä¸‹è¾¹ -> low
      let lowerWick: number = yLow - yBottomBody;
      if (lowerWick < minWick) {
        lowerWick = minWick;
      }

      // topGapï¼šèœ¡çƒ›æ•´ä½“ç¦»é¡¶éƒ¨çš„ç©ºç™½ï¼ˆç”¨äºå…ˆç”»ä¸€ä¸ª Blank æŠŠèœ¡çƒ›â€œé¡¶â€åˆ°æ­£ç¡®ä½ç½®ï¼‰
      let topGap: number = yHigh;
      if (topGap < 0) {
        topGap = 0;
      }
      if (topGap > fullHeight) {
        topGap = fullHeight;
      }

      // å†åšä¸€å±‚é˜²å¾¡ï¼šå¦‚æœç©ºç™½+å½±çº¿+å®ä½“åŠ èµ·æ¥è¶…è¿‡ç»˜å›¾åŒºï¼Œä¼šå¯¼è‡´å¸ƒå±€æº¢å‡º
      // è¿™é‡Œä¼˜å…ˆå‹ç¼© topGapï¼ˆè§†è§‰å½±å“æœ€å°ï¼‰ï¼Œå½±çº¿/å®ä½“å°½é‡ä¸åŠ¨
      const totalH: number = topGap + upperWick + (yBottomBody - yTopBody) + lowerWick;
      if (totalH > fullHeight) {
        const overflow: number = totalH - fullHeight;
        topGap = topGap - overflow;
        if (topGap < 0) {
          topGap = 0;
        }
      }

      // ç»„è£…ç»™ UI ç”¨çš„ç»“æ„ï¼šåé¢ ForEach ç›´æ¥ç”» Rect
      geoms.push({
        upperWick: upperWick,
        bodyHeight: (yBottomBody - yTopBody),
        lowerWick: lowerWick,
        topGap: topGap,
        isUp: pt.close >= pt.open // æ”¶>=å¼€ è§†ä¸ºæ¶¨ï¼ˆå†³å®šå®ä½“é¢œè‰²ï¼‰
      });
    }

    // 4) x è½´æ ‡ç­¾ï¼šæœ€å¤šæ˜¾ç¤º 5 ä¸ªï¼Œå‡åŒ€æŠ½æ ·ï¼ˆä¸ç„¶ 60 æ ¹ K çº¿ä¼šæŒ¤æˆä¸€å›¢ï¼‰
    const total: number = points.length;
    const maxLabels: number = 5;
    const actualLabels: number = total >= maxLabels ? maxLabels : total;

    if (actualLabels > 0) {
      const lastIndex: number = total - 1;
      for (let i: number = 0; i < actualLabels; i++) {
        let idx: number;
        if (actualLabels === 1) {
          idx = 0;
        } else {
          idx = Math.floor(i * lastIndex / (actualLabels - 1));
        }

        // æ—¥æœŸä¸€èˆ¬æ˜¯ YYYY-MM-DDï¼Œè¿™é‡Œåªæ˜¾ç¤º MM-DD æ›´çœç©ºé—´
        const dateStr: string = points[idx].date;
        const label: string = dateStr.length >= 5 ? dateStr.substring(5) : dateStr;
        labels.push(label);
      }
    }

    // ä¸€æ¬¡æ€§å†™å›çŠ¶æ€ï¼Œè®© UI åˆ·æ–°
    this.klineGeoms = geoms;
    this.klineXLabels = labels;
  }


  // é€‰ä¸­æŸä¸€æ ¹ K çº¿
  private onKlineSelected(index: number): void {
    if (index < 0 || index >= this.klinePoints.length) {
      return;
    }

    const pt: KLinePoint = this.klinePoints[index];

    this.selectedKlineIndex = index;
    this.selectedKlineDate = pt.date;
    this.selectedKlineOpen = pt.open;
    this.selectedKlineHigh = pt.high;
    this.selectedKlineLow = pt.low;
    this.selectedKlineClose = pt.close;
  }

  // ===== å»æ‰ strip ä¸­æŸä¸ªæ ‡çš„ =====
  private removeQuoteCard(code: string, type: 'index' | 'stock'): void {
    // æœç´¢ç»“æœé‡ŒæŠŠå¯¹åº”çš„å¡ç‰‡åˆ æ‰ï¼ˆåŒ code + åŒ type æ‰ç®—åŒä¸€ä¸ªï¼‰
    this.searchedQuotes = this.searchedQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );

    // å®æ—¶è¡Œæƒ…åˆ—è¡¨é‡Œä¹Ÿåˆ æ‰ä¸€ä»½
    this.marketQuotes = this.marketQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );

    // å¦‚æœåˆ æ‰çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„é‚£åªï¼Œå°±æŠŠå³ä¾§ K çº¿åŒºåŸŸä¹Ÿä¸€å¹¶æ¸…ç©ºï¼Œé¿å…è¿˜æ˜¾ç¤ºæ—§æ•°æ®
    if (this.selectedQuoteCode === code && this.selectedQuoteType === type) {
      this.selectedQuoteCode = '';
      this.selectedQuoteName = '';
      this.selectedKlineIndex = -1;
      this.klinePoints = [];
      this.klineGeoms = [];
      this.klineXLabels = [];
    }
  }


  // ===== æ ¹æ®ä»£ç æŸ¥è¯¢å•ä¸ªæ ‡çš„ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ =====
  private async queryQuoteByCode(): Promise<void> {
    // è¾“å…¥æ¡†é‡Œæ‹¿åˆ°çš„ä»£ç å…ˆåšä¸€æ¬¡ trimï¼Œé¿å…ç”¨æˆ·ä¸å°å¿ƒè¾“ç©ºæ ¼
    const code: string = this.searchCode.trim()

    // è¿™é‡Œåªæ”¯æŒ 6 ä½ä»£ç ï¼ˆæŒ‡æ•° / A è‚¡éƒ½æŒ‰ 6 ä½èµ°ï¼‰
    if (code.length !== 6) {
      this.searchError = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    // è¿›å…¥è¯·æ±‚æ€ï¼šå±•ç¤ºâ€œæ­£åœ¨æŸ¥è¯¢â€¦â€ï¼Œå¹¶æ¸…æ‰ä¸Šä¸€æ¬¡çš„é”™è¯¯æç¤º
    this.searchLoading = true
    this.searchError = ''

    const httpRequest = http.createHttp()
    try {
      // æŸ¥è¯¢ç±»å‹è·Ÿç€å½“å‰æ¨¡å¼èµ°ï¼šæŒ‡æ•°æ¨¡å¼å°±æŸ¥æŒ‡æ•°æ¥å£ï¼Œè‚¡ç¥¨æ¨¡å¼å°±æŸ¥è‚¡ç¥¨æ¥å£
      const type: 'index' | 'stock' = this.currentMode
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=${type}&code=${code}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      // 200ï¼šåç«¯è¿”å›å•æ¡è¡Œæƒ…
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const newItem: Quote = this.mapBackendQuote(backendItem, type)

        // å†™å…¥ç¼“å­˜ï¼šåé¢è‡ªé€‰ç»Ÿè®¡ã€åˆ—è¡¨è¡Œå±•ç¤ºéƒ½ä¾èµ– quoteCache
        this.mergeQuotesToCache([newItem])

        // æœç´¢ç»“æœåªæ˜¾ç¤ºâ€œå½“å‰æ¨¡å¼â€çš„å†…å®¹ï¼š
        // - æ–°ç»“æœæ”¾æœ€å‰é¢
        // - å»æ‰é‡å¤ï¼ˆåŒ code + type çš„åªä¿ç•™ä¸€æ¡ï¼‰
        const next: Quote[] = [newItem]
        for (let i: number = 0; i < this.searchedQuotes.length; i++) {
          const q: Quote = this.searchedQuotes[i]
          if (q.type !== type) continue
          if (q.code === newItem.code && q.type === newItem.type) continue
          next.push(q)
        }
        this.searchedQuotes = next
        return
      }

      // 404ï¼šåç«¯æ˜ç¡®è¡¨ç¤ºæ²¡è¿™ä¸ªä»£ç ï¼ˆç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤ºï¼‰
      if (res.responseCode === 404) {
        this.searchError = 'æœªæ‰¾åˆ°è¯¥ä»£ç '
      } else {
        // å…¶ä»–é”™è¯¯ï¼šç›´æ¥æŠŠ HTTP code æ˜¾ç¤ºå‡ºæ¥ï¼Œä¾¿äºæ’æŸ¥
        this.searchError = `HTTP ${res.responseCode}`
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸ / JSON è§£æå¼‚å¸¸ç­‰ï¼šè½¬æˆå­—ç¬¦ä¸²æ˜¾ç¤º
      this.searchError = `${e}`
    } finally {
      // æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦é‡Šæ”¾è¯·æ±‚å¯¹è±¡ï¼Œå¹¶é€€å‡º loading çŠ¶æ€
      httpRequest.destroy()
      this.searchLoading = false
    }
  }

  // ===== è®¡ç®—æ•´æ®µ K çº¿åŒºåŸŸæ€»å®½åº¦ =====
  private getKlineTotalWidth(): number {
    const count: number = this.klineGeoms.length;
    if (count <= 0) {
      return 0;
    }
    return count * this.candleBodyWidth + (count - 1) * this.candleGap;
  }


  // åŠ è½½åˆ†ç»„
  private async loadGroupsFromPrefs(): Promise<void> {
    // è¿›æ¥å…ˆæ‰“ä¸ª logï¼Œä¸»è¦æ˜¯æ’æŸ¥â€œä¸ºå•¥åˆ†ç»„æ²¡åŠ è½½/åŠ è½½æ…¢/é‡å¤åŠ è½½â€è¿™ç±»é—®é¢˜
    this.dbg('loadGroupsFromPrefs:enter')

    // æ‰“å¼€æœ¬åœ° Preferences æ–‡ä»¶ï¼ˆç›¸å½“äºä¸€ä¸ªå°å‹çš„ key-value å­˜å‚¨ï¼‰
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)

    // ä»æŒ‡å®š key è¯»å‡ºåˆ†ç»„çš„ JSON å­—ç¬¦ä¸²ï¼›æ²¡æœ‰å°±ç»™ç©ºä¸²
    const jsonStr: string = (await pref.get(this.PREF_KEY_GROUPS, '')) as string

    // ç¬¬ä¸€æ¬¡å®‰è£… / æ²¡å­˜è¿‡åˆ†ç»„ï¼šèµ°åˆå§‹åŒ–é€»è¾‘ï¼Œç»™ä¸€ä¸ªâ€œé»˜è®¤åˆ†ç»„â€
    if (jsonStr.trim().length === 0) {
      const g: StockGroup = {
        id: 1,
        name: 'é»˜è®¤åˆ†ç»„',
        stocks: [],
        createdAt: Date.now(),
        version: 0
      }

      // groups ç”¨æ–°æ•°ç»„ç›´æ¥è¦†ç›–ï¼Œä¿è¯ UI èƒ½ç«‹åˆ»æ¸²æŸ“å‡ºæ¥
      this.groups = [g]
      this.activeGroupId = 1
      this.nextGroupId = 2 // ä¸‹æ¬¡æ–°å»ºåˆ†ç»„ä» 2 å¼€å§‹
      await this.saveGroupsToPrefs() // æŠŠé»˜è®¤åˆ†ç»„å†™å›å»ï¼Œåç»­å¯åŠ¨å°±èƒ½ç›´æ¥è¯»åˆ°

      // é»˜è®¤åˆ†ç»„ä¹Ÿè¦åŒæ­¥ä¸€æ¬¡ activeStocksï¼Œå¦åˆ™è‡ªé€‰é¡µå¯èƒ½è¿˜æ˜¯ç©ºçŠ¶æ€
      this.syncActiveStocks()
      this.dbg('loadGroupsFromPrefs:initDefault')
      return
    }

    // æœ‰æ•°æ®ï¼šæŠŠ JSON è§£ææˆ StockGroup[]ï¼ˆsafeParseGroups å†…éƒ¨åšè¿‡ç»“æ„å…œåº•ï¼‰
    const parsed: StockGroup[] = this.safeParseGroups(jsonStr)
    this.groups = parsed

    // æ‰«ä¸€éå·²æœ‰åˆ†ç»„ idï¼Œç”¨æ¥è®¡ç®— nextGroupIdï¼ˆé¿å…æ–°å»ºåˆ†ç»„ id æ’è½¦ï¼‰
    let maxId: number = 0
    for (let i: number = 0; i < parsed.length; i++) {
      if (parsed[i].id > maxId) maxId = parsed[i].id
    }
    this.nextGroupId = maxId + 1

    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç»„ï¼ˆæ²¡æœ‰åˆ†ç»„å°±è®¾ä¸º -1ï¼‰
    this.activeGroupId = parsed.length > 0 ? parsed[0].id : -1

    // activeGroupId å˜äº†å°±åŒæ­¥ activeStocksï¼Œä¿è¯è‡ªé€‰åˆ—è¡¨/ç»Ÿè®¡è·Ÿç€åˆ·æ–°
    this.syncActiveStocks()
    this.dbg('loadGroupsFromPrefs:done')
  }


  // æŠŠå½“å‰çš„åˆ†ç»„åˆ—è¡¨ï¼ˆthis.groupsï¼‰åºåˆ—åŒ–æˆ JSONï¼Œå¹¶å†™å…¥ Preferencesï¼Œä¿è¯ä¸‹æ¬¡å¯åŠ¨è¿˜èƒ½æ¢å¤åˆ†ç»„æ•°æ®
  private async saveGroupsToPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE);
    const jsonStr: string = JSON.stringify(this.groups);
    await pref.put(this.PREF_KEY_GROUPS, jsonStr);
    await pref.flush();
  }

  // ä» Preferences é‡Œè¯»å‡ºæ¥çš„ JSON å­—ç¬¦ä¸²è¿˜åŸæˆ StockGroup[]ï¼Œé¡ºä¾¿åšä¸€æ¬¡ç»“æ„å…œåº•ï¼ˆé˜²æ­¢è€æ•°æ®/è„æ•°æ®æŠŠé¡µé¢æå´©ï¼‰
  private safeParseGroups(jsonStr: string): StockGroup[] {
    try {
      // å…ˆæŠŠå­—ç¬¦ä¸² parse æˆ JS å¯¹è±¡ï¼›è¿™é‡Œä¸åš any/unknownï¼Œç»Ÿä¸€æŒ‰ Object æ¥ä½å†é€å­—æ®µè½¬
      const rawObj: Object = JSON.parse(jsonStr) as Object;
      if (!Array.isArray(rawObj)) {
        // ä¸æ˜¯æ•°ç»„å°±ç›´æ¥è®¤ä¸ºæ— æ•ˆï¼ˆæˆ‘ä»¬å­˜çš„ groups_json æœ¬æ¥å°±æ˜¯æ•°ç»„ï¼‰
        return [];
      }

      const arr: Object[] = rawObj as Object[];
      const result: StockGroup[] = [];

      for (let i: number = 0; i < arr.length; i++) {
        // å•ä¸ªåˆ†ç»„å¯¹è±¡ï¼šç”¨ Record<string, Object> æ¥åšå­—æ®µè®¿é—®ï¼ˆç¬¦åˆ arkts6 çš„é™åˆ¶ï¼‰
        const item: Record<string, Object> = arr[i] as Record<string, Object>;

        // è¿™äº›å­—æ®µéƒ½èµ° Number/String å¼ºè½¬ï¼šå°±ç®—ç¼ºå­—æ®µ/ç±»å‹ä¸å¯¹ï¼Œä¹Ÿä¸ä¼šç›´æ¥æŠ›å¼‚å¸¸
        const id: number = Number(item['id']);
        const name: string = String(item['name'] ?? '');
        const createdAt: number = Number(item['createdAt'] ?? Date.now());
        const version: number = Number(item['version'] ?? 0); // è€ç‰ˆæœ¬æ²¡ version çš„è¯ï¼Œé»˜è®¤ä» 0 å¼€å§‹

        // stocks å¯èƒ½ä¸å­˜åœ¨/ä¸æ˜¯æ•°ç»„ï¼šç»Ÿä¸€å…œåº•æˆç©ºæ•°ç»„
        const stocksRaw: Object = item['stocks'] ?? [];
        const stocks: StockRef[] = [];

        if (Array.isArray(stocksRaw)) {
          const sr: Object[] = stocksRaw as Object[];
          for (let j: number = 0; j < sr.length; j++) {
            const s: Record<string, Object> = sr[j] as Record<string, Object>;

            // åªæ¥å— 6 ä½ codeï¼›name å¯é€‰ï¼Œæœ‰å°±å¸¦ä¸Š
            const code: string = String(s['code'] ?? '').trim();
            if (code.length === 6) {
              const ref: StockRef = { code: code };

              const nm: string = String(s['name'] ?? '').trim();
              if (nm.length > 0) {
                ref.name = nm;
              }
              stocks.push(ref);
            }
          }
        }

        // æœ€èµ·ç è¦æœ‰ id + name æ‰ç®—ä¸€ä¸ªåˆæ³•åˆ†ç»„
        if (!Number.isNaN(id) && name.length > 0) {
          result.push({ id, name, stocks, createdAt, version });
        }
      }

      return result;
    } catch (e) {
      // JSON è§£æå¤±è´¥æˆ–è€…ç»“æ„ç‰¹åˆ«ç¦»è°±ï¼šç›´æ¥å›ç©ºï¼Œé¿å…å½±å“é¡µé¢å¯åŠ¨
      return [];
    }
  }

  // æ‰¾group id
  private findGroupIndex(groupId: number): number {
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id === groupId) {
        return i;
      }
    }
    return -1;
  }

  // æ–°å»ºä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼šå†™å…¥å†…å­˜ï¼ˆthis.groupsï¼‰+ è®¾ä¸ºå½“å‰æ¿€æ´»åˆ†ç»„ + è½ç›˜åˆ° Preferences
  private async createGroup(name: string): Promise<void> {
    // è¾“å…¥æ¡†é‡Œå¯èƒ½å¸¦ç©ºæ ¼ï¼Œå…ˆ trim ä¸€ä¸‹ï¼›ç©ºåå­—å°±ç›´æ¥å¿½ç•¥
    const n: string = name.trim();
    if (n.length === 0) return;

    // ç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ†ç»„å¯¹è±¡ï¼šid ç”¨è‡ªå¢çš„ nextGroupIdï¼Œversion ä» 0 å¼€å§‹ï¼ˆç”¨äº List å¼ºåˆ¶åˆ·æ–°ï¼‰
    const g: StockGroup = { id: this.nextGroupId, name: n, stocks: [], createdAt: Date.now(), version: 0 };
    this.nextGroupId += 1; // ä¸‹ä¸€ä¸ªåˆ†ç»„çš„ id é¢„ç•™å‡ºæ¥

    // æŠŠæ–°åˆ†ç»„æ”¾åˆ°æœ€å‰é¢ï¼ˆç”¨æˆ·ä¸€èˆ¬å¸Œæœ›åˆšå»ºçš„ç»„é©¬ä¸Šå‡ºç°åœ¨é¡¶éƒ¨ï¼‰
    const copy: StockGroup[] = [g, ...this.groups];
    this.groups = copy;

    // ç«‹å³åˆ‡åˆ°æ–°åˆ†ç»„ï¼Œåç»­ UI éƒ½ä»¥ activeGroupId ä¸ºå‡†
    this.activeGroupId = g.id;

    // å…³é”®ï¼šactiveGroupId å˜äº†ä»¥åï¼Œè¦æŠŠâ€œå½“å‰æ´»è·ƒè‚¡ç¥¨åˆ—è¡¨/ç»Ÿè®¡â€è¿™æ¡é“¾è·¯åŒæ­¥ä¸€é
    // ä¸ç„¶ UI ä¼šå‡ºç°â€œçœ‹èµ·æ¥åˆ‡äº†ç»„ï¼Œä½†æ•°æ®è¿˜åœç•™åœ¨ä¸Šä¸€ä¸ªç»„â€çš„æƒ…å†µ
    this.syncActiveStocks();           // activeStocks / è‚¡ç¥¨æ•°é‡ç­‰ç«‹åˆ»æ›´æ–°
    this.refreshActiveGroupStats();    // ç»Ÿè®¡å¡ç«‹åˆ»åˆ·æ–°ï¼ˆæ–°å»ºç©ºç»„å°±æ˜¯ 0ï¼‰

    // è½ç›˜ï¼šä¸‹æ¬¡å¯åŠ¨è¿˜èƒ½æ¢å¤åˆ†ç»„
    await this.saveGroupsToPrefs();

    // é¢„çƒ­ä¸€ä¸‹å½“å‰åˆ†ç»„çš„è¡Œæƒ…ç¼“å­˜ï¼ˆæ–°ç»„ä¸ºç©ºä¹Ÿæ²¡å…³ç³»ï¼Œæµç¨‹ä¿æŒä¸€è‡´ï¼‰
    await this.preloadActiveGroupQuotes();

    // å…œåº•å†åˆ·ä¸€æ¬¡ç»Ÿè®¡ï¼ˆæœ‰äº›æƒ…å†µä¸‹ preload ä¼šæ”¹å˜ç¼“å­˜å‘½ä¸­æƒ…å†µï¼‰
    this.refreshActiveGroupStats();
  }

  // åˆ é™¤ä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼šä» this.groups é‡Œç§»é™¤ + å¤„ç†å½“å‰æ¿€æ´»åˆ†ç»„çš„åˆ‡æ¢ + è½ç›˜ä¿å­˜
  private async deleteGroup(groupId: number): Promise<void> {
    // 1) å…ˆæŠŠè¦åˆ çš„åˆ†ç»„è¿‡æ»¤æ‰ï¼ˆä¸ç”¨ filter æ˜¯ä¸ºäº†å°‘è¸© ArkTS ç±»å‹å‘ï¼‰
    const copy: StockGroup[] = [];
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id !== groupId) copy.push(this.groups[i]);
    }
    this.groups = copy;

    // 2) å¦‚æœåˆ æ‰çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šéœ€è¦æŠŠ activeGroupId åˆ‡åˆ°ä¸€ä¸ªâ€œè¿˜å­˜åœ¨â€çš„åˆ†ç»„
    //    è¿™é‡Œç®€å•å¤„ç†ï¼šåˆ‡åˆ°åˆ—è¡¨ç¬¬ä¸€ä¸ªï¼›å¦‚æœä¸€ä¸ªéƒ½æ²¡äº†ï¼Œå°±ç”¨ -1 è¡¨ç¤ºâ€œæ²¡æœ‰æ¿€æ´»åˆ†ç»„â€
    if (this.activeGroupId === groupId) {
      this.activeGroupId = this.groups.length > 0 ? this.groups[0].id : -1;
    }

    // 3) åˆ†ç»„å˜åŠ¨ä¼šå½±å“ activeStocks / ç»Ÿè®¡å¡ï¼Œæ‰€ä»¥è¦ç«‹åˆ»åŒæ­¥ä¸€ä¸‹ UI ä¾§çš„â€œactive é“¾è·¯â€
    //    å¦åˆ™ä¼šå‡ºç°ï¼šåˆ†ç»„å·²ç»åˆ äº†ï¼Œä½†é¡µé¢è¿˜åœ¨æ˜¾ç¤ºæ—§åˆ†ç»„çš„è‚¡ç¥¨å’Œç»Ÿè®¡
    this.syncActiveStocks();
    this.refreshActiveGroupStats();

    // 4) è½ç›˜ä¿å­˜ï¼šä¿è¯ä¸‹æ¬¡å¯åŠ¨åˆ†ç»„åˆ—è¡¨æ˜¯å¯¹çš„
    await this.saveGroupsToPrefs();

    // 5) å¦‚æœå½“å‰è¿˜æœ‰æ¿€æ´»åˆ†ç»„ï¼šé¢„çƒ­ä¸€ä¸‹è¯¥åˆ†ç»„çš„è¡Œæƒ…ç¼“å­˜ï¼Œç„¶åå†åˆ·ä¸€æ¬¡ç»Ÿè®¡ï¼ˆèµ°çš„æ˜¯æœ€æ–°ç¼“å­˜/æœ€æ–°è¡Œæƒ…ï¼‰
    if (this.activeGroupId >= 0) {
      await this.preloadActiveGroupQuotes();
      this.refreshActiveGroupStats();
    }
  }

  // å¾€æŒ‡å®šåˆ†ç»„é‡Œæ‰¹é‡æ·»åŠ è‚¡ç¥¨ä»£ç ï¼šåš 6 ä½æ ¡éªŒ + å»é‡ + æ›´æ–° groups + è½ç›˜ +ï¼ˆå¿…è¦æ—¶ï¼‰é¢„çƒ­è¡Œæƒ…
  private async addStocksToGroup(groupId: number, codes: string[]): Promise<void> {
    // ä»…ç”¨äºä½ è‡ªå·±çš„è°ƒè¯•æ—¥å¿—ï¼šæ–¹ä¾¿åœ¨æ§åˆ¶å°å¿«é€Ÿç¡®è®¤ä¼ å‚å’Œæµç¨‹æœ‰æ²¡æœ‰èµ°åˆ°
    this.dbg(`addStocksToGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    // æ‰¾åˆ°ç›®æ ‡åˆ†ç»„åœ¨ this.groups é‡Œçš„ä¸‹æ ‡ï¼›æ²¡æ‰¾åˆ°å°±ç›´æ¥é€€å‡º
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) å…ˆæŠŠå½“å‰åˆ†ç»„å·²æœ‰çš„ code æ”¶é›†èµ·æ¥ï¼šåé¢ç”¨æ¥åšå»é‡
    const existed: Set<string> = new Set<string>()
    const curStocks: StockRef[] = this.groups[idx].stocks
    for (let i: number = 0; i < curStocks.length; i++) {
      existed.add(curStocks[i].code)
    }

    // 2) å¤„ç†æœ¬æ¬¡è¦åŠ çš„ codesï¼š
    //    - trim æ‰ç©ºæ ¼
    //    - åªæ¥å— 6 ä½
    //    - è·Ÿåˆ†ç»„å·²æœ‰çš„å»é‡
    //    - åŒä¸€æ‰¹ codes è‡ªå·±ä¹Ÿå»é‡ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¸€æ¬¡è¾“å…¥é‡å¤äº†ï¼‰
    const addList: StockRef[] = []
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length !== 6) {
        continue
      }
      if (existed.has(code6)) {
        continue
      }
      existed.add(code6)
      // è¿™é‡Œåªå…ˆå­˜ codeï¼›name å¯ä»¥åé¢é€šè¿‡è¡Œæƒ…æ¥å£è¡¥å…¨ï¼Œå‡å°‘ä¸€æ¬¡è¾“å…¥è´Ÿæ‹…
      addList.push({ code: code6 })
    }

    // å¦‚æœè¿™æ¬¡æ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ–°å¢ï¼Œå°±ä¸ç”¨ç»§ç»­åšåé¢çš„ UI æ›´æ–°å’Œè½ç›˜äº†
    if (addList.length === 0) {
      this.dbg('addStocksToGroup:skip empty addList')
      return
    }

    // 3) æ›´æ–° groupsï¼š
    //    è¿™é‡Œå¿…é¡»â€œæ–°æ•°ç»„ + æ–°å¯¹è±¡â€ï¼ŒArkUI æ‰æ›´å®¹æ˜“è¯†åˆ«åˆ°ç»“æ„å˜åŒ–å¹¶è§¦å‘åˆ·æ–°
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    const newStocks: StockRef[] = g.stocks.concat(addList)
    // cloneGroupWithStocks ä¸€èˆ¬ä¼šé¡ºå¸¦ version+1ï¼Œé¿å… List å› ä¸ºå¼•ç”¨æ²¡å˜è€Œä¸åˆ·æ–°
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœæ”¹çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šé©¬ä¸ŠåŒæ­¥ activeStocks
    //    ä¸ç„¶ç”¨æˆ·ä¼šæ„Ÿè§‰â€œæˆ‘ç‚¹äº†æ·»åŠ ï¼Œä½†åˆ—è¡¨æ²¡å˜/ç»Ÿè®¡æ²¡å˜â€
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) ç»™ä¸ªç®€å•æç¤ºï¼šå‘Šè¯‰ç”¨æˆ·è¿™æ¬¡åŠ äº†å¤šå°‘åªã€å½“å‰åˆ†ç»„æ€»å…±æœ‰å¤šå°‘åª
    this.watchlistMsg = `å·²æ·»åŠ  ${addList.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) è½ç›˜ä¿å­˜ï¼šä¿è¯ä¸‹æ¬¡å¯åŠ¨åˆ†ç»„æ•°æ®è¿˜åœ¨
    await this.saveGroupsToPrefs()
    this.dbg('addStocksToGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šé¡ºæ‰‹é¢„çƒ­ä¸€ä¸‹è¿™äº›è‚¡ç¥¨çš„è¡Œæƒ…
    //    è¿™æ · quoteCache å¾ˆå¿«å°±æœ‰æ•°æ®ï¼Œç»Ÿè®¡å¡ï¼ˆæ¶¨è·Œ/å‡å€¼ï¼‰å°±ä¸ä¼šä¸€ç›´æ˜¯ "--"
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('addStocksToGroup:afterPreload')
    }
  }

  // ä»æŒ‡å®šåˆ†ç»„é‡Œæ‰¹é‡ç§»é™¤è‚¡ç¥¨ï¼šæŠŠè¦åˆ çš„ code åšæˆé›†åˆï¼Œç„¶åé‡å»º stocksã€æ›´æ–° groupsã€è½ç›˜ï¼Œå¹¶åŒæ­¥å½“å‰åˆ†ç»„çš„ UI/ç»Ÿè®¡
  private async removeStocksFromGroup(groupId: number, codes: string[]): Promise<void> {
    // è°ƒè¯•ç”¨ï¼šç¡®è®¤æ˜¯è°è§¦å‘çš„ã€ä¼ è¿›æ¥è¦åˆ å“ªäº›ä»£ç 
    this.dbg(`removeStocksFromGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    // æ‰¾ç›®æ ‡åˆ†ç»„åœ¨ groups é‡Œçš„ä½ç½®ï¼›æ‰¾ä¸åˆ°å°±ä¸ç»§ç»­äº†
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) å…ˆæŠŠâ€œè¦ç§»é™¤çš„ codeâ€æ•´ç†æˆ Setï¼š
    //    - trim ç©ºæ ¼
    //    - åªè®¤ 6 ä½
    //    - Set å¤©ç”Ÿå»é‡ï¼Œé¿å…é‡å¤åˆ åŒä¸€ä¸ª code è¿˜è¦é¢å¤–åˆ¤æ–­
    const toRemove: Set<string> = new Set<string>()
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length === 6) {
        toRemove.add(code6)
      }
    }

    // å¦‚æœæ²¡æœ‰ä»»ä½•æœ‰æ•ˆçš„ codeï¼Œå°±ç›´æ¥é€€å‡ºï¼Œé¿å…åšæ— æ„ä¹‰çš„çŠ¶æ€æ›´æ–°
    if (toRemove.size === 0) {
      this.dbg('removeStocksFromGroup:skip empty toRemove')
      return
    }

    // 2) ç”¨è¿‡æ»¤çš„æ–¹å¼ç”Ÿæˆæ–°çš„ stocksï¼ˆæŠŠè¦åˆ çš„è¿‡æ»¤æ‰ï¼‰
    const oldStocks: StockRef[] = this.groups[idx].stocks
    const newStocks: StockRef[] = []
    for (let i: number = 0; i < oldStocks.length; i++) {
      const code: string = oldStocks[i].code
      if (!toRemove.has(code)) {
        // è¿™é‡Œç›´æ¥å¤ç”¨åŸæ¥çš„ StockRefï¼ˆé‡Œé¢å¯èƒ½å¸¦ç€ nameï¼‰ï¼Œä¸åšé¢å¤–æ”¹åŠ¨
        newStocks.push(oldStocks[i])
      }
    }

    // å¦‚æœè¿‡æ»¤å®Œé•¿åº¦æ²¡å˜ï¼Œè¯´æ˜è¿™æ¬¡è¦åˆ çš„ codes éƒ½ä¸åœ¨åˆ†ç»„é‡Œï¼Œå°±åˆ«æŠ˜è…¾ UI/è½ç›˜äº†
    if (newStocks.length === oldStocks.length) {
      this.dbg('removeStocksFromGroup:skip no changes')
      return
    }

    // 3) æ›´æ–° groupsï¼šåŒæ ·èµ°â€œæ–°æ•°ç»„ + æ–°å¯¹è±¡â€çš„æ–¹å¼ï¼Œä¿è¯ UI èƒ½åˆ·æ–°å‡ºæ¥
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šé©¬ä¸ŠåŒæ­¥ activeStocks
    //    ä¸ç„¶ç”¨æˆ·ä¼šçœ‹åˆ°åˆ†ç»„é‡Œå°‘äº†ï¼Œä½†ä¸‹é¢åˆ—è¡¨/ç»Ÿè®¡è¿˜åœç•™åœ¨æ—§æ•°æ®
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) ç®€å•æç¤ºï¼šå‘Šè¯‰ç”¨æˆ·è¿™æ¬¡åˆ äº†å¤šå°‘ã€ç°åœ¨è¿˜å‰©å¤šå°‘
    this.watchlistMsg = `å·²åˆ é™¤ ${oldStocks.length - newStocks.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) è½ç›˜ä¿å­˜ï¼šä¸‹æ¬¡å¯åŠ¨ä¾æ—§ä¿æŒåˆ é™¤åçš„çŠ¶æ€
    await this.saveGroupsToPrefs()
    this.dbg('removeStocksFromGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šå¯é€‰åœ°å†é¢„çƒ­ä¸€æ¬¡è¡Œæƒ…å¹¶åˆ·æ–°ç»Ÿè®¡
    //    ï¼ˆåˆ é™¤å cache é‡Œå¯èƒ½è¿˜æœ‰æ—§æ ‡çš„ï¼Œä½†ç»Ÿè®¡æ˜¯æŒ‰ activeStocks ç®—çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ˜¯ä¿æŒæµç¨‹ä¸€è‡´ï¼‰
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('removeStocksFromGroup:afterPreload')
    }
  }

  // ç”¨â€œæ–°å¯¹è±¡â€å…‹éš†ä¸€ä¸ªåˆ†ç»„ï¼Œå¹¶æ›¿æ¢ stocksã€‚
  // è¿™é‡Œé¡ºæ‰‹æŠŠ version +1ï¼šä¸»è¦æ˜¯ç»™ List/æ¸²æŸ“å±‚ä¸€ä¸ªâ€œæˆ‘çœŸçš„å˜äº†â€çš„ä¿¡å·ï¼Œé¿å…æŸäº›æƒ…å†µä¸‹ UI è®¤ä¸ºç»“æ„æ²¡å˜è€Œä¸åˆ·æ–°ã€‚
  private cloneGroupWithStocks(g: StockGroup, stocks: StockRef[]): StockGroup {
    return {
      id: g.id,
      name: g.name,
      stocks: stocks,          // æ–°çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆå·²ç» add/remove å¤„ç†è¿‡ï¼‰
      createdAt: g.createdAt,  // åˆ†ç»„åˆ›å»ºæ—¶é—´ä¸å˜
      version: g.version + 1   // æ¯æ¬¡æ”¹ stocks éƒ½ +1ï¼Œç”¨æ¥å¼ºåˆ¶è§¦å‘ UI é‡æ–°æ¸²æŸ“
    };
  }

  // å–â€œå½“å‰é€‰ä¸­çš„åˆ†ç»„â€å¯¹è±¡ã€‚
  // è¿™é‡Œè¿”å› StockGroup | nullï¼šå¤–é¢ç”¨çš„æ—¶å€™å¯ä»¥å¾ˆç›´è§‚åœ°åšç©ºåˆ¤æ–­ï¼Œé¿å… activeGroupId è¿˜æ²¡åˆå§‹åŒ–/åˆ†ç»„è¢«åˆ æ‰æ—¶ç›´æ¥å´©ã€‚
  private getActiveGroup(): StockGroup | null {
    // activeGroupId ä¸º -1 è¿™ç±»å€¼æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰é€‰ä¸­ä»»ä½•åˆ†ç»„
    if (this.activeGroupId < 0) {
      return null;
    }

    // ç”¨ id æ‰¾åˆ°å®ƒåœ¨ this.groups æ•°ç»„é‡Œçš„ä¸‹æ ‡
    const idx: number = this.findGroupIndex(this.activeGroupId);
    if (idx < 0) {
      // æ²¡æ‰¾åˆ°ï¼šä¸€èˆ¬æ˜¯åˆ†ç»„åˆšè¢«åˆ é™¤ã€æˆ–æœ¬åœ°æ•°æ®å¼‚å¸¸å¯¼è‡´
      return null;
    }

    // æ‰¾åˆ°äº†å°±ç›´æ¥è¿”å›å¯¹åº”åˆ†ç»„
    return this.groups[idx];
  }


  private findQuoteInCaches(code: string): Quote | null {
    // ä¼ è¿›æ¥çš„å¯èƒ½å¸¦ç©ºæ ¼ï¼ˆæ¯”å¦‚è¾“å…¥æ¡†/å‰ªè´´æ¿ï¼‰ï¼Œå…ˆåšä¸€æ¬¡æ ‡å‡†åŒ–
    const code6: string = code.trim();
    // æˆ‘ä»¬çš„åç«¯/æ•°æ®çº¦å®šéƒ½æ˜¯ 6 ä½ä»£ç ï¼›ä¸ç¬¦åˆå°±ç›´æ¥å½“ä½œæ— æ•ˆè¾“å…¥
    if (code6.length !== 6) return null;

    // ç¼“å­˜é‡Œçš„ key ç»Ÿä¸€åšäº†å‰ç¼€åŒºåˆ†ï¼šstock-xxxxxx / index-xxxxxx
    // è¿™é‡Œå…ˆæŒ‰è‚¡ç¥¨æŸ¥ä¸€æ¬¡ï¼ˆå¤§éƒ¨åˆ†åœºæ™¯ç”¨æˆ·æ›´å¸¸é€‰è‚¡ç¥¨ï¼‰
    const kStock: string = `stock-${code6}`;
    const vStock: Quote | undefined = this.quoteCache.get(kStock);
    if (vStock !== undefined) return vStock;

    // è‚¡ç¥¨æ²¡æ‰¾åˆ°ï¼Œå†æŒ‰æŒ‡æ•°æŸ¥ä¸€æ¬¡
    const kIndex: string = `index-${code6}`;
    const vIndex: Quote | undefined = this.quoteCache.get(kIndex);
    if (vIndex !== undefined) return vIndex;

    // ä¸¤ç±»éƒ½æ²¡æœ‰ï¼Œè¯´æ˜ç¼“å­˜é‡Œç¡®å®æ²¡æœ‰è¿™ä¸ªæ ‡çš„
    return null;
  }

  private getStockRowName(s: StockRef): string {
    // è¿™é‡Œâ€œè¯»ä¸€ä¸‹ quoteCacheVerâ€æ˜¯ä¸ºäº†è®© UI ä¾èµ–åˆ°ç¼“å­˜ç‰ˆæœ¬å·ï¼š
    // åªè¦è¡Œæƒ…ç¼“å­˜è¢«æ›´æ–°å¹¶ä¸”ä½ é€’å¢äº† quoteCacheVerï¼Œè¿™ä¸€è¡Œå°±ä¼šé‡æ–°è®¡ç®—ã€é‡æ–°æ¸²æŸ“åç§°ã€‚
    const _qv: number = this.quoteCacheVer

    // ä¼˜å…ˆä»ç¼“å­˜é‡Œæ‹¿â€œæœ€æ–°è¡Œæƒ…å¯¹åº”çš„åå­—â€ï¼ˆæœ€æƒå¨ï¼Œèƒ½è‡ªåŠ¨è·Ÿéšåç«¯ä¿®æ­£/è¡¥å…¨ï¼‰
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q !== null) {
      return q.name;
    }

    // ç¼“å­˜æ²¡å‘½ä¸­æ—¶ï¼Œé€€ä¸€æ­¥ç”¨ StockRef é‡Œä¿å­˜è¿‡çš„ nameï¼ˆæ¯”å¦‚ç¬¬ä¸€æ¬¡æ·»åŠ è‡ªé€‰æ—¶å†™è¿›å»çš„ï¼‰
    if (s.name && s.name.length > 0) {
      return s.name;
    }

    // ä¸¤è¾¹éƒ½æ²¡æœ‰å°±ç»™ä¸ªå ä½ç¬¦ï¼Œé¿å… UI æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²
    return 'â€”';
  }

  // ç”¨äºåœ¨è‡ªé€‰åˆ—è¡¨é‡Œå±•ç¤ºæŸåªè‚¡ç¥¨çš„â€œå½“å‰ä»·â€æ–‡æœ¬ï¼ˆä¼˜å…ˆç”¨ç¼“å­˜è¡Œæƒ…ï¼Œæ²¡æœ‰å°±ç»™å ä½ç¬¦ï¼‰
  private getStockRowPriceText(s: StockRef): string {
    // åŒ getStockRowNameï¼šè¯»ä¸€ä¸‹ quoteCacheVerï¼Œç¡®ä¿ç¼“å­˜ç‰ˆæœ¬å˜åŒ–æ—¶è¿™ä¸€è¡Œä¼šè§¦å‘é‡ç®—/åˆ·æ–°
    const _qv: number = this.quoteCacheVer

    // å°è¯•ä»è¡Œæƒ…ç¼“å­˜é‡Œæ‹¿åˆ°è¯¥è‚¡ç¥¨çš„æœ€æ–°æŠ¥ä»·
    const q: Quote | null = this.findStockQuoteInCache(s.code)

    // æœ‰è¡Œæƒ…ï¼šæŒ‰ 2 ä½å°æ•°å±•ç¤ºï¼›æ²¡è¡Œæƒ…ï¼šç”¨å ä½ç¬¦ï¼Œé¿å…å‡ºç° NaN/ç©ºç™½
    return (q !== null) ? q.price.toFixed(2) : '--'
  }

  // ç”¨äºåœ¨è‡ªé€‰åˆ—è¡¨é‡Œå±•ç¤ºæŸåªè‚¡ç¥¨çš„â€œæ¶¨è·Œé¢â€æ–‡æœ¬ï¼ˆä¼˜å…ˆç”¨ç¼“å­˜è¡Œæƒ…ï¼Œæ²¡æœ‰å°±ç»™å ä½ç¬¦ï¼‰
  private getStockRowChangeText(s: StockRef): string {
    // è¯»ä¸€ä¸‹ quoteCacheVerï¼Œç¡®ä¿ç¼“å­˜è¡Œæƒ…æ›´æ–°æ—¶è¿™ä¸€è¡Œä¼šè·Ÿç€åˆ·æ–°
    const _qv: number = this.quoteCacheVer

    // å°è¯•ä»è¡Œæƒ…ç¼“å­˜é‡Œæ‹¿åˆ°è¯¥è‚¡ç¥¨çš„æœ€æ–°æŠ¥ä»·
    const q: Quote | null = this.findStockQuoteInCache(s.code)

    // æœ‰è¡Œæƒ…ï¼šæŒ‰ 2 ä½å°æ•°å±•ç¤ºæ¶¨è·Œé¢ï¼›æ²¡è¡Œæƒ…ï¼šç”¨å ä½ç¬¦
    return (q !== null) ? q.change.toFixed(2) : '--'
  }

  // ç”¨äºåœ¨è‡ªé€‰åˆ—è¡¨é‡Œå±•ç¤ºæŸåªè‚¡ç¥¨çš„â€œæ¶¨è·Œå¹…(%)â€æ–‡æœ¬ï¼ˆä¼˜å…ˆç”¨ç¼“å­˜è¡Œæƒ…ï¼Œæ²¡æœ‰å°±ç»™å ä½ç¬¦ï¼‰
  private getStockRowPctText(s: StockRef): string {
    // è¯»ä¸€ä¸‹ quoteCacheVerï¼Œç¡®ä¿ç¼“å­˜è¡Œæƒ…æ›´æ–°æ—¶è¿™ä¸€è¡Œä¼šè·Ÿç€åˆ·æ–°
    const _qv: number = this.quoteCacheVer

    // å°è¯•ä»è¡Œæƒ…ç¼“å­˜é‡Œæ‹¿åˆ°è¯¥è‚¡ç¥¨çš„æœ€æ–°æŠ¥ä»·
    const q: Quote | null = this.findStockQuoteInCache(s.code)

    // æœ‰è¡Œæƒ…ï¼šä¿ç•™ 2 ä½å°æ•°å¹¶è¡¥ä¸Š %ï¼›æ²¡è¡Œæƒ…ï¼šç”¨å ä½ç¬¦
    return (q !== null) ? (q.changePercent.toFixed(2) + '%') : '--'
  }

  // ç”¨äºåœ¨è‡ªé€‰åˆ—è¡¨é‡Œå†³å®šâ€œä»·æ ¼æ•°å­—â€çš„é¢œè‰²ï¼šæ¶¨(å«0)ç”¨çº¢è‰²ï¼Œè·Œç”¨ç»¿è‰²ï¼›æ²¡æ‹¿åˆ°è¡Œæƒ…å°±ç”¨ç°è‰²å ä½
  private getStockRowPriceColor(s: StockRef): string {
    // è¯»ä¸€ä¸‹ quoteCacheVerï¼Œç¡®ä¿è¡Œæƒ…ç¼“å­˜æ›´æ–°æ—¶ï¼Œè¿™ä¸ªé¢œè‰²ä¹Ÿä¼šè§¦å‘é‡æ–°è®¡ç®—/æ¸²æŸ“
    const _qv: number = this.quoteCacheVer

    // ä»ç¼“å­˜é‡Œå–è¿™åªè‚¡ç¥¨çš„æœ€æ–°è¡Œæƒ…ï¼ˆæ‹¿ä¸åˆ°å°±è¿”å› nullï¼‰
    const q: Quote | null = this.findStockQuoteInCache(s.code)

    // æ²¡è¡Œæƒ…ï¼šç»Ÿä¸€ç”¨ç°è‰²ï¼Œé¿å… UI å‡ºç°â€œçº¢ç»¿ä¹±è·³â€
    if (q === null) {
      return '#AAAAAA'
    }

    // æœ‰è¡Œæƒ…ï¼šæŒ‰æ¶¨è·Œå†³å®šé¢œè‰²ï¼ˆchange >= 0 ä¹Ÿç®—â€œæ¶¨/å¹³â€ï¼Œèµ°çº¢è‰²ï¼‰
    return (q.change >= 0) ? '#FF4D4F' : '#39D98A'
  }

  // ç”¨äºåœ¨è‡ªé€‰åˆ—è¡¨é‡Œå†³å®šâ€œå‰¯æ–‡æœ¬/è¾…åŠ©ä¿¡æ¯â€ï¼ˆæ¯”å¦‚æ¶¨è·Œé¢ã€æ¶¨è·Œå¹…ä¸€ç±»ï¼‰æ˜¾ç¤ºçš„é¢œè‰²ï¼šæ¶¨(å«0)ç”¨æµ…çº¢ï¼Œè·Œç”¨æµ…ç»¿ï¼›æ²¡æ‹¿åˆ°è¡Œæƒ…å°±ç”¨æ›´æš—çš„ç°
  private getStockRowSubColor(s: StockRef): string {
    // è¯»ä¸€ä¸‹ quoteCacheVerï¼Œç¡®ä¿è¡Œæƒ…ç¼“å­˜æ›´æ–°æ—¶ï¼Œè¿™ä¸ªé¢œè‰²ä¹Ÿä¼šè·Ÿç€è§¦å‘é‡æ–°è®¡ç®—/æ¸²æŸ“
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code)

    // æ²¡æœ‰è¡Œæƒ…æ•°æ®ï¼šå‰¯æ–‡æœ¬ç”¨æ·±ä¸€ç‚¹çš„ç°è‰²ï¼Œå’Œä¸»ä»·æ ¼çš„ç°åŒºåˆ†å¼€
    if (q === null) {
      return '#777777'
    }

    // æœ‰è¡Œæƒ…ï¼šæ¶¨ç”¨æµ…çº¢ã€è·Œç”¨æµ…ç»¿ï¼ˆæ¯”ä¸»ä»·æ ¼è‰²æ›´â€œæŸ”å’Œâ€ï¼Œä¸æŠ¢ä¸»è§†è§‰ï¼‰
    return (q.change >= 0) ? '#FF7875' : '#6BE49B'
  }

  // ç¡®ä¿æŸä¸ªè‚¡ç¥¨ code çš„è¡Œæƒ…å·²ç»è¿›äº† quoteCacheï¼šå¦‚æœç¼“å­˜é‡Œæ²¡æœ‰ï¼Œå°±è¡¥ä¸€æ¬¡ by_code è¯·æ±‚æŠŠå®ƒæ‹‰è¿›æ¥ï¼ˆä¸»è¦ç»™è‡ªé€‰ç»Ÿè®¡/åˆ—è¡¨å…œåº•ç”¨ï¼‰
  private async ensureQuoteCachedForCode(code: string): Promise<void> {
    const code6: string = code.trim()
    if (code6.length !== 6) return

    // è¿™é‡Œåªçœ‹ stock-${code} è¿™ä¸€æ¡ç¼“å­˜ï¼šé¿å…â€œæŒ‡æ•°/è‚¡ç¥¨åŒç â€æ—¶ï¼Œè¢« index ç¼“å­˜è¯¯åˆ¤æˆå·²ç»æœ‰æ•°æ®
    const cacheKey: string = `stock-${code6}`
    const existed: Quote | undefined = this.quoteCache.get(cacheKey)
    if (existed !== undefined) return

    const httpRequest = http.createHttp()
    try {
      // è¡¥æ‹‰å•ä¸ªè‚¡ç¥¨è¡Œæƒ…ï¼šåªè¦æˆåŠŸå†™å…¥ cacheï¼Œåç»­ç»Ÿè®¡/åˆ—è¡¨å°±èƒ½ç”¨ç¼“å­˜å€¼ç®—å‡ºæ¥
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=stock&code=${code6}`
      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      this.dbg(`ensureQuoteCachedForCode:request ${code6}`)
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const q: Quote = this.mapBackendQuote(backendItem, 'stock')

        // mergeQuotesToCache å†…éƒ¨ä¼šæ›´æ–° quoteCache + quoteCacheVerï¼Œ
        // quoteCacheVer å˜åŒ–ä¼šè®©ä¾èµ–ç¼“å­˜çš„ UIï¼ˆæ¯”å¦‚ç»Ÿè®¡å¡ï¼‰åˆ·æ–°
        this.mergeQuotesToCache([q])
        this.dbg(`ensureQuoteCachedForCode:cached ${code6}`)
      }
    } catch (e) {
      // è¿™é‡Œæ˜¯â€œå…œåº•è¡¥æ‹‰â€ï¼Œå¤±è´¥å°±ç®—äº†ï¼Œä¸è¦å½±å“ä¸»æµç¨‹ï¼ˆUI ä»ç„¶å¯ä»¥æ˜¾ç¤º '--'ï¼‰
    } finally {
      httpRequest.destroy()
    }
  }

  // æŒ‰ typeï¼ˆindex/stockï¼‰å…œåº•è¡¥æ‹‰å•ä¸ªæ ‡çš„è¡Œæƒ…ï¼šå¦‚æœ quoteCache é‡Œè¿˜æ²¡æœ‰ï¼Œå°±è°ƒç”¨ by_code æ¥å£æ‹‰ä¸€æ¬¡å¹¶å†™å…¥ç¼“å­˜
  private async ensureQuoteCachedByType(type: QuoteType, code6: string): Promise<void> {
    const code: string = code6.trim()
    if (code.length !== 6) return

    // ç¼“å­˜ key ç»Ÿä¸€ç”¨ `${type}-${code}`ï¼šåŒä¸€ä»£ç åœ¨æŒ‡æ•°/è‚¡ç¥¨ä¸‹ä¹Ÿèƒ½å…±å­˜ï¼Œä¸ä¼šäº’ç›¸è¦†ç›–
    const cacheKey: string = `${type}-${code}`
    const existed: Quote | undefined = this.quoteCache.get(cacheKey)
    if (existed !== undefined) return

    const httpRequest = http.createHttp()
    try {
      // åªè¡¥æ‹‰è¿™ä¸€æ¡ï¼šç”¨äºâ€œåˆ—è¡¨/ç»Ÿè®¡/å¡ç‰‡â€åœ¨ç¼ºè¡Œæƒ…æ—¶çš„å…œåº•ï¼Œä¸å½±å“ä¸» fetchQuotes æµç¨‹
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=${type}&code=${code}`
      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote

        // åç«¯å­—æ®µæ˜ å°„ + å¡«ä¸Š typeï¼Œä¿æŒ Quote ç»“æ„ä¸€è‡´ï¼ˆæŒ‡æ•°/è‚¡ç¥¨ä¸€å¥—é€»è¾‘ï¼‰
        const q: Quote = this.mapBackendQuote(backendItem, type)

        // å†™å…¥ quoteCacheï¼›mergeQuotesToCache é€šå¸¸ä¼šé¡ºå¸¦ bump quoteCacheVerï¼Œè§¦å‘ä¾èµ–ç¼“å­˜çš„ UI åˆ·æ–°
        this.mergeQuotesToCache([q])
      }
    } catch (e) {
      // å…œåº•è¡¥æ‹‰å¤±è´¥å°±å¿½ç•¥ï¼šæœ€å¤šè®© UI æ˜¾ç¤º '--'ï¼Œä¸è¦æŠŠé”™è¯¯æ‰©æ•£åˆ°é¡µé¢ä¸»æµç¨‹
    } finally {
      httpRequest.destroy()
    }
  }

  // æŒ‰ typeï¼ˆindex/stockï¼‰+ code ä» quoteCache é‡Œå–ä¸€æ¡è¡Œæƒ…ï¼›å–ä¸åˆ°å°±è¿”å› null
  private findQuoteInCacheByType(type: QuoteType, code6: string): Quote | null {
    const code: string = code6.trim()
    if (code.length !== 6) return null

    // ç¼“å­˜ key è§„åˆ™ï¼š`${type}-${code}`ï¼Œç¡®ä¿æŒ‡æ•°å’Œè‚¡ç¥¨åŒç ä¹Ÿä¸ä¼šäº’ç›¸é¡¶æ‰
    const k: string = `${type}-${code}`

    // Map.get å–ä¸åˆ°ä¼šæ˜¯ undefinedï¼Œè¿™é‡Œç»Ÿä¸€è½¬æˆ nullï¼Œå¤–é¢å†™åˆ¤æ–­æ›´é¡ºæ‰‹
    const v: Quote | undefined = this.quoteCache.get(k)
    return (v !== undefined) ? v : null
  }

  // é¢„çƒ­å½“å‰åˆ†ç»„é‡Œæ‰€æœ‰è‚¡ç¥¨çš„è¡Œæƒ…åˆ°ç¼“å­˜ï¼ˆquoteCacheï¼‰ï¼Œè®©è‡ªé€‰åˆ—è¡¨/ç»Ÿè®¡å¡èƒ½å°½å¿«æ‹¿åˆ°æœ€æ–°æ•°æ®
  private async preloadActiveGroupQuotes(): Promise<void> {
    const g: StockGroup | null = this.getActiveGroup()
    if (g === null) {
      // æ²¡æœ‰é€‰ä¸­åˆ†ç»„ï¼ˆæˆ–åˆ†ç»„ä¸å­˜åœ¨ï¼‰å°±ä¸ç”¨åšä»»ä½•äº‹
      return
    }

    // æ¯åªè‚¡ç¥¨å¯¹åº”ä¸€ä¸ªâ€œç¡®ä¿ç¼“å­˜å­˜åœ¨â€çš„è¯·æ±‚ä»»åŠ¡
    const tasks: Promise<void>[] = []
    for (let i: number = 0; i < g.stocks.length; i++) {
      const code: string = g.stocks[i].code
      tasks.push(this.ensureQuoteCachedForCode(code))
    }

    // å¹¶è¡Œé¢„çƒ­ï¼šæŸä¸€åªå¤±è´¥ä¹Ÿä¸å½±å“å…¶å®ƒï¼ˆé¿å…å› ä¸ºå•ä¸ªæ¥å£å¼‚å¸¸å¯¼è‡´æ•´ç»„å¡ä½ï¼‰
    await Promise.all(tasks.map((p: Promise<void>) => p.catch(() => { })))
  }

  // æŠŠæœ€æ–°æ‹‰åˆ°çš„è¡Œæƒ…åˆå¹¶è¿›æœ¬åœ° quoteCacheï¼ˆkey = `${type}-${code}`ï¼‰ï¼ŒåŒæ—¶è§¦å‘ç»Ÿè®¡åˆ·æ–°
  private mergeQuotesToCache(list: Quote[]): void {
    console.info(`[DBG] mergeQuotesToCache: in list=${list.length} oldCache=${this.quoteCache.size}`);

    // ç”¨â€œæ–° Mapâ€æ‹·è´ä¸€ä»½æ—§ç¼“å­˜ï¼šé¿å…ç›´æ¥åœ¨åŸ Map ä¸Šæ”¹å¯¼è‡´çŠ¶æ€å˜æ›´ä¸æ˜æ˜¾ï¼ˆä¹Ÿæ–¹ä¾¿ç»Ÿä¸€æ›¿æ¢ï¼‰
    const newMap: Map<string, Quote> = new Map<string, Quote>();
    this.quoteCache.forEach((v: Quote, k: string) => {
      newMap.set(k, v);
    });

    // æŠŠè¿™æ¬¡è¯·æ±‚å›æ¥çš„è¡Œæƒ…é€æ¡å†™å…¥ç¼“å­˜ï¼šåŒ key ä¼šè¦†ç›–æ—§å€¼ï¼ˆç›¸å½“äºæ›´æ–°ï¼‰
    for (let i: number = 0; i < list.length; i++) {
      const q: Quote = list[i];
      const key: string = `${q.type}-${q.code}`; // stock-300750 / index-000001 è¿™ç§ï¼Œé¿å…åŒç å†²çª
      newMap.set(key, q);
    }

    // ä¸€æ¬¡æ€§æ›¿æ¢ç¼“å­˜å¼•ç”¨ï¼Œé…åˆç‰ˆæœ¬å·è®©ä¾èµ–æ–¹ï¼ˆç»Ÿè®¡/åˆ—è¡¨ï¼‰çŸ¥é“â€œç¼“å­˜æ›´æ–°è¿‡äº†â€
    this.quoteCache = newMap;
    this.quoteCacheVer += 1;

    // è¡Œæƒ…ä¸€å˜ï¼Œè‡ªé€‰åˆ†ç»„çš„æ¶¨è·Œç»Ÿè®¡ï¼ˆup/down/avgï¼‰ä¹Ÿè¦è·Ÿç€ç«‹åˆ»åˆ·æ–°
    this.refreshActiveGroupStats();

    console.info(`[DBG] mergeQuotesToCache: out newCache=${this.quoteCache.size}`);
  }

  // å–å½“å‰â€œé€‰ä¸­çš„åˆ†ç»„â€ï¼ˆactiveGroupId å¯¹åº”çš„é‚£ä¸€ä¸ªï¼‰ï¼›å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­åˆ†ç»„æˆ–æ‰¾ä¸åˆ°ï¼Œå°±è¿”å› null
  private getActiveGroupOrNull(): StockGroup | null {
    // activeGroupId < 0 è¡¨ç¤ºå½“å‰æ²¡é€‰ä¸­ä»»ä½•åˆ†ç»„ï¼ˆæ¯”å¦‚åˆšå¯åŠ¨è¿˜æ²¡åˆå§‹åŒ–å®Œï¼Œæˆ–å·²ç»åˆ å…‰äº†ï¼‰
    if (this.activeGroupId < 0) return null

    // åœ¨ groups æ•°ç»„é‡Œæ‰¾ activeGroupId å¯¹åº”çš„ä¸‹æ ‡
    const idx: number = this.findGroupIndex(this.activeGroupId)

    // æ²¡æ‰¾åˆ°è¯´æ˜æ•°æ®ä¸åŒæ­¥/åˆ†ç»„è¢«åˆ äº†ï¼Œå…œåº•è¿”å› null
    if (idx < 0) return null

    // æ‰¾åˆ°å°±ç›´æ¥è¿”å›è¿™ä¸ªåˆ†ç»„å¯¹è±¡
    return this.groups[idx]
  }

  // é¡¶éƒ¨/ç»Ÿè®¡åŒºç”¨çš„ï¼šæ‹¿åˆ°å½“å‰é€‰ä¸­åˆ†ç»„çš„åç§°ï¼Œæ²¡é€‰ä¸­å°±è¿”å›ç©ºå­—ç¬¦ä¸²
  private getActiveGroupNameText(): string {
    // å…ˆå°è¯•å–å½“å‰ active åˆ†ç»„å¯¹è±¡ï¼ˆå¯èƒ½ä¸º nullï¼‰
    const g: StockGroup | null = this.getActiveGroupOrNull()

    // æœ‰åˆ†ç»„å°±æ˜¾ç¤ºå®ƒçš„ nameï¼›æ²¡æœ‰å°±æ˜¾ç¤ºç©ºï¼ˆUI ä¸€èˆ¬ä¼šè‡ªç„¶ä¸å±•ç¤ºï¼‰
    return g ? g.name : ''
  }

  // è¿”å›å½“å‰é€‰ä¸­åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆç”¨äºæ¸²æŸ“â€œè‡ªé€‰åˆ—è¡¨â€ç­‰ UIï¼‰ï¼›å¦‚æœå½“å‰æ²¡æœ‰æœ‰æ•ˆåˆ†ç»„å°±è¿”å›ç©ºæ•°ç»„
  private getActiveGroupStocksList(): StockRef[] {
    // å…ˆæ‹¿åˆ°å½“å‰ activeGroupId å¯¹åº”çš„åˆ†ç»„å¯¹è±¡ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
    const g: StockGroup | null = this.getActiveGroupOrNull()

    // æœ‰åˆ†ç»„å°±è¿”å›å®ƒçš„ stocksï¼›æ²¡æœ‰å°±è¿”å›ç©ºæ•°ç»„ï¼Œé¿å… UI/è°ƒç”¨æ–¹å†åšç©ºåˆ¤æ–­
    return g ? g.stocks : []
  }

  // æ ¹æ®â€œå½“å‰åˆ†ç»„é‡Œçš„è‚¡ç¥¨åˆ—è¡¨ + å·²ç¼“å­˜çš„è¡Œæƒ…æ•°æ®â€ï¼Œè®¡ç®—åˆ†ç»„ç»Ÿè®¡å¡è¦æ˜¾ç¤ºçš„å‡ ä¸ªæ•°å­—ï¼ˆæ€»æ•°/æ¶¨/è·Œ/å¹³å‡æ¶¨è·Œå¹…ï¼‰
  private computeStatsFromStocks(list: StockRef[]): ActiveGroupStats {
    // åˆ†ç»„é‡Œä¸€å…±å¤šå°‘åªè‚¡ç¥¨ï¼šè¿™ä¸ªä¸ä¾èµ–è¡Œæƒ…ç¼“å­˜ï¼Œç›´æ¥ç”¨åˆ—è¡¨é•¿åº¦å°±è¡Œ
    const stockCount: number = list.length

    // up/downï¼šç»Ÿè®¡ä»Šå¤©æ¶¨/è·Œçš„æ•°é‡ï¼ˆåªç»Ÿè®¡æ‹¿å¾—åˆ°è¡Œæƒ…çš„é‚£éƒ¨åˆ†ï¼‰
    let up: number = 0
    let down: number = 0

    // å¹³å‡æ¶¨è·Œå¹…ï¼šç´¯åŠ  percentï¼Œæœ€åé™¤ä»¥æœ‰æ•ˆæ•°é‡
    let sumPct: number = 0
    let cntPct: number = 0

    for (let i: number = 0; i < list.length; i++) {
      const code: string = list[i].code

      // ä»ç¼“å­˜é‡Œæ‰¾è¿™åªè‚¡ç¥¨çš„è¡Œæƒ…ï¼ˆè¿™é‡Œåªç®—è‚¡ç¥¨ï¼Œæ‰€ä»¥ç”¨ findStockQuoteInCacheï¼Œé¿å… index åŒç å¹²æ‰°ï¼‰
      // å¦‚æœè¿™åªè‚¡ç¥¨è¿˜æ²¡æ‹‰åˆ°è¡Œæƒ…ï¼ˆç¼“å­˜é‡Œæ²¡æœ‰ï¼‰ï¼Œå°±å…ˆè·³è¿‡ï¼Œä¸æŠŠå®ƒç®—è¿›å¹³å‡å€¼
      const q: Quote | null = this.findStockQuoteInCache(code)

      if (q !== null) {
        // change >= 0 å½“ä½œâ€œä¸Šæ¶¨/ä¸è·Œâ€ï¼ˆåŒ…å« 0 çš„æƒ…å†µï¼‰
        if (q.change >= 0) {
          up += 1
        } else {
          down += 1
        }

        // åªè¦æœ‰è¡Œæƒ…ï¼Œå°±æŠŠæ¶¨è·Œå¹…çº³å…¥å¹³å‡å€¼çš„ç»Ÿè®¡
        sumPct += q.changePercent
        cntPct += 1
      }
    }

    // å¦‚æœä¸€åªè¡Œæƒ…éƒ½æ²¡æ‹¿åˆ°ï¼Œå°±æ˜¾ç¤º â€œ--â€ï¼Œé¿å…å‡ºç° NaN%
    const avgPct: string = (cntPct > 0) ? ((sumPct / cntPct).toFixed(2) + '%') : '--'

    // ç»Ÿè®¡å¡é‚£è¾¹ç”¨çš„æ˜¯ stringï¼Œæ‰€ä»¥è¿™é‡Œç»Ÿä¸€è½¬æˆå­—ç¬¦ä¸²è¿”å›
    return {
      stockCount: stockCount.toString(),
      up: up.toString(),
      down: down.toString(),
      avgPct: avgPct
    }
  }

  // åªä»ç¼“å­˜é‡Œæ‰¾â€œè‚¡ç¥¨â€è¡Œæƒ…ï¼šç»™è‡ªé€‰åˆ†ç»„ç”¨ï¼Œé¿å… index/stock ä»£ç ç›¸åŒï¼ˆæ¯”å¦‚ 000001ï¼‰æ—¶æ‹¿é”™æ•°æ®
  private findStockQuoteInCache(code: string): Quote | null {
    // å…ˆåšä¸€æ¬¡æœ€åŸºæœ¬çš„æ¸…æ´—ï¼Œé¿å…ç”¨æˆ·è¾“å…¥/å­˜å‚¨é‡Œå¸¦ç©ºæ ¼
    const code6: string = code.trim()
    if (code6.length !== 6) return null  // ä¸æ˜¯ 6 ä½ä»£ç å°±ç›´æ¥å½“æ— æ•ˆ

    // ç¼“å­˜çš„ key ç»Ÿä¸€ç”¨ `${type}-${code}`ï¼Œè¿™é‡Œå›ºå®šæŸ¥ stock
    const kStock: string = `stock-${code6}`

    // Map.get å–ä¸åˆ°ä¼šè¿”å› undefinedï¼Œè¿™é‡Œæ˜¾å¼å¤„ç†æˆ nullï¼Œå¤–å±‚åˆ¤æ–­æ›´ç›´è§‚
    const v: Quote | undefined = this.quoteCache.get(kStock)
    return (v !== undefined) ? v : null
  }

  private logSeq: number = 0;

  // ç»Ÿä¸€çš„è°ƒè¯•æ—¥å¿—ï¼šæŠŠå½“å‰é¡µé¢å…³é”®çŠ¶æ€æ‰“ä¸€è¡Œå‡ºæ¥ï¼Œæ–¹ä¾¿ä½ è¿½â€œåˆ†ç»„ / ç¼“å­˜ / UI åˆ‡æ¢â€åˆ°åº•å“ªé‡Œæ²¡åŒæ­¥
  private dbg(tag: string): void {
    // ç»™æ¯æ¡æ—¥å¿—ä¸€ä¸ªé€’å¢åºå·ï¼Œæ’æŸ¥å¼‚æ­¥æµç¨‹æ—¶æ›´å®¹æ˜“æŒ‰é¡ºåºå¯¹é½
    this.logSeq += 1;

    // å½“å‰é€‰ä¸­çš„åˆ†ç»„ idï¼ˆ-1 è¡¨ç¤ºè¿˜æ²¡é€‰ä¸­/æ²¡æœ‰åˆ†ç»„ï¼‰
    const gid: number = this.activeGroupId;

    // activeGroupId åœ¨ groups é‡Œçš„ä¸‹æ ‡ï¼›æ‰¾ä¸åˆ°å°±ä¼šæ˜¯ -1
    const idx: number = this.findGroupIndex(gid);

    // é»˜è®¤å…ˆç»™â€œæ— æ•ˆå€¼â€ï¼Œé¿å… idx=-1 æ—¶è®¿é—®æ•°ç»„è¶Šç•Œ
    let activeCount: number = -1;
    let activeName: string = '';

    // åªæœ‰ idx åˆæ³•æ—¶æ‰è¯»å–åˆ†ç»„ä¿¡æ¯ï¼ˆåˆ†ç»„åã€åˆ†ç»„é‡Œè‚¡ç¥¨æ•°é‡ï¼‰
    if (idx >= 0) {
      activeCount = this.groups[idx].stocks.length;
      activeName = this.groups[idx].name;
    }

    // ä¸€æ¡æ—¥å¿—å°½é‡æŠŠä½ æ’æŸ¥æ—¶æœ€å¸¸çœ‹çš„çŠ¶æ€éƒ½å¸¦ä¸Šï¼š
    // - å½“å‰åœ¨å“ªä¸ª Tab / è¡Œæƒ…æ¨¡å¼ï¼ˆæŒ‡æ•° or è‚¡ç¥¨ï¼‰
    // - å½“å‰ activeGroupId æ˜¯å¦æœ‰æ•ˆã€å¯¹åº”çš„åˆ†ç»„åã€åˆ†ç»„é‡Œæœ‰å¤šå°‘åª
    // - groups æ€»æ•°ã€ç¼“å­˜æ¡ç›®æ•°ã€activeStocks æ•°é‡ã€ç¼“å­˜ç‰ˆæœ¬å·ï¼ˆç”¨æ¥ç¡®è®¤ UI æ˜¯å¦åº”è¯¥åˆ·æ–°ï¼‰
    console.info(
      `[DBG#${this.logSeq}] ${tag} | tab=${this.currentTabIndex} mode=${this.currentMode}` +
        ` | activeGroupId=${gid} activeIdx=${idx} activeName=${activeName} activeStocks=${activeCount}` +
        ` | groups=${this.groups.length} cache=${this.quoteCache.size}` +
        ` | activeStocks=${this.activeStocks.length} cache=${this.quoteCache.size} cacheVer=${this.quoteCacheVer}`
    );
  }

  // åŒæ­¥â€œå½“å‰é€‰ä¸­åˆ†ç»„â€çš„è‚¡ç¥¨åˆ—è¡¨åˆ° activeStocksï¼ˆUI åˆ—è¡¨ã€ç»Ÿè®¡å¡éƒ½èµ°è¿™æ¡é“¾è·¯ï¼‰
  private syncActiveStocks(): void {
    // å…ˆæ‹¿åˆ°å½“å‰ activeGroupId å¯¹åº”çš„åˆ†ç»„ï¼›æ‹¿ä¸åˆ°å°±å½“ä½œæ²¡æœ‰é€‰ä¸­åˆ†ç»„
    const g: StockGroup | null = this.getActiveGroupOrNull()

    if (g === null) {
      // æ²¡æœ‰æœ‰æ•ˆåˆ†ç»„ï¼šè‡ªé€‰åˆ—è¡¨æ¸…ç©º
      this.activeStocks = []
    } else {
      // è¿™é‡Œç”¨ slice() æ˜¯ä¸ºäº†æ‹¿åˆ°ä¸€ä¸ªâ€œæ–°çš„æ•°ç»„å¼•ç”¨â€
      // ArkUI çš„çŠ¶æ€æ›´æ–°æ›´ä¾èµ–å¼•ç”¨å˜åŒ–ï¼šç›´æ¥ç”¨ g.stocks å¯èƒ½å¯¼è‡´ UI è®¤ä¸ºâ€œè¿˜æ˜¯åŒä¸€ä¸ªæ•°ç»„â€è€Œä¸åˆ·æ–°
      this.activeStocks = g.stocks.slice()
    }

    // ç”¨ä¸€ä¸ªç‰ˆæœ¬å·é…åˆ key/ä¾èµ–ï¼Œå¼ºåˆ¶ç›¸å…³ List æˆ–ç»Ÿè®¡åŒºåŸŸåœ¨éœ€è¦æ—¶é‡æ–°æ¸²æŸ“
    this.activeStocksVer += 1

    // activeStocks å˜äº†ï¼Œé¡ºæ‰‹æŠŠç»Ÿè®¡ï¼ˆæ•°é‡ / æ¶¨è·Œæ•° / å¹³å‡æ¶¨å¹…ï¼‰ä¹Ÿåˆ·æ–°ä¸€ä¸‹
    this.refreshActiveGroupStats()
  }

  // è¿”å›æŸä¸ªåˆ†ç»„çš„â€œå¹³å‡æ¶¨è·Œå¹…â€å±•ç¤ºæ–‡æœ¬ï¼ˆç”¨äºåˆ†ç»„åˆ—è¡¨é‡Œçš„é‚£ä¸€è¡Œæ•°æ®ï¼‰
  private getGroupAvgPctText(groupId: number): string {
    // è¿™é‡Œæ•…æ„è¯»ä¸€ä¸‹ quoteCacheVerï¼Œè®© ArkUI çŸ¥é“è¿™ä¸ªè¿”å›å€¼ä¾èµ–è¡Œæƒ…ç¼“å­˜ã€‚
    // è¡Œæƒ…ä¸€æ›´æ–°ï¼ˆmergeQuotesToCache é‡Œ quoteCacheVer++ï¼‰ï¼Œåˆ†ç»„è¡Œé‡Œçš„å¹³å‡æ¶¨å¹…å°±ä¼šè·Ÿç€é‡ç®—/é‡ç»˜ã€‚
    const _qv: number = this.quoteCacheVer

    // å…ˆæ‰¾åˆ°åˆ†ç»„åœ¨ groups æ•°ç»„é‡Œçš„ä½ç½®ï¼›æ‰¾ä¸åˆ°å°±ç»™ä¸€ä¸ªå ä½æ–‡æœ¬
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '--'

    // ç»Ÿè®¡æ˜¯â€œç°ç®—ç°ç”¨â€ï¼šç”¨è¯¥åˆ†ç»„çš„ stocks åˆ—è¡¨å»ç¼“å­˜é‡Œæ‰¾æœ€æ–° quoteï¼Œå†ç®—å¹³å‡æ¶¨è·Œå¹…
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    return st.avgPct
  }

  // è®¡ç®—æŸä¸ªåˆ†ç»„â€œå¹³å‡æ¶¨è·Œå¹…â€å¯¹åº”çš„å±•ç¤ºé¢œè‰²ï¼šæ¶¨ç”¨çº¢è‰²ã€è·Œç”¨ç»¿è‰²ã€æ²¡æ•°æ®ç”¨ç°è‰²
  private getGroupAvgPctColor(groupId: number): string {
    // è¯»ä¸€ä¸‹ç¼“å­˜ç‰ˆæœ¬å·ï¼Œè®© ArkUI çŸ¥é“ï¼šè¡Œæƒ…ç¼“å­˜å˜äº†ï¼Œè¿™ä¸ªé¢œè‰²ä¹Ÿè¦è·Ÿç€é‡æ–°ç®—/åˆ·æ–°
    const _qv: number = this.quoteCacheVer

    // æ ¹æ® groupId æ‰¾åˆ°åˆ†ç»„ä¸‹æ ‡ï¼›æ‰¾ä¸åˆ°å°±ç»™ä¸€ä¸ªé»˜è®¤ç°è‰²
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '#777777'

    // å¤ç”¨ç°æˆçš„ç»Ÿè®¡é€»è¾‘ï¼Œæ‹¿åˆ°è¯¥åˆ†ç»„çš„ avgPctï¼ˆå½¢å¦‚ "1.23%" æˆ– "--"ï¼‰
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    const avg: string = st.avgPct

    // æ²¡æœ‰å¯ç”¨è¡Œæƒ…æ—¶ avgPct ä¼šæ˜¯ "--"ï¼Œè¿™æ—¶å€™ç”¨ç°è‰²
    if (avg === '--') {
      return '#777777'
    }

    // avgPct æ˜¯å­—ç¬¦ä¸²å¸¦ "%"ï¼Œè¿™é‡Œå»æ‰ç™¾åˆ†å·åè½¬æˆæ•°å­—ï¼Œæ–¹ä¾¿åˆ¤æ–­æ­£è´Ÿ
    const v: number = Number(avg.replace('%', ''))
    if (Number.isNaN(v)) {
      return '#777777'
    }

    // v >= 0 è®¤ä¸ºæ˜¯ä¸Šæ¶¨ï¼ˆçº¢ï¼‰ï¼Œv < 0 è®¤ä¸ºæ˜¯ä¸‹è·Œï¼ˆç»¿ï¼‰
    return v >= 0 ? '#FF4D4F' : '#39D98A'
  }


  // æŠŠä¸€æ¡è¡Œæƒ… Quote æ•´ç†æˆâ€œæ¡Œé¢å¡ç‰‡â€éœ€è¦çš„ç»‘å®šæ•°æ®ï¼ˆä¸»è¦æ˜¯æŠŠæ•°å€¼è½¬æˆå¯ç›´æ¥å±•ç¤ºçš„å­—ç¬¦ä¸²ï¼‰
  private buildWidgetDataFromQuote(q: Quote): WidgetBindData {
    // æ¡Œé¢å¡ç‰‡ä¸Šé€šå¸¸ä¼šæ˜¾ç¤ºâ€œæ›´æ–°æ—¶é—´â€ï¼Œè¿™é‡Œç”¨æœ¬åœ°æ—¶é—´æ‹¼ä¸€ä¸ª HH:mm
    const now: Date = new Date()
    const hh: string = now.getHours().toString().padStart(2, '0')
    const mm: string = now.getMinutes().toString().padStart(2, '0')

    return {
      // å½“å‰è¿™å¼ å¡ç‰‡çš„å®ä¾‹ idï¼ˆä» AppStorageV2 æ¶ˆè´¹è¿‡æ¥ï¼‰ï¼Œåé¢æ›´æ–°å¡ç‰‡æ—¶è¦é å®ƒå®šä½åˆ°å“ªå¼ å¡
      formId: this.activeFormId,

      // å¡ç‰‡æ ‡é¢˜ï¼šæŒ‡æ•° / è‚¡ç¥¨ï¼ˆç»™ç”¨æˆ·ä¸€çœ¼åˆ†æ¸…æ¥šå½“å‰ç»‘å®šçš„æ˜¯å“ªç§æ ‡çš„ï¼‰
      title: (q.type === 'index') ? 'æŒ‡æ•°' : 'è‚¡ç¥¨',

      // æ ‡çš„åŸºæœ¬ä¿¡æ¯ï¼šä»£ç ã€åç§°
      code: q.code,
      name: q.name,

      // ä»·æ ¼/æ¶¨è·Œ/æ¶¨è·Œå¹…éƒ½è½¬æˆâ€œç›´æ¥å¯æ˜¾ç¤ºâ€çš„æ–‡æœ¬ï¼Œé¿å…å¡ç‰‡ä¾§å†åšæ ¼å¼åŒ–
      priceText: q.price.toFixed(2),
      changeText: q.change.toFixed(2),
      pctText: q.changePercent.toFixed(2) + '%',

      // æ›´æ–°æ—¶é—´ï¼ˆåªåšåˆ°åˆ†é’Ÿçº§åˆ«ï¼Œè¶³å¤Ÿè®©äººåˆ¤æ–­æ˜¯ä¸æ˜¯åˆšåˆ·æ–°ï¼‰
      tsText: `${hh}:${mm}`,

      // è¿™ä¸¤ä¸ªå¼€å…³ä¸€èˆ¬ç”¨äºå¡ç‰‡ä¸Šçš„â€œä¸Šä¸€åª/ä¸‹ä¸€åªâ€æŒ‰é’®æ˜¯å¦å¯ç‚¹ï¼ˆä½ è¿™é‡Œå…ˆå›ºå®šä¸º trueï¼‰
      hasPrev: true,
      hasNext: true
    }
  }

  // å¦‚æœè¿™æ¬¡æ˜¯ä»æ¡Œé¢å¡ç‰‡ç‚¹è¿›æ¥çš„ï¼ˆactiveFormId æœ‰å€¼ï¼‰ï¼Œå°±æŠŠâ€œå½“å‰é€‰ä¸­çš„æ ‡çš„â€å›å†™åˆ°é‚£å¼ å¡ç‰‡ä¸Š
  private async updateWidgetIfLaunchedFromForm(q: Quote): Promise<void> {
    // formId å¯èƒ½å¸¦ç©ºæ ¼ï¼Œå…ˆ trim ä¸€ä¸‹ï¼Œé¿å…æ›´æ–°å¤±è´¥è¿˜ä¸å¥½æ’æŸ¥
    const fid: string = this.activeFormId.trim()

    hilog.error(DOMAIN, TAG, '[WIDGET] ENTER updateWidget fid=%{public}s code=%{public}s', fid, q.code)

    // æ²¡æœ‰ formId è¯´æ˜ä¸æ˜¯ä»å¡ç‰‡å¯åŠ¨çš„ï¼Œæˆ–è€… formId è¿˜æ²¡æ¶ˆè´¹åˆ°ï¼Œç›´æ¥è·³è¿‡
    if (fid.length === 0) {
      hilog.error(DOMAIN, TAG, '[WIDGET] SKIP activeFormId empty')
      return
    }

    try {
      // æŠŠå½“å‰ Quote è½¬æˆå¡ç‰‡ä¾§èƒ½ç›´æ¥å±•ç¤ºçš„ç»‘å®šæ•°æ®ï¼ˆå­—ç¬¦ä¸²åŒ–ã€å¸¦æ—¶é—´æˆ³ç­‰ï¼‰
      const data: WidgetBindData = this.buildWidgetDataFromQuote(q)

      // FormKit éœ€è¦çš„æ˜¯ FormBindingDataï¼Œè¿™é‡ŒæŠŠæ™®é€šå¯¹è±¡åŒ…è£…ä¸€ä¸‹
      const binding: formBindingData.FormBindingData = formBindingData.createFormBindingData(data)

      // æ›´æ–°æ¡Œé¢ä¸Šé‚£å¼  formId å¯¹åº”çš„å¡ç‰‡å†…å®¹
      await formProvider.updateForm(fid, binding)

      hilog.error(DOMAIN, TAG, '[WIDGET] OK updateForm formId=%{public}s code=%{public}s', fid, q.code)
    } catch (e) {
      // æ›´æ–°å¤±è´¥é€šå¸¸æ˜¯ formId ä¸å¯¹ã€å¡ç‰‡å·²è¢«ç§»é™¤ã€æˆ–æ•°æ®ç»“æ„ä¸åŒ¹é…ï¼Œè¿™é‡Œæ‰“å‡ºæ¥æ–¹ä¾¿å®šä½
      hilog.error(
        DOMAIN,
        TAG,
        '[WIDGET] FAIL updateForm formId=%{public}s err=%{public}s',
        fid,
        JSON.stringify(e)
      )
    }
  }

  // ä» AppStorageV2 é‡Œâ€œæ‹¿ä¸€æ¬¡â€æ¡Œé¢å¡ç‰‡ä¼ æ¥çš„ formIdï¼šåŒæ­¥åˆ°é¡µé¢å­—æ®µåç«‹åˆ»æ¸…ç©ºï¼Œé¿å…é‡å¤è§¦å‘
  private consumeFormIdFromAppStorageV2(from: string): void {
    const st: ActiveFormState | undefined =
      AppStorageV2.connect(ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM, () => new ActiveFormState())

    // è¿æ¥å¤±è´¥å°±ç›´æ¥è¿”å›ï¼ˆåç»­ä¹Ÿæ²¡æ³•åŒæ­¥æ¡Œé¢å¡ç‰‡ï¼‰
    if (!st) {
      hilog.error(DOMAIN, TAG, '[%{public}s] AppStorageV2.connect failed', from)
      return
    }

    const fid: string = st.formId
    if (fid.length === 0) {
      // ä¸æ˜¯ä»å¡ç‰‡è¿›æ¥çš„ / å·²ç»è¢«æ¶ˆè´¹è¿‡
      hilog.info(DOMAIN, TAG, '[%{public}s] no formId in ActiveFormState', from)
      return
    }

    // è®°åˆ°é¡µé¢ä¸Šï¼Œåé¢ updateForm è¦ç”¨
    this.activeFormId = fid

    // ç”¨å®Œå°±æ¸…æ‰ï¼Œé¿å… onPageShow / onResume å¤šæ¬¡è¿›æ¥é‡å¤æ¶ˆè´¹
    st.formId = ''

    hilog.info(DOMAIN, TAG, '[%{public}s] consumed formId=%{public}s', from, fid)
  }

  // ç¡®ä¿ç³»ç»Ÿé€šçŸ¥æƒé™/å¼€å…³å·²æ‰“å¼€ï¼šæ²¡å¼€å°±å¼•å¯¼ç”¨æˆ·å»ç³»ç»Ÿç•Œé¢æ‰“å¼€ï¼Œæœ€åè¿”å›æ˜¯å¦å¯ç”¨
  private async ensureNotificationEnabled(): Promise<boolean> {
    try {
      // å…ˆæŸ¥ä¸€æ¬¡å½“å‰åº”ç”¨çš„é€šçŸ¥å¼€å…³çŠ¶æ€ï¼ˆç³»ç»Ÿå±‚é¢çš„æ€»å¼€å…³/æƒé™ï¼‰
      const enabled: boolean = await notificationManager.isNotificationEnabled()
      if (enabled) {
        return true
      }

      // æ²¡å¼€çš„è¯ï¼Œæ‹‰èµ·ç³»ç»Ÿçš„é€šçŸ¥å¼€å…³/æˆæƒé¡µé¢ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ‰“å¼€
      await notificationManager.requestEnableNotification()

      // ç”¨æˆ·ä»ç³»ç»Ÿé¡µé¢è¿”å›åï¼Œå†æŸ¥ä¸€æ¬¡ï¼Œç¡®è®¤æœ€ç»ˆç»“æœ
      const enabled2: boolean = await notificationManager.isNotificationEnabled()
      return enabled2
    } catch (e) {
      // è¿™é‡Œä¸å¼ºè¡ŒæŠ›é”™ï¼šé€šçŸ¥ä¸å¯ç”¨å°±æŒ‰ä¸å¯ç”¨å¤„ç†ï¼Œé¿å…å½±å“ä¸»æµç¨‹
      return false
    }
  }

  // ä»æœ¬åœ°åå¥½ï¼ˆPreferencesï¼‰é‡ŒæŠŠâ€œé€šçŸ¥è§„åˆ™åˆ—è¡¨â€è¯»å‡ºæ¥ï¼Œæ¢å¤åˆ° notifyRulesï¼›é¡ºä¾¿æŠŠ nextRuleId æ ¡å‡†åˆ°ä¸ä¼šæ’å·
  private async loadNotifyRulesFromPrefs(): Promise<void> {
    // æ‰“å¼€ï¼ˆæˆ–åˆ›å»ºï¼‰è¿™ä¸ªåº”ç”¨è‡ªå·±çš„åå¥½å­˜å‚¨æ–‡ä»¶ï¼šPREF_FILE æ˜¯æ–‡ä»¶åï¼Œä¸æ˜¯è·¯å¾„
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)

    // ç”¨ PREF_KEY_RULES è¿™æŠŠâ€œé”®â€å–å‡ºä¹‹å‰ä¿å­˜çš„è§„åˆ™ JSON å­—ç¬¦ä¸²ï¼›å–ä¸åˆ°å°±ç»™ç©ºä¸²
    const jsonStr: string = (await pref.get(this.PREF_KEY_RULES, '')) as string

    // ä¸ºç©ºè¯´æ˜ä»¥å‰æ²¡ä¿å­˜è¿‡è§„åˆ™ï¼šä¿æŒå½“å‰ @State notifyRules é»˜è®¤å€¼å³å¯
    // åŒæ—¶æŠŠ nextRuleId æŒ‰å½“å‰è§„åˆ™æœ€å¤§ id é‡æ–°ç®—ä¸€éï¼Œé¿å…åç»­æ–°å¢è§„åˆ™ id å†²çª
    if (jsonStr.trim().length === 0) {
      this.recomputeNextRuleId()
      return
    }

    // æœ‰å†…å®¹åˆ™æŒ‰æˆ‘ä»¬çš„ç»“æ„åšä¸€æ¬¡â€œå®‰å…¨è§£æâ€ï¼ˆå­—æ®µç¼ºå¤±/ç±»å‹ä¸å¯¹ä¼šè¢«è¿‡æ»¤ï¼‰
    const parsed: NotifyRule[] = this.safeParseNotifyRules(jsonStr)

    // è§£æå‡ºæ¥ç¡®å®æœ‰æœ‰æ•ˆè§„åˆ™ï¼Œæ‰è¦†ç›–åˆ°é¡µé¢çŠ¶æ€ï¼›ç„¶ååŒæ ·æ ¡å‡† nextRuleId
    if (parsed.length > 0) {
      this.notifyRules = parsed
      this.recomputeNextRuleId()
    }
  }


  // æŠŠå½“å‰å†…å­˜é‡Œçš„ notifyRules åºåˆ—åŒ–æˆ JSONï¼Œå†™å›åˆ° Preferencesï¼ˆä¸‹æ¬¡å¯åŠ¨/å›åˆ°é¡µé¢è¿˜èƒ½æ¢å¤ï¼‰
  private async saveNotifyRulesToPrefs(): Promise<void> {
    // æ‰“å¼€ï¼ˆæˆ–åˆ›å»ºï¼‰æœ¬åº”ç”¨çš„åå¥½å­˜å‚¨æ–‡ä»¶ï¼ˆPREF_FILE æ˜¯æ–‡ä»¶åæ ‡è¯†ï¼‰
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)

    // notifyRules æ˜¯å¯¹è±¡æ•°ç»„ï¼ŒPreferences åªèƒ½å­˜åŸºç¡€ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œè½¬æˆ JSON å­—ç¬¦ä¸²å†å­˜
    const jsonStr: string = JSON.stringify(this.notifyRules)

    // ç”¨ PREF_KEY_RULES ä½œä¸ºâ€œé”®â€æŠŠè¿™ä¸² JSON ä¿å­˜è¿›å»ï¼ˆåŒä¸€ä¸ªé”®ä¼šè¦†ç›–æ—§å€¼ï¼‰
    await pref.put(this.PREF_KEY_RULES, jsonStr)

    // flush æ‰æ˜¯æŠŠæœ¬æ¬¡ put çš„æ”¹åŠ¨çœŸæ­£è½ç›˜ï¼ˆä¸ flush å¯èƒ½åªåœ¨å†…å­˜é‡Œï¼Œé‡å¯åä¸¢ï¼‰
    await pref.flush()
  }


  // ä» Preferences é‡Œè¯»å‡ºæ¥çš„æ˜¯ä¸€ä¸² JSONï¼Œè¿™é‡Œè´Ÿè´£â€œå°½é‡å®‰å…¨åœ°â€æŠŠå®ƒè¿˜åŸæˆ NotifyRule[]ï¼ˆè€æ•°æ®ç¼ºå­—æ®µä¹Ÿèƒ½å…œä½ï¼‰
  private safeParseNotifyRules(jsonStr: string): NotifyRule[] {
    try {
      // å…ˆæŠŠ JSON è§£ææˆä¸€ä¸ªæ³›å¯¹è±¡ï¼›åé¢ä¼šé€é¡¹åšæ ¡éªŒ/å…œåº•ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç›´æ¥ä¿¡å®ƒçš„ç»“æ„
      const raw: Object = JSON.parse(jsonStr) as Object
      if (!Array.isArray(raw)) return []

      // raw ç¡®è®¤æ˜¯æ•°ç»„åï¼Œå†æŒ‰æ•°ç»„å»å¤„ç†
      const arr: Object[] = raw as Object[]
      const out: NotifyRule[] = []

      for (let i: number = 0; i < arr.length; i++) {
        // æ¯ä¸ªå…ƒç´ ç†è®ºä¸Šéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼š{ id, quoteType, stockCode, ... }
        // ç”¨ Record<string, Object> åªæ˜¯ä¸ºäº†â€œèƒ½ç”¨ key å–å€¼â€ï¼Œå¹¶ä¸ä»£è¡¨å®ƒä¸€å®šåˆæ³•
        const item: Record<string, Object> = arr[i] as Record<string, Object>

        // idï¼šç”¨ Number å¼ºè½¬ï¼›å¦‚æœæ˜¯ '123' è¿™ç§å­—ç¬¦ä¸²ä¹Ÿèƒ½è½¬æˆ 123
        const id: number = Number(item['id'])

        // stockCode / stockName / conditionTextï¼šç»Ÿä¸€è½¬æˆå­—ç¬¦ä¸²å¹¶ trimï¼Œé¿å… null/undefined é€ æˆå´©æºƒ
        const stockCode: string = String(item['stockCode'] ?? '').trim()
        const stockName: string = String(item['stockName'] ?? '').trim()
        const conditionText: string = String(item['conditionText'] ?? '').trim()

        // enabledï¼šBoolean(...) ä¼šæŠŠ 0/1ã€true/falseã€ç©ºå­—ç¬¦ä¸²ç­‰è½¬æˆå¸ƒå°”å€¼
        const enabled: boolean = Boolean(item['enabled'])

        // quoteTypeï¼šæ–°å¢å­—æ®µã€‚è€ç‰ˆæœ¬å­˜çš„æ•°æ®æ²¡æœ‰ quoteTypeï¼Œè¿™é‡Œé»˜è®¤æŒ‰ stock å¤„ç†
        // åŒæ—¶åšä¸€æ¬¡ç™½åå•ï¼šåªæœ‰ 'index' æ‰å½“æˆ indexï¼Œå…¶å®ƒä¸€å¾‹æŒ‰ stockï¼ˆé˜²è„æ•°æ®ï¼‰
        const qtRaw: string = String(item['quoteType'] ?? 'stock').trim()
        const quoteType: QuoteType = (qtRaw === 'index') ? 'index' : 'stock'

        // æœ€åŸºæœ¬çš„åˆæ³•æ€§æ ¡éªŒï¼šid å¿…é¡»èƒ½è½¬æˆæ•°å­—ã€ä»£ç å¿…é¡» 6 ä½ã€åç§°/æ¡ä»¶ä¸èƒ½ä¸ºç©º
        // æ³¨æ„ï¼šè¿™é‡Œä¸æ ¡éªŒ quoteTypeï¼ˆä¸Šé¢å·²ç»åšè¿‡ç™½åå•å…œåº•äº†ï¼‰
        if (!Number.isNaN(id) && stockCode.length === 6 && stockName.length > 0 && conditionText.length > 0) {
          // é€šè¿‡æ ¡éªŒçš„æ‰åŠ å…¥è¾“å‡ºæ•°ç»„ï¼Œé¿å…æŠŠè„æ•°æ®å¸¦åˆ° UI / RuleEngine
          out.push({
            id: id,
            quoteType: quoteType,
            stockCode: stockCode,
            stockName: stockName,
            conditionText: conditionText,
            enabled: enabled
          })
        }
      }
      return out
    } catch (e) {
      // JSON è§£æå¤±è´¥/ç»“æ„å¼‚å¸¸ï¼šç›´æ¥è¿”å›ç©ºæ•°ç»„ï¼Œä¿è¯é¡µé¢ä¸ä¼šå› ä¸ºåæ•°æ®å´©
      return []
    }
  }


  // æ ¹æ®å½“å‰å·²æœ‰çš„é€šçŸ¥è§„åˆ™ï¼Œé‡æ–°è®¡ç®— nextRuleIdï¼ˆä¿è¯æ–°å¢è§„åˆ™æ—¶ id ä¸ä¼šå’Œå·²æœ‰çš„é‡å¤ï¼‰
  private recomputeNextRuleId(): void {
    // ä» 0 å¼€å§‹æ‰«ä¸€éï¼Œæ‰¾å‡ºå½“å‰ notifyRules é‡Œæœ€å¤§çš„ id
    let maxId: number = 0
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      // åªå…³å¿ƒ id æœ€å¤§å€¼ï¼›è¿™é‡Œä¸åšå¤æ‚æ ¡éªŒï¼Œå› ä¸º notifyRules æœ¬èº«å·²ç»æ˜¯æˆ‘ä»¬ç»´æŠ¤çš„ç»“æ„
      if (this.notifyRules[i].id > maxId) maxId = this.notifyRules[i].id
    }

    // ä¸‹ä¸€ä¸ªå¯ç”¨ id = å½“å‰æœ€å¤§ id + 1ï¼ˆç®€å•ã€ç›´è§‚ï¼Œä¹Ÿæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
    this.nextRuleId = maxId + 1
  }

  // ä»â€œé€šçŸ¥â€é¡µçš„è¾“å…¥æ¡†ç»„è£…ä¸€æ¡æ–°è§„åˆ™ï¼šæ ¡éªŒè¾“å…¥ â†’ å»é‡ â†’ è¡¥å…¨åç§° â†’ å†™å…¥ notifyRules å¹¶è½ç›˜
  private async addNotifyRuleFromUI(): Promise<void> {
    // 1) è¯»å–å¹¶æ ¡éªŒä»£ç ï¼šè§„åˆ™å¼•æ“/åç«¯æ¥å£éƒ½æŒ‰ 6 ä½ä»£ç èµ°ï¼Œé•¿åº¦ä¸å¯¹ç›´æ¥æ‹¦ä½
    const code: string = this.ruleStockCodeInput.trim()
    if (code.length !== 6) {
      this.ruleMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    // 2) è¯»å–å¹¶æ ¡éªŒé˜ˆå€¼ï¼šè¿™é‡Œå…è®¸ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²ï¼Œä½†æœ€ç»ˆå¿…é¡»èƒ½è½¬æˆæ•°å­—
    const v: number = Number(this.rulePriceInput.trim())
    if (Number.isNaN(v)) {
      this.ruleMsg = 'è¯·è¾“å…¥æ­£ç¡®çš„ä»·æ ¼é˜ˆå€¼'
      return
    }

    // 3) æ‹¼å‡ºç»Ÿä¸€çš„æ¡ä»¶æ–‡æ¡ˆï¼šåç»­â€œå»é‡â€å’Œâ€œå‘½ä¸­åˆ¤æ–­â€éƒ½ä¾èµ– conditionText çš„ä¸€è‡´æ€§
    //    ruleOpIndex=0 è¡¨ç¤º â‰¥ï¼Œ=1 è¡¨ç¤º â‰¤ï¼ˆä½ ç•Œé¢ä¸Šä¸¤ä¸ªæŒ‰é’®å°±æ˜¯åœ¨æ”¹è¿™ä¸ªï¼‰
    const opText: string = (this.ruleOpIndex === 0) ? 'â‰¥' : 'â‰¤'
    const cond: string = `ä»·æ ¼ ${opText} ${v.toFixed(2)}`

    // 4) å»é‡ï¼šåŒ quoteType + åŒ code + åŒ condï¼Œè§†ä¸ºåŒä¸€æ¡è§„åˆ™ï¼Œç›´æ¥æç¤ºä¸å†æ·»åŠ 
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.quoteType === this.ruleQuoteType && r.stockCode === code && r.conditionText === cond) {
        this.ruleMsg = 'è¯¥è§„åˆ™å·²å­˜åœ¨'
        return
      }
    }

    // 5) å°è¯•æŠŠæ ‡çš„åç§°è¡¥å…¨å‡ºæ¥ï¼šä¼˜å…ˆé€šè¿‡ç¼“å­˜/åç«¯æ‹¿åˆ° nameï¼Œè¿™æ ·åˆ—è¡¨é‡Œæ˜¾ç¤ºæ›´å‹å¥½
    //    æ³¨æ„è¿™é‡ŒæŒ‰ quoteType è¯·æ±‚ï¼Œé¿å…â€œæŒ‡æ•°/è‚¡ç¥¨åŒç â€æ—¶æ‹¿é”™åå­—
    const qt: QuoteType = this.ruleQuoteType
    await this.ensureQuoteCachedByType(qt, code)
    const q: Quote | null = this.findQuoteInCacheByType(qt, code)
    const name: string = (q !== null) ? q.name : code  // æ‹¿ä¸åˆ°å°±å…ˆç”¨ code é¡¶ä¸Š

    // 6) ç»„è£…æ–°è§„åˆ™å¯¹è±¡ï¼šenabled é»˜è®¤ trueï¼Œè¡¨ç¤ºæ·»åŠ åç«‹åˆ»ç”Ÿæ•ˆ
    const newRule: NotifyRule = {
      id: this.nextRuleId,
      quoteType: qt,
      stockCode: code,
      stockName: name,
      conditionText: cond,
      enabled: true
    }

    // 7) æå‰æŠŠ id æ¸¸æ ‡åŠ  1ï¼šé¿å…å¹¶å‘/é‡å¤ç‚¹å‡»æ—¶å‡ºç°åŒ id
    this.nextRuleId += 1

    // 8) æ›´æ–°çŠ¶æ€ï¼šArkUI å¯¹æ•°ç»„å¼•ç”¨æ•æ„Ÿï¼Œæ‰€ä»¥è¿™é‡Œç”¨â€œæ–°æ•°ç»„â€è§¦å‘ UI åˆ·æ–°
    const next: NotifyRule[] = [newRule].concat(this.notifyRules)
    this.notifyRules = next
    this.notifyRulesVer += 1

    // 9) æŒä¹…åŒ–åˆ° preferencesï¼šä¿è¯é‡å¯åè§„åˆ™è¿˜åœ¨
    await this.saveNotifyRulesToPrefs()

    // 10) æ¸…ç©ºè¾“å…¥å¹¶ç»™ä¸€ä¸ªè½»æç¤ºï¼šè®©ç”¨æˆ·çŸ¥é“è¿™æ¬¡ç‚¹å‡»ç”Ÿæ•ˆäº†
    this.ruleStockCodeInput = ''
    this.rulePriceInput = ''
    this.ruleMsg = 'å·²æ·»åŠ å¹¶å¯ç”¨'
  }

  // åˆ é™¤ä¸€æ¡é€šçŸ¥è§„åˆ™ï¼šæŒ‰ id è¿‡æ»¤æ‰ç›®æ ‡è§„åˆ™ â†’ æ›´æ–°åˆ—è¡¨ç‰ˆæœ¬å· â†’ ç«‹åˆ»è½ç›˜åˆ° preferences
  private async deleteRule(ruleId: number): Promise<void> {
    // ç”¨æ–°æ•°ç»„æ‰¿æ¥ç»“æœï¼ˆä¸è¦åŸåœ° spliceï¼‰ï¼Œè¿™æ · ArkUI æ‰èƒ½ç¨³å®šè§¦å‘åˆ·æ–°
    const next: NotifyRule[] = []

    // éå†ç°æœ‰è§„åˆ™ï¼ŒæŠŠâ€œä¸æ˜¯è¦åˆ çš„é‚£æ¡â€éƒ½ä¿ç•™ä¸‹æ¥
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.id !== ruleId) {
        next.push(r)
      }
    }

    // æ›¿æ¢ä¸ºæ–°æ•°ç»„ï¼šé€šçŸ¥é¡µé¢ List ä¼šè·Ÿç€é‡ç»˜
    this.notifyRules = next

    // æ‰‹åŠ¨ bump ä¸€ä¸‹ç‰ˆæœ¬å·ï¼ˆä½ ç”¨å®ƒå½“ keyï¼‰ï¼Œç¡®ä¿åˆ—è¡¨åœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šå¼ºåˆ¶åˆ·æ–°
    this.notifyRulesVer += 1

    // ä¿å­˜åˆ°æœ¬åœ°ï¼šé¿å…é‡å¯åâ€œåˆ æ‰çš„è§„åˆ™åˆå›æ¥äº†â€
    await this.saveNotifyRulesToPrefs()
  }

  // åˆ‡æ¢æŸå¼ è¡Œæƒ…å¡ç‰‡çš„â€œå±•å¼€ / æ”¶èµ·â€çŠ¶æ€ï¼ˆç”¨ Map è®°å½•ï¼Œæ¯å¼ å¡ä¸€ä¸ª keyï¼‰
  private toggleCardExpanded(item: Quote): void {
    // key é‡Œå¸¦ä¸Š typeï¼Œé¿å…æŒ‡æ•°/è‚¡ç¥¨å‡ºç°åŒç æ—¶äº’ç›¸è¦†ç›–ï¼ˆæ¯”å¦‚ 000001ï¼‰
    const key: string = `${item.type}-${item.code}`;

    // æ—§çŠ¶æ€ï¼šMap é‡Œæ²¡å­˜è¿‡å°±å½“ä½œ falseï¼ˆé»˜è®¤æ”¶èµ·ï¼‰
    const oldVal: boolean = this.cardExpandedMap.get(key) ?? false;

    // è¿™é‡Œä¸ç›´æ¥æ”¹åŸæ¥çš„ Mapï¼Œè€Œæ˜¯å¤åˆ¶ä¸€ä¸ªæ–°çš„ï¼š
    // ArkUI çš„ @State æ›´å®¹æ˜“è¯†åˆ«â€œå¼•ç”¨å˜äº†â€ï¼Œä»è€Œè§¦å‘ç›¸å…³ UI é‡ç»˜
    const newMap: Map<string, boolean> = new Map<string, boolean>();
    this.cardExpandedMap.forEach((value: boolean, k: string) => {
      newMap.set(k, value);
    });

    // æŠŠè¿™å¼ å¡ç‰‡çš„çŠ¶æ€å–åï¼ˆå±•å¼€ <-> æ”¶èµ·ï¼‰
    newMap.set(key, !oldVal);

    // æ›¿æ¢ä¸ºæ–° Mapï¼ˆé€šè¿‡â€œæ¢å¼•ç”¨â€è®©çŠ¶æ€æ›´æ–°ç”Ÿæ•ˆï¼‰
    this.cardExpandedMap = newMap;
  }


  // ===== è‡ªå®šä¹‰ TabBarï¼šè¿™é‡Œå°±èƒ½å®Œå…¨æ§åˆ¶æ–‡å­—é¢œè‰² =====
  @Builder
  tabBarBuilder(title: string, index: number) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor(this.currentTabIndex === index ? Color.White : '#888888')
    }
    .height(40)
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Black)
  }

  // é¡µé¢ä¸»å…¥å£ï¼šä¸Šé¢æ˜¯æ ‡é¢˜æ ï¼Œä¸‹é¢ç”¨ Tabs åˆ‡ä¸‰å—ï¼ˆå¸‚åœº / è‡ªé€‰ / é€šçŸ¥ï¼‰
  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ ï¼ˆlogo / æ ‡é¢˜ / å³ä¾§æŒ‰é’®ä¹‹ç±»çš„éƒ½åœ¨è¿™é‡Œï¼‰
      this.buildHeader()

      // ä¸‰ä¸ª Tabï¼šåªè´Ÿè´£â€œåˆ‡é¡µé¢â€ï¼Œå…·ä½“å†…å®¹åˆ†åˆ«äº¤ç»™ buildXXXTab()
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildMarketTab()
        }
        .tabBar(this.tabBarBuilder('å¸‚åœº', 0)) // å¸‚åœºè¡Œæƒ…ï¼šæŒ‡æ•°/è‚¡ç¥¨åˆ—è¡¨ + K çº¿

        TabContent() {
          this.buildWatchlistTab()
        }
        .tabBar(this.tabBarBuilder('è‡ªé€‰', 1)) // è‡ªé€‰åˆ†ç»„ï¼šåˆ†ç»„ç®¡ç† + è‡ªé€‰åˆ—è¡¨ + ç»Ÿè®¡å¡

        TabContent() {
          this.buildNotificationTab()
        }
        .tabBar(this.tabBarBuilder('é€šçŸ¥', 2)) // é€šçŸ¥è§„åˆ™ï¼šè§„åˆ™å¢åˆ æ”¹ + å‘½ä¸­åç³»ç»Ÿé€šçŸ¥
      }
      .barMode(BarMode.Fixed)               // å›ºå®š Tab æ ï¼Œä¸æ»šåŠ¨
      .backgroundColor(Color.Black)
      .divider({ strokeWidth: 0.5, color: '#333333' }) // TabBar ä¸‹æ–¹é‚£æ¡ç»†åˆ†å‰²çº¿
      .onChange((index: number) => {
        // ç”¨æˆ·åˆ‡æ¢ Tab æ—¶ï¼Œæ›´æ–°å½“å‰ç´¢å¼•ï¼ˆç”¨äºæ§åˆ¶å½“å‰æ˜¾ç¤ºå“ªä¸€é¡µï¼‰
        this.currentTabIndex = index
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  // ====== Header åŒºåŸŸ ======
  @Builder
  private buildHeader() {
    Column() {
      Row({ space: 8 }) {
        Text('HARMONYSTOCK')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Text('é¸¿è‚¡é€š')
          .fontSize(14)
          .fontColor('#AAAAAA')
          .margin({ top: 4 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
    }
    .backgroundColor('#111111')
  }

  // ===== æ¨¡å¼åˆ‡æ¢ï¼šæŒ‡æ•° / è‚¡ç¥¨ =====
  @Builder
  private buildModeSwitcher() {
    Row({ space: 24 }) {
      this.buildModeChip('æŒ‡æ•°', 'index');
      this.buildModeChip('è‚¡ç¥¨', 'stock');
    }.width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .height(50)
  }

  // å¸‚åœºé¡µé¡¶éƒ¨çš„â€œæŒ‡æ•° / è‚¡ç¥¨â€åˆ‡æ¢æŒ‰é’®ï¼ˆä¸€ä¸ª chip å¯¹åº”ä¸€ç§æ¨¡å¼ï¼‰
  @Builder
  private buildModeChip(label: string, mode: 'index' | 'stock') {
    Text(label)
      .fontSize(16)
      // å½“å‰æ¨¡å¼é€‰ä¸­æ€ï¼šæ–‡å­—é«˜äº®ï¼›æœªé€‰ä¸­åˆ™ç°è‰²
      .fontColor(this.currentMode === mode ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      // é€‰ä¸­æ€ç»™æ›´äº®çš„åº•è‰²ï¼Œåšæˆâ€œèƒ¶å›ŠæŒ‰é’®â€æ•ˆæœ
      .backgroundColor(this.currentMode === mode ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        // ç‚¹åˆ°å·²ç»é€‰ä¸­çš„æ¨¡å¼å°±ä¸åšä»»ä½•äº‹ï¼Œé¿å…é‡å¤è¯·æ±‚/é‡å¤æ¸…çŠ¶æ€
        if (this.currentMode === mode) {
          return;
        }

        // åˆ‡æ¢è¡Œæƒ…æ¨¡å¼ï¼ˆå½±å“ï¼šåˆ—è¡¨æ¥å£ typeã€æœç´¢ typeã€K çº¿ typeï¼‰
        this.currentMode = mode;

        // åˆ‡æ¨¡å¼æ—¶æŠŠâ€œå¸‚åœºé¡µç›¸å…³çŠ¶æ€â€å…¨éƒ¨æ¸…æ‰ï¼Œé¿å…æ®‹ç•™ä¸Šä¸€ä¸ªæ¨¡å¼çš„æ•°æ®
        this.marketQuotes = [];
        this.searchedQuotes = [];
        this.selectedQuoteCode = '';
        this.selectedQuoteName = '';
        this.selectedQuoteType = mode;   // å½“å‰é€‰ä¸­æ ‡çš„çš„ç±»å‹ä¹Ÿè·Ÿç€åˆ‡
        this.selectedKlineIndex = -1;
        this.klinePoints = [];
        this.klineGeoms = [];
        this.klineXLabels = [];
        this.klineError = '';

        // é‡æ–°æ‹‰å–è¯¥æ¨¡å¼ä¸‹çš„è¡Œæƒ…åˆ—è¡¨
        this.fetchQuotes(mode);
      })
  }


  // Tab 1ï¼šå¸‚åœºé¡µï¼ˆæŒ‡æ•° / è‚¡ç¥¨åˆ‡æ¢ + è¡Œæƒ…å¡ç‰‡æ¨ªæ»‘ + K çº¿å±•ç¤ºï¼‰
  @Builder
  private buildMarketTab() {
    Column() {
      // é¡¶éƒ¨æ¨¡å¼åˆ‡æ¢ï¼ˆæŒ‡æ•° / è‚¡ç¥¨ä¸¤ä¸ª chipï¼‰
      this.buildModeSwitcher()

      // é¡¶éƒ¨ä¸€è¡Œï¼šå·¦ä¾§æ ‡é¢˜ + å³ä¾§æœç´¢æ¡†
      Row() {
        // æ ‡é¢˜è·Ÿéš currentMode å˜åŒ–ï¼Œæç¤ºå½“å‰çœ‹çš„æ˜¯ä»€ä¹ˆåˆ—è¡¨
        Text(this.currentMode === 'index' ? 'æŒ‡æ•°å¡ç‰‡' : 'è‚¡ç¥¨å¡ç‰‡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .margin({ left: 16, top: 12, bottom: 4 })

        // å ä½æŠŠå³ä¾§å†…å®¹é¡¶åˆ°æœ€å³è¾¹
        Blank()

        // æœç´¢åŒºåŸŸï¼šæŒ‰ 6 ä½ä»£ç æŸ¥å•ä¸ªæ ‡çš„ï¼ˆæŒ‡æ•°/è‚¡ç¥¨å–å†³äº currentModeï¼‰
        this.buildSearchArea();
      }
      .width('100%')
      // è®©æ ‡é¢˜ã€æœç´¢æ¡†åœ¨å‚ç›´æ–¹å‘å±…ä¸­å¯¹é½ï¼ˆçœ‹èµ·æ¥æ›´æ•´é½ï¼‰
      .alignItems(VerticalAlign.Center)

      // è¡Œæƒ…æ¨ªå‘æ»šåŠ¨æ¡ï¼šå±•ç¤ºå¸‚åœºåˆ—è¡¨ + æœç´¢ç»“æœï¼ˆå¯ç‚¹é€‰åˆ‡æ¢ K çº¿ï¼‰
      this.buildQuoteStrip();

      // K çº¿å¡ç‰‡ï¼šå±•ç¤ºå½“å‰é€‰ä¸­æ ‡çš„çš„ K çº¿ï¼ˆå‘¨æœŸåˆ‡æ¢ã€ç‚¹å‡»é«˜äº®ç­‰ï¼‰
      this.buildKlineCard();
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    // Column å†…éƒ¨å†…å®¹æ•´ä½“ä»å·¦å¯¹é½ï¼ˆé¿å…é»˜è®¤å±…ä¸­å¯¼è‡´å¸ƒå±€é£˜ï¼‰
    .alignItems(HorizontalAlign.Start)
  }


  // è¡Œæƒ…æ¨ªæ»‘ stripï¼šä¸Šé¢ä¼˜å…ˆå±•ç¤ºâ€œæœç´¢ç»“æœâ€ï¼Œåé¢æ˜¯â€œåå°å®æ—¶åˆ—è¡¨â€ï¼›
  // åŒæ—¶æŠŠåŠ è½½/é”™è¯¯çŠ¶æ€ä¹Ÿæ”¾åœ¨è¿™é‡Œå…œä½ï¼Œé¿å…é¡µé¢ç©ºç™½ã€‚
  @Builder
  private buildQuoteStrip() {
    // è¡Œæƒ…åˆ—è¡¨è¯·æ±‚ä¸­ï¼šç»™ç”¨æˆ·ä¸€ä¸ªæ˜ç¡®çš„åŠ è½½åé¦ˆ
    if (this.listLoading) {
      Row() {
        Text('è¡Œæƒ…åŠ è½½ä¸­â€¦')
          .fontSize(12)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // è¡Œæƒ…åˆ—è¡¨è¯·æ±‚å¤±è´¥ï¼šå±•ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆåªå½±å“å½“å‰æ¨¡å¼çš„ UIï¼‰
    } else if (this.listError) {
      Row() {
        Text(`è¡Œæƒ…åŠ è½½å¤±è´¥ï¼š${this.listError}`)
          .fontSize(12)
          .fontColor('#FF7875')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // æ­£å¸¸çŠ¶æ€ï¼šç”¨æ¨ªå‘ Scroll + Row å½¢æˆâ€œå¡ç‰‡æ¨ªæ»‘â€çš„æ•ˆæœ
    } else {
      Scroll() {
        Row({ space: 12 }) {

          // â‘  æœç´¢å‡ºæ¥çš„å¡ç‰‡ï¼šæ”¾æœ€å‰é¢ï¼Œç›¸å½“äºâ€œç½®é¡¶â€ï¼Œæ›´æ–¹ä¾¿ä½ åˆšæœå®Œé©¬ä¸Šç‚¹
          ForEach(this.searchedQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `search-${item.type}-${item.code}`) // keyï¼šä¿è¯åŒä¸€æ¡æ•°æ®ç¨³å®šå¤ç”¨ï¼Œä¸ä¹±è·³

          // â‘¡ åå°å®æ—¶å¡ç‰‡ï¼šå¸‚åœºåˆ—è¡¨ï¼ˆè½®è¯¢/åˆ·æ–°å¾—åˆ°çš„ï¼‰
          ForEach(this.marketQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `rt-${item.type}-${item.code}`) // keyï¼šrt=real-timeï¼Œé¿å…å’Œ search çš„ key å†²çª
        }
        // strip çš„å·¦å³ç•™ç™½ + ä¸Šä¸‹å†…è¾¹è·ï¼Œå¡ç‰‡ä¸ä¼šè´´è¾¹
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      // å…³é”®ï¼šæŠŠ Scroll è®¾ç½®æˆæ¨ªå‘æ»šåŠ¨ï¼Œæ‰èƒ½å·¦å³æ»‘å¡ç‰‡
      .scrollable(ScrollDirection.Horizontal)
    }
  }


  // æœç´¢åŒºï¼šè¾“å…¥ 6 ä½ä»£ç  + ç‚¹â€œæŸ¥è¯¢â€æ‹‰å•åªè¡Œæƒ…ï¼›
  // ä¸‹æ–¹é¡ºå¸¦å±•ç¤ºæŸ¥è¯¢ä¸­çš„ loading / errorï¼Œå°è€Œå®Œæ•´çš„ä¸€å— UIã€‚
  @Builder
  private buildSearchArea() {
    Column() {

      // ç¬¬ä¸€è¡Œï¼šè¾“å…¥æ¡† + æŸ¥è¯¢æŒ‰é’®
      Row({ space: 8 }) {

        // è¾“å…¥æ¡†ï¼šplaceholder ä¼šè·Ÿç€å½“å‰æ¨¡å¼åˆ‡æ¢ï¼ˆæŒ‡æ•°/è‚¡ç¥¨ï¼‰ï¼Œé¿å…ç”¨æˆ·è¾“é”™ç±»å‹
        TextInput({
          placeholder: this.currentMode === 'index'
            ? 'è¾“å…¥æŒ‡æ•°ä»£ç ï¼Œä¾‹å¦‚ 000001'
            : 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚ 300750'
        })
          .width('60%')
          .height(32)
          .fontSize(14)
          .backgroundColor(Color.White)
          .fontColor(Color.Black)
          // ç”¨æˆ·æ¯æ¬¡è¾“å…¥å˜åŒ–ï¼Œå°±æŠŠå†…å®¹å†™è¿› searchCodeï¼ˆç»Ÿä¸€åœ¨ queryQuoteByCode é‡Œæ ¡éªŒé•¿åº¦ï¼‰
          .onChange((value: string) => {
            this.searchCode = value.trim();
          })

        // æŸ¥è¯¢æŒ‰é’®ï¼šè§¦å‘ queryQuoteByCodeï¼ˆé‡Œé¢ä¼šæŒ‰ currentMode å»æŸ¥ index æˆ– stockï¼‰
        Button('æŸ¥è¯¢')
          .height(32)
          .onClick(() => {
            this.queryQuoteByCode();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 4 })

      // ç¬¬äºŒè¡Œï¼šæŸ¥è¯¢çŠ¶æ€æç¤ºï¼ˆåªåœ¨éœ€è¦æ—¶å‡ºç°ï¼‰
      if (this.searchLoading) {
        Row() {
          // æŸ¥è¯¢ä¸­ç»™ä¸ªè½»æç¤ºï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºæ²¡ç‚¹ä¸Š
          Text('æ­£åœ¨æŸ¥è¯¢â€¦')
            .fontSize(12)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })

      } else if (this.searchError) {
        Row() {
          // æŸ¥è¯¢å¤±è´¥ï¼šæŠŠé”™è¯¯ä¿¡æ¯ç›´æ¥éœ²å‡ºæ¥ï¼ˆä¾‹å¦‚â€œæœªæ‰¾åˆ°è¯¥ä»£ç â€â€œHTTP 500â€ç­‰ï¼‰
          Text(`æŸ¥è¯¢å¤±è´¥ï¼š${this.searchError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      }
    }
  }


  // ===== è¡Œæƒ…å¡ç‰‡ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰=====
  // è¿™å¼ å¡åšä¸¤ä»¶äº‹ï¼š
  // 1) ç‚¹å¡ç‰‡ä¸»ä½“ï¼šé€‰ä¸­è¯¥æ ‡çš„ + å›å†™æ¡Œé¢å¡ç‰‡ï¼ˆå¦‚æœæ˜¯ä»æ¡Œé¢å¡ç‰‡è¿›æ¥çš„ï¼‰+ æ‹‰ K çº¿
  // 2) ç‚¹å³ä¸‹è§’ â€œï¼‹/ï¼â€ï¼šåªåˆ‡æ¢å¡ç‰‡å±•å¼€/æ”¶èµ·ï¼ˆä¸åˆ‡æ¢é€‰ä¸­ã€ä¸æ‹‰ K çº¿ï¼‰
  @Builder
  private buildQuoteCard(item: Quote) {
    Column() {
      Column() {
        // ===== å¡ç‰‡ä¸»ä½“åŒºåŸŸï¼šæ˜¾ç¤ºåç§°/ä»·æ ¼/æ¶¨è·Œ =====
        Column() {
          Row() {
            // æ ‡çš„åç§°ï¼ˆæŒ‡æ•°å / è‚¡ç¥¨åï¼‰
            Text(item.name)
              .fontSize(12)
              .fontColor('#AAAAAA')

            // åˆ é™¤æŒ‰é’®ï¼šä» strip é‡Œç§»é™¤è¿™å¼ å¡
            Text('âœ•')
              .fontSize(12)
              .fontColor('#777777')
              // ç”¨ TapGesture è€Œä¸æ˜¯ onClickï¼šæ¨ªå‘ Scroll æ—¶æ›´ä¸å®¹æ˜“è¢«æ»‘åŠ¨æ‰‹åŠ¿æŠ¢èµ°
              .parallelGesture(
                TapGesture().onAction(async () => {
                  await this.removeQuoteCard(item.code, item.type)
                })
              )
          }
          .width('100%')
          // ä¸¤ç«¯å¯¹é½ï¼šå·¦è¾¹ nameï¼Œå³è¾¹ âœ•
          .justifyContent(FlexAlign.SpaceBetween)
          // å‚ç›´å±…ä¸­ï¼šè®© name å’Œ âœ• çœ‹èµ·æ¥åœ¨åŒä¸€æ°´å¹³çº¿ä¸Š
          .alignItems(VerticalAlign.Center)

          // å½“å‰ä»·ï¼šå±•å¼€æ—¶å­—ä½“æ›´å¤§
          Text(item.price.toFixed(2))
          // è¿™é‡Œç”¨ Map é‡Œçš„çŠ¶æ€æ§åˆ¶â€œå±•å¼€/æ”¶èµ·â€çš„å­—å·
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 28 : 20)
            .fontWeight(FontWeight.Bold)
            // æ¶¨çº¢è·Œç»¿ï¼ˆæŒ‰ä½ å…¨å±€é…è‰²ï¼‰
            .fontColor(item.change >= 0 ? '#FF4D4F' : '#39D98A')
            .margin({ top: 4 })

          // æ¶¨è·Œé¢ + æ¶¨è·Œå¹…ï¼šå±•å¼€æ—¶å­—ä½“æ›´å¤§
          Text(`${item.change.toFixed(2)}  ${item.changePercent.toFixed(2)}%`)
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 16 : 12)
            .fontColor(item.change >= 0 ? '#FF7875' : '#6BE49B')
            .margin({ top: 4 })
        }

        // ===== å³ä¸‹è§’å±•å¼€/æ”¶èµ·æŒ‰é’®ï¼šåªæ”¹å°ºå¯¸ï¼Œä¸è§¦å‘é€‰ä¸­é€»è¾‘ =====
        Row() {
          Blank()
          Text((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 'ï¼' : 'ï¼‹')
            .fontSize(18)
            .fontColor('#CCCCCC')
            // åŒæ ·ç”¨ TapGestureï¼Œé¿å…å’Œå¤–å±‚â€œç‚¹å¡ç‰‡é€‰ä¸­â€çš„ tap äº’ç›¸å½±å“
            .parallelGesture(
              TapGesture().onAction(() => {
                this.toggleCardExpanded(item)
              })
            )
        }
        .width('100%')
        .margin({ top: 8 })
      }
      // å±•å¼€æ—¶ padding æ›´å¤§ï¼Œçœ‹èµ·æ¥â€œå¡ç‰‡æ›´æ¾â€
      .padding((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 20 : 12)
      .backgroundColor('#171717')
      .borderRadius(12)
      // å±•å¼€æ—¶å¡ç‰‡æ›´å®½
      .width((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 200 : 140)
      // å±•å¼€æ—¶ç»™ä¸€ä¸ªå›ºå®šé«˜åº¦ï¼›æ”¶èµ·æ—¶ä¸å†™ heightï¼Œè®©å®ƒæŒ‰å†…å®¹è‡ªé€‚åº”
      .height((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 150 : undefined)

      // ===== å¡ç‰‡æ•´ä½“çš„ç‚¹å‡»ï¼šé€‰ä¸­ + å›å†™æ¡Œé¢å¡ç‰‡ + æ‹‰ K çº¿ =====
      // ç”¨ parallelGesture çš„åŸå› ï¼šè¿™å¼ å¡æ˜¯åœ¨æ¨ªå‘ Scroll é‡Œï¼Œæ™®é€šç‚¹å‡»å¾ˆå®¹æ˜“è¢«æ»šåŠ¨æ‰‹åŠ¿åæ‰
      .parallelGesture(
        TapGesture().onAction(async () => {
          // è¿™äº›æ—¥å¿—æ˜¯ä¸ºäº†æ’æŸ¥ï¼šæ˜¯å¦ç‚¹å‡»äº‹ä»¶æ²¡è¿›æ¥ã€activeFormId æ˜¯å¦ä¸ºç©ºç­‰
          console.info(`[TAP] quoteCard tapped code=${item.code} activeFormId=${this.activeFormId}`)
          hilog.error(DOMAIN, TAG, '[TAP] quoteCard tapped code=%{public}s activeFormId=%{public}s',
            item.code, this.activeFormId)

          // æ›´æ–°â€œå½“å‰é€‰ä¸­æ ‡çš„â€ï¼šK çº¿å’Œå³ä¾§è¯¦ç»†å±•ç¤ºéƒ½é è¿™å‡ ä¸ªå­—æ®µ
          this.selectedQuoteCode = item.code
          this.selectedQuoteName = item.name
          this.selectedQuoteType = item.type
          hilog.error(DOMAIN, TAG, '[TAP] selected set type=%{public}s code=%{public}s', item.type, item.code)

          // å¦‚æœæ˜¯ä»æ¡Œé¢å¡ç‰‡æ‰“å¼€çš„ï¼ˆactiveFormId æœ‰å€¼ï¼‰ï¼Œå°±æŠŠå½“å‰é€‰ä¸­çš„æ ‡çš„åŒæ­¥å›æ¡Œé¢å¡ç‰‡
          hilog.error(DOMAIN, TAG, '[TAP] before updateWidgetIfLaunchedFromForm')
          await this.updateWidgetIfLaunchedFromForm(item)
          hilog.error(DOMAIN, TAG, '[TAP] after updateWidgetIfLaunchedFromForm')

          // ç‚¹å‡»å¡ç‰‡åæ‹‰å¯¹åº”å‘¨æœŸçš„ K çº¿
          const period: string = this.getKlinePeriodParam()
          this.fetchKline(item.type, item.code, period)
        })
      )
    }
  }


  // ===== K çº¿å¡ç‰‡ =====
  // ç”¨ä¸€å¼ å¡æŠŠ â€œKçº¿å›¾ + å‘¨æœŸåˆ‡æ¢ + å½“å‰èœ¡çƒ›è¯¦æƒ…â€ æ”¾åœ¨ä¸€èµ·ï¼šä¸Šé¢æ˜¯æ ‡é¢˜/å‘¨æœŸï¼Œä¸­é—´æ˜¯å›¾ï¼Œä¸‹é¢æ˜¯ x è½´æ—¥æœŸã€‚
  @Builder
  private buildKlineCard() {
    Column() {
      // æ ‡é¢˜è¡Œï¼šå·¦è¾¹æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„æ ‡çš„åï¼Œå³è¾¹æ˜¯ æ—¥/å‘¨/æœˆ åˆ‡æ¢
      Row({ space: 12 }) {
        Text(
          // å·²ç»é€‰ä¸­è¿‡æŸä¸ªè¡Œæƒ…å¡ç‰‡ï¼šä¼˜å…ˆç”¨é€‰ä¸­çš„åå­—åšæ ‡é¢˜
          this.selectedQuoteName !== ''
            ? `${this.selectedQuoteName} K çº¿`
            // å¦åˆ™å°±æŒ‰å½“å‰æ¨¡å¼ç»™ä¸ªé»˜è®¤æ ‡é¢˜
            : (this.currentMode === 'index' ? 'æŒ‡æ•° K çº¿' : 'è‚¡ç¥¨ K çº¿')
        )
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)

        Blank() // æŠŠå³ä¾§çš„å‘¨æœŸæŒ‰é’®é¡¶åˆ°æœ€å³

        // å‘¨æœŸæŒ‰é’®ï¼šå†…éƒ¨ä¼šåˆ‡æ¢ klinePeriodIndex å¹¶è§¦å‘é‡æ–°æ‹‰å–
        this.buildKlinePeriodChip('æ—¥K', 0)
        this.buildKlinePeriodChip('å‘¨K', 1)
        this.buildKlinePeriodChip('æœˆK', 2)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8 })

      // å½“å‰é€‰ä¸­çš„é‚£æ ¹èœ¡çƒ›çš„è¯¦æƒ…æ¡ï¼ˆç‚¹æŸæ ¹ K çº¿åæ‰ä¼šå‡ºç°ï¼‰
      if (this.selectedKlineIndex >= 0) {
        Row({ space: 8 }) {
          Text(this.selectedKlineDate) // æ—¥æœŸ
            .fontSize(10)
            .fontColor('#CCCCCC')

          // OHLCï¼šå¼€/é«˜/ä½/æ”¶
          Text(`å¼€ ${this.selectedKlineOpen.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`é«˜ ${this.selectedKlineHigh.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`ä½ ${this.selectedKlineLow.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`æ”¶ ${this.selectedKlineClose.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 4, bottom: 4 })
      }

      // ä¸»ä½“å†…å®¹ï¼šæ ¹æ®åŠ è½½/é”™è¯¯/ç©ºæ•°æ®/æ­£å¸¸æ•°æ®å››ç§çŠ¶æ€åˆ‡æ¢å±•ç¤º
      Column() {
        if (this.klineLoading) {
          Text('K çº¿åŠ è½½ä¸­â€¦')
            .fontSize(12)
            .fontColor('#888888')
        } else if (this.klineError) {
          Text(`K çº¿åŠ è½½å¤±è´¥ï¼š${this.klineError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        } else if (this.klineGeoms.length === 0) {
          Text('æš‚æ—  K çº¿æ•°æ®')
            .fontSize(12)
            .fontColor('#666666')
        } else {
          // æœ‰æ•°æ®ï¼šå·¦ä¾§æ˜¯ y è½´åˆ»åº¦ï¼Œå³ä¾§æ˜¯å¯æ¨ªå‘æ»šåŠ¨çš„èœ¡çƒ›å›¾ + x è½´æ ‡ç­¾
          Column() {
            Row() {
              // y è½´åˆ»åº¦ï¼šç®€å•æ”¾ 3 ä¸ªï¼ˆæœ€å¤§/ä¸­é—´/æœ€å°ï¼‰ï¼Œç”¨ SpaceBetween æ’‘å¼€
              Column() {
                Text(this.klineMaxPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(((this.klineMaxPrice + this.klineMinPrice) / 2).toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(this.klineMinPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
              }
              .width(40)
              .height(this.KLINE_PLOT_H)
              .justifyContent(FlexAlign.SpaceBetween)

              // å³ä¾§å›¾è¡¨ï¼šå› ä¸º K çº¿æ•°é‡å¤šï¼Œæ‰€ä»¥æŠŠâ€œèœ¡çƒ›åŒºåŸŸ + xè½´æ—¥æœŸâ€ä¸€èµ·æ”¾è¿›æ¨ªå‘ Scroll
              Scroll() {
                Column() {
                  // èœ¡çƒ›å›¾åŒºåŸŸï¼šæ¯æ ¹èœ¡çƒ›ç”¨ KlineGeom é‡Œé¢„å…ˆç®—å¥½çš„ topGap / wick / body æ¥æ‹¼å‡ºæ¥
                  Row({ space: this.candleGap }) {
                    ForEach(this.klineGeoms, (g: KlineGeom, idx: number) => {
                      Column() {
                        // é¡¶éƒ¨ç©ºç™½ï¼šæŠŠèœ¡çƒ›æ•´ä½“â€œå‹â€åˆ°æ­£ç¡®çš„ y ä½ç½®
                        Blank().height(g.topGap)

                        // ä¸Šå½±çº¿
                        Rect()
                          .width(2)
                          .height(g.upperWick)
                          .fill('#444444')

                        // å®ä½“ï¼šæ¶¨è·Œç”¨ä¸åŒé¢œè‰²ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„ isUp å®šä¹‰æ˜¯ close >= openï¼‰
                        Rect()
                          .width(this.candleBodyWidth)
                          .height(g.bodyHeight)
                          .fill(g.isUp ? '#39D98A' : '#FF4D4F')

                        // ä¸‹å½±çº¿
                        Rect()
                          .width(2)
                          .height(g.lowerWick)
                          .fill('#444444')

                        Blank().height(4)
                      }
                      // é«˜äº®å½“å‰é€‰ä¸­çš„èœ¡çƒ›ï¼šç”¨è¾¹æ¡†åšä¸€ä¸ªè½»é‡çš„â€œé€‰ä¸­æ¡†â€
                      .border({
                        width: this.selectedKlineIndex === idx ? 1 : 0,
                        color: this.selectedKlineIndex === idx ? '#FACC15' : '#000000'
                      })
                      // ç‚¹æŸæ ¹èœ¡çƒ›ï¼šæ›´æ–° selectedKlineIndex å’Œè¯¦æƒ…æ¡å±•ç¤ºçš„æ•°æ®
                      .parallelGesture(
                        TapGesture().onAction(() => {
                          this.onKlineSelected(idx)
                        })
                      )
                    }, (g: KlineGeom, idx: number) => `${idx}`)
                  }
                  // æ€»å®½åº¦ = èœ¡çƒ›æ•°é‡ * (å®ä½“å®½ + é—´è·) ä¹‹ç±»çš„é€»è¾‘ï¼ˆä½ åœ¨ getKlineTotalWidth() é‡Œç®—ï¼‰
                  .width(this.getKlineTotalWidth())
                  .height(this.KLINE_PLOT_H)

                  // x è½´æ—¥æœŸæ ‡ç­¾ï¼šç”¨ SpaceBetween æŠŠå°‘é‡æ ‡ç­¾å‡åŒ€é“ºå¼€
                  if (this.klineXLabels.length > 0) {
                    Row() {
                      ForEach(this.klineXLabels, (label: string, idx: number) => {
                        Text(label)
                          .fontSize(10)
                          .fontColor('#777777')
                      }, (label: string, idx: number) => `${idx}-${label}`)
                    }
                    .width(this.getKlineTotalWidth())
                    .justifyContent(FlexAlign.SpaceBetween)
                    .margin({ bottom: 10 })
                  }
                }
                // å³ä¾§ç•™ä¸€ç‚¹è¾¹è·ï¼Œé¿å…æœ€åä¸€æ ¹èœ¡çƒ›è´´è¾¹ä¸å¥½ç‚¹
                .padding({ right: 32 })
              }
              .scrollable(ScrollDirection.Horizontal)
              // å›¾ + xè½´ä¸€èµ·æ»šï¼Œæ‰€ä»¥é«˜åº¦æ˜¯ plot + label
              .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H)
              .margin({ left: 8 })
            }
            .width('100%')
          }
        }
      }
      // å¡ç‰‡æ•´ä½“çš„å›ºå®šé«˜åº¦ï¼šç»™å†…å®¹ç•™å‡ºç©ºé—´ï¼ˆå›¾ + xè½´ + æ ‡é¢˜/è¯¦æƒ…æ¡çš„ä½™é‡ï¼‰
      .width('100%')
      .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H + 70)
      .margin({ top: 8, bottom: 12 })
      .padding(16)
      .backgroundColor('#101010')
      .borderRadius(16)
    }
  }

  // K çº¿å‘¨æœŸåˆ‡æ¢æŒ‰é’®ï¼šç‚¹â€œæ—¥/å‘¨/æœˆâ€æ—¶ï¼Œæ›´æ–° klinePeriodIndexï¼Œå¹¶æŒ‰å½“å‰é€‰ä¸­çš„æ ‡çš„é‡æ–°æ‹‰ä¸€æ¬¡ K çº¿
  @Builder
  private buildKlinePeriodChip(label: string, index: number) {
    Text(label)
      .fontSize(12)
      // é€‰ä¸­æ€é«˜äº®ï¼šå½“å‰å‘¨æœŸ == è¿™ä¸ª chip çš„ index
      .fontColor(this.klinePeriodIndex === index ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .backgroundColor(this.klinePeriodIndex === index ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        // ç‚¹åˆ°åŒä¸€ä¸ªå‘¨æœŸå°±ä¸åšäº‹ï¼Œé¿å…é‡å¤è¯·æ±‚ + æ— æ„ä¹‰åˆ·æ–°
        if (this.klinePeriodIndex === index) {
          return;
        }

        // å…ˆæ›´æ–°å‘¨æœŸç´¢å¼•ï¼ˆgetKlinePeriodParam() ä¼šæ ¹æ®å®ƒè¿”å› day/week/monthï¼‰
        this.klinePeriodIndex = index;

        // åªæœ‰â€œå·²ç»é€‰ä¸­è¿‡æŸä¸ªè¡Œæƒ…å¡ç‰‡â€æ‰æ‹‰ K çº¿
        // ï¼ˆæ²¡é€‰ä¸­çš„è¯ selectedQuoteCode ä¸ºç©ºï¼Œæ‹‰äº†ä¹Ÿä¸çŸ¥é“æ‹‰è°ï¼‰
        if (this.selectedQuoteCode !== '') {
          const period: string = this.getKlinePeriodParam();
          // ç”¨å½“å‰é€‰ä¸­çš„ç±»å‹ + ä»£ç é‡æ–°æ‹‰ä¸€ä»½ K çº¿æ•°æ®
          this.fetchKline(this.selectedQuoteType, this.selectedQuoteCode, period);
        }
      })
  }


  // Tab 2ï¼ˆè‡ªé€‰ï¼‰ï¼šåˆ†ç»„ç®¡ç† + å½“å‰åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆä¾èµ– activeGroupId / activeStocks / quoteCache æ¥é©±åŠ¨ UIï¼‰
  @Builder
  private buildWatchlistTab() {
    Column() {
      // é¡¶éƒ¨ï¼šåˆ†ç»„æ¨ªå‘æ¡ï¼ˆåˆ‡æ¢åˆ†ç»„ã€åˆ é™¤åˆ†ç»„ç­‰ä¸€èˆ¬éƒ½åœ¨è¿™é‡Œåšï¼‰
      this.buildGroupStrip()

      // æ–°å»ºåˆ†ç»„è¾“å…¥æ 
      this.buildCreateGroupBar()

      // é¡µé¢çº§æç¤ºä¿¡æ¯ï¼ˆæ¯”å¦‚â€œå·²æ·»åŠ  xx åªâ€â€œå·²åˆ é™¤ xx åªâ€ä¹‹ç±»ï¼‰
      if (this.watchlistMsg.length > 0) {
        Text(this.watchlistMsg)
          .fontSize(10)
          .fontColor('#777777')
          .margin({ left: 16, bottom: 8 })
      }

      // æ²¡æœ‰ä»»ä½•åˆ†ç»„æ—¶çš„ç©ºæ€
      if (this.activeGroupId < 0 || this.groups.length === 0) {
        Text('æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç»„')
          .fontSize(12)
          .fontColor('#777777')
          .margin({ top: 24 })
          .width('100%')
          .textAlign(TextAlign.Center)
      } else {
        // å½“å‰åˆ†ç»„æ ‡é¢˜åŒºï¼ˆç›´æ¥è¯» activeGroupId å¯¹åº”çš„ group ä¿¡æ¯ï¼‰
        this.buildActiveGroupHeaderCurrent()

        // å½“å‰åˆ†ç»„ç»Ÿè®¡å¡ï¼ˆè‚¡ç¥¨æ•° / æ¶¨è·Œæ•° / å¹³å‡æ¶¨è·Œå¹…ï¼Œä¾èµ– quoteCacheï¼‰
        this.buildGroupStatsCard()

        // ç»„å†…æ·»åŠ è‚¡ç¥¨è¾“å…¥æ 
        this.buildAddStockBar()

        // å½“å‰åˆ†ç»„æ²¡æœ‰è‚¡ç¥¨æ—¶çš„ç©ºæ€
        if (this.getActiveGroupStocksList().length === 0) {
          Text('è¯¥åˆ†ç»„æš‚æ— è‚¡ç¥¨ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥ä»£ç æ·»åŠ ')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 12, left: 16 })
        } else {
          // ç»„å†…è‚¡ç¥¨åˆ—è¡¨ï¼šç”¨ activeStocksï¼ˆä» activeGroup.stocks slice å‡ºæ¥çš„â€œæ–°æ•°ç»„â€ï¼‰
          List() {
            ForEach(this.activeStocks, (s: StockRef) => {
              this.buildStockRefRow(this.activeGroupId, s)
            }, (s: StockRef) => {
              // è¡Œçº§ keyï¼šä¿è¯åŒä¸€åˆ†ç»„å†… code å”¯ä¸€å³å¯
              return `${this.activeGroupId}-${s.code}`
            })
          }
          // List çº§ keyï¼šactiveStocksVer å˜åŒ–æ—¶å¼ºåˆ¶ List é‡å»ºï¼Œè§£å†³â€œæ•°ç»„å†…å®¹å˜äº†ä½†åˆ—è¡¨ä¸åˆ·æ–°â€çš„æƒ…å†µ
          .key(`${this.activeGroupId}-${this.activeStocksVer}`)
          .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    // é¡µé¢çº§ keyï¼šæŠŠå‡ ä¸ªå…³é”®ç‰ˆæœ¬å·éƒ½å¸¦ä¸Šï¼Œä¿è¯åˆ†ç»„åˆ‡æ¢/è¡Œæƒ…æ›´æ–°/ç»Ÿè®¡åˆ·æ–°æ—¶ï¼Œè¿™ä¸ª Tab çš„å…³é”®åŒºåŸŸèƒ½ç¨³å®šé‡ç»˜
    .key(`watchlist-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }


  // å½“å‰åˆ†ç»„çš„â€œæ ‡é¢˜è¡Œâ€ï¼šå·¦ä¾§æ˜¾ç¤ºåˆ†ç»„åï¼Œå³ä¾§æä¾›â€œåˆ é™¤åˆ†ç»„â€å…¥å£ï¼ˆç›´æ¥æ“ä½œ activeGroupIdï¼‰
  @Builder
  private buildActiveGroupHeaderCurrent() {
    Row({ space: 8 }) {
      // åˆ†ç»„åç§°ï¼šä» activeGroupId å¯¹åº”çš„ group é‡Œå– nameï¼ˆç©ºæ—¶è¿”å› ''ï¼‰
      Text(this.getActiveGroupNameText())
        .fontSize(14)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)

      Blank()

      // åˆ é™¤æŒ‰é’®ï¼šåˆ é™¤å½“å‰ activeGroupId å¯¹åº”çš„åˆ†ç»„ï¼Œå¹¶è§¦å‘ active é“¾è·¯åŒæ­¥ï¼ˆä½ åœ¨ deleteGroup é‡Œå·²ç»åšäº†ï¼‰
      Text('åˆ é™¤åˆ†ç»„')
        .fontSize(12)
        .fontColor('#FF7875')
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#1A1A1A')
        .borderRadius(10)
        .onClick(() => {
          this.deleteGroup(this.activeGroupId)
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 6 })
  }


  // åˆ†ç»„æ¨ªå‘æ»šåŠ¨æ¡ï¼šå±•ç¤ºæ‰€æœ‰åˆ†ç»„ï¼Œå¹¶å…è®¸ç‚¹å‡»åˆ‡æ¢å½“å‰ active åˆ†ç»„
  @Builder
  private buildGroupStrip() {
    Scroll() {
      Row({ space: 8 }) {
        ForEach(this.groups, (group: StockGroup) => {
          Column({ space: 2 }) {
            // åˆ†ç»„åç§°
            Text(group.name)
              .fontSize(12)
              // å½“å‰é€‰ä¸­çš„åˆ†ç»„é«˜äº®æ˜¾ç¤º
              .fontColor(this.activeGroupId === group.id ? '#FFFFFF' : '#DDDDDD')

            // åˆ†ç»„å¹³å‡æ¶¨è·Œå¹…ï¼ˆæ¥è‡ªç¼“å­˜è¡Œæƒ…çš„ç»Ÿè®¡ç»“æœï¼‰
            Text(this.getGroupAvgPctText(group.id))
              .fontSize(10)
              .fontColor(this.getGroupAvgPctColor(group.id))
          }
          // æ¯ä¸ªåˆ†ç»„ chip çš„æ•´ä½“æ ·å¼
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(this.activeGroupId === group.id ? '#2A2A2A' : '#161616')
          .borderRadius(12)
          .onClick(async () => {
            // ç‚¹å‡»åˆ‡æ¢å½“å‰åˆ†ç»„
            this.activeGroupId = group.id

            // å…ˆåŒæ­¥ä¸€æ¬¡ activeStocksï¼Œä¿è¯åˆ—è¡¨ç«‹å³åˆ‡æ¢
            this.syncActiveStocks()

            // é¢„çƒ­è¯¥åˆ†ç»„ä¸‹æ‰€æœ‰è‚¡ç¥¨çš„è¡Œæƒ…ï¼ˆè¡¥é½ç¼“å­˜ï¼‰
            await this.preloadActiveGroupQuotes()

            // è¡Œæƒ…å›æ¥åå†åŒæ­¥ä¸€æ¬¡ï¼Œç¡®ä¿ç»Ÿè®¡å’Œåˆ—è¡¨éƒ½ç”¨åˆ°æœ€æ–°æ•°æ®
            this.syncActiveStocks()
          })
        }, (group: StockGroup) => group.id.toString())
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
    }
    // æ¨ªå‘æ»šåŠ¨ï¼Œç”¨æ¥å®¹çº³è¾ƒå¤šåˆ†ç»„
    .scrollable(ScrollDirection.Horizontal)
  }


  // æ–°å»ºåˆ†ç»„è¾“å…¥æ ï¼šè¾“å…¥åˆ†ç»„åå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªé€‰åˆ†ç»„
  @Builder
  private buildCreateGroupBar() {
    Row({ space: 8 }) {
      // åˆ†ç»„åè¾“å…¥æ¡†ï¼ˆå—æ§è¾“å…¥ï¼Œå€¼ç›´æ¥ç»‘å®šåˆ° newGroupNameï¼‰
      TextInput({
        placeholder: 'æ–°å»ºåˆ†ç»„åï¼ˆå¦‚ ç§‘æŠ€è‚¡ï¼‰',
        text: this.newGroupName
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          // å®æ—¶æ›´æ–° stateï¼Œåé¢ç‚¹å‡»â€œåˆ›å»ºâ€æ—¶ç›´æ¥ç”¨
          this.newGroupName = v.trim();
        })

      // åˆ›å»ºæŒ‰é’®ï¼šæ ¡éªŒè¾“å…¥å¹¶è°ƒç”¨ createGroup
      Button('åˆ›å»º')
        .height(32)
        .onClick(async () => {
          const name: string = this.newGroupName.trim();
          if (name.length === 0) {
            // ç®€å•çš„è¾“å…¥æ ¡éªŒæç¤º
            this.watchlistMsg = 'è¯·è¾“å…¥åˆ†ç»„å';
            return;
          }

          // çœŸæ­£åˆ›å»ºåˆ†ç»„ï¼ˆå†…éƒ¨ä¼šæ›´æ–° groups / activeGroupId / æŒä¹…åŒ–ï¼‰
          await this.createGroup(name);
        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }


  // åˆ†ç»„ç»Ÿè®¡å¡ï¼šå±•ç¤ºå½“å‰ active åˆ†ç»„çš„æ•´ä½“æƒ…å†µï¼ˆè‚¡ç¥¨æ•° / ä¸Šæ¶¨ / ä¸‹è·Œ / å¹³å‡æ¶¨è·Œå¹…ï¼‰
  @Builder
  private buildGroupStatsCard() {
    Column() {
      Row({ space: 12 }) {

        // è‚¡ç¥¨æ€»æ•°
        Column({ space: 4 }) {
          Text('è‚¡ç¥¨æ•°')
            .fontSize(10)
            .fontColor('#777777')
          Text(this.activeStatStockCount)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }.width('22%')

        // ä¸Šæ¶¨æ•°é‡
        Column({ space: 4 }) {
          Text('ä¸Šæ¶¨')
            .fontSize(10)
            .fontColor('#777777')
          Text(this.activeStatUp)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }.width('22%')

        // ä¸‹è·Œæ•°é‡
        Column({ space: 4 }) {
          Text('ä¸‹è·Œ')
            .fontSize(10)
            .fontColor('#777777')
          Text(this.activeStatDown)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }.width('22%')

        // å¹³å‡æ¶¨è·Œå¹…ï¼ˆå¯èƒ½æ˜¯ '--'ï¼Œè¡¨ç¤ºå½“å‰è¿˜æ²¡æœ‰æœ‰æ•ˆè¡Œæƒ…ï¼‰
        Column({ space: 4 }) {
          Text('å‡æ¶¨è·Œ')
            .fontSize(10)
            .fontColor('#777777')
          Text(this.activeStatAvgPct)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
        }.width('22%')
      }
      .width('100%')
      .padding(12)
      .margin({ left: 16, right: 16, bottom: 8 })
      .backgroundColor('#101010')
      .borderRadius(14)
    }
    // key é‡Œå¸¦ä¸Šåˆ†ç»„ / è¡Œæƒ… / ç»Ÿè®¡ç‰ˆæœ¬å·ï¼Œç¡®ä¿ç›¸å…³æ•°æ®å˜åŒ–æ—¶è¿™å¼ ç»Ÿè®¡å¡ä¼šé‡æ–°æ¸²æŸ“
    .key(`stats-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }

  // æ·»åŠ è‚¡ç¥¨è¾“å…¥æ ï¼šå‘å½“å‰ active åˆ†ç»„é‡Œè¿½åŠ è‚¡ç¥¨ä»£ç 
  @Builder
  private buildAddStockBar() {
    Row({ space: 8 }) {
      // è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†ï¼ˆå—æ§è¾“å…¥ï¼Œç»‘å®š addStockCodeInputï¼‰
      TextInput({
        placeholder: 'è¾“å…¥ 6 ä½è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 300750ï¼‰',
        text: this.addStockCodeInput
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          // å®æ—¶åŒæ­¥è¾“å…¥å€¼ï¼Œç‚¹å‡»â€œæ·»åŠ â€æ—¶ç›´æ¥ä½¿ç”¨
          this.addStockCodeInput = v.trim();
        })

      // æ·»åŠ æŒ‰é’®ï¼šæ ¡éªŒè¾“å…¥å¹¶æŠŠè‚¡ç¥¨åŠ åˆ°å½“å‰åˆ†ç»„
      Button('æ·»åŠ ')
        .height(32)
        .onClick(async () => {
          const code: string = this.addStockCodeInput.trim();

          // åŸºæœ¬æ ¡éªŒï¼šå¿…é¡»æ˜¯ 6 ä½ä»£ç 
          if (code.length !== 6) {
            this.watchlistMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç ';
            return;
          }

          // æ°¸è¿œä»¥å½“å‰ activeGroupId ä¸ºå‡†ï¼Œé¿å… Builder é—­åŒ…é‡Œæ‹¿åˆ°æ—§å€¼
          const gid: number = this.activeGroupId;
          if (gid < 0) {
            this.watchlistMsg = 'å½“å‰æ²¡æœ‰å¯ç”¨åˆ†ç»„';
            return;
          }

          // è°ƒç”¨åˆ†ç»„é€»è¾‘æ·»åŠ è‚¡ç¥¨ï¼ˆå†…éƒ¨ä¼šå»é‡ã€æŒä¹…åŒ–ã€åˆ·æ–°ç»Ÿè®¡ï¼‰
          await this.addStocksToGroup(gid, [code]);

          // ç®€å•çš„æ“ä½œåé¦ˆæç¤º
          this.watchlistMsg = `å·²å°è¯•æ·»åŠ ï¼š${code} -> group=${gid}`;
        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }

  // è‡ªé€‰åˆ—è¡¨ä¸­çš„å•è¡Œè‚¡ç¥¨é¡¹ï¼šå±•ç¤ºåç§° / ä»£ç  / è¡Œæƒ…ä¿¡æ¯ï¼Œå¹¶æä¾›åˆ é™¤å…¥å£
  @Builder
  private buildStockRefRow(groupId: number, s: StockRef) {
    ListItem() {
      Row() {
        // å·¦ä¾§ï¼šè‚¡ç¥¨åç§° + ä»£ç 
        Column({ space: 4 }) {
          // åç§°ä¼˜å…ˆä»è¡Œæƒ…ç¼“å­˜é‡Œå–ï¼Œå…œåº•ç”¨ StockRef é‡Œçš„ name / å ä½ç¬¦
          Text(this.getStockRowName(s))
            .fontSize(14)
            .fontColor(Color.White)

          // è‚¡ç¥¨ä»£ç ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
          Text(s.code)
            .fontSize(11)
            .fontColor('#666666')
        }

        Blank() // æ’‘å¼€å·¦å³ä¸¤åˆ—

        // å³ä¾§ï¼šä»·æ ¼ + æ¶¨è·Œä¿¡æ¯ï¼ˆå³å¯¹é½ï¼Œæ›´åƒè¡Œæƒ…åˆ—è¡¨ï¼‰
        Column({ space: 4 }) {
          // å½“å‰ä»·æ ¼ï¼Œé¢œè‰²æŒ‰æ¶¨è·ŒåŒºåˆ†
          Text(this.getStockRowPriceText(s))
            .fontSize(14)
            .fontColor(this.getStockRowPriceColor(s))
            .textAlign(TextAlign.End)

          // æ¶¨è·Œé¢ + æ¶¨è·Œå¹…ï¼ˆæ¬¡è¦ä¿¡æ¯ï¼Œç”¨æµ…ä¸€ç‚¹çš„é¢œè‰²ï¼‰
          Text(this.getStockRowChangeText(s) + '  ' + this.getStockRowPctText(s))
            .fontSize(11)
            .fontColor(this.getStockRowSubColor(s))
            .textAlign(TextAlign.End)
        }

        // åˆ é™¤æŒ‰é’®ï¼šæŠŠå½“å‰è‚¡ç¥¨ä»è¯¥åˆ†ç»„ä¸­ç§»é™¤
        Button('âœ•')
          .height(28)
          .width(28)
          .padding(0)
          .backgroundColor('#1A1A1A')
          .fontColor('#777777')
          .borderRadius(14)
          .onClick(() => {
            // è¿™é‡ŒåªåšåŒæ­¥åˆ é™¤è°ƒç”¨ï¼Œä¸ç”¨ asyncï¼Œé¿å…æ‰‹åŠ¿é“¾è·¯å˜å¤æ‚
            this.removeStocksFromGroup(groupId, [s.code])
          })
      }
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      .backgroundColor('#101010')
      .borderRadius(12)
      .width('100%')
    }
    // è¡Œä¸è¡Œä¹‹é—´ç•™ä¸€ç‚¹é—´è·
    .margin({ bottom: 8 })
    .width('100%')
  }


  // ====== Tab 3ï¼šè¡Œæƒ…é€šçŸ¥ä¸­å¿ƒï¼ˆåªè´Ÿè´£â€œè§„åˆ™çš„å¢åˆ å±•ç¤ºâ€ï¼ŒçœŸæ­£çš„è§¦å‘åœ¨ RuleEngineï¼‰ ======
  @Builder
  private buildNotificationTab() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ ï¼šè¿™é‡Œåªåšæ ‡é¢˜å±•ç¤ºï¼Œä¸æ”¾å¤æ‚äº¤äº’
      Row() {
        Text('é€šçŸ¥è§„åˆ™').fontSize(14).fontColor(Color.White)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // æ–°å¢è§„åˆ™åŒºï¼šæŠŠâ€œç±»å‹ + ä»£ç  + æ¡ä»¶ + æ·»åŠ æŒ‰é’®â€é›†ä¸­æ”¾åœ¨ä¸€èµ·
      Column({ space: 8 }) {
        Column({ space: 8 }) {
          // è§„åˆ™ç±»å‹ï¼šè‚¡ç¥¨ / æŒ‡æ•°ï¼ˆäºŒé€‰ä¸€ï¼Œå½±å“ placeholder å’Œåç«¯æŸ¥è¯¢ typeï¼‰
          Row({ space: 6 }) {
            this.buildRuleTypeChip('è‚¡ç¥¨', 'stock')
            this.buildRuleTypeChip('æŒ‡æ•°', 'index')
          }

          Row({ space: 8 }) {
            // ä»£ç è¾“å…¥ï¼š6 ä½ï¼›placeholder ä¼šè·Ÿéšå½“å‰ ruleQuoteType åˆ‡æ¢
            TextInput({
              placeholder: this.ruleQuoteType === 'stock' ? 'è‚¡ç¥¨ä»£ç (6ä½)' : 'æŒ‡æ•°ä»£ç (6ä½)',
              text: this.ruleStockCodeInput
            })
              .width('28%')
              .height(32)
              .fontSize(13)
              .backgroundColor(Color.White)
              .fontColor(Color.Black)
              // è¾“å…¥æ—¶æŠŠä¸¤è¾¹ç©ºæ ¼å»æ‰ï¼Œé¿å…â€œçœ‹ç€ä¸€æ ·å…¶å®å¤šäº†ç©ºæ ¼â€å¯¼è‡´æ ¡éªŒå¤±è´¥
              .onChange((v: string) => { this.ruleStockCodeInput = v.trim() })

            // æ“ä½œç¬¦é€‰æ‹©ï¼šç”¨ä¸¤ä¸ªæŒ‰é’®ï¼ˆâ‰¥ / â‰¤ï¼‰ï¼Œé¿å… Picker çš„æ‰‹åŠ¿å†²çªå’Œç±»å‹éº»çƒ¦
            Row({ space: 6 }) {
              Text('â‰¥')
                .fontSize(12)
                .fontColor(this.ruleOpIndex === 0 ? '#FFFFFF' : '#AAAAAA')
                .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                .backgroundColor(this.ruleOpIndex === 0 ? '#333333' : '#181818')
                .borderRadius(10)
                .onClick(() => { this.ruleOpIndex = 0 })

              Text('â‰¤')
                .fontSize(12)
                .fontColor(this.ruleOpIndex === 1 ? '#FFFFFF' : '#AAAAAA')
                .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                .backgroundColor(this.ruleOpIndex === 1 ? '#333333' : '#181818')
                .borderRadius(10)
                .onClick(() => { this.ruleOpIndex = 1 })
            }

            // é˜ˆå€¼è¾“å…¥ï¼šæ¯”å¦‚ 12.34ï¼›æœ€ç»ˆä¼šæ‹¼è¿› conditionTextï¼ˆ"ä»·æ ¼ â‰¥ xx.xx"ï¼‰
            TextInput({ placeholder: 'é˜ˆå€¼', text: this.rulePriceInput })
              .width('18%')
              .height(32)
              .fontSize(13)
              .backgroundColor(Color.White)
              .fontColor(Color.Black)
              .onChange((v: string) => { this.rulePriceInput = v.trim() })

            // æ·»åŠ æŒ‰é’®ï¼šçœŸæ­£çš„æ ¡éªŒ / å»é‡ / å†™å…¥ prefs éƒ½åœ¨ addNotifyRuleFromUI é‡Œåš
            Button('æ·»åŠ ')
              .height(32)
              .onClick(async () => { await this.addNotifyRuleFromUI() })
          }
        }

        // UI æç¤ºï¼šæ¯”å¦‚â€œè¯·è¾“å…¥ 6 ä½ä»£ç  / å·²æ·»åŠ å¹¶å¯ç”¨â€
        if (this.ruleMsg.length > 0) {
          Text(this.ruleMsg)
            .fontSize(10)
            .fontColor('#777777')
        }
      }
      .padding({ left: 16, right: 16, bottom: 10 })

      // è§„åˆ™åˆ—è¡¨ï¼šåªæ˜¯æŠŠ notifyRules æ¸²æŸ“æˆå¯æ“ä½œçš„è¡Œï¼ˆå¯ç”¨/åˆ é™¤ç­‰ï¼‰
      List() {
        ForEach(this.notifyRules, (rule: NotifyRule) => {
          this.buildNotifyRuleItem(rule)
        }, (rule: NotifyRule) => rule.id.toString())
      }
      // ç”¨ç‰ˆæœ¬å·åš keyï¼šç¡®ä¿å¢åˆ è§„åˆ™å List èƒ½é‡æ–°åˆ›å»ºï¼Œé¿å…å¶å‘ä¸åˆ·æ–°
      .key(`notifyRules-${this.notifyRulesVer}`)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }


  // å•æ¡é€šçŸ¥è§„åˆ™çš„åˆ—è¡¨è¡Œï¼šå±•ç¤ºâ€œç±»å‹ + åç§°/ä»£ç  + æ¡ä»¶â€ï¼Œå¹¶æä¾›åˆ é™¤å…¥å£
  @Builder
  private buildNotifyRuleItem(rule: NotifyRule) {
    ListItem() {
      Row({ space: 10 }) {
        Column({ space: 4 }) {
          Row({ space: 6 }) {
            // ç±»å‹å°æ ‡ç­¾ï¼šè®©ç”¨æˆ·ä¸€çœ¼èƒ½åŒºåˆ†è¿™æ¡è§„åˆ™æ˜¯è‚¡ç¥¨è¿˜æ˜¯æŒ‡æ•°
            Text(rule.quoteType === 'stock' ? 'è‚¡ç¥¨' : 'æŒ‡æ•°')
              .fontSize(10)
              .fontColor('#AAAAAA')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor('#1A1A1A')
              .borderRadius(6)

            // ä¸»æ ‡é¢˜ï¼šæ ‡çš„åç§° + ä»£ç ï¼ˆè·Ÿè¡Œæƒ…å¡ç‰‡çš„å±•ç¤ºä¹ æƒ¯ä¿æŒä¸€è‡´ï¼‰
            Text(`${rule.stockName}ï¼ˆ${rule.stockCode}ï¼‰`)
              .fontSize(13)
              .fontColor(Color.White)
          }

          // æ¡ä»¶æ–‡æœ¬ï¼šç›´æ¥å¤ç”¨ä½ ä¿å­˜çš„ conditionTextï¼ˆä¾‹å¦‚ â€œä»·æ ¼ â‰¥ 12.34â€ï¼‰
          Text(rule.conditionText)
            .fontSize(11)
            .fontColor('#BBBBBB')
        }
        .layoutWeight(1) // å·¦ä¾§ä¿¡æ¯åŒºå æ»¡å‰©ä½™ç©ºé—´ï¼ŒæŠŠâ€œåˆ é™¤â€æŒ‰é’®é¡¶åˆ°å³è¾¹

        // åˆ é™¤æŒ‰é’®ï¼šåªè´Ÿè´£è§¦å‘åˆ é™¤é€»è¾‘ï¼Œå…·ä½“æŒä¹…åŒ–åœ¨ deleteRule é‡Œåš
        Button('åˆ é™¤')
          .height(28)
          .padding({ left: 10, right: 10 })
          .backgroundColor('#1A1A1A')
          .fontColor('#FF7875')
          .borderRadius(10)
          .onClick(async () => {
            await this.deleteRule(rule.id)
          })
      }
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#101010')
    }
    .margin({ bottom: 1 }) // è¡Œä¸è¡Œä¹‹é—´ç•™ä¸€ç‚¹ç¼ï¼Œè§†è§‰ä¸Šæ›´åƒâ€œåˆ—è¡¨â€
  }


  // è§„åˆ™ç±»å‹é€‰æ‹©æŒ‰é’®ï¼šç”¨äºåœ¨â€œè‚¡ç¥¨ / æŒ‡æ•°â€ä¹‹é—´åˆ‡æ¢å½“å‰è¦åˆ›å»ºçš„é€šçŸ¥è§„åˆ™ç±»å‹
  @Builder
  private buildRuleTypeChip(label: string, t: 'index' | 'stock') {
    Text(label)
      .fontSize(12)
      // å½“å‰é€‰ä¸­çš„ç±»å‹é«˜äº®æ˜¾ç¤ºï¼Œå…¶ä½™ç½®ç°
      .fontColor(this.ruleQuoteType === t ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 6, bottom: 6 })
      .backgroundColor(this.ruleQuoteType === t ? '#333333' : '#181818')
      .borderRadius(10)
      .onClick(() => {
        // ç‚¹å‡»åç›´æ¥åˆ‡æ¢å½“å‰è§„åˆ™çš„ quoteType
        // åç»­è¾“å…¥æ¡† placeholderã€æŸ¥è¯¢ç±»å‹éƒ½ä¼šéšä¹‹å˜åŒ–
        this.ruleQuoteType = t
      })
  }

}

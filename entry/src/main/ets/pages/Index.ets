// entry/src/main/ets/pages/Index.ets
import { TabBarOptions } from '@kit.ArkUI';
import http from '@ohos.net.http';
import preferences from '@ohos.data.preferences';
import { formBindingData, formProvider } from '@kit.FormKit';
import { AppStorageV2 } from '@kit.ArkUI'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM } from '../common/ActiveFormatState'

import notificationManager from '@ohos.notificationManager'
import notification from '@ohos.notification'
import { RuleEngine, NotifyRuleLite } from '../service/RuleEngine'
import wantAgent from '@ohos.wantAgent'

const DOMAIN = 0x0000
const TAG: string = 'HarmonyStock'




// ====== é€šç”¨è¡Œæƒ…ç»“æ„ï¼ˆæŒ‡æ•° / è‚¡ç¥¨ï¼‰ ======
interface Quote {
  code: string;
  name: string;
  price: number;
  change: number;
  changePercent: number;
  type: 'index' | 'stock';
}

interface BackendQuote {
  code: string;
  name: string;
  price: number;
  change: number;
  change_percent: number;
}

// ====== è‡ªé€‰è‚¡ / é€šçŸ¥ç”¨ç»“æ„ï¼ˆä¿æŒä½ åŸæ¥çš„ï¼‰ ======
interface StockQuote {
  name: string;
  code: string;
  price: number;
  change: number;
  changePercent: number;
}

interface NotifyRule {
  id: number;
  stockCode: string;
  stockName: string;
  conditionText: string; // æ¯”å¦‚ "ä»·æ ¼ â‰¥ 25.00"
  enabled: boolean;
}

// ====== K çº¿ç‚¹ç»“æ„ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ ======
interface KLinePoint {
  date: string;
  open: number;
  high: number;
  low: number;
  close: number;
  volume: number;
}

interface KlineGeom {
  upperWick: number;   // ä¸Šå½±çº¿é«˜åº¦
  bodyHeight: number;  // å®ä½“é«˜åº¦
  lowerWick: number;   // ä¸‹å½±çº¿é«˜åº¦
  topGap: number;      // æ•´æ ¹èœ¡çƒ›è·ç¦»é¡¶éƒ¨çš„ç©ºç™½
  isUp: boolean;       // æ˜¯å¦ä¸Šæ¶¨ï¼ˆclose >= openï¼‰
}


interface StockRef {
  code: string;      // 6 ä½
  name?: string;     // å¯é€‰ï¼šç¬¬ä¸€æ¬¡åŠ å…¥æ—¶å¡«ï¼›åç»­å¯ç”±åç«¯ quote è¡¥å…¨
}

interface StockGroup {
  id: number;
  name: string;
  stocks: StockRef[];
  createdAt: number;
  version: number; // âœ… ç”¨äºå¼ºåˆ¶ List è¯†åˆ«ç»“æ„å˜åŒ–
}

interface GroupStats {
  groupId: number;
  stockCount: number;
  upCount: number;        // å½“æ—¥ä¸Šæ¶¨æ•°é‡ï¼ˆéœ€è¦è¡Œæƒ…æ•°æ®ï¼‰
  downCount: number;      // å½“æ—¥ä¸‹è·Œæ•°é‡
  avgChangePercent: number; // å¹³å‡æ¶¨è·Œå¹…ï¼ˆéœ€è¦è¡Œæƒ…æ•°æ®ï¼‰
}

interface ActiveGroupStats {
  stockCount: string;
  up: string;
  down: string;
  avgPct: string;
}



interface WidgetBindData {
  formId: string
  title: string
  code: string
  name: string
  priceText: string
  changeText: string
  pctText: string
  tsText: string
  hasPrev: boolean
  hasNext: boolean
}


// ====== é¡µé¢ç»„ä»¶ ======
@Entry
@Component
struct HarmonyStockPage {
  // é¡¶éƒ¨ Tabï¼š0 å¸‚åœº 1 è‡ªé€‰ 2 é€šçŸ¥
  @State currentTabIndex: number = 0;

  // å½“å‰è¡Œæƒ…æ¨¡å¼ï¼šæŒ‡æ•° / è‚¡ç¥¨
  @State currentMode: 'index' | 'stock' = 'index';

  // è¡Œæƒ…åˆ—è¡¨çŠ¶æ€ï¼ˆstripï¼‰
  @State listLoading: boolean = false;
  @State listError: string = '';

  // æœç´¢çŠ¶æ€
  @State searchCode: string = '';
  @State searchLoading: boolean = false;
  @State searchError: string = '';

  // è¡Œæƒ…å¡ç‰‡ï¼šåå°å®æ—¶ + æœç´¢ç»“æœ
  @State marketQuotes: Quote[] = [];
  @State searchedQuotes: Quote[] = [];

  // å½“å‰é€‰ä¸­çš„æ ‡çš„ï¼ˆç”¨äº K çº¿ï¼‰
  @State selectedQuoteCode: string = '';
  @State selectedQuoteName: string = '';
  @State selectedQuoteType: 'index' | 'stock' = 'index';

  // å½“å‰ K çº¿å‘¨æœŸï¼š0 æ—¥K 1 å‘¨K 2 æœˆK
  @State klinePeriodIndex: number = 0;

  // K çº¿è¯·æ±‚çŠ¶æ€
  @State klineLoading: boolean = false;
  @State klineError: string = '';
  @State klinePoints: KLinePoint[] = [];

  // K çº¿å‡ ä½•ä¿¡æ¯ & åæ ‡è½´
  @State klineGeoms: KlineGeom[] = [];
  @State klineMinPrice: number = 0;
  @State klineMaxPrice: number = 0;
  @State klineXLabels: string[] = [];

  private readonly KLINE_PLOT_H: number = 180;     // èœ¡çƒ›ç»˜å›¾åŒºé«˜åº¦ï¼ˆè®¡ç®— + æ¸²æŸ“ç»Ÿä¸€ï¼‰
  private readonly KLINE_LABEL_H: number = 24;     // xè½´æ ‡ç­¾åŒºåŸŸé«˜åº¦
  private readonly KLINE_CARD_INNER_PAD: number = 16;


  // å½“å‰é€‰ä¸­çš„ K çº¿ï¼ˆç”¨äºæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯æ¡ + é«˜äº®ï¼‰
  @State selectedKlineIndex: number = -1;
  @State selectedKlineDate: string = '';
  @State selectedKlineOpen: number = 0;
  @State selectedKlineHigh: number = 0;
  @State selectedKlineLow: number = 0;
  @State selectedKlineClose: number = 0;

  // æ¯æ ¹ K çº¿å®ä½“å®½åº¦ & é—´è·
  private candleBodyWidth: number = 8;
  private candleGap: number = 4;

  @State expandedKeys: string[] = [];
  // è®°å½•æ¯å¼ å¡ç‰‡æ˜¯å¦å±•å¼€ï¼škey = `${type}-${code}`
  @State cardExpandedMap: Map<string, boolean> = new Map<string, boolean>();

  private readonly HTTP_CONNECT_TIMEOUT: number = 55000; // 55s
  private readonly HTTP_READ_TIMEOUT: number = 55000;    // 55s

  private readonly PREF_FILE: string = 'harmonystock_watchlist';
  private readonly PREF_KEY_GROUPS: string = 'groups_json';
  private nextGroupId: number = 1;

  @State activeGroupId: number = -1; // å½“å‰é€‰ä¸­çš„åˆ†ç»„
  @State watchlistMsg: string = '';
  @State newGroupName: string = '';
  @State addStockCodeInput: string = '';

  @State quoteCache: Map<string, Quote> = new Map<string, Quote>();
  @State quoteCacheVer: number = 0

  @State activeStocks: StockRef[] = []
  @State activeStocksVer: number = 0

  @State activeStatStockCount: string = '0'
  @State activeStatUp: string = '0'
  @State activeStatDown: string = '0'
  @State activeStatAvgPct: string = '--'
  @State activeStatsVer: number = 0   // ä¿ç•™ä¹Ÿè¡Œï¼ˆç”¨äº keyï¼‰

  // âœ… åŠ åœ¨è¿™é‡Œï¼ˆå’Œå…¶ä»–çŠ¶æ€å­—æ®µæ”¾ä¸€èµ·ï¼‰
  @State activeFormId: string = ''

  @State ruleStockCodeInput: string = ''
  @State ruleOpIndex: number = 0        // 0: â‰¥  1: â‰¤
  @State rulePriceInput: string = ''    // é˜ˆå€¼
  @State ruleMsg: string = ''

  @State notifyRulesVer: number = 0

  onPageShow() {
    hilog.error(0x0000, 'INDEX_DEBUG', 'ğŸ”¥ Index onPageShow CALLED')

    // â‘  å…ˆæ¶ˆè´¹ formIdï¼ˆä½ å·²æœ‰ï¼‰
    this.consumeFormIdFromAppStorageV2('onPageShow')

    // â‘¡ å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„è¡Œæƒ…ï¼Œä¸»åŠ¨åŒæ­¥åˆ°æ¡Œé¢å¡ç‰‡
    if (this.activeFormId.length > 0 && this.selectedQuoteCode.length > 0) {
      const q: Quote | null = this.findQuoteInCaches(this.selectedQuoteCode)
      if (q !== null) {
        hilog.error(DOMAIN, TAG,
          '[WIDGET] onPageShow sync current quote code=%{public}s',
          q.code
        )
        this.updateWidgetIfLaunchedFromForm(q)
      }
    }
  }

  private consumeFormIdFromAppStorageV2(from: string): void {
    const st: ActiveFormState | undefined =
      AppStorageV2.connect(ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM, () => new ActiveFormState())

    if (!st) {
      hilog.error(DOMAIN, TAG, '[%{public}s] AppStorageV2.connect failed', from)
      return
    }

    const fid: string = st.formId
    if (fid.length === 0) {
      hilog.info(DOMAIN, TAG, '[%{public}s] no formId in ActiveFormState', from)
      return
    }

    // 1) åŒæ­¥åˆ°é¡µé¢å­—æ®µï¼šåç»­ updateWidgetIfLaunchedFromForm ä¾èµ–å®ƒ
    this.activeFormId = fid

    // 2) æ¶ˆè´¹æ‰ï¼Œé¿å…é‡å¤
    st.formId = ''

    hilog.info(DOMAIN, TAG, '[%{public}s] âœ… consumed formId=%{public}s -> this.activeFormId', from, fid)
  }


  private refreshActiveGroupStats(): void {
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    this.activeStatStockCount = st.stockCount
    this.activeStatUp = st.up
    this.activeStatDown = st.down
    this.activeStatAvgPct = st.avgPct
    this.activeStatsVer += 1
    console.info(`[DBG] stats=${this.activeStatStockCount}, up=${this.activeStatUp}, down=${this.activeStatDown}, avg=${this.activeStatAvgPct}, ver=${this.activeStatsVer}`)

  }


  // ===== è‡ªé€‰ / é€šçŸ¥å‡æ•°æ®ï¼ˆä¿æŒåŸæ ·ï¼‰ =====
  @State groups: StockGroup[] = [
    {
      id: 1,
      name: 'ç§‘æŠ€è‚¡',
      stocks: [
        { name: 'å®å¾·æ—¶ä»£', code: '300750' },
        { name: 'ä¸­èŠ¯å›½é™…', code: '688981' }
      ],
      createdAt: Date.now(),
      version: 0
    },
    {
      id: 2,
      name: 'æ–°èƒ½æº',
      stocks: [
        { name: 'éš†åŸºç»¿èƒ½', code: '601012' }
      ],
      createdAt: Date.now(),
      version: 0
    }
  ];

  @State notifyRules: NotifyRule[] = [
    { id: 999, stockCode: '300750', stockName: 'å®å¾·æ—¶ä»£', conditionText: 'ä»·æ ¼ â‰¥ 1.00', enabled: true },
    { id: 2, stockCode: '601012', stockName: 'éš†åŸºç»¿èƒ½', conditionText: 'ä»·æ ¼ â‰¤ 28.00', enabled: false }
  ]

  private nextRuleId: number = 1000
  private readonly PREF_KEY_RULES: string = 'notify_rules_json'

  // ===== é€šç”¨ï¼šåç«¯è¡Œæƒ… -> å‰ç«¯ Quote =====
  private mapBackendQuote(raw: BackendQuote, type: 'index' | 'stock'): Quote {
    return {
      code: raw.code,
      name: raw.name,
      price: raw.price,
      change: raw.change,
      changePercent: raw.change_percent,
      type: type
    };
  }

  // ===== é¡µé¢ç”Ÿå‘½å‘¨æœŸ =====
  aboutToAppear() {
    this.dbg('aboutToAppear:enter')

    this.loadGroupsFromPrefs().then(async () => {
      await this.loadNotifyRulesFromPrefs()   // âœ… åŠ è¿™ä¸€å¥
      await this.preloadActiveGroupQuotes()
      this.fetchQuotes(this.currentMode)
    })

    RuleEngine.start((): NotifyRuleLite[] => {
      const out: NotifyRuleLite[] = []
      for (let i: number = 0; i < this.notifyRules.length; i++) {
        const r: NotifyRule = this.notifyRules[i]
        out.push({ id: r.id, stockCode: r.stockCode, stockName: r.stockName, conditionText: r.conditionText, enabled: r.enabled })
      }
      return out
    }, 5000, 10000)
  }
  aboutToDisappear(): void {
    RuleEngine.stop()
  }

  // ===== æ‹‰å–è¡Œæƒ…åˆ—è¡¨ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰ =====
  private async fetchQuotes(type: 'index' | 'stock'): Promise<void> {
    const affectUI: boolean = (type === this.currentMode)

    if (affectUI) {
      this.listLoading = true
      this.listError = ''
    }

    const httpRequest = http.createHttp()
    try {
      const url: string = `http://101.43.185.73:8000/api/quote?type=${type}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        const raw: BackendQuote[] = JSON.parse(res.result as string) as BackendQuote[]
        const mapped: Quote[] = raw.map((it: BackendQuote): Quote => this.mapBackendQuote(it, type))

        // å½“å‰æ¨¡å¼ï¼šæ›´æ–°å¸‚åœºåˆ—è¡¨
        if (affectUI) {
          this.marketQuotes = mapped
        }

        // ä¸¤ç§æ¨¡å¼ï¼šéƒ½å†™å…¥ç¼“å­˜ï¼ˆè‡ªé€‰ç»Ÿè®¡ä¾èµ–ï¼‰
        this.mergeQuotesToCache(mapped)

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€åª + æ‹‰Kçº¿ï¼šåªå¯¹å½“å‰æ¨¡å¼ç”Ÿæ•ˆ
        if (affectUI && this.selectedQuoteCode === '' && mapped.length > 0) {
          const first: Quote = mapped[0]
          this.selectedQuoteCode = first.code
          this.selectedQuoteName = first.name
          this.selectedQuoteType = first.type
          const period: string = this.getKlinePeriodParam()
          this.fetchKline(first.type, first.code, period)
        }
      } else {
        if (affectUI) {
          this.listError = `HTTP ${res.responseCode}`
          this.marketQuotes = []
        }
        // éå½“å‰æ¨¡å¼å¤±è´¥ï¼šä¸è¦æ±¡æŸ“ UI
      }
    } catch (e) {
      if (affectUI) {
        this.listError = `${e}`
        this.marketQuotes = []
      }
    } finally {
      httpRequest.destroy()
      if (affectUI) {
        this.listLoading = false
      }
    }
  }



  // ===== æ‹‰å– K çº¿æ•°æ®ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰ =====
  private async fetchKline(
    type: 'index' | 'stock',
    code: string,
    period: string
  ): Promise<void> {
    this.klineLoading = true;
    this.klineError = '';

    const httpRequest = http.createHttp();
    try {
      const url: string =
        `http://101.43.185.73:8000/api/kline` +
          `?type=${type}&code=${code}&period=${period}&limit=60`;

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      });


      if (res.responseCode === 200 && res.result) {
        const raw: KLinePoint[] =
          JSON.parse(res.result as string) as KLinePoint[];

        this.klinePoints = raw;

        // é»˜è®¤é€‰ä¸­æœ€åä¸€æ ¹ K çº¿
        if (this.klinePoints.length > 0) {
          const lastIndex: number = this.klinePoints.length - 1;
          this.onKlineSelected(lastIndex);
        } else {
          this.selectedKlineIndex = -1;
        }

        this.recomputeKlineGeom();
      } else {
        this.klineError = `HTTP ${res.responseCode}`;
        this.klinePoints = [];
        this.klineGeoms = [];
        this.klineXLabels = [];
        this.selectedKlineIndex = -1;
      }
    } catch (e) {
      this.klineError = `${e}`;
      this.klinePoints = [];
      this.klineGeoms = [];
      this.klineXLabels = [];
      this.selectedKlineIndex = -1;
    } finally {
      httpRequest.destroy();
      this.klineLoading = false;
    }
  }

  // ===== æ ¹æ®å½“å‰å‘¨æœŸç´¢å¼• -> period å‚æ•° =====
  private getKlinePeriodParam(): string {
    if (this.klinePeriodIndex === 1) {
      return 'week';   // å‘¨ K
    }
    if (this.klinePeriodIndex === 2) {
      return 'month';  // æœˆ K
    }
    return 'day';      // é»˜è®¤æ—¥ K
  }

  // ===== è®¡ç®— K çº¿å‡ ä½•ä¿¡æ¯ & åæ ‡è½´ =====
  private recomputeKlineGeom(): void {
    const points: KLinePoint[] = this.klinePoints;
    const geoms: KlineGeom[] = [];
    const labels: string[] = [];

    if (points.length === 0) {
      this.klineGeoms = geoms;
      this.klineXLabels = labels;
      return;
    }

    // 1) æ‰¾æœ€é«˜ä»· / æœ€ä½ä»·
    let minPrice: number = points[0].low;
    let maxPrice: number = points[0].high;

    for (let i: number = 1; i < points.length; i++) {
      const p: KLinePoint = points[i];
      if (p.low < minPrice) {
        minPrice = p.low;
      }
      if (p.high > maxPrice) {
        maxPrice = p.high;
      }
    }

    // range é˜²å¾¡
    let range: number = maxPrice - minPrice;
    if (range <= 0) {
      range = 1.0;
      maxPrice = minPrice + range;
    }

    this.klineMinPrice = minPrice;
    this.klineMaxPrice = maxPrice;

    // 2) ç»˜å›¾åŒºé«˜åº¦ç»Ÿä¸€ä½¿ç”¨å¸¸é‡ï¼ˆå¿…é¡»å’Œ UI çš„èœ¡çƒ›åŒºåŸŸ .height ä¸€è‡´ï¼‰
    const fullHeight: number = this.KLINE_PLOT_H;

    // æœ€å°å¯è§é«˜åº¦ï¼ˆé˜²æ­¢â€œåå­—çº¿â€çœ‹ä¸åˆ°ï¼‰
    const minBody: number = 4;
    const minWick: number = 2;

    // ä»·æ ¼ -> y åæ ‡ï¼ˆ0 é¡¶éƒ¨ï¼ŒfullHeight åº•éƒ¨ï¼‰
    const priceToY = (price: number): number => {
      const y: number = (maxPrice - price) / range * fullHeight;
      if (y < 0) {
        return 0;
      }
      if (y > fullHeight) {
        return fullHeight;
      }
      return y;
    };

    // 3) é€ä¸ªç‚¹ç®—å‡ ä½•
    for (let i: number = 0; i < points.length; i++) {
      const pt: KLinePoint = points[i];

      // å°†å…³é”®ä»·æ ¼æ˜ å°„åˆ° y
      const yHigh: number = priceToY(pt.high);
      const yLow: number = priceToY(pt.low);
      const yOpen: number = priceToY(pt.open);
      const yClose: number = priceToY(pt.close);

      // å®ä½“ä¸Šä¸‹è¾¹ç•Œ
      let yTopBody: number = Math.min(yOpen, yClose);
      let yBottomBody: number = Math.max(yOpen, yClose);

      // å®ä½“æœ€å°é«˜åº¦ä¿è¯
      if (yBottomBody - yTopBody < minBody) {
        const mid: number = (yTopBody + yBottomBody) / 2.0;
        yTopBody = mid - minBody / 2.0;
        yBottomBody = mid + minBody / 2.0;

        // è£å‰ªåˆ°ç»˜å›¾åŒºèŒƒå›´
        if (yTopBody < 0) {
          yTopBody = 0;
          yBottomBody = minBody;
        }
        if (yBottomBody > fullHeight) {
          yBottomBody = fullHeight;
          yTopBody = fullHeight - minBody;
        }
      }

      // ä¸Šå½±çº¿ï¼šhigh -> å®ä½“ä¸Šè¾¹
      let upperWick: number = yTopBody - yHigh;
      if (upperWick < minWick) {
        upperWick = minWick;
      }

      // ä¸‹å½±çº¿ï¼šå®ä½“ä¸‹è¾¹ -> low
      let lowerWick: number = yLow - yBottomBody;
      if (lowerWick < minWick) {
        lowerWick = minWick;
      }

      // é¡¶éƒ¨ç©ºç™½ = yHigh
      let topGap: number = yHigh;
      if (topGap < 0) {
        topGap = 0;
      }
      if (topGap > fullHeight) {
        topGap = fullHeight;
      }

      // é¢å¤–é˜²å¾¡ï¼šé¿å… topGap + wick + body è¶…å‡ºå®¹å™¨å¯¼è‡´æº¢å‡º
      // å¦‚æœç¡®å®æº¢å‡ºï¼Œä¼˜å…ˆå‹ç¼© topGapï¼ˆä¸åŠ¨å®ä½“/å½±çº¿ï¼‰
      const totalH: number = topGap + upperWick + (yBottomBody - yTopBody) + lowerWick;
      if (totalH > fullHeight) {
        const overflow: number = totalH - fullHeight;
        topGap = topGap - overflow;
        if (topGap < 0) {
          topGap = 0;
        }
      }

      geoms.push({
        upperWick: upperWick,
        bodyHeight: (yBottomBody - yTopBody),
        lowerWick: lowerWick,
        topGap: topGap,
        isUp: pt.close >= pt.open
      });
    }

    // 4) x è½´æ ‡ç­¾ï¼šæœ€å¤š 5 ä¸ªï¼Œå‡åŒ€å–æ ·
    const total: number = points.length;
    const maxLabels: number = 5;
    const actualLabels: number = total >= maxLabels ? maxLabels : total;

    if (actualLabels > 0) {
      const lastIndex: number = total - 1;
      for (let i: number = 0; i < actualLabels; i++) {
        let idx: number;
        if (actualLabels === 1) {
          idx = 0;
        } else {
          idx = Math.floor(i * lastIndex / (actualLabels - 1));
        }

        const dateStr: string = points[idx].date;
        const label: string = dateStr.length >= 5 ? dateStr.substring(5) : dateStr;
        labels.push(label);
      }
    }

    this.klineGeoms = geoms;
    this.klineXLabels = labels;
  }


  // ===== é€‰ä¸­æŸä¸€æ ¹ K çº¿ =====
  private onKlineSelected(index: number): void {
    if (index < 0 || index >= this.klinePoints.length) {
      return;
    }

    const pt: KLinePoint = this.klinePoints[index];

    this.selectedKlineIndex = index;
    this.selectedKlineDate = pt.date;
    this.selectedKlineOpen = pt.open;
    this.selectedKlineHigh = pt.high;
    this.selectedKlineLow = pt.low;
    this.selectedKlineClose = pt.close;
  }

  // ===== å»æ‰ strip ä¸­æŸä¸ªæ ‡çš„ =====
  private removeQuoteCard(code: string, type: 'index' | 'stock'): void {
    this.searchedQuotes = this.searchedQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );
    this.marketQuotes = this.marketQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );

    // å¦‚æœåˆ çš„æ˜¯å½“å‰é€‰ä¸­æ ‡çš„ï¼Œé¡ºå¸¦æ¸…ç©º K çº¿
    if (this.selectedQuoteCode === code && this.selectedQuoteType === type) {
      this.selectedQuoteCode = '';
      this.selectedQuoteName = '';
      this.selectedKlineIndex = -1;
      this.klinePoints = [];
      this.klineGeoms = [];
      this.klineXLabels = [];
    }
  }

  // ===== æ ¹æ®ä»£ç æŸ¥è¯¢å•ä¸ªæ ‡çš„ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ =====
  private async queryQuoteByCode(): Promise<void> {
    const code: string = this.searchCode.trim()

    if (code.length !== 6) {
      this.searchError = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    this.searchLoading = true
    this.searchError = ''

    const httpRequest = http.createHttp()
    try {
      const type: 'index' | 'stock' = this.currentMode
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=${type}&code=${code}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const newItem: Quote = this.mapBackendQuote(backendItem, type)

        this.mergeQuotesToCache([newItem])

        // åªä¿ç•™å½“å‰æ¨¡å¼ + å»é‡ + æ–°ç»“æœç½®é¡¶
        const next: Quote[] = [newItem]
        for (let i: number = 0; i < this.searchedQuotes.length; i++) {
          const q: Quote = this.searchedQuotes[i]
          if (q.type !== type) continue
          if (q.code === newItem.code && q.type === newItem.type) continue
          next.push(q)
        }
        this.searchedQuotes = next
        return
      }

      if (res.responseCode === 404) {
        this.searchError = 'æœªæ‰¾åˆ°è¯¥ä»£ç '
      } else {
        this.searchError = `HTTP ${res.responseCode}`
      }
    } catch (e) {
      this.searchError = `${e}`
    } finally {
      httpRequest.destroy()
      this.searchLoading = false
    }
  }

  // ===== è®¡ç®—æ•´æ®µ K çº¿åŒºåŸŸæ€»å®½åº¦ =====
  private getKlineTotalWidth(): number {
    const count: number = this.klineGeoms.length;
    if (count <= 0) {
      return 0;
    }
    return count * this.candleBodyWidth + (count - 1) * this.candleGap;
  }

  private async loadGroupsFromPrefs(): Promise<void> {
    this.dbg('loadGroupsFromPrefs:enter')
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)
    const jsonStr: string = (await pref.get(this.PREF_KEY_GROUPS, '')) as string

    if (jsonStr.trim().length === 0) {
      const g: StockGroup = { id: 1, name: 'é»˜è®¤åˆ†ç»„', stocks: [], createdAt: Date.now(), version: 0 }
      this.groups = [g]
      this.activeGroupId = 1
      this.nextGroupId = 2
      await this.saveGroupsToPrefs()

      this.syncActiveStocks() // âœ… æ”¾è¿™é‡Œï¼ˆé»˜è®¤åˆ†ç»„åˆ†æ”¯ï¼‰
      this.dbg('loadGroupsFromPrefs:initDefault')
      return
    }

    // âœ… parsed å¿…é¡»å…ˆå£°æ˜
    const parsed: StockGroup[] = this.safeParseGroups(jsonStr)
    this.groups = parsed

    let maxId: number = 0
    for (let i: number = 0; i < parsed.length; i++) {
      if (parsed[i].id > maxId) maxId = parsed[i].id
    }
    this.nextGroupId = maxId + 1

    this.activeGroupId = parsed.length > 0 ? parsed[0].id : -1

    this.syncActiveStocks() // âœ… æ”¾è¿™é‡Œï¼ˆparsed åˆ†æ”¯ï¼Œä¸”åœ¨ activeGroupId ä¹‹åï¼‰
    this.dbg('loadGroupsFromPrefs:done')
  }


  private async saveGroupsToPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE);
    const jsonStr: string = JSON.stringify(this.groups);
    await pref.put(this.PREF_KEY_GROUPS, jsonStr);
    await pref.flush();
  }

  // ä¸ç”¨ any/unknownï¼šå¯¹ç»“æ„åšå…œåº•æ ¡éªŒ
  private safeParseGroups(jsonStr: string): StockGroup[] {
    try {
      const rawObj: Object = JSON.parse(jsonStr) as Object;
      if (!Array.isArray(rawObj)) {
        return [];
      }

      const arr: Object[] = rawObj as Object[];
      const result: StockGroup[] = [];

      for (let i: number = 0; i < arr.length; i++) {
        const item: Record<string, Object> = arr[i] as Record<string, Object>;

        const id: number = Number(item['id']);
        const name: string = String(item['name'] ?? '');
        const createdAt: number = Number(item['createdAt'] ?? Date.now());
        const version: number = Number(item['version'] ?? 0); // âœ… è€æ•°æ®é»˜è®¤ 0

        const stocksRaw: Object = item['stocks'] ?? [];
        const stocks: StockRef[] = [];

        if (Array.isArray(stocksRaw)) {
          const sr: Object[] = stocksRaw as Object[];
          for (let j: number = 0; j < sr.length; j++) {
            const s: Record<string, Object> = sr[j] as Record<string, Object>;
            const code: string = String(s['code'] ?? '').trim();
            if (code.length === 6) {
              const ref: StockRef = { code: code };
              const nm: string = String(s['name'] ?? '').trim();
              if (nm.length > 0) {
                ref.name = nm;
              }
              stocks.push(ref);
            }
          }
        }

        if (!Number.isNaN(id) && name.length > 0) {
          result.push({ id, name, stocks, createdAt, version });
        }
      }
      return result;
    } catch (e) {
      return [];
    }
  }

  private findGroupIndex(groupId: number): number {
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id === groupId) {
        return i;
      }
    }
    return -1;
  }

  private async createGroup(name: string): Promise<void> {
    const n: string = name.trim();
    if (n.length === 0) return;

    const g: StockGroup = { id: this.nextGroupId, name: n, stocks: [], createdAt: Date.now(), version: 0 };
    this.nextGroupId += 1;

    const copy: StockGroup[] = [g, ...this.groups];
    this.groups = copy;
    this.activeGroupId = g.id;

    // âœ… å…³é”®ï¼šç«‹åˆ»è®© UI çš„ active é“¾è·¯åŒæ­¥ï¼ˆä¸éœ€è¦å†ç‚¹ä¸€æ¬¡ï¼‰
    this.syncActiveStocks();           // åˆ—è¡¨ & è‚¡ç¥¨æ•°ç«‹åˆ»æ­£ç¡®
    this.refreshActiveGroupStats();    // ç»Ÿè®¡å¡ç«‹åˆ»æ­£ç¡®ï¼ˆç©ºç»„å°±æ˜¯ 0ï¼‰

    await this.saveGroupsToPrefs();

    // âœ… å¯é€‰ï¼šæ–°ç»„ä¸ºç©ºä¹Ÿæ²¡å…³ç³»ï¼Œä½†ä¿æŒæµç¨‹ä¸€è‡´
    await this.preloadActiveGroupQuotes();
    this.refreshActiveGroupStats();
  }


  private async deleteGroup(groupId: number): Promise<void> {
    const copy: StockGroup[] = [];
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id !== groupId) copy.push(this.groups[i]);
    }
    this.groups = copy;

    if (this.activeGroupId === groupId) {
      this.activeGroupId = this.groups.length > 0 ? this.groups[0].id : -1;
    }

    // âœ… å…³é”®ï¼šåˆ é™¤å¯¼è‡´ activeGroupId å˜åŒ–æ—¶ï¼Œç«‹åˆ»åŒæ­¥ active é“¾è·¯
    this.syncActiveStocks();
    this.refreshActiveGroupStats();

    await this.saveGroupsToPrefs();

    // âœ… å¦‚æœè¿˜æœ‰åˆ†ç»„ï¼šé¢„çƒ­æ–° active åˆ†ç»„ï¼Œç„¶åå†åˆ·æ–°ç»Ÿè®¡
    if (this.activeGroupId >= 0) {
      await this.preloadActiveGroupQuotes();
      this.refreshActiveGroupStats();
    }
  }

  private async addStocksToGroup(groupId: number, codes: string[]): Promise<void> {
    this.dbg(`addStocksToGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) æ”¶é›†å·²æœ‰ codeï¼Œä¾¿äºå»é‡
    const existed: Set<string> = new Set<string>()
    const curStocks: StockRef[] = this.groups[idx].stocks
    for (let i: number = 0; i < curStocks.length; i++) {
      existed.add(curStocks[i].code)
    }

    // 2) è¿‡æ»¤ + å»é‡å¾…æ·»åŠ  codesï¼ˆåŒä¸€æ‰¹ codes å†…ä¹Ÿå»é‡ï¼‰
    const addList: StockRef[] = []
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length !== 6) {
        continue
      }
      if (existed.has(code6)) {
        continue
      }
      existed.add(code6)
      addList.push({ code: code6 })
    }

    if (addList.length === 0) {
      this.dbg('addStocksToGroup:skip empty addList')
      return
    }

    // 3) æ›´æ–° groupsï¼ˆå¿…é¡»æ–°æ•°ç»„ + æ–°å¯¹è±¡ï¼Œè§¦å‘ UI/çŠ¶æ€ï¼‰
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    const newStocks: StockRef[] = g.stocks.concat(addList)
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šç«‹åˆ»åŒæ­¥ activeStocksï¼ˆè®©åˆ—è¡¨/ç»Ÿè®¡ç«‹å³å¯è§ï¼‰
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) ä¸šåŠ¡æç¤ºï¼ˆå¯é€‰ï¼‰
    this.watchlistMsg = `å·²æ·»åŠ  ${addList.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) æŒä¹…åŒ–
    await this.saveGroupsToPrefs()
    this.dbg('addStocksToGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šé¢„çƒ­è¡Œæƒ…ï¼ˆè¡Œæƒ…å›å†™ quoteCache åç»Ÿè®¡ä¼šè‡ªåŠ¨æ›´æ–°ï¼‰
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('addStocksToGroup:afterPreload')
    }
  }



  private async removeStocksFromGroup(groupId: number, codes: string[]): Promise<void> {
    this.dbg(`removeStocksFromGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) éœ€è¦ç§»é™¤çš„ code é›†åˆï¼ˆå»é‡ + è¿‡æ»¤ 6 ä½ï¼‰
    const toRemove: Set<string> = new Set<string>()
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length === 6) {
        toRemove.add(code6)
      }
    }
    if (toRemove.size === 0) {
      this.dbg('removeStocksFromGroup:skip empty toRemove')
      return
    }

    // 2) ç”Ÿæˆæ–° stocks
    const oldStocks: StockRef[] = this.groups[idx].stocks
    const newStocks: StockRef[] = []
    for (let i: number = 0; i < oldStocks.length; i++) {
      const code: string = oldStocks[i].code
      if (!toRemove.has(code)) {
        newStocks.push(oldStocks[i])
      }
    }

    // å¦‚æœæ²¡å˜åŒ–ï¼Œç›´æ¥è¿”å›
    if (newStocks.length === oldStocks.length) {
      this.dbg('removeStocksFromGroup:skip no changes')
      return
    }

    // 3) æ›´æ–° groupsï¼ˆæ–°æ•°ç»„ + æ–°å¯¹è±¡ï¼‰
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šç«‹åˆ»åŒæ­¥ activeStocksï¼ˆåˆ—è¡¨/ç»Ÿè®¡ç«‹å³å˜ï¼‰
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) æç¤ºï¼ˆå¯é€‰ï¼‰
    this.watchlistMsg = `å·²åˆ é™¤ ${oldStocks.length - newStocks.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) æŒä¹…åŒ–
    await this.saveGroupsToPrefs()
    this.dbg('removeStocksFromGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šé¢„çƒ­è¡Œæƒ…ï¼ˆå¯é€‰ï¼Œä½†ä¿æŒä¸€è‡´æ€§ï¼›ä¹Ÿèƒ½è¡¥é½ cacheï¼‰
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('removeStocksFromGroup:afterPreload')
    }
  }




  private cloneGroupWithStocks(g: StockGroup, stocks: StockRef[]): StockGroup {
    return {
      id: g.id,
      name: g.name,
      stocks: stocks,
      createdAt: g.createdAt,
      version: g.version + 1 // âœ… å…³é”®ï¼šæ¯æ¬¡ stocks å˜åŒ–éƒ½é€’å¢
    };
  }


  private getActiveGroup(): StockGroup | null {
    if (this.activeGroupId < 0) {
      return null;
    }
    const idx: number = this.findGroupIndex(this.activeGroupId);
    if (idx < 0) {
      return null;
    }
    return this.groups[idx];
  }

  private findQuoteInCaches(code: string): Quote | null {
    const code6: string = code.trim();
    if (code6.length !== 6) return null;

    const kStock: string = `stock-${code6}`;
    const vStock: Quote | undefined = this.quoteCache.get(kStock);
    if (vStock !== undefined) return vStock;

    const kIndex: string = `index-${code6}`;
    const vIndex: Quote | undefined = this.quoteCache.get(kIndex);
    if (vIndex !== undefined) return vIndex;

    return null;
  }

  private getStockRowName(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q !== null) {
      return q.name;
    }
    if (s.name && s.name.length > 0) {
      return s.name;
    }
    return 'â€”';
  }

  private getStockRowPriceText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? q.price.toFixed(2) : '--';
  }

  private getStockRowChangeText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? q.change.toFixed(2) : '--';
  }

  private getStockRowPctText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? (q.changePercent.toFixed(2) + '%') : '--';
  }

  private getStockRowPriceColor(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q === null) {
      return '#AAAAAA';
    }
    return (q.change >= 0) ? '#FF4D4F' : '#39D98A';
  }

  private getStockRowSubColor(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q === null) {
      return '#777777';
    }
    return (q.change >= 0) ? '#FF7875' : '#6BE49B';
  }

  private async ensureQuoteCachedForCode(code: string): Promise<void> {
    const code6: string = code.trim()
    if (code6.length !== 6) return

    // âœ… ä»…æ£€æŸ¥ stock ç¼“å­˜ï¼Œé¿å… index åŒç å¯¼è‡´è¯¯åˆ¤
    const cacheKey: string = `stock-${code6}`
    const existed: Quote | undefined = this.quoteCache.get(cacheKey)
    if (existed !== undefined) return

    const httpRequest = http.createHttp()
    try {
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=stock&code=${code6}`
      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      this.dbg(`ensureQuoteCachedForCode:request ${code6}`)
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const q: Quote = this.mapBackendQuote(backendItem, 'stock')
        this.mergeQuotesToCache([q]) // âœ… quoteCacheVer++ ä¼šè§¦å‘ç»Ÿè®¡å¡åˆ·æ–°
        this.dbg(`ensureQuoteCachedForCode:request ${code6}`)
      }
    } catch (e) {
      // ignore
    } finally {
      httpRequest.destroy()
    }
  }


  private async preloadActiveGroupQuotes(): Promise<void> {
    const g: StockGroup | null = this.getActiveGroup();
    if (g === null) {
      return;
    }

    const tasks: Promise<void>[] = [];
    for (let i: number = 0; i < g.stocks.length; i++) {
      const code: string = g.stocks[i].code;
      tasks.push(this.ensureQuoteCachedForCode(code));
    }

    // å¹¶è¡Œé¢„çƒ­ï¼šå•åªå¤±è´¥ä¸ä¼šé˜»å¡æ•´ä½“
    await Promise.all(tasks.map((p: Promise<void>) => p.catch(() => { })));

  }

  private mergeQuotesToCache(list: Quote[]): void {
    console.info(`[DBG] mergeQuotesToCache: in list=${list.length} oldCache=${this.quoteCache.size}`);
    const newMap: Map<string, Quote> = new Map<string, Quote>();
    this.quoteCache.forEach((v: Quote, k: string) => {
      newMap.set(k, v);
    });

    for (let i: number = 0; i < list.length; i++) {
      const q: Quote = list[i];
      const key: string = `${q.type}-${q.code}`;
      newMap.set(key, q);
    }

    this.quoteCache = newMap;
    this.quoteCacheVer += 1
    this.refreshActiveGroupStats()   // âœ… æ–°å¢ï¼šè¡Œæƒ…å˜äº†ï¼Œç»Ÿè®¡ï¼ˆup/down/avgï¼‰ç«‹åˆ»åˆ·æ–°
    console.info(`[DBG] mergeQuotesToCache: out newCache=${this.quoteCache.size}`);
  }


  private getActiveGroupOrNull(): StockGroup | null {
    if (this.activeGroupId < 0) return null
    const idx: number = this.findGroupIndex(this.activeGroupId)
    if (idx < 0) return null
    return this.groups[idx]
  }

  private getActiveGroupNameText(): string {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    return g ? g.name : ''
  }

  private getActiveGroupStocksList(): StockRef[] {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    return g ? g.stocks : []
  }

  private computeStatsFromStocks(list: StockRef[]): ActiveGroupStats {
    const stockCount: number = list.length

    let up: number = 0
    let down: number = 0
    let sumPct: number = 0
    let cntPct: number = 0

    for (let i: number = 0; i < list.length; i++) {
      const code: string = list[i].code
      // const q: Quote | null = this.findQuoteInCaches(code)
      const q: Quote | null = this.findStockQuoteInCache(code)
      if (q !== null) {
        if (q.change >= 0) {
          up += 1
        } else {
          down += 1
        }
        sumPct += q.changePercent
        cntPct += 1
      }
    }

    const avgPct: string = (cntPct > 0) ? ((sumPct / cntPct).toFixed(2) + '%') : '--'

    return {
      stockCount: stockCount.toString(),
      up: up.toString(),
      down: down.toString(),
      avgPct: avgPct
    }
  }

  private getActiveGroupStatsStockCount(): string {
    const _av: number = this.activeStocksVer     // âœ… è®©â€œå¢åˆ è‚¡ç¥¨â€è§¦å‘åˆ·æ–°
    const _qv: number = this.quoteCacheVer       // âœ… è®©â€œè¡Œæƒ…å›å†™â€è§¦å‘åˆ·æ–°
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.stockCount
  }

  private getActiveGroupStatsUp(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.up
  }

  private getActiveGroupStatsDown(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.down
  }

  private getActiveGroupStatsAvgPct(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.avgPct
  }

  // âœ… è‡ªé€‰åˆ†ç»„ä¸“ç”¨ï¼šåªæŒ‰ stock æŸ¥ç¼“å­˜ï¼Œé¿å…ä¸ index åŒç å†²çªï¼ˆå¦‚ 000001ï¼‰
  private findStockQuoteInCache(code: string): Quote | null {
    const code6: string = code.trim()
    if (code6.length !== 6) return null

    const kStock: string = `stock-${code6}`
    const v: Quote | undefined = this.quoteCache.get(kStock)
    return (v !== undefined) ? v : null
  }



  private logSeq: number = 0;

  private dbg(tag: string): void {
    this.logSeq += 1;

    const gid: number = this.activeGroupId;
    const idx: number = this.findGroupIndex(gid);

    let activeCount: number = -1;
    let activeName: string = '';
    if (idx >= 0) {
      activeCount = this.groups[idx].stocks.length;
      activeName = this.groups[idx].name;
    }

    console.info(
      `[DBG#${this.logSeq}] ${tag} | tab=${this.currentTabIndex} mode=${this.currentMode}` +
        ` | activeGroupId=${gid} activeIdx=${idx} activeName=${activeName} activeStocks=${activeCount}` +
        ` | groups=${this.groups.length} cache=${this.quoteCache.size}` +
        ` | activeStocks=${this.activeStocks.length} cache=${this.quoteCache.size} cacheVer=${this.quoteCacheVer}`
    );
  }

  private syncActiveStocks(): void {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    if (g === null) {
      this.activeStocks = []
    } else {
      // å…³é”®ï¼šå¿…é¡»åˆ›å»ºâ€œæ–°æ•°ç»„å¼•ç”¨â€
      this.activeStocks = g.stocks.slice()
    }
    this.activeStocksVer += 1

    this.refreshActiveGroupStats()
  }

  private getGroupAvgPctText(groupId: number): string {
    // âœ… ä¾èµ–ç¼“å­˜ç‰ˆæœ¬ï¼šè¡Œæƒ…æ›´æ–° => quoteCacheVer++ => è¿™é‡Œä¼šé‡æ–°è®¡ç®— => UI é‡ç»˜
    const _qv: number = this.quoteCacheVer

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '--'

    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    return st.avgPct
  }

  private getGroupAvgPctColor(groupId: number): string {
    // âœ… ä¾èµ–è¡Œæƒ…ç¼“å­˜ç‰ˆæœ¬ï¼Œä¿è¯è¡Œæƒ…å˜åŒ–æ—¶é¢œè‰²ä¹Ÿåˆ·æ–°
    const _qv: number = this.quoteCacheVer

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '#777777'

    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    const avg: string = st.avgPct

    // æ²¡æœ‰è¡Œæƒ…
    if (avg === '--') {
      return '#777777'
    }

    // å»æ‰ %
    const v: number = Number(avg.replace('%', ''))
    if (Number.isNaN(v)) {
      return '#777777'
    }

    // âœ… æ¶¨çº¢ï¼Œè·Œç»¿ï¼ˆæŒ‰ä½ å½“å‰å…¨å±€é…è‰²ï¼‰
    return v >= 0 ? '#FF4D4F' : '#39D98A'
  }

  // âœ… æ–¹æ¡ˆ1ç¬¬ä¸‰æ­¥ï¼šæŠŠ Quote è½¬æˆæ¡Œé¢å¡ç‰‡ç»‘å®šæ•°æ®
  private buildWidgetDataFromQuote(q: Quote): WidgetBindData {
    const now: Date = new Date()
    const hh: string = now.getHours().toString().padStart(2, '0')
    const mm: string = now.getMinutes().toString().padStart(2, '0')

    return {
      formId: this.activeFormId,
      title: (q.type === 'index') ? 'æŒ‡æ•°' : 'è‚¡ç¥¨',
      code: q.code,
      name: q.name,
      priceText: q.price.toFixed(2),
      changeText: q.change.toFixed(2),
      pctText: q.changePercent.toFixed(2) + '%',
      tsText: `${hh}:${mm}`,
      hasPrev: true,
      hasNext: true
    }
  }

  // âœ… æ–¹æ¡ˆ1ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ˜¯ä»æ¡Œé¢å¡ç‰‡æ‰“å¼€çš„ Appï¼ˆactiveFormId æœ‰å€¼ï¼‰ï¼Œå°±æŠŠå½“å‰é€‰æ‹©å›å†™åˆ°å¡ç‰‡
  private async updateWidgetIfLaunchedFromForm(q: Quote): Promise<void> {
    const fid: string = this.activeFormId.trim()

    hilog.error(DOMAIN, TAG, '[WIDGET] ENTER updateWidget fid=%{public}s code=%{public}s', fid, q.code)

    if (fid.length === 0) {
      hilog.error(DOMAIN, TAG, '[WIDGET] SKIP activeFormId empty')
      return
    }

    try {
      const data: WidgetBindData = this.buildWidgetDataFromQuote(q)
      const binding: formBindingData.FormBindingData = formBindingData.createFormBindingData(data)

      await formProvider.updateForm(fid, binding)

      hilog.error(DOMAIN, TAG, '[WIDGET] OK updateForm formId=%{public}s code=%{public}s', fid, q.code)
    } catch (e) {
      hilog.error(DOMAIN, TAG, '[WIDGET] FAIL updateForm formId=%{public}s err=%{public}s',
        fid, JSON.stringify(e))
    }
  }



  private async triggerRuleAlert(rule: NotifyRule): Promise<void> {
    try {
      // å…ˆå°è¯•æ‹‰èµ·é€šçŸ¥æˆæƒå¼¹çª—ï¼ˆè‹¥å·²å¼€å¯ï¼Œé€šå¸¸ä¸ä¼šå½±å“ï¼›è‹¥æœªå¼€å¯ä¼šæç¤ºç”¨æˆ·å¼€å¯ï¼‰
      // è‹¥ç”¨æˆ·æ‹’ç»ï¼Œå¸¸è§é”™è¯¯ç ä¸º 1600004
      try {
        await notificationManager.requestEnableNotification()
      } catch (e) {
        // ä¸ä½¿ç”¨ any/unknownï¼šåªåšæœ€ä¿å®ˆå¤„ç†
        const errObj: Record<string, Object> = e as Record<string, Object>
        const codeNum: number = Number(errObj['code'])
        hilog.error(DOMAIN, TAG, 'requestEnableNotification failed: %{public}s', JSON.stringify(e))

        // 1600004ï¼šç”¨æˆ·æ‹’ç»/é€šçŸ¥æœªæˆæƒï¼ˆæˆ–å·²è¢«å…³é—­ï¼‰
        if (codeNum === 1600004) {
          // è¿™é‡Œä½ å¯ä»¥æ”¹æˆ UI æç¤ºï¼šå¼•å¯¼ç”¨æˆ·åˆ°ç³»ç»Ÿè®¾ç½®å¼€å¯é€šçŸ¥
          return
        }
      }

      const req: notificationManager.NotificationRequest = {
        id: 10000 + rule.id,
        content: {
          // å…³é”®ï¼šç”¨ notificationContentTypeï¼ˆä¸æ˜¯ contentTypeï¼‰
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'è¡Œæƒ…æé†’',
            text: `${rule.stockName}ï¼ˆ${rule.stockCode}ï¼‰${rule.conditionText}`,
            additionalText: 'æ‰“å¼€åº”ç”¨æŸ¥çœ‹è¯¦æƒ…'
          }
        }
        // slotType / wantAgent / autoDeletedï¼šå…ˆéƒ½ä¸å†™ï¼Œé¿å…ä½ å½“å‰ SDK æšä¸¾/ç±»å‹ä¸ä¸€è‡´å¯¼è‡´ç¼–è¯‘æˆ–è¿è¡Œå¤±è´¥
      }

      await notificationManager.publish(req)
      hilog.info(DOMAIN, TAG, 'triggerRuleAlert ok, id=%{public}d', req.id)
    } catch (e) {
      hilog.error(DOMAIN, TAG, 'triggerRuleAlert failed: %{public}s', JSON.stringify(e))
    }
  }



  // âœ… å…ˆæ£€æŸ¥é€šçŸ¥æ˜¯å¦å¼€å¯ï¼›æ²¡å¼€å°±æ‹‰èµ·ç³»ç»Ÿæˆæƒ/å¼€å…³é¡µé¢
  private async ensureNotificationEnabled(): Promise<boolean> {
    try {
      const enabled: boolean = await notificationManager.isNotificationEnabled()
      if (enabled) {
        return true
      }

      // æ‹‰èµ·ç³»ç»Ÿç•Œé¢è®©ç”¨æˆ·æ‰“å¼€é€šçŸ¥å¼€å…³
      await notificationManager.requestEnableNotification()

      // ç”¨æˆ·æ“ä½œåå†æ£€æŸ¥ä¸€æ¬¡
      const enabled2: boolean = await notificationManager.isNotificationEnabled()
      return enabled2
    } catch (e) {
      // ä»»æ„å¼‚å¸¸éƒ½è§†ä¸ºä¸å¯ç”¨
      return false
    }
  }

  // âœ… ä¸“é—¨å¤„ç† publish çš„ 1600004ï¼šæç¤º + å¼•å¯¼å¼€å¯
  private async handlePublishError(code: number): Promise<void> {
    if (code === 1600004) {
      // ä½ å¯ä»¥ç”¨ä½ ç°æœ‰çš„ UI çŠ¶æ€å­—æ®µæç¤ºç”¨æˆ·
      this.watchlistMsg = 'é€šçŸ¥æƒé™æœªå¼€å¯ï¼šè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­ä¸º HarmonyStock æ‰“å¼€é€šçŸ¥åé‡è¯•'
      // å†ä¸»åŠ¨æ‹‰èµ·ä¸€æ¬¡ç³»ç»Ÿå¼€å…³ç•Œé¢
      await this.ensureNotificationEnabled()
    }
  }


  private async loadNotifyRulesFromPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)
    const jsonStr: string = (await pref.get(this.PREF_KEY_RULES, '')) as string

    if (jsonStr.trim().length === 0) {
      // æ²¡å­˜è¿‡ï¼šç”¨é»˜è®¤ @State çš„ notifyRules å³å¯ï¼ŒåŒæ—¶æ ¡å‡† nextRuleId
      this.recomputeNextRuleId()
      return
    }

    const parsed: NotifyRule[] = this.safeParseNotifyRules(jsonStr)
    if (parsed.length > 0) {
      this.notifyRules = parsed
      this.recomputeNextRuleId()
    }
  }

  private async saveNotifyRulesToPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)
    const jsonStr: string = JSON.stringify(this.notifyRules)
    await pref.put(this.PREF_KEY_RULES, jsonStr)
    await pref.flush()
  }

  private safeParseNotifyRules(jsonStr: string): NotifyRule[] {
    try {
      const raw: Object = JSON.parse(jsonStr) as Object
      if (!Array.isArray(raw)) return []

      const arr: Object[] = raw as Object[]
      const out: NotifyRule[] = []

      for (let i: number = 0; i < arr.length; i++) {
        const item: Record<string, Object> = arr[i] as Record<string, Object>

        const id: number = Number(item['id'])
        const stockCode: string = String(item['stockCode'] ?? '').trim()
        const stockName: string = String(item['stockName'] ?? '').trim()
        const conditionText: string = String(item['conditionText'] ?? '').trim()
        const enabled: boolean = Boolean(item['enabled'])

        if (!Number.isNaN(id) && stockCode.length === 6 && stockName.length > 0 && conditionText.length > 0) {
          out.push({ id, stockCode, stockName, conditionText, enabled })
        }
      }
      return out
    } catch (e) {
      return []
    }
  }

  private recomputeNextRuleId(): void {
    let maxId: number = 0
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      if (this.notifyRules[i].id > maxId) maxId = this.notifyRules[i].id
    }
    this.nextRuleId = maxId + 1
  }

  private async addNotifyRuleFromUI(): Promise<void> {
    const code: string = this.ruleStockCodeInput.trim()
    if (code.length !== 6) {
      this.ruleMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    const v: number = Number(this.rulePriceInput.trim())
    if (Number.isNaN(v)) {
      this.ruleMsg = 'è¯·è¾“å…¥æ­£ç¡®çš„ä»·æ ¼é˜ˆå€¼'
      return
    }

    // å»é‡ï¼šåŒ code + åŒæ¡ä»¶ ç›´æ¥ä¸åŠ 
    const opText: string = (this.ruleOpIndex === 0) ? 'â‰¥' : 'â‰¤'
    const cond: string = `ä»·æ ¼ ${opText} ${v.toFixed(2)}`
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.stockCode === code && r.conditionText === cond) {
        this.ruleMsg = 'è¯¥è§„åˆ™å·²å­˜åœ¨'
        return
      }
    }

    // å°½é‡ä»ç¼“å­˜/åç«¯æ‹¿ nameï¼ˆä½ çš„ ensureQuoteCachedForCode å·²æœ‰ï¼‰
    await this.ensureQuoteCachedForCode(code)
    const q: Quote | null = this.findStockQuoteInCache(code)
    const name: string = (q !== null) ? q.name : code

    const newRule: NotifyRule = {
      id: this.nextRuleId,
      stockCode: code,
      stockName: name,
      conditionText: cond,
      enabled: true
    }
    this.nextRuleId += 1

    // âœ… è§¦å‘ UIï¼šå¿…é¡» new array
    const next: NotifyRule[] = [newRule].concat(this.notifyRules)
    this.notifyRules = next
    this.notifyRulesVer += 1
    await this.saveNotifyRulesToPrefs()

    // æ¸…ç©ºè¾“å…¥
    this.ruleStockCodeInput = ''
    this.rulePriceInput = ''
    this.ruleMsg = 'å·²æ·»åŠ å¹¶å¯ç”¨'
  }

  private async deleteRule(ruleId: number): Promise<void> {
    const next: NotifyRule[] = []
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.id !== ruleId) next.push(r)
    }
    this.notifyRules = next
    this.notifyRulesVer += 1
    await this.saveNotifyRulesToPrefs()
  }



  // ===== è‡ªå®šä¹‰ TabBarï¼šè¿™é‡Œå°±èƒ½å®Œå…¨æ§åˆ¶æ–‡å­—é¢œè‰² =====
  @Builder
  tabBarBuilder(title: string, index: number) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor(this.currentTabIndex === index ? Color.White : '#888888')
    }
    .height(40)
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Black)
  }

  build() {

    Column() {

      Button('å‘é€ä¸€æ¡æµ‹è¯•é€šçŸ¥')
        .margin({ left: 16, right: 16, top: 8, bottom: 8 })
        .onClick(async () => {
          const rule: NotifyRule = {
            id: 999,
            stockCode: '300750',
            stockName: 'å®å¾·æ—¶ä»£',
            conditionText: 'ä»·æ ¼ â‰¥ 220.00',
            enabled: true
          }
          await this.triggerRuleAlert(rule)
        })
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildHeader()

      // ===== Tabs éƒ¨åˆ† =====
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildMarketTab()
        }
        .tabBar(this.tabBarBuilder('å¸‚åœº', 0))

        TabContent() {
          this.buildWatchlistTab()
        }
        .tabBar(this.tabBarBuilder('è‡ªé€‰', 1))

        TabContent() {
          this.buildNotificationTab()
        }
        .tabBar(this.tabBarBuilder('é€šçŸ¥', 2))
      }
      .barMode(BarMode.Fixed)
      .backgroundColor(Color.Black)
      .divider({
        strokeWidth: 0.5,
        color: '#333333'
      })
      .onChange((index: number) => {
        this.currentTabIndex = index;

      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  // ====== Header åŒºåŸŸ ======
  @Builder
  private buildHeader() {
    Column() {
      Row({ space: 8 }) {
        Text('HARMONYSTOCK')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Text('é¸¿è‚¡é€š')
          .fontSize(14)
          .fontColor('#AAAAAA')
          .margin({ top: 4 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
    }
    .backgroundColor('#111111')
  }

  // ===== æ¨¡å¼åˆ‡æ¢ï¼šæŒ‡æ•° / è‚¡ç¥¨ =====
  @Builder
  private buildModeSwitcher() {
    Row({ space: 24 }) {
      this.buildModeChip('æŒ‡æ•°', 'index');
      this.buildModeChip('è‚¡ç¥¨', 'stock');
    }.width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .height(50)                         // åŒºåŸŸæ›´é«˜ï¼Œçœ‹èµ·æ¥æ›´åƒå¤§æŒ‰é’®åŒºåŸŸ
  }

  @Builder
  private buildModeChip(label: string, mode: 'index' | 'stock') {
    Text(label)
      .fontSize(16)
      .fontColor(this.currentMode === mode ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .backgroundColor(this.currentMode === mode ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        if (this.currentMode === mode) {
          return;
        }
        this.currentMode = mode;

        // åˆ‡æ¨¡å¼æ—¶é‡ç½®çŠ¶æ€ + é‡æ–°æ‹‰æ•°æ®
        this.marketQuotes = [];
        this.searchedQuotes = [];
        this.selectedQuoteCode = '';
        this.selectedQuoteName = '';
        this.selectedQuoteType = mode;
        this.selectedKlineIndex = -1;
        this.klinePoints = [];
        this.klineGeoms = [];
        this.klineXLabels = [];
        this.klineError = '';

        this.fetchQuotes(mode);
      })
  }


  // ====== Tab 1ï¼šå¸‚åœºï¼ˆæŒ‡æ•° / è‚¡ç¥¨ + K çº¿ + æ¡Œé¢å¡ç‰‡é¢„è§ˆï¼‰ ======
  @Builder
  private buildMarketTab() {
    Column() {
      this.buildModeSwitcher()

      // é¡¶éƒ¨ï¼šæ ‡é¢˜ + æ¨¡å¼åˆ‡æ¢ + æœç´¢åŒºåŸŸ
      Row() {
        Text(this.currentMode === 'index' ? 'æŒ‡æ•°å¡ç‰‡' : 'è‚¡ç¥¨å¡ç‰‡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .margin({ left: 16, top: 12, bottom: 4 })

        Blank()

        this.buildSearchArea();
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)



      // è¡Œæƒ…æ¨ªå‘æ»šåŠ¨ strip
      this.buildQuoteStrip();

      // K çº¿å¡ç‰‡
      this.buildKlineCard();



    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .alignItems(HorizontalAlign.Start)
  }

  // ===== è¡Œæƒ… stripï¼Œå¸¦åŠ è½½ / é”™è¯¯çŠ¶æ€ + å¯åˆ é™¤å¡ç‰‡ =====
  @Builder
  private buildQuoteStrip() {
    if (this.listLoading) {
      Row() {
        Text('è¡Œæƒ…åŠ è½½ä¸­â€¦')
          .fontSize(12)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    } else if (this.listError) {
      Row() {
        Text(`è¡Œæƒ…åŠ è½½å¤±è´¥ï¼š${this.listError}`)
          .fontSize(12)
          .fontColor('#FF7875')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    } else {
      Scroll() {
        Row({ space: 12 }) {
          // æœç´¢å‡ºæ¥çš„å¡ç‰‡
          ForEach(this.searchedQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `search-${item.type}-${item.code}`)

          // åå°å®æ—¶å¡ç‰‡
          ForEach(this.marketQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `rt-${item.type}-${item.code}`)
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .scrollable(ScrollDirection.Horizontal)
    }
  }

  // ===== æœç´¢åŒºåŸŸ =====
  @Builder
  private buildSearchArea() {
    Column() {
      Row({ space: 8 }) {
        TextInput({
          placeholder: this.currentMode === 'index'
            ? 'è¾“å…¥æŒ‡æ•°ä»£ç ï¼Œä¾‹å¦‚ 000001'
            : 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚ 300750'
        })
          .width('60%')
          .height(32)
          .fontSize(14)
          .backgroundColor(Color.White)
          .fontColor(Color.Black)
          .onChange((value: string) => {
            this.searchCode = value.trim();
          })

        Button('æŸ¥è¯¢')
          .height(32)
          .onClick(() => {
            this.queryQuoteByCode();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 4 })

      if (this.searchLoading) {
        Row() {
          Text('æ­£åœ¨æŸ¥è¯¢â€¦')
            .fontSize(12)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      } else if (this.searchError) {
        Row() {
          Text(`æŸ¥è¯¢å¤±è´¥ï¼š${this.searchError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      }
    }
  }

  private toggleCardExpanded(item: Quote): void {
    const key: string = `${item.type}-${item.code}`;
    const oldVal: boolean = this.cardExpandedMap.get(key) ?? false;

    // å¤åˆ¶æ–° Mapï¼ˆè§¦å‘ State æ›´æ–°ï¼‰
    const newMap: Map<string, boolean> = new Map<string, boolean>();
    this.cardExpandedMap.forEach((value: boolean, k: string) => {
      newMap.set(k, value);
    });

    newMap.set(key, !oldVal);
    this.cardExpandedMap = newMap;
  }




  // ===== è¡Œæƒ…å¡ç‰‡ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ =====
  @Builder
  private buildQuoteCard(item: Quote) {
    Column() {
      Column() {
        // ===== å¡ç‰‡ä¸»ä½“ï¼šç‚¹è¿™é‡Œæ‰é€‰ä¸­ + æ‹‰ K çº¿ =====
        Column() {
          Row() {
            Text(item.name)
              .fontSize(12)
              .fontColor('#AAAAAA')

            Text('âœ•')
              .fontSize(12)
              .fontColor('#777777')
              // âœ… ç”¨ TapGestureï¼Œé¿å…è¢« Scroll æ‰‹åŠ¿å / å†²çª
              .parallelGesture(
                TapGesture().onAction(async () => {
                  await this.removeQuoteCard(item.code, item.type)
                })
              )
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)

          Text(item.price.toFixed(2))
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 28 : 20)
            .fontWeight(FontWeight.Bold)
            .fontColor(item.change >= 0 ? '#FF4D4F' : '#39D98A')
            .margin({ top: 4 })

          Text(`${item.change.toFixed(2)}  ${item.changePercent.toFixed(2)}%`)
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 16 : 12)
            .fontColor(item.change >= 0 ? '#FF7875' : '#6BE49B')
            .margin({ top: 4 })
        }

        // ===== å³ä¸‹è§’ +/-ï¼šåªè´Ÿè´£å±•å¼€æ”¶èµ· =====
        Row() {
          Blank()
          Text((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 'ï¼' : 'ï¼‹')
            .fontSize(18)
            .fontColor('#CCCCCC')
            // âœ… ä¹Ÿç”¨ TapGestureï¼Œé¿å…å’Œå¤–å±‚ç‚¹å‡»æ‰“æ¶
            .parallelGesture(
              TapGesture().onAction(() => {
                this.toggleCardExpanded(item)
              })
            )
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 20 : 12)
      .backgroundColor('#171717')
      .borderRadius(12)
      .width((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 200 : 140)
      .height((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 150 : undefined)

      // âœ… å…³é”®ï¼šå¤–å±‚å¡ç‰‡ç”¨ parallelGesture æ•è· tapï¼Œæ¨ªå‘ Scroll ä¸‹æ›´ç¨³å®š
      .parallelGesture(
        TapGesture().onAction(async () => {
          console.info(`[TAP] quoteCard tapped code=${item.code} activeFormId=${this.activeFormId}`)
          hilog.error(DOMAIN, TAG, '[TAP] quoteCard tapped code=%{public}s activeFormId=%{public}s',
            item.code, this.activeFormId)

          this.selectedQuoteCode = item.code
          this.selectedQuoteName = item.name
          this.selectedQuoteType = item.type
          hilog.error(DOMAIN, TAG, '[TAP] selected set type=%{public}s code=%{public}s', item.type, item.code)

          hilog.error(DOMAIN, TAG, '[TAP] before updateWidgetIfLaunchedFromForm')
          await this.updateWidgetIfLaunchedFromForm(item)
          hilog.error(DOMAIN, TAG, '[TAP] after updateWidgetIfLaunchedFromForm')

          // âœ… ä½ è¦çš„â€œç‚¹å‡»åˆ‡æ¢è¡Œæƒ…å¡ç‰‡ + æ‹‰Kçº¿â€
          const period: string = this.getKlinePeriodParam()
          this.fetchKline(item.type, item.code, period)
        })
      )
    }
  }


  // ===== K çº¿å¡ç‰‡ =====
  @Builder
  private buildKlineCard() {
    Column() {
      // æ ‡é¢˜ + å‘¨æœŸåˆ‡æ¢
      Row({ space: 12 }) {
        Text(
          this.selectedQuoteName !== ''
            ? `${this.selectedQuoteName} K çº¿`
            : (this.currentMode === 'index' ? 'æŒ‡æ•° K çº¿' : 'è‚¡ç¥¨ K çº¿')
        )
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)

        Blank()

        this.buildKlinePeriodChip('æ—¥K', 0)
        this.buildKlinePeriodChip('å‘¨K', 1)
        this.buildKlinePeriodChip('æœˆK', 2)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8 })

      // å½“å‰é€‰ä¸­ K çº¿çš„è¯¦ç»†ä¿¡æ¯æ¡
      if (this.selectedKlineIndex >= 0) {
        Row({ space: 8 }) {
          Text(this.selectedKlineDate)
            .fontSize(10)
            .fontColor('#CCCCCC')

          Text(`å¼€ ${this.selectedKlineOpen.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`é«˜ ${this.selectedKlineHigh.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`ä½ ${this.selectedKlineLow.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`æ”¶ ${this.selectedKlineClose.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 4, bottom: 4 })
      }

      // ä¸»ä½“åŒºåŸŸ
      Column() {
        if (this.klineLoading) {
          Text('K çº¿åŠ è½½ä¸­â€¦')
            .fontSize(12)
            .fontColor('#888888')
        } else if (this.klineError) {
          Text(`K çº¿åŠ è½½å¤±è´¥ï¼š${this.klineError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        } else if (this.klineGeoms.length === 0) {
          Text('æš‚æ—  K çº¿æ•°æ®')
            .fontSize(12)
            .fontColor('#666666')
        } else {
          Column() {
            Row() {
              // y è½´åˆ»åº¦
              Column() {
                Text(this.klineMaxPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(((this.klineMaxPrice + this.klineMinPrice) / 2).toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(this.klineMinPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
              }
              .width(40)
              .height(this.KLINE_PLOT_H)
              .justifyContent(FlexAlign.SpaceBetween)

              // å³ä¾§ï¼šK çº¿ + x è½´ä¸€èµ·æ¨ªå‘æ»šåŠ¨
              Scroll() {
                Column() {
                  // èœ¡çƒ›å›¾åŒºåŸŸ
                  Row({ space: this.candleGap }) {
                    ForEach(this.klineGeoms, (g: KlineGeom, idx: number) => {
                      Column() {
                        Blank().height(g.topGap)

                        Rect()      // ä¸Šå½±çº¿
                          .width(2)
                          .height(g.upperWick)
                          .fill('#444444')

                        Rect()      // å®ä½“
                          .width(this.candleBodyWidth)
                          .height(g.bodyHeight)
                          .fill(g.isUp ? '#39D98A' : '#FF4D4F')

                        Rect()      // ä¸‹å½±çº¿
                          .width(2)
                          .height(g.lowerWick)
                          .fill('#444444')

                        Blank().height(4)
                      }
                      .border({
                        width: this.selectedKlineIndex === idx ? 1 : 0,
                        color: this.selectedKlineIndex === idx ? '#FACC15' : '#000000'
                      })
                      .onClick(() => {
                        this.onKlineSelected(idx);
                      })
                    }, (g: KlineGeom, idx: number) => `${idx}`)
                  }
                  .width(this.getKlineTotalWidth())
                  .height(this.KLINE_PLOT_H)

                  // x è½´æ—¥æœŸæ ‡ç­¾
                  if (this.klineXLabels.length > 0) {
                    Row() {
                      ForEach(this.klineXLabels, (label: string, idx: number) => {
                        Text(label)
                          .fontSize(10)
                          .fontColor('#777777')
                      }, (label: string, idx: number) => `${idx}-${label}`)
                    }
                    .width(this.getKlineTotalWidth())
                    .justifyContent(FlexAlign.SpaceBetween)
                    .margin({ bottom: 10 })
                  }
                }
                .padding({ right: 32 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H)
              .margin({ left: 8 })
            }
            .width('100%')
          }
        }
      }
      .width('100%')
      .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H + 70)
      .margin({ top: 8, bottom: 12 })
      .padding(16)
      .backgroundColor('#101010')
      .borderRadius(16)
    }
  }

  @Builder
  private buildKlinePeriodChip(label: string, index: number) {
    Text(label)
      .fontSize(12)
      .fontColor(this.klinePeriodIndex === index ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .backgroundColor(this.klinePeriodIndex === index ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        if (this.klinePeriodIndex === index) {
          return;
        }
        this.klinePeriodIndex = index;

        if (this.selectedQuoteCode !== '') {
          const period: string = this.getKlinePeriodParam();
          this.fetchKline(this.selectedQuoteType, this.selectedQuoteCode, period);
        }
      })
  }


  @Builder
  private buildDesktopCardSmall() {
    Column() {
      Text('è‡ªé€‰è‚¡ï¼ˆå°å·å¡ç‰‡ï¼‰')
        .fontSize(10)
        .fontColor('#999999')
        .margin({ bottom: 4 })

      Text('300750 å®å¾·æ—¶ä»£')
        .fontSize(12)
        .fontColor(Color.White)

      Text('210.35  -1.25  -0.59%')
        .fontSize(11)
        .fontColor('#39D98A')
        .margin({ top: 4 })
    }
    .padding(10)
    .backgroundColor('#151515')
    .borderRadius(14)
    .width(140)
  }

  @Builder
  private buildDesktopCardLarge() {
    Column() {
      Row() {
        Text('å¤§ç›˜æŒ‡æ•°')
          .fontSize(12)
          .fontColor('#BBBBBB')
        Blank()
        Text('ä¸Šè¯')
          .fontSize(11)
          .fontColor('#888888')
      }

      Text('3050.32')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF4D4F')
        .margin({ top: 4 })

      Text('+12.34  +0.41%')
        .fontSize(11)
        .fontColor('#FF7875')
        .margin({ top: 2 })

      Row({ space: 2 }) {
        ForEach([16, 10, 18, 8, 20, 12, 14], (h: number, idx: number) => {
          Rect()
            .width(6)
            .height(h)
            .fill('#333333')
        }, (h: number, idx: number) => `${idx}-${h}`)
      }
      .margin({ top: 8 })
    }
    .padding(12)
    .backgroundColor('#151515')
    .borderRadius(14)
    .width(180)
  }

  // ====== Tab 2ï¼šè‡ªé€‰ï¼ˆåˆ†ç»„ç®¡ç† + ç»„å†…åˆ—è¡¨ï¼‰ ======
  @Builder
  private buildWatchlistTab() {
    Column() {
      this.buildGroupStrip()
      this.buildCreateGroupBar()

      if (this.watchlistMsg.length > 0) {
        Text(this.watchlistMsg)
          .fontSize(10)
          .fontColor('#777777')
          .margin({ left: 16, bottom: 8 })
      }

      if (this.activeGroupId < 0 || this.groups.length === 0) {
        Text('æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç»„')
          .fontSize(12)
          .fontColor('#777777')
          .margin({ top: 24 })
          .width('100%')
          .textAlign(TextAlign.Center)
      } else {
        // ç»„å¤´ï¼ˆæ— å‚ Builderï¼šç›´æ¥ç”¨ activeGroupName + activeGroupIdï¼‰
        this.buildActiveGroupHeaderCurrent()

        // ç»Ÿè®¡ï¼ˆæ— å‚ Builderï¼šç”¨ activeGroupXXXTextï¼‰
        this.buildGroupStatsCard()

        // æ·»åŠ æ¡
        this.buildAddStockBar()

        if (this.getActiveGroupStocksList().length === 0) {
          Text('è¯¥åˆ†ç»„æš‚æ— è‚¡ç¥¨ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥ä»£ç æ·»åŠ ')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 12, left: 16 })
        } else {
          List() {
            ForEach(this.activeStocks, (s: StockRef) => {
              this.buildStockRefRow(this.activeGroupId, s)
            }, (s: StockRef) => {
              // key åªéœ€è¦ç¨³å®šå”¯ä¸€å³å¯ï¼Œä¸è¦æŠŠ ver æ”¾è¿™é‡Œä¹Ÿè¡Œ
              return `${this.activeGroupId}-${s.code}`
            })
          }
          .key(`${this.activeGroupId}-${this.activeStocksVer}`)  // âœ…å…³é”®ï¼šè®© List é‡æ–°åˆ›å»º
          .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .key(`watchlist-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }

  @Builder
  private buildActiveGroupHeaderCurrent() {
    Row({ space: 8 }) {
      Text(this.getActiveGroupNameText())
        .fontSize(14)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)

      Blank()

      Text('åˆ é™¤åˆ†ç»„')
        .fontSize(12)
        .fontColor('#FF7875')
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#1A1A1A')
        .borderRadius(10)
        .onClick(() => {
          this.deleteGroup(this.activeGroupId)
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 6 })
  }


  @Builder
  private buildGroupStrip() {
    Scroll() {
      Row({ space: 8 }) {
        ForEach(this.groups, (group: StockGroup) => {
          Column({ space: 2 }) {
            Text(group.name)
              .fontSize(12)
              .fontColor(this.activeGroupId === group.id ? '#FFFFFF' : '#DDDDDD')

            Text(this.getGroupAvgPctText(group.id))
              .fontSize(10)
              .fontColor(this.getGroupAvgPctColor(group.id))
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(this.activeGroupId === group.id ? '#2A2A2A' : '#161616')
          .borderRadius(12)
          .onClick(async () => {
            this.activeGroupId = group.id

            this.syncActiveStocks()
            await this.preloadActiveGroupQuotes()
            this.syncActiveStocks()
          })
        }, (group: StockGroup) => group.id.toString())
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
    }
    .scrollable(ScrollDirection.Horizontal)
  }

  @Builder
  private buildCreateGroupBar() {
    Row({ space: 8 }) {
      TextInput({
        placeholder: 'æ–°å»ºåˆ†ç»„åï¼ˆå¦‚ ç§‘æŠ€è‚¡ï¼‰',
        text: this.newGroupName // âœ… å—æ§ï¼šUI ç»‘å®š state
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          this.newGroupName = v.trim();
        })

      Button('åˆ›å»º')
        .height(32)
        .onClick(async () => {
          const name: string = this.newGroupName.trim();
          if (name.length === 0) {
            this.watchlistMsg = 'è¯·è¾“å…¥åˆ†ç»„å';
            return;
          }
          await this.createGroup(name);

        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }


  @Builder
  private buildActiveGroupHeader(g: StockGroup) {
    Row({ space: 8 }) {
      Text(g.name)
        .fontSize(14)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)

      Blank()

      Text('åˆ é™¤åˆ†ç»„')
        .fontSize(12)
        .fontColor('#FF7875')
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#1A1A1A')
        .borderRadius(10)
        .onClick(() => {
          this.deleteGroup(g.id)
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 6 })
  }



  @Builder
  private buildGroupStatsCard() {
    Column() {
      Row({ space: 12 }) {

        Column({ space: 4 }) {
          Text('è‚¡ç¥¨æ•°').fontSize(10).fontColor('#777777')
          Text(this.activeStatStockCount).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('ä¸Šæ¶¨').fontSize(10).fontColor('#777777')
          Text(this.activeStatUp).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('ä¸‹è·Œ').fontSize(10).fontColor('#777777')
          Text(this.activeStatDown).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('å‡æ¶¨è·Œ').fontSize(10).fontColor('#777777')
          Text(this.activeStatAvgPct).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')
      }
      .width('100%')
      .padding(12)
      .margin({ left: 16, right: 16, bottom: 8 })
      .backgroundColor('#101010')
      .borderRadius(14)
    }
    // è¿™ä¸ª key ä½ ä¿ç•™å³å¯
    .key(`stats-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }


  @Builder
  private buildAddStockBar() {
    Row({ space: 8 }) {
      TextInput({
        placeholder: 'è¾“å…¥ 6 ä½è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 300750ï¼‰',
        text: this.addStockCodeInput
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          this.addStockCodeInput = v.trim();
        })

      Button('æ·»åŠ ')
        .height(32)
        .onClick(async () => {
          const code: string = this.addStockCodeInput.trim();
          if (code.length !== 6) {
            this.watchlistMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç ';
            return;
          }

          // âœ… å…³é”®ï¼šæ°¸è¿œå–â€œå½“å‰ activeGroupIdâ€ï¼Œä¸å†ä¾èµ– Builder å‚æ•°é—­åŒ…
          const gid: number = this.activeGroupId;
          if (gid < 0) {
            this.watchlistMsg = 'å½“å‰æ²¡æœ‰å¯ç”¨åˆ†ç»„';
            return;
          }

          await this.addStocksToGroup(gid, [code]);
          this.watchlistMsg = `å·²å°è¯•æ·»åŠ ï¼š${code} -> group=${gid}`;
        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }



  @Builder
  private buildStockRefRow(groupId: number, s: StockRef) {
    ListItem() {
      Row() {
        Column({ space: 4 }) {
          Text(this.getStockRowName(s))
            .fontSize(14)
            .fontColor(Color.White)

          Text(s.code)
            .fontSize(11)
            .fontColor('#666666')
        }

        Blank()

        Column({ space: 4 }) {
          Text(this.getStockRowPriceText(s))
            .fontSize(14)
            .fontColor(this.getStockRowPriceColor(s))
            .textAlign(TextAlign.End)

          Text(this.getStockRowChangeText(s) + '  ' + this.getStockRowPctText(s))
            .fontSize(11)
            .fontColor(this.getStockRowSubColor(s))
            .textAlign(TextAlign.End)
        }

        Button('âœ•')
          .height(28)
          .width(28)
          .padding(0)
          .backgroundColor('#1A1A1A')
          .fontColor('#777777')
          .borderRadius(14)
          .onClick(() => {
            // åªåšåˆ é™¤ï¼Œä¸è¦ asyncï¼Œé¿å…æ‰‹åŠ¿é“¾è·¯æ›´å¤æ‚
            this.removeStocksFromGroup(groupId, [s.code])
          })
      }
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      .backgroundColor('#101010')
      .borderRadius(12)
    }
    .margin({ bottom: 8 })
  }


  @Builder
  private buildWatchlistRow(s: StockQuote) {
    ListItem() {
      Row() {
        Column({ space: 4 }) {
          Text(s.name)
            .fontSize(14)
            .fontColor(Color.White)

          Text(s.code)
            .fontSize(11)
            .fontColor('#666666')
        }

        Blank()

        Column({ space: 4 }) {
          Text(s.price.toFixed(2))
            .fontSize(14)
            .fontColor(s.change >= 0 ? '#FF4D4F' : '#39D98A')
            .textAlign(TextAlign.End)

          Text(`${s.change.toFixed(2)}  ${s.changePercent.toFixed(2)}%`)
            .fontSize(11)
            .fontColor(s.change >= 0 ? '#FF7875' : '#6BE49B')
            .textAlign(TextAlign.End)
        }
      }
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#101010')
    }
    .margin({ bottom: 1 })
  }

  // ====== Tab 3ï¼šè¡Œæƒ…é€šçŸ¥ä¸­å¿ƒï¼ˆåªæ˜¯ UI åˆ—è¡¨ï¼‰ ======
  @Builder
  private buildNotificationTab() {
    Column() {
      Row() {
        Text('é€šçŸ¥è§„åˆ™').fontSize(14).fontColor(Color.White)
        Blank()
        Text('å‘½ä¸­åï¼šç³»ç»Ÿé€šçŸ¥ + éœ‡åŠ¨ï¼ˆçœŸæœºï¼‰')
          .fontSize(10).fontColor('#777777')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // âœ… æ–°å¢è§„åˆ™åŒº
      Column({ space: 8 }) {
        Row({ space: 8 }) {
          TextInput({ placeholder: 'è‚¡ç¥¨ä»£ç (6ä½)', text: this.ruleStockCodeInput })
            .width('38%').height(32).fontSize(13)
            .backgroundColor(Color.White).fontColor(Color.Black)
            .onChange((v: string) => { this.ruleStockCodeInput = v.trim() })

          // æ“ä½œç¬¦ï¼šç”¨ä¸¤ä¸ªå°æŒ‰é’®æœ€ç¨³ï¼Œä¸ç”¨å¤æ‚ Picker
          Row({ space: 6 }) {
            Text('â‰¥')
              .fontSize(12)
              .fontColor(this.ruleOpIndex === 0 ? '#FFFFFF' : '#AAAAAA')
              .padding({ left: 10, right: 10, top: 6, bottom: 6 })
              .backgroundColor(this.ruleOpIndex === 0 ? '#333333' : '#181818')
              .borderRadius(10)
              .onClick(() => { this.ruleOpIndex = 0 })

            Text('â‰¤')
              .fontSize(12)
              .fontColor(this.ruleOpIndex === 1 ? '#FFFFFF' : '#AAAAAA')
              .padding({ left: 10, right: 10, top: 6, bottom: 6 })
              .backgroundColor(this.ruleOpIndex === 1 ? '#333333' : '#181818')
              .borderRadius(10)
              .onClick(() => { this.ruleOpIndex = 1 })
          }

          TextInput({ placeholder: 'é˜ˆå€¼', text: this.rulePriceInput })
            .width('24%').height(32).fontSize(13)
            .backgroundColor(Color.White).fontColor(Color.Black)
            .onChange((v: string) => { this.rulePriceInput = v.trim() })

          Button('æ·»åŠ ')
            .height(32)
            .onClick(async () => { await this.addNotifyRuleFromUI() })
        }

        if (this.ruleMsg.length > 0) {
          Text(this.ruleMsg).fontSize(10).fontColor('#777777')
        }
      }
      .padding({ left: 16, right: 16, bottom: 10 })

      List() {
        ForEach(this.notifyRules, (rule: NotifyRule) => {
          this.buildNotifyRuleItem(rule);
        }, (rule: NotifyRule) => rule.id.toString())
      }
      .key(`notifyRules-${this.notifyRulesVer}`)  // ä½¿ç”¨ notifyRulesVer ä½œä¸º keyï¼Œç¡®ä¿æ¯æ¬¡æ›´æ–°æ—¶æ¸²æŸ“

    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }


  @Builder
  private buildNotifyRuleItem(rule: NotifyRule) {
    ListItem() {
      Row({ space: 10 }) {
        Column({ space: 4 }) {
          Text(`${rule.stockName}ï¼ˆ${rule.stockCode}ï¼‰`)
            .fontSize(13).fontColor(Color.White)

          Text(rule.conditionText)
            .fontSize(11).fontColor('#BBBBBB')
        }.layoutWeight(1)

        Button('åˆ é™¤')
          .height(28)
          .padding({ left: 10, right: 10 })
          .backgroundColor('#1A1A1A')
          .fontColor('#FF7875')
          .borderRadius(10)
          .onClick(async () => {
            await this.deleteRule(rule.id);
          })
      }
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#101010')
    }
    .margin({ bottom: 1 })
  }

}

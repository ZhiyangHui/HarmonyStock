import http from '@ohos.net.http';
import preferences from '@ohos.data.preferences';
import { formBindingData, formProvider } from '@kit.FormKit';
import { AppStorageV2 } from '@kit.ArkUI'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM } from '../common/ActiveFormatState'

import notificationManager from '@ohos.notificationManager'
import notification from '@ohos.notification'
import { RuleEngine, NotifyRuleLite } from '../service/RuleEngine'
import wantAgent from '@ohos.wantAgent'

const DOMAIN = 0x0000
const TAG: string = 'HarmonyStock'


// å‰ç«¯ç»Ÿä¸€çš„è¡Œæƒ…å¯¹è±¡ï¼ˆæŒ‡æ•°/è‚¡ç¥¨å…±ç”¨ï¼ŒUI/ç¼“å­˜/Kçº¿éƒ½ç”¨å®ƒï¼‰
interface Quote {
  code: string
  name: string
  price: number
  change: number
  changePercent: number
  type: 'index' | 'stock' // ç”¨æ¥åŒºåˆ†æŒ‡æ•°/è‚¡ç¥¨
}

// åç«¯åŸå§‹è¿”å›ç»“æ„ï¼ˆå­—æ®µåæŒ‰åç«¯æ¥ï¼Œç”¨ mapBackendQuote è½¬æˆ Quoteï¼‰
interface BackendQuote {
  code: string
  name: string
  price: number
  change: number
  change_percent: number // åç«¯ç”¨ä¸‹åˆ’çº¿å‘½åï¼›å‰ç«¯æ˜ å°„åˆ° changePercent
}

// è‡ªé€‰é¡µå±•ç¤ºç”¨çš„ç®€åŒ–è¡Œæƒ…ç»“æ„ï¼ˆä¸ä¸€å®šæ¯å¤„éƒ½è¦ç”¨ï¼Œä½†ä¿ç•™æ–¹ä¾¿ï¼‰
interface StockQuote {
  name: string
  code: string
  price: number
  change: number
  changePercent: number
}

// é€šçŸ¥è§„åˆ™é‡Œç”¨åˆ°çš„æ ‡çš„ç±»å‹ï¼ˆå†³å®š RuleEngine è¯·æ±‚å“ªä¸ª typeï¼‰
type QuoteType = 'index' | 'stock'

// é€šçŸ¥è§„åˆ™ï¼ˆå­˜æœ¬åœ° + RuleEngine è½®è¯¢åˆ¤æ–­å‘½ä¸­ï¼‰
interface NotifyRule {
  id: number
  quoteType: QuoteType      // è§„åˆ™é’ˆå¯¹æŒ‡æ•°è¿˜æ˜¯è‚¡ç¥¨ï¼ˆä¸åŠ è¿™ä¸ªä¼šæœ‰åŒç å†²çªé—®é¢˜ï¼‰
  stockCode: string         // 6ä½ä»£ç ï¼ˆ
  stockName: string
  conditionText: string     // ä¾‹å¦‚ "ä»·æ ¼ â‰¥ 25.00"ï¼ˆRuleEngine ä¼šè§£æè¿™ä¸ªå­—ç¬¦ä¸²ï¼‰
  enabled: boolean
}

// Kçº¿ç‚¹ï¼ˆåç«¯è¿”å›çš„OHLCVï¼‰
interface KLinePoint {
  date: string
  open: number
  high: number
  low: number
  close: number
  volume: number
}

// Kçº¿æ¸²æŸ“ç”¨çš„å‡ ä½•ä¿¡æ¯ï¼ˆæŠŠâ€œä»·æ ¼â€é¢„å¤„ç†æˆâ€œé«˜åº¦/åç§»â€ï¼ŒUIç›´æ¥ç”»Rectï¼‰
interface KlineGeom {
  upperWick: number
  bodyHeight: number
  lowerWick: number
  topGap: number
  isUp: boolean // close >= open
}

// è‡ªé€‰é‡Œå­˜çš„â€œè‚¡ç¥¨å¼•ç”¨â€ï¼ˆåªå­˜codeï¼Œnameå¯é€‰ï¼‰
interface StockRef {
  code: string
  name?: string
}

// ä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼ˆstockså˜åŒ–æ—¶ version +1ï¼Œç”¨æ¥å¼ºåˆ¶Liståˆ·æ–°ï¼‰
interface StockGroup {
  id: number
  name: string
  stocks: StockRef[]
  createdAt: number
  version: number // ç”¨äºè§¦å‘ UI è¯†åˆ«ç»“æ„å˜åŒ–ï¼ˆå°¤å…¶æ˜¯ List/ForEach åœºæ™¯ï¼‰
}

// åˆ†ç»„ç»Ÿè®¡ï¼ˆæ•°å€¼ç‰ˆï¼Œé€‚åˆè®¡ç®—ï¼‰
interface GroupStats {
  groupId: number
  stockCount: number
  upCount: number
  downCount: number
  avgChangePercent: number
}

// åˆ†ç»„ç»Ÿè®¡ï¼ˆå±•ç¤ºç‰ˆï¼Œç›´æ¥ç»™Textç”¨ï¼›ç¼ºæ•°æ®æ—¶ç”¨ '--'ï¼‰
interface ActiveGroupStats {
  stockCount: string
  up: string
  down: string
  avgPct: string // ä¾‹å¦‚ "0.52%" æˆ– "--"
}

// æ¡Œé¢å¡ç‰‡ç»‘å®šæ•°æ®ï¼ˆupdateFormç”¨ï¼›å¤šæ•°æ˜¯å·²ç»æ ¼å¼åŒ–å¥½çš„å­—ç¬¦ä¸²ï¼‰
interface WidgetBindData {
  formId: string
  title: string
  code: string
  name: string
  priceText: string
  changeText: string
  pctText: string
  tsText: string
  hasPrev: boolean
  hasNext: boolean
}


// é¡µé¢ç»„ä»¶
@Entry
@Component
struct HarmonyStockPage {
  // é¡¶éƒ¨ Tabï¼š0 å¸‚åœº / 1 è‡ªé€‰ / 2 é€šçŸ¥ï¼ˆTabs.onChange ä¼šæ”¹å®ƒï¼‰
  @State currentTabIndex: number = 0

  // å½“å‰è¡Œæƒ…æ¨¡å¼ï¼šæŒ‡æ•° or è‚¡ç¥¨ï¼ˆå½±å“è¡Œæƒ…åˆ—è¡¨ã€æœç´¢ã€Kçº¿è¯·æ±‚ typeï¼‰
  @State currentMode: 'index' | 'stock' = 'index'

  // è¡Œæƒ…æ¨ªå‘ strip çš„åŠ è½½/æŠ¥é”™çŠ¶æ€ï¼ˆåªç®¡â€œå¸‚åœºé¡µâ€çš„é‚£ä¸€æ¡ï¼‰
  @State listLoading: boolean = false
  @State listError: string = ''

  // æœç´¢è¾“å…¥ä¸çŠ¶æ€ï¼ˆè¾“å…¥æ¡† + æŸ¥è¯¢æŒ‰é’®é‚£å—ï¼‰
  @State searchCode: string = ''          // è¾“å…¥çš„ 6 ä½ä»£ç 
  @State searchLoading: boolean = false
  @State searchError: string = ''

  // è¡Œæƒ…å¡ç‰‡æ•°æ®ï¼šå®æ—¶åˆ—è¡¨ + æœç´¢ç»“æœï¼ˆéƒ½æ˜¾ç¤ºåœ¨åŒä¸€ä¸ªæ¨ªå‘ strip é‡Œï¼‰
  @State marketQuotes: Quote[] = []       // åç«¯æ‰¹é‡è¿”å›çš„å®æ—¶å¡ç‰‡
  @State searchedQuotes: Quote[] = []     // æŸ¥è¯¢å‡ºæ¥çš„å¡ç‰‡ï¼ˆç½®é¡¶ã€å»é‡ï¼‰

  // å½“å‰é€‰ä¸­çš„æ ‡çš„ï¼ˆå†³å®š K çº¿å±•ç¤ºçš„æ˜¯è°ï¼Œä¹Ÿç”¨äºæ¡Œé¢å¡ç‰‡å›å†™ï¼‰
  @State selectedQuoteCode: string = ''   // 6 ä½ä»£ç 
  @State selectedQuoteName: string = ''   // UI æ ‡é¢˜ç”¨
  @State selectedQuoteType: 'index' | 'stock' = 'index' // Kçº¿è¯·æ±‚ type / ç¼“å­˜keyç”¨

  // å½“å‰ K çº¿å‘¨æœŸï¼š0 æ—¥K / 1 å‘¨K / 2 æœˆKï¼ˆåˆ‡æ¢æŒ‰é’®ç”¨ï¼‰
  @State klinePeriodIndex: number = 0

  // K çº¿è¯·æ±‚çŠ¶æ€ï¼ˆåŠ è½½/é”™è¯¯/æ•°æ®ï¼‰
  @State klineLoading: boolean = false
  @State klineError: string = ''
  @State klinePoints: KLinePoint[] = []  // åç«¯è¿”å›çš„ OHLCV ç‚¹

  // K çº¿æ¸²æŸ“ç”¨çš„â€œé¢„è®¡ç®—â€ç»“æœï¼ˆæŠŠç‚¹ç®—æˆé«˜åº¦/åç§»ï¼ŒUIç›´æ¥ç”»ï¼‰
  @State klineGeoms: KlineGeom[] = []
  @State klineMinPrice: number = 0       // yè½´ä¸‹è¾¹ç•Œï¼ˆæ˜¾ç¤ºåˆ»åº¦ç”¨ï¼‰
  @State klineMaxPrice: number = 0       // yè½´ä¸Šè¾¹ç•Œï¼ˆæ˜¾ç¤ºåˆ»åº¦ç”¨ï¼‰
  @State klineXLabels: string[] = []     // xè½´æ ‡ç­¾ï¼ˆæœ€å¤šå–å‡ æ®µï¼‰

  // K çº¿å¸ƒå±€å¸¸é‡ï¼ˆè®¡ç®—å’Œ UI é«˜åº¦å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™ä¼šæº¢å‡º/å‹ç¼©ï¼‰
  private readonly KLINE_PLOT_H: number = 180     // èœ¡çƒ›ç»˜å›¾åŒºé«˜åº¦
  private readonly KLINE_LABEL_H: number = 24     // x è½´æ ‡ç­¾åŒºåŸŸé«˜åº¦
  // private readonly KLINE_CARD_INNER_PAD: number = 16 // Kçº¿å¡ç‰‡å†…éƒ¨ paddingï¼ˆç•™ç€ç»Ÿä¸€æ”¹ï¼‰

  // å½“å‰é€‰ä¸­çš„é‚£æ ¹ K çº¿ï¼ˆç‚¹æŸæ ¹èœ¡çƒ›åï¼Œè¯¦æƒ…æ¡æ˜¾ç¤ºè¿™äº›å€¼ï¼‰
  @State selectedKlineIndex: number = -1
  @State selectedKlineDate: string = ''
  @State selectedKlineOpen: number = 0
  @State selectedKlineHigh: number = 0
  @State selectedKlineLow: number = 0
  @State selectedKlineClose: number = 0

  // èœ¡çƒ›å®½åº¦ä¸é—´è·ï¼ˆå½±å“æ€»å®½åº¦ä¸æ»šåŠ¨æ‰‹æ„Ÿï¼‰
  private candleBodyWidth: number = 8
  private candleGap: number = 4

  // expandedKeys ç»Ÿä¸€æ§åˆ¶å±•å¼€é¡¹ï¼ˆç°åœ¨å¯ä¸ç”¨ï¼‰
  @State expandedKeys: string[] = []

  // è®°å½•æ¯å¼ è¡Œæƒ…å¡ç‰‡æ˜¯å¦å±•å¼€ï¼škey = `${type}-${code}`ï¼ˆè§£å†³åŒç /ä¸åŒç±»å‹çš„å†²çªï¼‰
  @State cardExpandedMap: Map<string, boolean> = new Map<string, boolean>()

  // ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼ˆè¡Œæƒ…/Kçº¿/å•åªæŸ¥è¯¢éƒ½ç”¨è¿™å¥—ï¼‰
  private readonly HTTP_CONNECT_TIMEOUT: number = 55000
  private readonly HTTP_READ_TIMEOUT: number = 55000

  // è‡ªé€‰åˆ†ç»„æœ¬åœ°å­˜å‚¨ï¼ˆpreferences æ–‡ä»¶å + keyï¼‰
  private readonly PREF_FILE: string = 'harmonystock_watchlist'
  private readonly PREF_KEY_GROUPS: string = 'groups_json'
  private nextGroupId: number = 1         // æ–°å»ºåˆ†ç»„ç”¨çš„è‡ªå¢ id

  // è‡ªé€‰é¡µå½“å‰åˆ†ç»„ä¸è¾“å…¥çŠ¶æ€
  @State activeGroupId: number = -1       // å½“å‰é€‰ä¸­çš„åˆ†ç»„ id
  @State watchlistMsg: string = ''        // è‡ªé€‰é¡µ/æ“ä½œåé¦ˆçš„æç¤ºæ–‡æ¡ˆ
  @State newGroupName: string = ''        // æ–°å»ºåˆ†ç»„è¾“å…¥æ¡†
  @State addStockCodeInput: string = ''   // æ·»åŠ è‚¡ç¥¨è¾“å…¥æ¡†

  // è¡Œæƒ…ç¼“å­˜ï¼škey = `${type}-${code}`ï¼ˆè‡ªé€‰ç»Ÿè®¡/åç§°/æ¶¨è·Œä¾èµ–å®ƒï¼‰
  @State quoteCache: Map<string, Quote> = new Map<string, Quote>()
  @State quoteCacheVer: number = 0        // å¼ºåˆ¶è§¦å‘ä¾èµ–ç¼“å­˜çš„ UI é‡æ–°è®¡ç®—

  // å½“å‰ active åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆä» groups æ´¾ç”Ÿå‡ºæ¥ï¼Œå•ç‹¬å­˜ä¸€ä»½æ–¹ä¾¿ List æ¸²æŸ“ï¼‰
  @State activeStocks: StockRef[] = []
  @State activeStocksVer: number = 0      // å¼ºåˆ¶ List é‡æ–°åˆ›å»º/åˆ·æ–°ç”¨

  // è‡ªé€‰ç»Ÿè®¡å¡ä¸Šçš„å±•ç¤ºå€¼ï¼ˆè¿™é‡Œç›´æ¥å­˜ stringï¼Œé¿å… UI é‡Œåˆ°å¤„ toFixed/æ‹¼%ï¼‰
  @State activeStatStockCount: string = '0'
  @State activeStatUp: string = '0'
  @State activeStatDown: string = '0'
  @State activeStatAvgPct: string = '--'
  @State activeStatsVer: number = 0       // é…åˆ keyï¼Œç”¨æ¥è®©ç»Ÿè®¡å¡ç¨³å®šåˆ·æ–°

  // ä»æ¡Œé¢å¡ç‰‡æ‹‰èµ· App æ—¶çš„ formIdï¼ˆç”¨äºæŠŠâ€œå½“å‰é€‰æ‹©â€å›å†™åˆ°æ¡Œé¢å¡ç‰‡ï¼‰
  @State activeFormId: string = ''

  // é€šçŸ¥é¡µï¼šæ–°å¢è§„åˆ™è¾“å…¥åŒºï¼ˆè‚¡ç¥¨ä»£ç /æ“ä½œç¬¦/é˜ˆå€¼/æç¤ºï¼‰
  @State ruleStockCodeInput: string = ''  // è§„åˆ™ä»£ç è¾“å…¥
  @State ruleOpIndex: number = 0          // 0: â‰¥  1: â‰¤ï¼ˆä½ ç°åœ¨åªåšè¿™ä¿©å°±å¤Ÿç¨³ï¼‰
  @State rulePriceInput: string = ''      // ä»·æ ¼é˜ˆå€¼è¾“å…¥
  @State ruleMsg: string = ''             // æ–°å¢è§„åˆ™æ—¶çš„æç¤º/æ ¡éªŒä¿¡æ¯
  @State ruleQuoteType: QuoteType = 'stock' // è§„åˆ™é’ˆå¯¹æŒ‡æ•°è¿˜æ˜¯è‚¡ç¥¨ï¼ˆé»˜è®¤è‚¡ç¥¨æ›´ç¬¦åˆä¹ æƒ¯ï¼‰

  // é€šçŸ¥è§„åˆ™åˆ—è¡¨ç‰ˆæœ¬å·ï¼ˆæ¯æ¬¡å¢åˆ /åˆ‡æ¢ enabled éƒ½ ++ï¼Œç”¨æ¥åˆ·æ–° Listï¼‰
  @State notifyRulesVer: number = 0

  onPageShow() {
    // é¡µé¢å›åˆ°å‰å°æ—¶è§¦å‘ï¼šå…ˆæ‹¿åˆ°æ¡Œé¢å¡ç‰‡ä¼ æ¥çš„ formIdï¼Œå†ï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ ‡çš„ï¼‰é¡ºæ‰‹æŠŠå½“å‰è¡Œæƒ…å›å†™åˆ°å¡ç‰‡
    hilog.error(0x0000, 'INDEX_DEBUG', 'ğŸ”¥ Index onPageShow CALLED')

    // ä» AppStorageV2 æ¶ˆè´¹ formIdï¼ˆç”¨äºåç»­æ›´æ–°æ¡Œé¢å¡ç‰‡ï¼‰
    this.consumeFormIdFromAppStorageV2('onPageShow')

    // å¦‚æœæ˜¯ä»å¡ç‰‡æ‰“å¼€çš„ï¼Œå¹¶ä¸”å½“å‰å·²ç»é€‰ä¸­äº†ä¸€åªæ ‡çš„ï¼šåŒæ­¥æ›´æ–°å¡ç‰‡å±•ç¤º
    if (this.activeFormId.length > 0 && this.selectedQuoteCode.length > 0) {
      const q: Quote | null = this.findQuoteInCaches(this.selectedQuoteCode)
      if (q !== null) {
        this.updateWidgetIfLaunchedFromForm(q)
      }
    }
  }

  // ===== è‡ªé€‰ / é€šçŸ¥å‡æ•°æ®ï¼ˆä¿æŒåŸæ ·ï¼‰ =====
  @State groups: StockGroup[] = [
    {
      id: 1,
      name: 'ç§‘æŠ€è‚¡',
      stocks: [
        { name: 'å®å¾·æ—¶ä»£', code: '300750' },
        { name: 'ä¸­èŠ¯å›½é™…', code: '688981' }
      ],
      createdAt: Date.now(),
      version: 0
    },
    {
      id: 2,
      name: 'æ–°èƒ½æº',
      stocks: [
        { name: 'éš†åŸºç»¿èƒ½', code: '601012' }
      ],
      createdAt: Date.now(),
      version: 0
    }
  ];

  // é€šçŸ¥è§„åˆ™åˆ—è¡¨ï¼šUI é‡Œå±•ç¤ºã€RuleEngine è½®è¯¢æ—¶ä¹Ÿä»è¿™é‡Œå–ï¼ˆä¼šæŒä¹…åŒ–åˆ° prefsï¼‰
  @State notifyRules: NotifyRule[] = [
    // ç¤ºä¾‹è§„åˆ™ï¼šå®å¾·æ—¶ä»£ï¼Œè‚¡ç¥¨ç±»å‹ï¼›å½“ä»·æ ¼è¾¾åˆ°/è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘é€šçŸ¥
    { id: 999, quoteType: 'stock', stockCode: '300750', stockName: 'å®å¾·æ—¶ä»£', conditionText: 'ä»·æ ¼ â‰¥ 1.00', enabled: true },

    // ç¤ºä¾‹è§„åˆ™ï¼šéš†åŸºç»¿èƒ½ï¼Œè‚¡ç¥¨ç±»å‹ï¼›å½“ä»·æ ¼ä½äº/ç­‰äºé˜ˆå€¼æ—¶è§¦å‘é€šçŸ¥ï¼ˆè¿™é‡Œå…ˆå…³æ‰ï¼‰
    { id: 2, quoteType: 'stock', stockCode: '601012', stockName: 'éš†åŸºç»¿èƒ½', conditionText: 'ä»·æ ¼ â‰¤ 28.00', enabled: true }
  ]

  // ä¸‹ä¸€æ¡è§„åˆ™çš„è‡ªå¢ id èµ·ç‚¹ï¼šä» prefs è¯»å®Œè§„åˆ™åä¼šç”¨ recomputeNextRuleId() é‡æ–°æ ¡å‡†ï¼Œé¿å…é‡å¤
  private nextRuleId: number = 1000

  // é€šçŸ¥è§„åˆ™åœ¨ preferences é‡Œä¿å­˜ç”¨çš„ keyï¼ˆå¯¹åº” PREF_FILE é‡Œçš„ä¸€ä¸ªå­—æ®µåï¼‰
  private readonly PREF_KEY_RULES: string = 'notify_rules_json'

  private refreshActiveGroupStats(): void {
    // é‡æ–°æ ¹æ®å½“å‰åˆ†ç»„çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆactiveStocksï¼‰è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼šæ•°é‡/æ¶¨è·Œ/å‡æ¶¨è·Œ
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)

    // å†™å›åˆ°å‡ ä¸ª @State å­—æ®µï¼ŒUI é‡Œç»Ÿè®¡å¡ç‰‡ä¼šç›´æ¥ç»‘å®šè¿™äº›å€¼
    this.activeStatStockCount = st.stockCount
    this.activeStatUp = st.up
    this.activeStatDown = st.down
    this.activeStatAvgPct = st.avgPct

    // ç‰ˆæœ¬å·æ‰‹åŠ¨ +1ï¼šæœ‰äº›åœ°æ–¹ç”¨ key ä¾èµ–å®ƒï¼Œç¡®ä¿ç»Ÿè®¡åŒºåŸŸèƒ½ç¨³å®šåˆ·æ–°
    this.activeStatsVer += 1

    // è°ƒè¯•ç”¨ï¼šçœ‹ä¸€ä¸‹æ¯æ¬¡åˆ·æ–°åçš„ç»Ÿè®¡ç»“æœ
    console.info(
      `[DBG] stats=${this.activeStatStockCount}, up=${this.activeStatUp}, down=${this.activeStatDown}, avg=${this.activeStatAvgPct}, ver=${this.activeStatsVer}`
    )
  }


  // åç«¯è¡Œæƒ… -> å‰ç«¯ Quote
  private mapBackendQuote(raw: BackendQuote, type: 'index' | 'stock'): Quote {
    return {
      code: raw.code,
      name: raw.name,
      price: raw.price,
      change: raw.change,
      changePercent: raw.change_percent,
      type: type
    };
  }

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    // é¡µé¢å³å°†æ˜¾ç¤ºï¼šæ‰“ä¸ªè°ƒè¯•ç‚¹ï¼Œæ–¹ä¾¿çœ‹ç”Ÿå‘½å‘¨æœŸæ˜¯å¦æ­£å¸¸èµ°åˆ°è¿™
    this.dbg('aboutToAppear:enter')

    // å…ˆæŠŠæœ¬åœ°æŒä¹…åŒ–çš„æ•°æ®æ¢å¤å‡ºæ¥ï¼ˆåˆ†ç»„/è§„åˆ™/è‡ªé€‰é¢„çƒ­/æ‹‰è¡Œæƒ…ï¼‰
    // è¿™é‡Œç”¨ then æ˜¯ä¸ºäº†ç¡®ä¿é¡ºåºï¼šåˆ†ç»„ -> è§„åˆ™ -> é¢„çƒ­ -> æ‹‰åˆ—è¡¨
    this.loadGroupsFromPrefs().then(async () => {
      await this.loadNotifyRulesFromPrefs()   // è¯»å–æœ¬åœ°ä¿å­˜çš„é€šçŸ¥è§„åˆ™ï¼ˆnotify_rules_jsonï¼‰
      await this.preloadActiveGroupQuotes()   // é¢„çƒ­å½“å‰åˆ†ç»„çš„è‚¡ç¥¨è¡Œæƒ…åˆ°ç¼“å­˜ï¼Œåé¢ç»Ÿè®¡/åˆ—è¡¨èƒ½ç«‹åˆ»æ˜¾ç¤º
      this.fetchQuotes(this.currentMode)      // æ‹‰å–å½“å‰æ¨¡å¼ï¼ˆæŒ‡æ•°/è‚¡ç¥¨ï¼‰çš„å¸‚åœºåˆ—è¡¨
    })

    // å¯åŠ¨è§„åˆ™å¼•æ“ï¼šå†…éƒ¨ä¼šå®šæ—¶è½®è¯¢è¡Œæƒ…å¹¶åˆ¤æ–­è§„åˆ™æ˜¯å¦å‘½ä¸­
    // è¿™é‡Œä¼ çš„æ˜¯ä¸€ä¸ª providerï¼šæ¯æ¬¡ tick éƒ½ä»é¡µé¢æœ€æ–°çš„ notifyRules é‡Œå–ä¸€ä»½è½»é‡è§„åˆ™
    RuleEngine.start((): NotifyRuleLite[] => {
      const out: NotifyRuleLite[] = []

      for (let i: number = 0; i < this.notifyRules.length; i++) {
        const r: NotifyRule = this.notifyRules[i]

        // æ³¨æ„ï¼šRuleEngine åªè®¤è¯† NotifyRuleLiteï¼Œæ‰€ä»¥è¦æŠŠé¡µé¢è§„åˆ™â€œæ˜ å°„â€è¿‡å»
        // quoteType å¿…é¡»å¸¦ä¸Šï¼ˆè‚¡ç¥¨/æŒ‡æ•°ï¼‰ï¼Œä¸ç„¶ä¼šå‡ºç°ä½ ä¹‹å‰çš„ç¼ºå­—æ®µæŠ¥é”™
        out.push({
          id: r.id,
          quoteType: r.quoteType,      // stock / indexï¼ˆå†³å®šåç«¯æ‹‰ä»·æ—¶ type=stock è¿˜æ˜¯ type=indexï¼‰
          stockCode: r.stockCode,
          stockName: r.stockName,
          conditionText: r.conditionText,
          enabled: r.enabled
        })
      }
      return out
    }, 5000, 10000) // intervalMs=5000ï¼šæ¯ 5s æ£€æŸ¥ä¸€æ¬¡ï¼›cooldownMs=10000ï¼šå‘½ä¸­å 10s å†…ä¸é‡å¤é€šçŸ¥
  }

  aboutToDisappear(): void {
    // é¡µé¢ç¦»å¼€æ—¶åœæ­¢è½®è¯¢ï¼Œé¿å…åå°ä¸€ç›´è·‘ï¼ˆçœç”µ/çœæµé‡ï¼Œä¹Ÿé¿å…é‡å¤é€šçŸ¥ï¼‰
    RuleEngine.stop()
  }


  // æ‹‰å–è¡Œæƒ…åˆ—è¡¨ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰
  // type ä¼  'index' æˆ– 'stock'ï¼ŒåŒä¸€å¥—æ¥å£èµ°ä¸¤ç§æ•°æ®
  private async fetchQuotes(type: 'index' | 'stock'): Promise<void> {
    // åªæœ‰â€œè¯·æ±‚çš„ç±»å‹â€åˆšå¥½æ˜¯å½“å‰é¡µé¢æ¨¡å¼æ—¶ï¼Œæ‰æ›´æ–° loading / error / åˆ—è¡¨ UI
    // è¿™æ ·ä½ ä»¥åå¦‚æœåå°å·å·æ‹‰å¦ä¸€ç§ç±»å‹çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šæŠŠç”¨æˆ·æ­£åœ¨çœ‹çš„ç•Œé¢åˆ·ä¹±
    const affectUI: boolean = (type === this.currentMode)

    if (affectUI) {
      this.listLoading = true     // é¡µé¢ä¸Šçš„â€œè¡Œæƒ…åŠ è½½ä¸­â€¦â€çŠ¶æ€
      this.listError = ''         // æ¸…ç©ºä¸Šä¸€æ¬¡é”™è¯¯
    }

    const httpRequest = http.createHttp()
    try {
      // åç«¯æ ¹æ® type è¿”å›æŒ‡æ•°åˆ—è¡¨æˆ–è‚¡ç¥¨åˆ—è¡¨
      const url: string = `http://101.43.185.73:8000/api/quote?type=${type}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        // åç«¯å­—æ®µæ˜¯ change_percentï¼Œè¿™é‡Œç»Ÿä¸€æ˜ å°„æˆå‰ç«¯ Quote ç»“æ„
        const raw: BackendQuote[] = JSON.parse(res.result as string) as BackendQuote[]
        const mapped: Quote[] = raw.map((it: BackendQuote): Quote => this.mapBackendQuote(it, type))

        // åªåœ¨â€œå½“å‰æ¨¡å¼â€ä¸‹æ‰æ›´æ–°å¸‚åœºå¡ç‰‡åˆ—è¡¨
        if (affectUI) {
          this.marketQuotes = mapped
        }

        // ä¸ç®¡å½“å‰ UI åœ¨çœ‹å“ªç§æ¨¡å¼ï¼Œéƒ½æŠŠæ•°æ®å†™è¿›ç¼“å­˜ï¼š
        // è‡ªé€‰åˆ†ç»„ç»Ÿè®¡ / è‡ªé€‰åˆ—è¡¨è¡Œæ˜¾ç¤º éƒ½ä¾èµ– quoteCache
        this.mergeQuotesToCache(mapped)

        // ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢ï¼šé»˜è®¤é€‰ä¸­ç¬¬ä¸€æ¡ï¼Œå¹¶æ‹‰ä¸€ä»½ K çº¿
        // åªå¯¹å½“å‰æ¨¡å¼ç”Ÿæ•ˆï¼Œé¿å…åˆ‡åˆ°å¦ä¸€æ¨¡å¼æ—¶è¯¯è§¦å‘
        if (affectUI && this.selectedQuoteCode === '' && mapped.length > 0) {
          const first: Quote = mapped[0]
          this.selectedQuoteCode = first.code
          this.selectedQuoteName = first.name
          this.selectedQuoteType = first.type

          const period: string = this.getKlinePeriodParam()
          this.fetchKline(first.type, first.code, period) // è¿™é‡Œä¸ awaitï¼ŒK çº¿è‡ªå·±èµ° loading
        }
      } else {
        // HTTP é 200ï¼šåªåœ¨å½“å‰æ¨¡å¼ä¸‹æç¤ºé”™è¯¯ï¼Œé¿å…â€œåå°è¯·æ±‚å¤±è´¥â€å½±å“ç”¨æˆ·æ­£åœ¨çœ‹çš„ç•Œé¢
        if (affectUI) {
          this.listError = `HTTP ${res.responseCode}`
          this.marketQuotes = []
        }
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸/è§£æå¼‚å¸¸ï¼šåŒæ ·åªå½±å“å½“å‰æ¨¡å¼ UI
      if (affectUI) {
        this.listError = `${e}`
        this.marketQuotes = []
      }
    } finally {
      // é‡Šæ”¾ request å¯¹è±¡ï¼Œé¿å…èµ„æºæ³„æ¼
      httpRequest.destroy()

      // åªåœ¨å½“å‰æ¨¡å¼ä¸‹å…³é—­ loading
      if (affectUI) {
        this.listLoading = false
      }
    }
  }

  // æ‹‰å– K çº¿æ•°æ®ï¼ˆæŒ‡æ•° / è‚¡ç¥¨å…±ç”¨ï¼‰
  // type: 'index' / 'stock'ï¼Œcode: 6ä½ä»£ç ï¼Œperiod: day/week/month
  private async fetchKline(
    type: 'index' | 'stock',
    code: string,
    period: string
  ): Promise<void> {
    // è¿›å…¥åŠ è½½æ€ï¼šK çº¿å¡ç‰‡åŒºåŸŸä¼šæ˜¾ç¤ºâ€œåŠ è½½ä¸­â€¦â€
    this.klineLoading = true
    this.klineError = '' // æ¸…ç©ºä¸Šä¸€æ¬¡é”™è¯¯

    const httpRequest = http.createHttp()
    try {
      // limit=60ï¼šæœ€å¤šå–æœ€è¿‘ 60 æ ¹Kçº¿ï¼Œå‰ç«¯èœ¡çƒ›å›¾å®½åº¦ä¹ŸæŒ‰è¿™ä¸ªé‡æ¥ç®—
      const url: string =
        `http://101.43.185.73:8000/api/kline` +
          `?type=${type}&code=${code}&period=${period}&limit=60`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      if (res.responseCode === 200 && res.result) {
        // åç«¯è¿”å›çš„å°±æ˜¯ KLinePoint æ•°ç»„ï¼ˆdate/open/high/low/close/volumeï¼‰
        const raw: KLinePoint[] = JSON.parse(res.result as string) as KLinePoint[]
        this.klinePoints = raw

        // ä½“éªŒä¸Šä¸€èˆ¬é»˜è®¤çœ‹â€œæœ€æ–°ä¸€æ ¹â€ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æœ€åä¸€ä¸ªç‚¹
        // åŒæ—¶ä¼šæŠŠè¯¦ç»†ä¿¡æ¯æ¡ï¼ˆå¼€é«˜ä½æ”¶ï¼‰æ›´æ–°åˆ°å¯¹åº”çš„ @State å­—æ®µé‡Œ
        if (this.klinePoints.length > 0) {
          const lastIndex: number = this.klinePoints.length - 1
          this.onKlineSelected(lastIndex)
        } else {
          // æ²¡æ•°æ®å°±æ¸…æ‰é€‰ä¸­æ€ï¼Œé¿å…è¿˜æ˜¾ç¤ºæ—§çš„é«˜äº®/è¯¦æƒ…
          this.selectedKlineIndex = -1
        }

        // points æ›´æ–°åï¼Œé‡æ–°è®¡ç®—æ¯æ ¹èœ¡çƒ›çš„å‡ ä½•ä¿¡æ¯ï¼ˆä¸Šä¸‹å½±çº¿/å®ä½“é«˜åº¦/é¡¶éƒ¨ç©ºç™½ï¼‰
        // è¿™ä¸€æ­¥ä¼šåŒæ­¥æ›´æ–°ï¼šklineGeoms / klineMinPrice / klineMaxPrice / klineXLabels
        this.recomputeKlineGeom()
      } else {
        // HTTP é 200ï¼šè®°å½•é”™è¯¯ï¼Œå¹¶æŠŠå›¾è¡¨ç›¸å…³æ•°æ®æ¸…ç©ºï¼ˆé¿å…æ®‹ç•™æ—§å›¾ï¼‰
        this.klineError = `HTTP ${res.responseCode}`
        this.klinePoints = []
        this.klineGeoms = []
        this.klineXLabels = []
        this.selectedKlineIndex = -1
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸ / JSON è§£æå¼‚å¸¸ï¼šåŒæ ·æ¸…ç©ºå›¾è¡¨æ•°æ®ï¼Œç»™ UI ä¸€ä¸ªå¯é¢„æœŸçš„çŠ¶æ€
      this.klineError = `${e}`
      this.klinePoints = []
      this.klineGeoms = []
      this.klineXLabels = []
      this.selectedKlineIndex = -1
    } finally {
      // é‡Šæ”¾ request å¯¹è±¡
      httpRequest.destroy()

      // é€€å‡ºåŠ è½½æ€
      this.klineLoading = false
    }
  }


  // æ ¹æ®å½“å‰çš„å‘¨æœŸé€‰æ‹©ï¼ˆklinePeriodIndexï¼‰æ‹¼å‡ºåç«¯éœ€è¦çš„ period å‚æ•°
  // çº¦å®šï¼š0=æ—¥Kï¼Œ1=å‘¨Kï¼Œ2=æœˆKï¼ˆå’Œ UI ä¸Šçš„â€œæ—¥K/å‘¨K/æœˆKâ€æŒ‰é’®å¯¹åº”ï¼‰
  private getKlinePeriodParam(): string {
    if (this.klinePeriodIndex === 1) {
      return 'week'   // å‘¨Kï¼šç”¨äºè¯·æ±‚ ?period=week
    }
    if (this.klinePeriodIndex === 2) {
      return 'month'  // æœˆKï¼šç”¨äºè¯·æ±‚ ?period=month
    }
    return 'day'      // é»˜è®¤æ—¥Kï¼šç”¨äºè¯·æ±‚ ?period=day
  }

  // ===== è®¡ç®— K çº¿å‡ ä½•ä¿¡æ¯ & åæ ‡è½´ =====
  private recomputeKlineGeom(): void {
    // pointsï¼šåç«¯è¿”å›çš„åŸå§‹ K çº¿æ•°æ®ï¼ˆå¼€é«˜ä½æ”¶ + æ—¥æœŸï¼‰
    const points: KLinePoint[] = this.klinePoints;
    // geomsï¼šæŠŠâ€œä»·æ ¼â€æ¢ç®—æˆâ€œåƒç´ é«˜åº¦â€ï¼ŒUI æ¸²æŸ“èœ¡çƒ›å›¾åªç”¨å®ƒ
    const geoms: KlineGeom[] = [];
    // labelsï¼šx è½´æ˜¾ç¤ºçš„æ—¥æœŸï¼ˆåšäº†æŠ½æ ·ï¼Œä¸ä¼šæ¯æ ¹éƒ½ç”»ï¼‰
    const labels: string[] = [];

    // æ²¡æ•°æ®å°±æ¸…ç©º UI å¯¹åº”çŠ¶æ€
    if (points.length === 0) {
      this.klineGeoms = geoms;
      this.klineXLabels = labels;
      return;
    }

    // 1) æ‰«ä¸€éï¼Œæ‹¿åˆ°è¿™ä¸€å± K çº¿çš„æœ€é«˜ä»· / æœ€ä½ä»·ï¼ˆç”¨äºåš y è½´æ˜ å°„ï¼‰
    let minPrice: number = points[0].low;
    let maxPrice: number = points[0].high;

    for (let i: number = 1; i < points.length; i++) {
      const p: KLinePoint = points[i];
      if (p.low < minPrice) {
        minPrice = p.low;
      }
      if (p.high > maxPrice) {
        maxPrice = p.high;
      }
    }

    // æç«¯æƒ…å†µé˜²å¾¡ï¼šå¦‚æœæœ€é«˜ä»·=æœ€ä½ä»·ï¼Œrange=0ï¼Œä¼šå¯¼è‡´é™¤é›¶
    let range: number = maxPrice - minPrice;
    if (range <= 0) {
      range = 1.0;
      maxPrice = minPrice + range;
    }

    // è®°å½•ç»™ y è½´åˆ»åº¦æ˜¾ç¤ºç”¨
    this.klineMinPrice = minPrice;
    this.klineMaxPrice = maxPrice;

    // 2) ç»Ÿä¸€ä½¿ç”¨å›ºå®šç»˜å›¾é«˜åº¦ï¼ˆè¿™å¿…é¡»å’Œ UI èœ¡çƒ›åŒºåŸŸ height ä¿æŒä¸€è‡´ï¼‰
    const fullHeight: number = this.KLINE_PLOT_H;

    // å¤ªæ‰çš„èœ¡çƒ›çœ‹ä¸è§ï¼šç»™å®ä½“/å½±çº¿ä¸€ä¸ªæœ€å°åƒç´ é«˜åº¦
    const minBody: number = 4;
    const minWick: number = 2;

    // æŠŠâ€œä»·æ ¼â€æ˜ å°„åˆ°â€œy åƒç´ åæ ‡â€
    // y=0 åœ¨æœ€ä¸Šé¢ï¼›ä»·æ ¼è¶Šé«˜ï¼Œy è¶Šå°
    const priceToY = (price: number): number => {
      const y: number = (maxPrice - price) / range * fullHeight;
      if (y < 0) {
        return 0;
      }
      if (y > fullHeight) {
        return fullHeight;
      }
      return y;
    };

    // 3) æŠŠæ¯æ ¹ K çº¿è½¬æˆ UI å¯ç›´æ¥ç”»çš„å‡ ä½•æ•°æ®
    for (let i: number = 0; i < points.length; i++) {
      const pt: KLinePoint = points[i];

      // æŠŠå¼€é«˜ä½æ”¶éƒ½æ˜ å°„æˆ y åæ ‡ï¼ˆåé¢ç”¨è¿™äº›æ¥ç®—å®ä½“/å½±çº¿é«˜åº¦ï¼‰
      const yHigh: number = priceToY(pt.high);
      const yLow: number = priceToY(pt.low);
      const yOpen: number = priceToY(pt.open);
      const yClose: number = priceToY(pt.close);

      // å®ä½“çš„ä¸Šè¾¹/ä¸‹è¾¹ï¼šopen å’Œ close è°é«˜è°åœ¨ä¸Š
      let yTopBody: number = Math.min(yOpen, yClose);
      let yBottomBody: number = Math.max(yOpen, yClose);

      // å®ä½“å¤ªè–„æ—¶å¼ºåˆ¶æ‹‰åˆ°æœ€å°é«˜åº¦ï¼ˆå¦åˆ™ç”¨æˆ·ç‚¹é€‰æ—¶åƒâ€œæ²¡ä¸œè¥¿â€ï¼‰
      if (yBottomBody - yTopBody < minBody) {
        const mid: number = (yTopBody + yBottomBody) / 2.0;
        yTopBody = mid - minBody / 2.0;
        yBottomBody = mid + minBody / 2.0;

        // æ‹‰ä¼¸åå¯èƒ½è¶…å‡ºç»˜å›¾åŒºï¼Œåšä¸€æ¬¡è£å‰ª
        if (yTopBody < 0) {
          yTopBody = 0;
          yBottomBody = minBody;
        }
        if (yBottomBody > fullHeight) {
          yBottomBody = fullHeight;
          yTopBody = fullHeight - minBody;
        }
      }

      // ä¸Šå½±çº¿é«˜åº¦ï¼šhigh -> å®ä½“ä¸Šè¾¹ï¼ˆy è¶Šå°è¶Šé ä¸Šï¼Œæ‰€ä»¥ç”¨ yTopBody - yHighï¼‰
      let upperWick: number = yTopBody - yHigh;
      if (upperWick < minWick) {
        upperWick = minWick;
      }

      // ä¸‹å½±çº¿é«˜åº¦ï¼šå®ä½“ä¸‹è¾¹ -> low
      let lowerWick: number = yLow - yBottomBody;
      if (lowerWick < minWick) {
        lowerWick = minWick;
      }

      // topGapï¼šèœ¡çƒ›æ•´ä½“ç¦»é¡¶éƒ¨çš„ç©ºç™½ï¼ˆç”¨äºå…ˆç”»ä¸€ä¸ª Blank æŠŠèœ¡çƒ›â€œé¡¶â€åˆ°æ­£ç¡®ä½ç½®ï¼‰
      let topGap: number = yHigh;
      if (topGap < 0) {
        topGap = 0;
      }
      if (topGap > fullHeight) {
        topGap = fullHeight;
      }

      // å†åšä¸€å±‚é˜²å¾¡ï¼šå¦‚æœç©ºç™½+å½±çº¿+å®ä½“åŠ èµ·æ¥è¶…è¿‡ç»˜å›¾åŒºï¼Œä¼šå¯¼è‡´å¸ƒå±€æº¢å‡º
      // è¿™é‡Œä¼˜å…ˆå‹ç¼© topGapï¼ˆè§†è§‰å½±å“æœ€å°ï¼‰ï¼Œå½±çº¿/å®ä½“å°½é‡ä¸åŠ¨
      const totalH: number = topGap + upperWick + (yBottomBody - yTopBody) + lowerWick;
      if (totalH > fullHeight) {
        const overflow: number = totalH - fullHeight;
        topGap = topGap - overflow;
        if (topGap < 0) {
          topGap = 0;
        }
      }

      // ç»„è£…ç»™ UI ç”¨çš„ç»“æ„ï¼šåé¢ ForEach ç›´æ¥ç”» Rect
      geoms.push({
        upperWick: upperWick,
        bodyHeight: (yBottomBody - yTopBody),
        lowerWick: lowerWick,
        topGap: topGap,
        isUp: pt.close >= pt.open // æ”¶>=å¼€ è§†ä¸ºæ¶¨ï¼ˆå†³å®šå®ä½“é¢œè‰²ï¼‰
      });
    }

    // 4) x è½´æ ‡ç­¾ï¼šæœ€å¤šæ˜¾ç¤º 5 ä¸ªï¼Œå‡åŒ€æŠ½æ ·ï¼ˆä¸ç„¶ 60 æ ¹ K çº¿ä¼šæŒ¤æˆä¸€å›¢ï¼‰
    const total: number = points.length;
    const maxLabels: number = 5;
    const actualLabels: number = total >= maxLabels ? maxLabels : total;

    if (actualLabels > 0) {
      const lastIndex: number = total - 1;
      for (let i: number = 0; i < actualLabels; i++) {
        let idx: number;
        if (actualLabels === 1) {
          idx = 0;
        } else {
          idx = Math.floor(i * lastIndex / (actualLabels - 1));
        }

        // æ—¥æœŸä¸€èˆ¬æ˜¯ YYYY-MM-DDï¼Œè¿™é‡Œåªæ˜¾ç¤º MM-DD æ›´çœç©ºé—´
        const dateStr: string = points[idx].date;
        const label: string = dateStr.length >= 5 ? dateStr.substring(5) : dateStr;
        labels.push(label);
      }
    }

    // ä¸€æ¬¡æ€§å†™å›çŠ¶æ€ï¼Œè®© UI åˆ·æ–°
    this.klineGeoms = geoms;
    this.klineXLabels = labels;
  }



  // é€‰ä¸­æŸä¸€æ ¹ K çº¿
  private onKlineSelected(index: number): void {
    if (index < 0 || index >= this.klinePoints.length) {
      return;
    }

    const pt: KLinePoint = this.klinePoints[index];

    this.selectedKlineIndex = index;
    this.selectedKlineDate = pt.date;
    this.selectedKlineOpen = pt.open;
    this.selectedKlineHigh = pt.high;
    this.selectedKlineLow = pt.low;
    this.selectedKlineClose = pt.close;
  }

  // ===== å»æ‰ strip ä¸­æŸä¸ªæ ‡çš„ =====
  private removeQuoteCard(code: string, type: 'index' | 'stock'): void {
    // æœç´¢ç»“æœé‡ŒæŠŠå¯¹åº”çš„å¡ç‰‡åˆ æ‰ï¼ˆåŒ code + åŒ type æ‰ç®—åŒä¸€ä¸ªï¼‰
    this.searchedQuotes = this.searchedQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );

    // å®æ—¶è¡Œæƒ…åˆ—è¡¨é‡Œä¹Ÿåˆ æ‰ä¸€ä»½
    this.marketQuotes = this.marketQuotes.filter((item: Quote) =>
    !(item.code === code && item.type === type)
    );

    // å¦‚æœåˆ æ‰çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„é‚£åªï¼Œå°±æŠŠå³ä¾§ K çº¿åŒºåŸŸä¹Ÿä¸€å¹¶æ¸…ç©ºï¼Œé¿å…è¿˜æ˜¾ç¤ºæ—§æ•°æ®
    if (this.selectedQuoteCode === code && this.selectedQuoteType === type) {
      this.selectedQuoteCode = '';
      this.selectedQuoteName = '';
      this.selectedKlineIndex = -1;
      this.klinePoints = [];
      this.klineGeoms = [];
      this.klineXLabels = [];
    }
  }


  // ===== æ ¹æ®ä»£ç æŸ¥è¯¢å•ä¸ªæ ‡çš„ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ =====
  private async queryQuoteByCode(): Promise<void> {
    // è¾“å…¥æ¡†é‡Œæ‹¿åˆ°çš„ä»£ç å…ˆåšä¸€æ¬¡ trimï¼Œé¿å…ç”¨æˆ·ä¸å°å¿ƒè¾“ç©ºæ ¼
    const code: string = this.searchCode.trim()

    // è¿™é‡Œåªæ”¯æŒ 6 ä½ä»£ç ï¼ˆæŒ‡æ•° / A è‚¡éƒ½æŒ‰ 6 ä½èµ°ï¼‰
    if (code.length !== 6) {
      this.searchError = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    // è¿›å…¥è¯·æ±‚æ€ï¼šå±•ç¤ºâ€œæ­£åœ¨æŸ¥è¯¢â€¦â€ï¼Œå¹¶æ¸…æ‰ä¸Šä¸€æ¬¡çš„é”™è¯¯æç¤º
    this.searchLoading = true
    this.searchError = ''

    const httpRequest = http.createHttp()
    try {
      // æŸ¥è¯¢ç±»å‹è·Ÿç€å½“å‰æ¨¡å¼èµ°ï¼šæŒ‡æ•°æ¨¡å¼å°±æŸ¥æŒ‡æ•°æ¥å£ï¼Œè‚¡ç¥¨æ¨¡å¼å°±æŸ¥è‚¡ç¥¨æ¥å£
      const type: 'index' | 'stock' = this.currentMode
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=${type}&code=${code}`

      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      // 200ï¼šåç«¯è¿”å›å•æ¡è¡Œæƒ…
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const newItem: Quote = this.mapBackendQuote(backendItem, type)

        // å†™å…¥ç¼“å­˜ï¼šåé¢è‡ªé€‰ç»Ÿè®¡ã€åˆ—è¡¨è¡Œå±•ç¤ºéƒ½ä¾èµ– quoteCache
        this.mergeQuotesToCache([newItem])

        // æœç´¢ç»“æœåªæ˜¾ç¤ºâ€œå½“å‰æ¨¡å¼â€çš„å†…å®¹ï¼š
        // - æ–°ç»“æœæ”¾æœ€å‰é¢
        // - å»æ‰é‡å¤ï¼ˆåŒ code + type çš„åªä¿ç•™ä¸€æ¡ï¼‰
        const next: Quote[] = [newItem]
        for (let i: number = 0; i < this.searchedQuotes.length; i++) {
          const q: Quote = this.searchedQuotes[i]
          if (q.type !== type) continue
          if (q.code === newItem.code && q.type === newItem.type) continue
          next.push(q)
        }
        this.searchedQuotes = next
        return
      }

      // 404ï¼šåç«¯æ˜ç¡®è¡¨ç¤ºæ²¡è¿™ä¸ªä»£ç ï¼ˆç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤ºï¼‰
      if (res.responseCode === 404) {
        this.searchError = 'æœªæ‰¾åˆ°è¯¥ä»£ç '
      } else {
        // å…¶ä»–é”™è¯¯ï¼šç›´æ¥æŠŠ HTTP code æ˜¾ç¤ºå‡ºæ¥ï¼Œä¾¿äºæ’æŸ¥
        this.searchError = `HTTP ${res.responseCode}`
      }
    } catch (e) {
      // ç½‘ç»œå¼‚å¸¸ / JSON è§£æå¼‚å¸¸ç­‰ï¼šè½¬æˆå­—ç¬¦ä¸²æ˜¾ç¤º
      this.searchError = `${e}`
    } finally {
      // æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦é‡Šæ”¾è¯·æ±‚å¯¹è±¡ï¼Œå¹¶é€€å‡º loading çŠ¶æ€
      httpRequest.destroy()
      this.searchLoading = false
    }
  }

  // ===== è®¡ç®—æ•´æ®µ K çº¿åŒºåŸŸæ€»å®½åº¦ =====
  private getKlineTotalWidth(): number {
    const count: number = this.klineGeoms.length;
    if (count <= 0) {
      return 0;
    }
    return count * this.candleBodyWidth + (count - 1) * this.candleGap;
  }


  // åŠ è½½åˆ†ç»„
  private async loadGroupsFromPrefs(): Promise<void> {
    // è¿›æ¥å…ˆæ‰“ä¸ª logï¼Œä¸»è¦æ˜¯æ’æŸ¥â€œä¸ºå•¥åˆ†ç»„æ²¡åŠ è½½/åŠ è½½æ…¢/é‡å¤åŠ è½½â€è¿™ç±»é—®é¢˜
    this.dbg('loadGroupsFromPrefs:enter')

    // æ‰“å¼€æœ¬åœ° Preferences æ–‡ä»¶ï¼ˆç›¸å½“äºä¸€ä¸ªå°å‹çš„ key-value å­˜å‚¨ï¼‰
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)

    // ä»æŒ‡å®š key è¯»å‡ºåˆ†ç»„çš„ JSON å­—ç¬¦ä¸²ï¼›æ²¡æœ‰å°±ç»™ç©ºä¸²
    const jsonStr: string = (await pref.get(this.PREF_KEY_GROUPS, '')) as string

    // ç¬¬ä¸€æ¬¡å®‰è£… / æ²¡å­˜è¿‡åˆ†ç»„ï¼šèµ°åˆå§‹åŒ–é€»è¾‘ï¼Œç»™ä¸€ä¸ªâ€œé»˜è®¤åˆ†ç»„â€
    if (jsonStr.trim().length === 0) {
      const g: StockGroup = {
        id: 1,
        name: 'é»˜è®¤åˆ†ç»„',
        stocks: [],
        createdAt: Date.now(),
        version: 0
      }

      // groups ç”¨æ–°æ•°ç»„ç›´æ¥è¦†ç›–ï¼Œä¿è¯ UI èƒ½ç«‹åˆ»æ¸²æŸ“å‡ºæ¥
      this.groups = [g]
      this.activeGroupId = 1
      this.nextGroupId = 2 // ä¸‹æ¬¡æ–°å»ºåˆ†ç»„ä» 2 å¼€å§‹
      await this.saveGroupsToPrefs() // æŠŠé»˜è®¤åˆ†ç»„å†™å›å»ï¼Œåç»­å¯åŠ¨å°±èƒ½ç›´æ¥è¯»åˆ°

      // é»˜è®¤åˆ†ç»„ä¹Ÿè¦åŒæ­¥ä¸€æ¬¡ activeStocksï¼Œå¦åˆ™è‡ªé€‰é¡µå¯èƒ½è¿˜æ˜¯ç©ºçŠ¶æ€
      this.syncActiveStocks()
      this.dbg('loadGroupsFromPrefs:initDefault')
      return
    }

    // æœ‰æ•°æ®ï¼šæŠŠ JSON è§£ææˆ StockGroup[]ï¼ˆsafeParseGroups å†…éƒ¨åšè¿‡ç»“æ„å…œåº•ï¼‰
    const parsed: StockGroup[] = this.safeParseGroups(jsonStr)
    this.groups = parsed

    // æ‰«ä¸€éå·²æœ‰åˆ†ç»„ idï¼Œç”¨æ¥è®¡ç®— nextGroupIdï¼ˆé¿å…æ–°å»ºåˆ†ç»„ id æ’è½¦ï¼‰
    let maxId: number = 0
    for (let i: number = 0; i < parsed.length; i++) {
      if (parsed[i].id > maxId) maxId = parsed[i].id
    }
    this.nextGroupId = maxId + 1

    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç»„ï¼ˆæ²¡æœ‰åˆ†ç»„å°±è®¾ä¸º -1ï¼‰
    this.activeGroupId = parsed.length > 0 ? parsed[0].id : -1

    // activeGroupId å˜äº†å°±åŒæ­¥ activeStocksï¼Œä¿è¯è‡ªé€‰åˆ—è¡¨/ç»Ÿè®¡è·Ÿç€åˆ·æ–°
    this.syncActiveStocks()
    this.dbg('loadGroupsFromPrefs:done')
  }


  // æŠŠå½“å‰çš„åˆ†ç»„åˆ—è¡¨ï¼ˆthis.groupsï¼‰åºåˆ—åŒ–æˆ JSONï¼Œå¹¶å†™å…¥ Preferencesï¼Œä¿è¯ä¸‹æ¬¡å¯åŠ¨è¿˜èƒ½æ¢å¤åˆ†ç»„æ•°æ®
  private async saveGroupsToPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE);
    const jsonStr: string = JSON.stringify(this.groups);
    await pref.put(this.PREF_KEY_GROUPS, jsonStr);
    await pref.flush();
  }

  // ä» Preferences é‡Œè¯»å‡ºæ¥çš„ JSON å­—ç¬¦ä¸²è¿˜åŸæˆ StockGroup[]ï¼Œé¡ºä¾¿åšä¸€æ¬¡ç»“æ„å…œåº•ï¼ˆé˜²æ­¢è€æ•°æ®/è„æ•°æ®æŠŠé¡µé¢æå´©ï¼‰
  private safeParseGroups(jsonStr: string): StockGroup[] {
    try {
      // å…ˆæŠŠå­—ç¬¦ä¸² parse æˆ JS å¯¹è±¡ï¼›è¿™é‡Œä¸åš any/unknownï¼Œç»Ÿä¸€æŒ‰ Object æ¥ä½å†é€å­—æ®µè½¬
      const rawObj: Object = JSON.parse(jsonStr) as Object;
      if (!Array.isArray(rawObj)) {
        // ä¸æ˜¯æ•°ç»„å°±ç›´æ¥è®¤ä¸ºæ— æ•ˆï¼ˆæˆ‘ä»¬å­˜çš„ groups_json æœ¬æ¥å°±æ˜¯æ•°ç»„ï¼‰
        return [];
      }

      const arr: Object[] = rawObj as Object[];
      const result: StockGroup[] = [];

      for (let i: number = 0; i < arr.length; i++) {
        // å•ä¸ªåˆ†ç»„å¯¹è±¡ï¼šç”¨ Record<string, Object> æ¥åšå­—æ®µè®¿é—®ï¼ˆç¬¦åˆ arkts6 çš„é™åˆ¶ï¼‰
        const item: Record<string, Object> = arr[i] as Record<string, Object>;

        // è¿™äº›å­—æ®µéƒ½èµ° Number/String å¼ºè½¬ï¼šå°±ç®—ç¼ºå­—æ®µ/ç±»å‹ä¸å¯¹ï¼Œä¹Ÿä¸ä¼šç›´æ¥æŠ›å¼‚å¸¸
        const id: number = Number(item['id']);
        const name: string = String(item['name'] ?? '');
        const createdAt: number = Number(item['createdAt'] ?? Date.now());
        const version: number = Number(item['version'] ?? 0); // è€ç‰ˆæœ¬æ²¡ version çš„è¯ï¼Œé»˜è®¤ä» 0 å¼€å§‹

        // stocks å¯èƒ½ä¸å­˜åœ¨/ä¸æ˜¯æ•°ç»„ï¼šç»Ÿä¸€å…œåº•æˆç©ºæ•°ç»„
        const stocksRaw: Object = item['stocks'] ?? [];
        const stocks: StockRef[] = [];

        if (Array.isArray(stocksRaw)) {
          const sr: Object[] = stocksRaw as Object[];
          for (let j: number = 0; j < sr.length; j++) {
            const s: Record<string, Object> = sr[j] as Record<string, Object>;

            // åªæ¥å— 6 ä½ codeï¼›name å¯é€‰ï¼Œæœ‰å°±å¸¦ä¸Š
            const code: string = String(s['code'] ?? '').trim();
            if (code.length === 6) {
              const ref: StockRef = { code: code };

              const nm: string = String(s['name'] ?? '').trim();
              if (nm.length > 0) {
                ref.name = nm;
              }
              stocks.push(ref);
            }
          }
        }

        // æœ€èµ·ç è¦æœ‰ id + name æ‰ç®—ä¸€ä¸ªåˆæ³•åˆ†ç»„
        if (!Number.isNaN(id) && name.length > 0) {
          result.push({ id, name, stocks, createdAt, version });
        }
      }

      return result;
    } catch (e) {
      // JSON è§£æå¤±è´¥æˆ–è€…ç»“æ„ç‰¹åˆ«ç¦»è°±ï¼šç›´æ¥å›ç©ºï¼Œé¿å…å½±å“é¡µé¢å¯åŠ¨
      return [];
    }
  }

  // æ‰¾group id
  private findGroupIndex(groupId: number): number {
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id === groupId) {
        return i;
      }
    }
    return -1;
  }

  // æ–°å»ºä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼šå†™å…¥å†…å­˜ï¼ˆthis.groupsï¼‰+ è®¾ä¸ºå½“å‰æ¿€æ´»åˆ†ç»„ + è½ç›˜åˆ° Preferences
  private async createGroup(name: string): Promise<void> {
    // è¾“å…¥æ¡†é‡Œå¯èƒ½å¸¦ç©ºæ ¼ï¼Œå…ˆ trim ä¸€ä¸‹ï¼›ç©ºåå­—å°±ç›´æ¥å¿½ç•¥
    const n: string = name.trim();
    if (n.length === 0) return;

    // ç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ†ç»„å¯¹è±¡ï¼šid ç”¨è‡ªå¢çš„ nextGroupIdï¼Œversion ä» 0 å¼€å§‹ï¼ˆç”¨äº List å¼ºåˆ¶åˆ·æ–°ï¼‰
    const g: StockGroup = { id: this.nextGroupId, name: n, stocks: [], createdAt: Date.now(), version: 0 };
    this.nextGroupId += 1; // ä¸‹ä¸€ä¸ªåˆ†ç»„çš„ id é¢„ç•™å‡ºæ¥

    // æŠŠæ–°åˆ†ç»„æ”¾åˆ°æœ€å‰é¢ï¼ˆç”¨æˆ·ä¸€èˆ¬å¸Œæœ›åˆšå»ºçš„ç»„é©¬ä¸Šå‡ºç°åœ¨é¡¶éƒ¨ï¼‰
    const copy: StockGroup[] = [g, ...this.groups];
    this.groups = copy;

    // ç«‹å³åˆ‡åˆ°æ–°åˆ†ç»„ï¼Œåç»­ UI éƒ½ä»¥ activeGroupId ä¸ºå‡†
    this.activeGroupId = g.id;

    // å…³é”®ï¼šactiveGroupId å˜äº†ä»¥åï¼Œè¦æŠŠâ€œå½“å‰æ´»è·ƒè‚¡ç¥¨åˆ—è¡¨/ç»Ÿè®¡â€è¿™æ¡é“¾è·¯åŒæ­¥ä¸€é
    // ä¸ç„¶ UI ä¼šå‡ºç°â€œçœ‹èµ·æ¥åˆ‡äº†ç»„ï¼Œä½†æ•°æ®è¿˜åœç•™åœ¨ä¸Šä¸€ä¸ªç»„â€çš„æƒ…å†µ
    this.syncActiveStocks();           // activeStocks / è‚¡ç¥¨æ•°é‡ç­‰ç«‹åˆ»æ›´æ–°
    this.refreshActiveGroupStats();    // ç»Ÿè®¡å¡ç«‹åˆ»åˆ·æ–°ï¼ˆæ–°å»ºç©ºç»„å°±æ˜¯ 0ï¼‰

    // è½ç›˜ï¼šä¸‹æ¬¡å¯åŠ¨è¿˜èƒ½æ¢å¤åˆ†ç»„
    await this.saveGroupsToPrefs();

    // é¢„çƒ­ä¸€ä¸‹å½“å‰åˆ†ç»„çš„è¡Œæƒ…ç¼“å­˜ï¼ˆæ–°ç»„ä¸ºç©ºä¹Ÿæ²¡å…³ç³»ï¼Œæµç¨‹ä¿æŒä¸€è‡´ï¼‰
    await this.preloadActiveGroupQuotes();

    // å…œåº•å†åˆ·ä¸€æ¬¡ç»Ÿè®¡ï¼ˆæœ‰äº›æƒ…å†µä¸‹ preload ä¼šæ”¹å˜ç¼“å­˜å‘½ä¸­æƒ…å†µï¼‰
    this.refreshActiveGroupStats();
  }

  // åˆ é™¤ä¸€ä¸ªè‡ªé€‰åˆ†ç»„ï¼šä» this.groups é‡Œç§»é™¤ + å¤„ç†å½“å‰æ¿€æ´»åˆ†ç»„çš„åˆ‡æ¢ + è½ç›˜ä¿å­˜
  private async deleteGroup(groupId: number): Promise<void> {
    // 1) å…ˆæŠŠè¦åˆ çš„åˆ†ç»„è¿‡æ»¤æ‰ï¼ˆä¸ç”¨ filter æ˜¯ä¸ºäº†å°‘è¸© ArkTS ç±»å‹å‘ï¼‰
    const copy: StockGroup[] = [];
    for (let i: number = 0; i < this.groups.length; i++) {
      if (this.groups[i].id !== groupId) copy.push(this.groups[i]);
    }
    this.groups = copy;

    // 2) å¦‚æœåˆ æ‰çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šéœ€è¦æŠŠ activeGroupId åˆ‡åˆ°ä¸€ä¸ªâ€œè¿˜å­˜åœ¨â€çš„åˆ†ç»„
    //    è¿™é‡Œç®€å•å¤„ç†ï¼šåˆ‡åˆ°åˆ—è¡¨ç¬¬ä¸€ä¸ªï¼›å¦‚æœä¸€ä¸ªéƒ½æ²¡äº†ï¼Œå°±ç”¨ -1 è¡¨ç¤ºâ€œæ²¡æœ‰æ¿€æ´»åˆ†ç»„â€
    if (this.activeGroupId === groupId) {
      this.activeGroupId = this.groups.length > 0 ? this.groups[0].id : -1;
    }

    // 3) åˆ†ç»„å˜åŠ¨ä¼šå½±å“ activeStocks / ç»Ÿè®¡å¡ï¼Œæ‰€ä»¥è¦ç«‹åˆ»åŒæ­¥ä¸€ä¸‹ UI ä¾§çš„â€œactive é“¾è·¯â€
    //    å¦åˆ™ä¼šå‡ºç°ï¼šåˆ†ç»„å·²ç»åˆ äº†ï¼Œä½†é¡µé¢è¿˜åœ¨æ˜¾ç¤ºæ—§åˆ†ç»„çš„è‚¡ç¥¨å’Œç»Ÿè®¡
    this.syncActiveStocks();
    this.refreshActiveGroupStats();

    // 4) è½ç›˜ä¿å­˜ï¼šä¿è¯ä¸‹æ¬¡å¯åŠ¨åˆ†ç»„åˆ—è¡¨æ˜¯å¯¹çš„
    await this.saveGroupsToPrefs();

    // 5) å¦‚æœå½“å‰è¿˜æœ‰æ¿€æ´»åˆ†ç»„ï¼šé¢„çƒ­ä¸€ä¸‹è¯¥åˆ†ç»„çš„è¡Œæƒ…ç¼“å­˜ï¼Œç„¶åå†åˆ·ä¸€æ¬¡ç»Ÿè®¡ï¼ˆèµ°çš„æ˜¯æœ€æ–°ç¼“å­˜/æœ€æ–°è¡Œæƒ…ï¼‰
    if (this.activeGroupId >= 0) {
      await this.preloadActiveGroupQuotes();
      this.refreshActiveGroupStats();
    }
  }

  // å¾€æŒ‡å®šåˆ†ç»„é‡Œæ‰¹é‡æ·»åŠ è‚¡ç¥¨ä»£ç ï¼šåš 6 ä½æ ¡éªŒ + å»é‡ + æ›´æ–° groups + è½ç›˜ +ï¼ˆå¿…è¦æ—¶ï¼‰é¢„çƒ­è¡Œæƒ…
  private async addStocksToGroup(groupId: number, codes: string[]): Promise<void> {
    // ä»…ç”¨äºä½ è‡ªå·±çš„è°ƒè¯•æ—¥å¿—ï¼šæ–¹ä¾¿åœ¨æ§åˆ¶å°å¿«é€Ÿç¡®è®¤ä¼ å‚å’Œæµç¨‹æœ‰æ²¡æœ‰èµ°åˆ°
    this.dbg(`addStocksToGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    // æ‰¾åˆ°ç›®æ ‡åˆ†ç»„åœ¨ this.groups é‡Œçš„ä¸‹æ ‡ï¼›æ²¡æ‰¾åˆ°å°±ç›´æ¥é€€å‡º
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) å…ˆæŠŠå½“å‰åˆ†ç»„å·²æœ‰çš„ code æ”¶é›†èµ·æ¥ï¼šåé¢ç”¨æ¥åšå»é‡
    const existed: Set<string> = new Set<string>()
    const curStocks: StockRef[] = this.groups[idx].stocks
    for (let i: number = 0; i < curStocks.length; i++) {
      existed.add(curStocks[i].code)
    }

    // 2) å¤„ç†æœ¬æ¬¡è¦åŠ çš„ codesï¼š
    //    - trim æ‰ç©ºæ ¼
    //    - åªæ¥å— 6 ä½
    //    - è·Ÿåˆ†ç»„å·²æœ‰çš„å»é‡
    //    - åŒä¸€æ‰¹ codes è‡ªå·±ä¹Ÿå»é‡ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¸€æ¬¡è¾“å…¥é‡å¤äº†ï¼‰
    const addList: StockRef[] = []
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length !== 6) {
        continue
      }
      if (existed.has(code6)) {
        continue
      }
      existed.add(code6)
      // è¿™é‡Œåªå…ˆå­˜ codeï¼›name å¯ä»¥åé¢é€šè¿‡è¡Œæƒ…æ¥å£è¡¥å…¨ï¼Œå‡å°‘ä¸€æ¬¡è¾“å…¥è´Ÿæ‹…
      addList.push({ code: code6 })
    }

    // å¦‚æœè¿™æ¬¡æ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ–°å¢ï¼Œå°±ä¸ç”¨ç»§ç»­åšåé¢çš„ UI æ›´æ–°å’Œè½ç›˜äº†
    if (addList.length === 0) {
      this.dbg('addStocksToGroup:skip empty addList')
      return
    }

    // 3) æ›´æ–° groupsï¼š
    //    è¿™é‡Œå¿…é¡»â€œæ–°æ•°ç»„ + æ–°å¯¹è±¡â€ï¼ŒArkUI æ‰æ›´å®¹æ˜“è¯†åˆ«åˆ°ç»“æ„å˜åŒ–å¹¶è§¦å‘åˆ·æ–°
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    const newStocks: StockRef[] = g.stocks.concat(addList)
    // cloneGroupWithStocks ä¸€èˆ¬ä¼šé¡ºå¸¦ version+1ï¼Œé¿å… List å› ä¸ºå¼•ç”¨æ²¡å˜è€Œä¸åˆ·æ–°
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœæ”¹çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šé©¬ä¸ŠåŒæ­¥ activeStocks
    //    ä¸ç„¶ç”¨æˆ·ä¼šæ„Ÿè§‰â€œæˆ‘ç‚¹äº†æ·»åŠ ï¼Œä½†åˆ—è¡¨æ²¡å˜/ç»Ÿè®¡æ²¡å˜â€
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) ç»™ä¸ªç®€å•æç¤ºï¼šå‘Šè¯‰ç”¨æˆ·è¿™æ¬¡åŠ äº†å¤šå°‘åªã€å½“å‰åˆ†ç»„æ€»å…±æœ‰å¤šå°‘åª
    this.watchlistMsg = `å·²æ·»åŠ  ${addList.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) è½ç›˜ä¿å­˜ï¼šä¿è¯ä¸‹æ¬¡å¯åŠ¨åˆ†ç»„æ•°æ®è¿˜åœ¨
    await this.saveGroupsToPrefs()
    this.dbg('addStocksToGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šé¡ºæ‰‹é¢„çƒ­ä¸€ä¸‹è¿™äº›è‚¡ç¥¨çš„è¡Œæƒ…
    //    è¿™æ · quoteCache å¾ˆå¿«å°±æœ‰æ•°æ®ï¼Œç»Ÿè®¡å¡ï¼ˆæ¶¨è·Œ/å‡å€¼ï¼‰å°±ä¸ä¼šä¸€ç›´æ˜¯ "--"
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('addStocksToGroup:afterPreload')
    }
  }

  // ä»æŒ‡å®šåˆ†ç»„é‡Œæ‰¹é‡ç§»é™¤è‚¡ç¥¨ï¼šæŠŠè¦åˆ çš„ code åšæˆé›†åˆï¼Œç„¶åé‡å»º stocksã€æ›´æ–° groupsã€è½ç›˜ï¼Œå¹¶åŒæ­¥å½“å‰åˆ†ç»„çš„ UI/ç»Ÿè®¡
  private async removeStocksFromGroup(groupId: number, codes: string[]): Promise<void> {
    // è°ƒè¯•ç”¨ï¼šç¡®è®¤æ˜¯è°è§¦å‘çš„ã€ä¼ è¿›æ¥è¦åˆ å“ªäº›ä»£ç 
    this.dbg(`removeStocksFromGroup:enter gid=${groupId} codes=${JSON.stringify(codes)}`)

    // æ‰¾ç›®æ ‡åˆ†ç»„åœ¨ groups é‡Œçš„ä½ç½®ï¼›æ‰¾ä¸åˆ°å°±ä¸ç»§ç»­äº†
    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) {
      return
    }

    // 1) å…ˆæŠŠâ€œè¦ç§»é™¤çš„ codeâ€æ•´ç†æˆ Setï¼š
    //    - trim ç©ºæ ¼
    //    - åªè®¤ 6 ä½
    //    - Set å¤©ç”Ÿå»é‡ï¼Œé¿å…é‡å¤åˆ åŒä¸€ä¸ª code è¿˜è¦é¢å¤–åˆ¤æ–­
    const toRemove: Set<string> = new Set<string>()
    for (let i: number = 0; i < codes.length; i++) {
      const code6: string = codes[i].trim()
      if (code6.length === 6) {
        toRemove.add(code6)
      }
    }

    // å¦‚æœæ²¡æœ‰ä»»ä½•æœ‰æ•ˆçš„ codeï¼Œå°±ç›´æ¥é€€å‡ºï¼Œé¿å…åšæ— æ„ä¹‰çš„çŠ¶æ€æ›´æ–°
    if (toRemove.size === 0) {
      this.dbg('removeStocksFromGroup:skip empty toRemove')
      return
    }

    // 2) ç”¨è¿‡æ»¤çš„æ–¹å¼ç”Ÿæˆæ–°çš„ stocksï¼ˆæŠŠè¦åˆ çš„è¿‡æ»¤æ‰ï¼‰
    const oldStocks: StockRef[] = this.groups[idx].stocks
    const newStocks: StockRef[] = []
    for (let i: number = 0; i < oldStocks.length; i++) {
      const code: string = oldStocks[i].code
      if (!toRemove.has(code)) {
        // è¿™é‡Œç›´æ¥å¤ç”¨åŸæ¥çš„ StockRefï¼ˆé‡Œé¢å¯èƒ½å¸¦ç€ nameï¼‰ï¼Œä¸åšé¢å¤–æ”¹åŠ¨
        newStocks.push(oldStocks[i])
      }
    }

    // å¦‚æœè¿‡æ»¤å®Œé•¿åº¦æ²¡å˜ï¼Œè¯´æ˜è¿™æ¬¡è¦åˆ çš„ codes éƒ½ä¸åœ¨åˆ†ç»„é‡Œï¼Œå°±åˆ«æŠ˜è…¾ UI/è½ç›˜äº†
    if (newStocks.length === oldStocks.length) {
      this.dbg('removeStocksFromGroup:skip no changes')
      return
    }

    // 3) æ›´æ–° groupsï¼šåŒæ ·èµ°â€œæ–°æ•°ç»„ + æ–°å¯¹è±¡â€çš„æ–¹å¼ï¼Œä¿è¯ UI èƒ½åˆ·æ–°å‡ºæ¥
    const newGroups: StockGroup[] = this.groups.slice()
    const g: StockGroup = newGroups[idx]
    newGroups[idx] = this.cloneGroupWithStocks(g, newStocks)
    this.groups = newGroups

    // 4) å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„åˆ†ç»„ï¼šé©¬ä¸ŠåŒæ­¥ activeStocks
    //    ä¸ç„¶ç”¨æˆ·ä¼šçœ‹åˆ°åˆ†ç»„é‡Œå°‘äº†ï¼Œä½†ä¸‹é¢åˆ—è¡¨/ç»Ÿè®¡è¿˜åœç•™åœ¨æ—§æ•°æ®
    if (this.activeGroupId === groupId) {
      this.syncActiveStocks()
    }

    // 5) ç®€å•æç¤ºï¼šå‘Šè¯‰ç”¨æˆ·è¿™æ¬¡åˆ äº†å¤šå°‘ã€ç°åœ¨è¿˜å‰©å¤šå°‘
    this.watchlistMsg = `å·²åˆ é™¤ ${oldStocks.length - newStocks.length} åªï¼Œå½“å‰ ${newGroups[idx].stocks.length} åª`

    // 6) è½ç›˜ä¿å­˜ï¼šä¸‹æ¬¡å¯åŠ¨ä¾æ—§ä¿æŒåˆ é™¤åçš„çŠ¶æ€
    await this.saveGroupsToPrefs()
    this.dbg('removeStocksFromGroup:afterSavePrefs')

    // 7) å¦‚æœæ˜¯å½“å‰åˆ†ç»„ï¼šå¯é€‰åœ°å†é¢„çƒ­ä¸€æ¬¡è¡Œæƒ…å¹¶åˆ·æ–°ç»Ÿè®¡
    //    ï¼ˆåˆ é™¤å cache é‡Œå¯èƒ½è¿˜æœ‰æ—§æ ‡çš„ï¼Œä½†ç»Ÿè®¡æ˜¯æŒ‰ activeStocks ç®—çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ˜¯ä¿æŒæµç¨‹ä¸€è‡´ï¼‰
    if (this.activeGroupId === groupId) {
      await this.preloadActiveGroupQuotes()
      this.refreshActiveGroupStats()
      this.dbg('removeStocksFromGroup:afterPreload')
    }
  }

  // ç”¨â€œæ–°å¯¹è±¡â€å…‹éš†ä¸€ä¸ªåˆ†ç»„ï¼Œå¹¶æ›¿æ¢ stocksã€‚
  // è¿™é‡Œé¡ºæ‰‹æŠŠ version +1ï¼šä¸»è¦æ˜¯ç»™ List/æ¸²æŸ“å±‚ä¸€ä¸ªâ€œæˆ‘çœŸçš„å˜äº†â€çš„ä¿¡å·ï¼Œé¿å…æŸäº›æƒ…å†µä¸‹ UI è®¤ä¸ºç»“æ„æ²¡å˜è€Œä¸åˆ·æ–°ã€‚
  private cloneGroupWithStocks(g: StockGroup, stocks: StockRef[]): StockGroup {
    return {
      id: g.id,
      name: g.name,
      stocks: stocks,          // æ–°çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆå·²ç» add/remove å¤„ç†è¿‡ï¼‰
      createdAt: g.createdAt,  // åˆ†ç»„åˆ›å»ºæ—¶é—´ä¸å˜
      version: g.version + 1   // æ¯æ¬¡æ”¹ stocks éƒ½ +1ï¼Œç”¨æ¥å¼ºåˆ¶è§¦å‘ UI é‡æ–°æ¸²æŸ“
    };
  }

  // å–â€œå½“å‰é€‰ä¸­çš„åˆ†ç»„â€å¯¹è±¡ã€‚
  // è¿™é‡Œè¿”å› StockGroup | nullï¼šå¤–é¢ç”¨çš„æ—¶å€™å¯ä»¥å¾ˆç›´è§‚åœ°åšç©ºåˆ¤æ–­ï¼Œé¿å… activeGroupId è¿˜æ²¡åˆå§‹åŒ–/åˆ†ç»„è¢«åˆ æ‰æ—¶ç›´æ¥å´©ã€‚
  private getActiveGroup(): StockGroup | null {
    // activeGroupId ä¸º -1 è¿™ç±»å€¼æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰é€‰ä¸­ä»»ä½•åˆ†ç»„
    if (this.activeGroupId < 0) {
      return null;
    }

    // ç”¨ id æ‰¾åˆ°å®ƒåœ¨ this.groups æ•°ç»„é‡Œçš„ä¸‹æ ‡
    const idx: number = this.findGroupIndex(this.activeGroupId);
    if (idx < 0) {
      // æ²¡æ‰¾åˆ°ï¼šä¸€èˆ¬æ˜¯åˆ†ç»„åˆšè¢«åˆ é™¤ã€æˆ–æœ¬åœ°æ•°æ®å¼‚å¸¸å¯¼è‡´
      return null;
    }

    // æ‰¾åˆ°äº†å°±ç›´æ¥è¿”å›å¯¹åº”åˆ†ç»„
    return this.groups[idx];
  }


  private findQuoteInCaches(code: string): Quote | null {
    const code6: string = code.trim();
    if (code6.length !== 6) return null;

    const kStock: string = `stock-${code6}`;
    const vStock: Quote | undefined = this.quoteCache.get(kStock);
    if (vStock !== undefined) return vStock;

    const kIndex: string = `index-${code6}`;
    const vIndex: Quote | undefined = this.quoteCache.get(kIndex);
    if (vIndex !== undefined) return vIndex;

    return null;
  }

  private getStockRowName(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q !== null) {
      return q.name;
    }
    if (s.name && s.name.length > 0) {
      return s.name;
    }
    return 'â€”';
  }

  private getStockRowPriceText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? q.price.toFixed(2) : '--';
  }

  private getStockRowChangeText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? q.change.toFixed(2) : '--';
  }

  private getStockRowPctText(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    return (q !== null) ? (q.changePercent.toFixed(2) + '%') : '--';
  }

  private getStockRowPriceColor(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q === null) {
      return '#AAAAAA';
    }
    return (q.change >= 0) ? '#FF4D4F' : '#39D98A';
  }

  private getStockRowSubColor(s: StockRef): string {
    const _qv: number = this.quoteCacheVer
    const q: Quote | null = this.findStockQuoteInCache(s.code);

    if (q === null) {
      return '#777777';
    }
    return (q.change >= 0) ? '#FF7875' : '#6BE49B';
  }

  private async ensureQuoteCachedForCode(code: string): Promise<void> {
    const code6: string = code.trim()
    if (code6.length !== 6) return

    // âœ… ä»…æ£€æŸ¥ stock ç¼“å­˜ï¼Œé¿å… index åŒç å¯¼è‡´è¯¯åˆ¤
    const cacheKey: string = `stock-${code6}`
    const existed: Quote | undefined = this.quoteCache.get(cacheKey)
    if (existed !== undefined) return

    const httpRequest = http.createHttp()
    try {
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=stock&code=${code6}`
      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })

      this.dbg(`ensureQuoteCachedForCode:request ${code6}`)
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const q: Quote = this.mapBackendQuote(backendItem, 'stock')
        this.mergeQuotesToCache([q]) // âœ… quoteCacheVer++ ä¼šè§¦å‘ç»Ÿè®¡å¡åˆ·æ–°
        this.dbg(`ensureQuoteCachedForCode:request ${code6}`)
      }
    } catch (e) {
      // ignore
    } finally {
      httpRequest.destroy()
    }
  }

  private async ensureQuoteCachedByType(type: QuoteType, code6: string): Promise<void> {
    const code: string = code6.trim()
    if (code.length !== 6) return

    const cacheKey: string = `${type}-${code}`
    const existed: Quote | undefined = this.quoteCache.get(cacheKey)
    if (existed !== undefined) return

    const httpRequest = http.createHttp()
    try {
      const url: string = `http://101.43.185.73:8000/api/quote/by_code?type=${type}&code=${code}`
      const res = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        connectTimeout: this.HTTP_CONNECT_TIMEOUT,
        readTimeout: this.HTTP_READ_TIMEOUT
      })
      if (res.responseCode === 200 && res.result) {
        const backendItem: BackendQuote = JSON.parse(res.result as string) as BackendQuote
        const q: Quote = this.mapBackendQuote(backendItem, type)
        this.mergeQuotesToCache([q])
      }
    } catch (e) {
      // ignore
    } finally {
      httpRequest.destroy()
    }
  }

  private findQuoteInCacheByType(type: QuoteType, code6: string): Quote | null {
    const code: string = code6.trim()
    if (code.length !== 6) return null
    const k: string = `${type}-${code}`
    const v: Quote | undefined = this.quoteCache.get(k)
    return (v !== undefined) ? v : null
  }

  private async preloadActiveGroupQuotes(): Promise<void> {
    const g: StockGroup | null = this.getActiveGroup();
    if (g === null) {
      return;
    }

    const tasks: Promise<void>[] = [];
    for (let i: number = 0; i < g.stocks.length; i++) {
      const code: string = g.stocks[i].code;
      tasks.push(this.ensureQuoteCachedForCode(code));
    }

    // å¹¶è¡Œé¢„çƒ­ï¼šå•åªå¤±è´¥ä¸ä¼šé˜»å¡æ•´ä½“
    await Promise.all(tasks.map((p: Promise<void>) => p.catch(() => { })));

  }

  private mergeQuotesToCache(list: Quote[]): void {
    console.info(`[DBG] mergeQuotesToCache: in list=${list.length} oldCache=${this.quoteCache.size}`);
    const newMap: Map<string, Quote> = new Map<string, Quote>();
    this.quoteCache.forEach((v: Quote, k: string) => {
      newMap.set(k, v);
    });

    for (let i: number = 0; i < list.length; i++) {
      const q: Quote = list[i];
      const key: string = `${q.type}-${q.code}`;
      newMap.set(key, q);
    }

    this.quoteCache = newMap;
    this.quoteCacheVer += 1
    this.refreshActiveGroupStats()   // âœ… æ–°å¢ï¼šè¡Œæƒ…å˜äº†ï¼Œç»Ÿè®¡ï¼ˆup/down/avgï¼‰ç«‹åˆ»åˆ·æ–°
    console.info(`[DBG] mergeQuotesToCache: out newCache=${this.quoteCache.size}`);
  }


  private getActiveGroupOrNull(): StockGroup | null {
    if (this.activeGroupId < 0) return null
    const idx: number = this.findGroupIndex(this.activeGroupId)
    if (idx < 0) return null
    return this.groups[idx]
  }

  private getActiveGroupNameText(): string {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    return g ? g.name : ''
  }

  private getActiveGroupStocksList(): StockRef[] {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    return g ? g.stocks : []
  }

  private computeStatsFromStocks(list: StockRef[]): ActiveGroupStats {
    const stockCount: number = list.length

    let up: number = 0
    let down: number = 0
    let sumPct: number = 0
    let cntPct: number = 0

    for (let i: number = 0; i < list.length; i++) {
      const code: string = list[i].code
      // const q: Quote | null = this.findQuoteInCaches(code)
      const q: Quote | null = this.findStockQuoteInCache(code)
      if (q !== null) {
        if (q.change >= 0) {
          up += 1
        } else {
          down += 1
        }
        sumPct += q.changePercent
        cntPct += 1
      }
    }

    const avgPct: string = (cntPct > 0) ? ((sumPct / cntPct).toFixed(2) + '%') : '--'

    return {
      stockCount: stockCount.toString(),
      up: up.toString(),
      down: down.toString(),
      avgPct: avgPct
    }
  }

  private getActiveGroupStatsStockCount(): string {
    const _av: number = this.activeStocksVer     // âœ… è®©â€œå¢åˆ è‚¡ç¥¨â€è§¦å‘åˆ·æ–°
    const _qv: number = this.quoteCacheVer       // âœ… è®©â€œè¡Œæƒ…å›å†™â€è§¦å‘åˆ·æ–°
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.stockCount
  }

  private getActiveGroupStatsUp(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.up
  }

  private getActiveGroupStatsDown(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.down
  }

  private getActiveGroupStatsAvgPct(): string {
    const _av: number = this.activeStocksVer
    const _qv: number = this.quoteCacheVer
    const st: ActiveGroupStats = this.computeStatsFromStocks(this.activeStocks)
    return st.avgPct
  }

  // âœ… è‡ªé€‰åˆ†ç»„ä¸“ç”¨ï¼šåªæŒ‰ stock æŸ¥ç¼“å­˜ï¼Œé¿å…ä¸ index åŒç å†²çªï¼ˆå¦‚ 000001ï¼‰
  private findStockQuoteInCache(code: string): Quote | null {
    const code6: string = code.trim()
    if (code6.length !== 6) return null

    const kStock: string = `stock-${code6}`
    const v: Quote | undefined = this.quoteCache.get(kStock)
    return (v !== undefined) ? v : null
  }



  private logSeq: number = 0;

  private dbg(tag: string): void {
    this.logSeq += 1;

    const gid: number = this.activeGroupId;
    const idx: number = this.findGroupIndex(gid);

    let activeCount: number = -1;
    let activeName: string = '';
    if (idx >= 0) {
      activeCount = this.groups[idx].stocks.length;
      activeName = this.groups[idx].name;
    }

    console.info(
      `[DBG#${this.logSeq}] ${tag} | tab=${this.currentTabIndex} mode=${this.currentMode}` +
        ` | activeGroupId=${gid} activeIdx=${idx} activeName=${activeName} activeStocks=${activeCount}` +
        ` | groups=${this.groups.length} cache=${this.quoteCache.size}` +
        ` | activeStocks=${this.activeStocks.length} cache=${this.quoteCache.size} cacheVer=${this.quoteCacheVer}`
    );
  }

  private syncActiveStocks(): void {
    const g: StockGroup | null = this.getActiveGroupOrNull()
    if (g === null) {
      this.activeStocks = []
    } else {
      // å…³é”®ï¼šå¿…é¡»åˆ›å»ºâ€œæ–°æ•°ç»„å¼•ç”¨â€
      this.activeStocks = g.stocks.slice()
    }
    this.activeStocksVer += 1

    this.refreshActiveGroupStats()
  }

  private getGroupAvgPctText(groupId: number): string {
    // âœ… ä¾èµ–ç¼“å­˜ç‰ˆæœ¬ï¼šè¡Œæƒ…æ›´æ–° => quoteCacheVer++ => è¿™é‡Œä¼šé‡æ–°è®¡ç®— => UI é‡ç»˜
    const _qv: number = this.quoteCacheVer

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '--'

    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    return st.avgPct
  }

  private getGroupAvgPctColor(groupId: number): string {
    // âœ… ä¾èµ–è¡Œæƒ…ç¼“å­˜ç‰ˆæœ¬ï¼Œä¿è¯è¡Œæƒ…å˜åŒ–æ—¶é¢œè‰²ä¹Ÿåˆ·æ–°
    const _qv: number = this.quoteCacheVer

    const idx: number = this.findGroupIndex(groupId)
    if (idx < 0) return '#777777'

    const st: ActiveGroupStats = this.computeStatsFromStocks(this.groups[idx].stocks)
    const avg: string = st.avgPct

    // æ²¡æœ‰è¡Œæƒ…
    if (avg === '--') {
      return '#777777'
    }

    // å»æ‰ %
    const v: number = Number(avg.replace('%', ''))
    if (Number.isNaN(v)) {
      return '#777777'
    }

    // âœ… æ¶¨çº¢ï¼Œè·Œç»¿ï¼ˆæŒ‰ä½ å½“å‰å…¨å±€é…è‰²ï¼‰
    return v >= 0 ? '#FF4D4F' : '#39D98A'
  }

  // âœ… æ–¹æ¡ˆ1ç¬¬ä¸‰æ­¥ï¼šæŠŠ Quote è½¬æˆæ¡Œé¢å¡ç‰‡ç»‘å®šæ•°æ®
  private buildWidgetDataFromQuote(q: Quote): WidgetBindData {
    const now: Date = new Date()
    const hh: string = now.getHours().toString().padStart(2, '0')
    const mm: string = now.getMinutes().toString().padStart(2, '0')

    return {
      formId: this.activeFormId,
      title: (q.type === 'index') ? 'æŒ‡æ•°' : 'è‚¡ç¥¨',
      code: q.code,
      name: q.name,
      priceText: q.price.toFixed(2),
      changeText: q.change.toFixed(2),
      pctText: q.changePercent.toFixed(2) + '%',
      tsText: `${hh}:${mm}`,
      hasPrev: true,
      hasNext: true
    }
  }

  // âœ… æ–¹æ¡ˆ1ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ˜¯ä»æ¡Œé¢å¡ç‰‡æ‰“å¼€çš„ Appï¼ˆactiveFormId æœ‰å€¼ï¼‰ï¼Œå°±æŠŠå½“å‰é€‰æ‹©å›å†™åˆ°å¡ç‰‡
  private async updateWidgetIfLaunchedFromForm(q: Quote): Promise<void> {
    const fid: string = this.activeFormId.trim()

    hilog.error(DOMAIN, TAG, '[WIDGET] ENTER updateWidget fid=%{public}s code=%{public}s', fid, q.code)

    if (fid.length === 0) {
      hilog.error(DOMAIN, TAG, '[WIDGET] SKIP activeFormId empty')
      return
    }

    try {
      const data: WidgetBindData = this.buildWidgetDataFromQuote(q)
      const binding: formBindingData.FormBindingData = formBindingData.createFormBindingData(data)

      await formProvider.updateForm(fid, binding)

      hilog.error(DOMAIN, TAG, '[WIDGET] OK updateForm formId=%{public}s code=%{public}s', fid, q.code)
    } catch (e) {
      hilog.error(DOMAIN, TAG, '[WIDGET] FAIL updateForm formId=%{public}s err=%{public}s',
        fid, JSON.stringify(e))
    }
  }



  private async triggerRuleAlert(rule: NotifyRule): Promise<void> {
    try {
      // å…ˆå°è¯•æ‹‰èµ·é€šçŸ¥æˆæƒå¼¹çª—ï¼ˆè‹¥å·²å¼€å¯ï¼Œé€šå¸¸ä¸ä¼šå½±å“ï¼›è‹¥æœªå¼€å¯ä¼šæç¤ºç”¨æˆ·å¼€å¯ï¼‰
      // è‹¥ç”¨æˆ·æ‹’ç»ï¼Œå¸¸è§é”™è¯¯ç ä¸º 1600004
      try {
        await notificationManager.requestEnableNotification()
      } catch (e) {
        // ä¸ä½¿ç”¨ any/unknownï¼šåªåšæœ€ä¿å®ˆå¤„ç†
        const errObj: Record<string, Object> = e as Record<string, Object>
        const codeNum: number = Number(errObj['code'])
        hilog.error(DOMAIN, TAG, 'requestEnableNotification failed: %{public}s', JSON.stringify(e))

        // 1600004ï¼šç”¨æˆ·æ‹’ç»/é€šçŸ¥æœªæˆæƒï¼ˆæˆ–å·²è¢«å…³é—­ï¼‰
        if (codeNum === 1600004) {
          // è¿™é‡Œä½ å¯ä»¥æ”¹æˆ UI æç¤ºï¼šå¼•å¯¼ç”¨æˆ·åˆ°ç³»ç»Ÿè®¾ç½®å¼€å¯é€šçŸ¥
          return
        }
      }

      const req: notificationManager.NotificationRequest = {
        id: 10000 + rule.id,
        content: {
          // å…³é”®ï¼šç”¨ notificationContentTypeï¼ˆä¸æ˜¯ contentTypeï¼‰
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'è¡Œæƒ…æé†’',
            text: `${rule.stockName}ï¼ˆ${rule.stockCode}ï¼‰${rule.conditionText}`,
            additionalText: 'æ‰“å¼€åº”ç”¨æŸ¥çœ‹è¯¦æƒ…'
          }
        }
        // slotType / wantAgent / autoDeletedï¼šå…ˆéƒ½ä¸å†™ï¼Œé¿å…ä½ å½“å‰ SDK æšä¸¾/ç±»å‹ä¸ä¸€è‡´å¯¼è‡´ç¼–è¯‘æˆ–è¿è¡Œå¤±è´¥
      }

      await notificationManager.publish(req)
      hilog.info(DOMAIN, TAG, 'triggerRuleAlert ok, id=%{public}d', req.id)
    } catch (e) {
      hilog.error(DOMAIN, TAG, 'triggerRuleAlert failed: %{public}s', JSON.stringify(e))
    }
  }



  // âœ… å…ˆæ£€æŸ¥é€šçŸ¥æ˜¯å¦å¼€å¯ï¼›æ²¡å¼€å°±æ‹‰èµ·ç³»ç»Ÿæˆæƒ/å¼€å…³é¡µé¢
  private async ensureNotificationEnabled(): Promise<boolean> {
    try {
      const enabled: boolean = await notificationManager.isNotificationEnabled()
      if (enabled) {
        return true
      }

      // æ‹‰èµ·ç³»ç»Ÿç•Œé¢è®©ç”¨æˆ·æ‰“å¼€é€šçŸ¥å¼€å…³
      await notificationManager.requestEnableNotification()

      // ç”¨æˆ·æ“ä½œåå†æ£€æŸ¥ä¸€æ¬¡
      const enabled2: boolean = await notificationManager.isNotificationEnabled()
      return enabled2
    } catch (e) {
      // ä»»æ„å¼‚å¸¸éƒ½è§†ä¸ºä¸å¯ç”¨
      return false
    }
  }

  // âœ… ä¸“é—¨å¤„ç† publish çš„ 1600004ï¼šæç¤º + å¼•å¯¼å¼€å¯
  private async handlePublishError(code: number): Promise<void> {
    if (code === 1600004) {
      // ä½ å¯ä»¥ç”¨ä½ ç°æœ‰çš„ UI çŠ¶æ€å­—æ®µæç¤ºç”¨æˆ·
      this.watchlistMsg = 'é€šçŸ¥æƒé™æœªå¼€å¯ï¼šè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­ä¸º HarmonyStock æ‰“å¼€é€šçŸ¥åé‡è¯•'
      // å†ä¸»åŠ¨æ‹‰èµ·ä¸€æ¬¡ç³»ç»Ÿå¼€å…³ç•Œé¢
      await this.ensureNotificationEnabled()
    }
  }


  private async loadNotifyRulesFromPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)
    const jsonStr: string = (await pref.get(this.PREF_KEY_RULES, '')) as string

    if (jsonStr.trim().length === 0) {
      // æ²¡å­˜è¿‡ï¼šç”¨é»˜è®¤ @State çš„ notifyRules å³å¯ï¼ŒåŒæ—¶æ ¡å‡† nextRuleId
      this.recomputeNextRuleId()
      return
    }

    const parsed: NotifyRule[] = this.safeParseNotifyRules(jsonStr)
    if (parsed.length > 0) {
      this.notifyRules = parsed
      this.recomputeNextRuleId()
    }
  }

  private async saveNotifyRulesToPrefs(): Promise<void> {
    const pref = await preferences.getPreferences(getContext(this), this.PREF_FILE)
    const jsonStr: string = JSON.stringify(this.notifyRules)
    await pref.put(this.PREF_KEY_RULES, jsonStr)
    await pref.flush()
  }

  private safeParseNotifyRules(jsonStr: string): NotifyRule[] {
    try {
      const raw: Object = JSON.parse(jsonStr) as Object
      if (!Array.isArray(raw)) return []

      const arr: Object[] = raw as Object[]
      const out: NotifyRule[] = []

      for (let i: number = 0; i < arr.length; i++) {
        const item: Record<string, Object> = arr[i] as Record<string, Object>

        const id: number = Number(item['id'])
        const stockCode: string = String(item['stockCode'] ?? '').trim()
        const stockName: string = String(item['stockName'] ?? '').trim()
        const conditionText: string = String(item['conditionText'] ?? '').trim()
        const enabled: boolean = Boolean(item['enabled'])

        // âœ… æ–°å¢ï¼šquoteTypeï¼ˆè€æ•°æ®æ²¡æœ‰å°±é»˜è®¤ stockï¼‰
        const qtRaw: string = String(item['quoteType'] ?? 'stock').trim()
        const quoteType: QuoteType = (qtRaw === 'index') ? 'index' : 'stock'

        if (!Number.isNaN(id) && stockCode.length === 6 && stockName.length > 0 && conditionText.length > 0) {
          out.push({
            id: id,
            quoteType: quoteType,
            stockCode: stockCode,
            stockName: stockName,
            conditionText: conditionText,
            enabled: enabled
          })
        }
      }
      return out
    } catch (e) {
      return []
    }
  }

  private recomputeNextRuleId(): void {
    let maxId: number = 0
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      if (this.notifyRules[i].id > maxId) maxId = this.notifyRules[i].id
    }
    this.nextRuleId = maxId + 1
  }

  private async addNotifyRuleFromUI(): Promise<void> {
    const code: string = this.ruleStockCodeInput.trim()
    if (code.length !== 6) {
      this.ruleMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç '
      return
    }

    const v: number = Number(this.rulePriceInput.trim())
    if (Number.isNaN(v)) {
      this.ruleMsg = 'è¯·è¾“å…¥æ­£ç¡®çš„ä»·æ ¼é˜ˆå€¼'
      return
    }

    // å»é‡ï¼šåŒ code + åŒæ¡ä»¶ ç›´æ¥ä¸åŠ 
    const opText: string = (this.ruleOpIndex === 0) ? 'â‰¥' : 'â‰¤'
    const cond: string = `ä»·æ ¼ ${opText} ${v.toFixed(2)}`
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.quoteType === this.ruleQuoteType && r.stockCode === code && r.conditionText === cond) {
        this.ruleMsg = 'è¯¥è§„åˆ™å·²å­˜åœ¨'
        return
      }
    }

    // å°½é‡ä»ç¼“å­˜/åç«¯æ‹¿ nameï¼ˆä½ çš„ ensureQuoteCachedForCode å·²æœ‰ï¼‰
    const qt: QuoteType = this.ruleQuoteType
    await this.ensureQuoteCachedByType(qt, code)
    const q: Quote | null = this.findQuoteInCacheByType(qt, code)
    const name: string = (q !== null) ? q.name : code

    const newRule: NotifyRule = {
      id: this.nextRuleId,
      quoteType: qt,                 // âœ… æ–°å¢
      stockCode: code,
      stockName: name,
      conditionText: cond,
      enabled: true
    }
    this.nextRuleId += 1

    // âœ… è§¦å‘ UIï¼šå¿…é¡» new array
    const next: NotifyRule[] = [newRule].concat(this.notifyRules)
    this.notifyRules = next
    this.notifyRulesVer += 1
    await this.saveNotifyRulesToPrefs()

    // æ¸…ç©ºè¾“å…¥
    this.ruleStockCodeInput = ''
    this.rulePriceInput = ''
    this.ruleMsg = 'å·²æ·»åŠ å¹¶å¯ç”¨'
  }

  private async deleteRule(ruleId: number): Promise<void> {
    const next: NotifyRule[] = []
    for (let i: number = 0; i < this.notifyRules.length; i++) {
      const r: NotifyRule = this.notifyRules[i]
      if (r.id !== ruleId) next.push(r)
    }
    this.notifyRules = next
    this.notifyRulesVer += 1
    await this.saveNotifyRulesToPrefs()
  }

  private consumeFormIdFromAppStorageV2(from: string): void {
    // ä» AppStorageV2 é‡ŒæŠŠæ¡Œé¢å¡ç‰‡ä¼ è¿›æ¥çš„ formId å–å‡ºæ¥ï¼ˆåªå–ä¸€æ¬¡ï¼Œç”¨å®Œå°±æ¸…æ‰ï¼‰
    const st: ActiveFormState | undefined =
      AppStorageV2.connect(ActiveFormState, APP_STORAGE_KEY_ACTIVE_FORM, () => new ActiveFormState())

    // AppStorage å–ä¸åˆ°å°±ç›´æ¥è¿”å›ï¼ˆä¸€èˆ¬æ˜¯ key æ²¡æ³¨å†ŒæˆåŠŸæˆ–ä¸Šä¸‹æ–‡å¼‚å¸¸ï¼‰
    if (!st) {
      hilog.error(DOMAIN, TAG, '[%{public}s] AppStorageV2.connect failed', from)
      return
    }

    // formId ä¸ºç©ºè¡¨ç¤ºè¿™æ¬¡ä¸æ˜¯ä»å¡ç‰‡è¿›æ¥çš„ï¼Œæˆ–è€…å·²ç»è¢«æ¶ˆè´¹è¿‡äº†
    const fid: string = st.formId
    if (fid.length === 0) {
      hilog.info(DOMAIN, TAG, '[%{public}s] no formId in ActiveFormState', from)
      return
    }

    // ä¿å­˜åˆ°é¡µé¢çŠ¶æ€ï¼šåç»­æ›´æ–°æ¡Œé¢å¡ç‰‡æ—¶ä¼šç”¨åˆ°è¿™ä¸ª id
    this.activeFormId = fid

    // æ¸…æ‰ AppStorage é‡Œçš„å€¼ï¼Œé¿å… onPageShow/onResume å¤šæ¬¡è§¦å‘å¯¼è‡´é‡å¤æ¶ˆè´¹
    st.formId = ''

    hilog.info(DOMAIN, TAG, '[%{public}s] âœ… consumed formId=%{public}s -> this.activeFormId', from, fid)
  }

  // ===== è‡ªå®šä¹‰ TabBarï¼šè¿™é‡Œå°±èƒ½å®Œå…¨æ§åˆ¶æ–‡å­—é¢œè‰² =====
  @Builder
  tabBarBuilder(title: string, index: number) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor(this.currentTabIndex === index ? Color.White : '#888888')
    }
    .height(40)
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(Color.Black)
  }

  build() {

    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildHeader()

      // ===== Tabs éƒ¨åˆ† =====
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildMarketTab()
        }
        .tabBar(this.tabBarBuilder('å¸‚åœº', 0))

        TabContent() {
          this.buildWatchlistTab()
        }
        .tabBar(this.tabBarBuilder('è‡ªé€‰', 1))

        TabContent() {
          this.buildNotificationTab()
        }
        .tabBar(this.tabBarBuilder('é€šçŸ¥', 2))
      }
      .barMode(BarMode.Fixed)
      .backgroundColor(Color.Black)
      .divider({
        strokeWidth: 0.5,
        color: '#333333'
      })
      .onChange((index: number) => {
        this.currentTabIndex = index;

      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  // ====== Header åŒºåŸŸ ======
  @Builder
  private buildHeader() {
    Column() {
      Row({ space: 8 }) {
        Text('HARMONYSTOCK')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)

        Text('é¸¿è‚¡é€š')
          .fontSize(14)
          .fontColor('#AAAAAA')
          .margin({ top: 4 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
    }
    .backgroundColor('#111111')
  }

  // ===== æ¨¡å¼åˆ‡æ¢ï¼šæŒ‡æ•° / è‚¡ç¥¨ =====
  @Builder
  private buildModeSwitcher() {
    Row({ space: 24 }) {
      this.buildModeChip('æŒ‡æ•°', 'index');
      this.buildModeChip('è‚¡ç¥¨', 'stock');
    }.width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .height(50)                         // åŒºåŸŸæ›´é«˜ï¼Œçœ‹èµ·æ¥æ›´åƒå¤§æŒ‰é’®åŒºåŸŸ
  }

  @Builder
  private buildModeChip(label: string, mode: 'index' | 'stock') {
    Text(label)
      .fontSize(16)
      .fontColor(this.currentMode === mode ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .backgroundColor(this.currentMode === mode ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        if (this.currentMode === mode) {
          return;
        }
        this.currentMode = mode;

        // åˆ‡æ¨¡å¼æ—¶é‡ç½®çŠ¶æ€ + é‡æ–°æ‹‰æ•°æ®
        this.marketQuotes = [];
        this.searchedQuotes = [];
        this.selectedQuoteCode = '';
        this.selectedQuoteName = '';
        this.selectedQuoteType = mode;
        this.selectedKlineIndex = -1;
        this.klinePoints = [];
        this.klineGeoms = [];
        this.klineXLabels = [];
        this.klineError = '';

        this.fetchQuotes(mode);
      })
  }


  // ====== Tab 1ï¼šå¸‚åœºï¼ˆæŒ‡æ•° / è‚¡ç¥¨ + K çº¿ + æ¡Œé¢å¡ç‰‡é¢„è§ˆï¼‰ ======
  @Builder
  private buildMarketTab() {
    Column() {
      this.buildModeSwitcher()

      // é¡¶éƒ¨ï¼šæ ‡é¢˜ + æ¨¡å¼åˆ‡æ¢ + æœç´¢åŒºåŸŸ
      Row() {
        Text(this.currentMode === 'index' ? 'æŒ‡æ•°å¡ç‰‡' : 'è‚¡ç¥¨å¡ç‰‡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)
          .margin({ left: 16, top: 12, bottom: 4 })

        Blank()

        this.buildSearchArea();
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)



      // è¡Œæƒ…æ¨ªå‘æ»šåŠ¨ strip
      this.buildQuoteStrip();

      // K çº¿å¡ç‰‡
      this.buildKlineCard();



    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .alignItems(HorizontalAlign.Start)
  }

  // ===== è¡Œæƒ… stripï¼Œå¸¦åŠ è½½ / é”™è¯¯çŠ¶æ€ + å¯åˆ é™¤å¡ç‰‡ =====
  @Builder
  private buildQuoteStrip() {
    if (this.listLoading) {
      Row() {
        Text('è¡Œæƒ…åŠ è½½ä¸­â€¦')
          .fontSize(12)
          .fontColor('#888888')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    } else if (this.listError) {
      Row() {
        Text(`è¡Œæƒ…åŠ è½½å¤±è´¥ï¼š${this.listError}`)
          .fontSize(12)
          .fontColor('#FF7875')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    } else {
      Scroll() {
        Row({ space: 12 }) {
          // æœç´¢å‡ºæ¥çš„å¡ç‰‡
          ForEach(this.searchedQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `search-${item.type}-${item.code}`)

          // åå°å®æ—¶å¡ç‰‡
          ForEach(this.marketQuotes, (item: Quote) => {
            this.buildQuoteCard(item);
          }, (item: Quote) => `rt-${item.type}-${item.code}`)
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .scrollable(ScrollDirection.Horizontal)
    }
  }

  // ===== æœç´¢åŒºåŸŸ =====
  @Builder
  private buildSearchArea() {
    Column() {
      Row({ space: 8 }) {
        TextInput({
          placeholder: this.currentMode === 'index'
            ? 'è¾“å…¥æŒ‡æ•°ä»£ç ï¼Œä¾‹å¦‚ 000001'
            : 'è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚ 300750'
        })
          .width('60%')
          .height(32)
          .fontSize(14)
          .backgroundColor(Color.White)
          .fontColor(Color.Black)
          .onChange((value: string) => {
            this.searchCode = value.trim();
          })

        Button('æŸ¥è¯¢')
          .height(32)
          .onClick(() => {
            this.queryQuoteByCode();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 4 })

      if (this.searchLoading) {
        Row() {
          Text('æ­£åœ¨æŸ¥è¯¢â€¦')
            .fontSize(12)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      } else if (this.searchError) {
        Row() {
          Text(`æŸ¥è¯¢å¤±è´¥ï¼š${this.searchError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      }
    }
  }

  private toggleCardExpanded(item: Quote): void {
    const key: string = `${item.type}-${item.code}`;
    const oldVal: boolean = this.cardExpandedMap.get(key) ?? false;

    // å¤åˆ¶æ–° Mapï¼ˆè§¦å‘ State æ›´æ–°ï¼‰
    const newMap: Map<string, boolean> = new Map<string, boolean>();
    this.cardExpandedMap.forEach((value: boolean, k: string) => {
      newMap.set(k, value);
    });

    newMap.set(key, !oldVal);
    this.cardExpandedMap = newMap;
  }




  // ===== è¡Œæƒ…å¡ç‰‡ï¼ˆæŒ‡æ•° / è‚¡ç¥¨é€šç”¨ï¼‰ =====
  @Builder
  private buildQuoteCard(item: Quote) {
    Column() {
      Column() {
        // ===== å¡ç‰‡ä¸»ä½“ï¼šç‚¹è¿™é‡Œæ‰é€‰ä¸­ + æ‹‰ K çº¿ =====
        Column() {
          Row() {
            Text(item.name)
              .fontSize(12)
              .fontColor('#AAAAAA')

            Text('âœ•')
              .fontSize(12)
              .fontColor('#777777')
              // âœ… ç”¨ TapGestureï¼Œé¿å…è¢« Scroll æ‰‹åŠ¿å / å†²çª
              .parallelGesture(
                TapGesture().onAction(async () => {
                  await this.removeQuoteCard(item.code, item.type)
                })
              )
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)

          Text(item.price.toFixed(2))
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 28 : 20)
            .fontWeight(FontWeight.Bold)
            .fontColor(item.change >= 0 ? '#FF4D4F' : '#39D98A')
            .margin({ top: 4 })

          Text(`${item.change.toFixed(2)}  ${item.changePercent.toFixed(2)}%`)
            .fontSize((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 16 : 12)
            .fontColor(item.change >= 0 ? '#FF7875' : '#6BE49B')
            .margin({ top: 4 })
        }

        // ===== å³ä¸‹è§’ +/-ï¼šåªè´Ÿè´£å±•å¼€æ”¶èµ· =====
        Row() {
          Blank()
          Text((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 'ï¼' : 'ï¼‹')
            .fontSize(18)
            .fontColor('#CCCCCC')
            // âœ… ä¹Ÿç”¨ TapGestureï¼Œé¿å…å’Œå¤–å±‚ç‚¹å‡»æ‰“æ¶
            .parallelGesture(
              TapGesture().onAction(() => {
                this.toggleCardExpanded(item)
              })
            )
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 20 : 12)
      .backgroundColor('#171717')
      .borderRadius(12)
      .width((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 200 : 140)
      .height((this.cardExpandedMap.get(`${item.type}-${item.code}`) ?? false) ? 150 : undefined)

      // âœ… å…³é”®ï¼šå¤–å±‚å¡ç‰‡ç”¨ parallelGesture æ•è· tapï¼Œæ¨ªå‘ Scroll ä¸‹æ›´ç¨³å®š
      .parallelGesture(
        TapGesture().onAction(async () => {
          console.info(`[TAP] quoteCard tapped code=${item.code} activeFormId=${this.activeFormId}`)
          hilog.error(DOMAIN, TAG, '[TAP] quoteCard tapped code=%{public}s activeFormId=%{public}s',
            item.code, this.activeFormId)

          this.selectedQuoteCode = item.code
          this.selectedQuoteName = item.name
          this.selectedQuoteType = item.type
          hilog.error(DOMAIN, TAG, '[TAP] selected set type=%{public}s code=%{public}s', item.type, item.code)

          hilog.error(DOMAIN, TAG, '[TAP] before updateWidgetIfLaunchedFromForm')
          await this.updateWidgetIfLaunchedFromForm(item)
          hilog.error(DOMAIN, TAG, '[TAP] after updateWidgetIfLaunchedFromForm')

          // âœ… ä½ è¦çš„â€œç‚¹å‡»åˆ‡æ¢è¡Œæƒ…å¡ç‰‡ + æ‹‰Kçº¿â€
          const period: string = this.getKlinePeriodParam()
          this.fetchKline(item.type, item.code, period)
        })
      )
    }
  }


  // ===== K çº¿å¡ç‰‡ =====
  @Builder
  private buildKlineCard() {
    Column() {
      // æ ‡é¢˜ + å‘¨æœŸåˆ‡æ¢
      Row({ space: 12 }) {
        Text(
          this.selectedQuoteName !== ''
            ? `${this.selectedQuoteName} K çº¿`
            : (this.currentMode === 'index' ? 'æŒ‡æ•° K çº¿' : 'è‚¡ç¥¨ K çº¿')
        )
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.White)

        Blank()

        this.buildKlinePeriodChip('æ—¥K', 0)
        this.buildKlinePeriodChip('å‘¨K', 1)
        this.buildKlinePeriodChip('æœˆK', 2)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8 })

      // å½“å‰é€‰ä¸­ K çº¿çš„è¯¦ç»†ä¿¡æ¯æ¡
      if (this.selectedKlineIndex >= 0) {
        Row({ space: 8 }) {
          Text(this.selectedKlineDate)
            .fontSize(10)
            .fontColor('#CCCCCC')

          Text(`å¼€ ${this.selectedKlineOpen.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`é«˜ ${this.selectedKlineHigh.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`ä½ ${this.selectedKlineLow.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')

          Text(`æ”¶ ${this.selectedKlineClose.toFixed(2)}`)
            .fontSize(10)
            .fontColor('#AAAAAA')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 4, bottom: 4 })
      }

      // ä¸»ä½“åŒºåŸŸ
      Column() {
        if (this.klineLoading) {
          Text('K çº¿åŠ è½½ä¸­â€¦')
            .fontSize(12)
            .fontColor('#888888')
        } else if (this.klineError) {
          Text(`K çº¿åŠ è½½å¤±è´¥ï¼š${this.klineError}`)
            .fontSize(12)
            .fontColor('#FF7875')
        } else if (this.klineGeoms.length === 0) {
          Text('æš‚æ—  K çº¿æ•°æ®')
            .fontSize(12)
            .fontColor('#666666')
        } else {
          Column() {
            Row() {
              // y è½´åˆ»åº¦
              Column() {
                Text(this.klineMaxPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(((this.klineMaxPrice + this.klineMinPrice) / 2).toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
                Blank()
                Text(this.klineMinPrice.toFixed(0))
                  .fontSize(10)
                  .fontColor('#777777')
              }
              .width(40)
              .height(this.KLINE_PLOT_H)
              .justifyContent(FlexAlign.SpaceBetween)

              // å³ä¾§ï¼šK çº¿ + x è½´ä¸€èµ·æ¨ªå‘æ»šåŠ¨
              Scroll() {
                Column() {
                  // èœ¡çƒ›å›¾åŒºåŸŸ
                  Row({ space: this.candleGap }) {
                    ForEach(this.klineGeoms, (g: KlineGeom, idx: number) => {
                      Column() {
                        Blank().height(g.topGap)

                        Rect()      // ä¸Šå½±çº¿
                          .width(2)
                          .height(g.upperWick)
                          .fill('#444444')

                        Rect()      // å®ä½“
                          .width(this.candleBodyWidth)
                          .height(g.bodyHeight)
                          .fill(g.isUp ? '#39D98A' : '#FF4D4F')

                        Rect()      // ä¸‹å½±çº¿
                          .width(2)
                          .height(g.lowerWick)
                          .fill('#444444')

                        Blank().height(4)
                      }
                      .border({
                        width: this.selectedKlineIndex === idx ? 1 : 0,
                        color: this.selectedKlineIndex === idx ? '#FACC15' : '#000000'
                      })
                      .parallelGesture(
                        TapGesture().onAction(() => {
                          this.onKlineSelected(idx)
                        }))
                    }, (g: KlineGeom, idx: number) => `${idx}`)
                  }
                  .width(this.getKlineTotalWidth())
                  .height(this.KLINE_PLOT_H)

                  // x è½´æ—¥æœŸæ ‡ç­¾
                  if (this.klineXLabels.length > 0) {
                    Row() {
                      ForEach(this.klineXLabels, (label: string, idx: number) => {
                        Text(label)
                          .fontSize(10)
                          .fontColor('#777777')
                      }, (label: string, idx: number) => `${idx}-${label}`)
                    }
                    .width(this.getKlineTotalWidth())
                    .justifyContent(FlexAlign.SpaceBetween)
                    .margin({ bottom: 10 })
                  }
                }
                .padding({ right: 32 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H)
              .margin({ left: 8 })
            }
            .width('100%')
          }
        }
      }
      .width('100%')
      .height(this.KLINE_PLOT_H + this.KLINE_LABEL_H + 70)
      .margin({ top: 8, bottom: 12 })
      .padding(16)
      .backgroundColor('#101010')
      .borderRadius(16)
    }
  }

  @Builder
  private buildKlinePeriodChip(label: string, index: number) {
    Text(label)
      .fontSize(12)
      .fontColor(this.klinePeriodIndex === index ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
      .backgroundColor(this.klinePeriodIndex === index ? '#333333' : '#181818')
      .borderRadius(12)
      .onClick(() => {
        if (this.klinePeriodIndex === index) {
          return;
        }
        this.klinePeriodIndex = index;

        if (this.selectedQuoteCode !== '') {
          const period: string = this.getKlinePeriodParam();
          this.fetchKline(this.selectedQuoteType, this.selectedQuoteCode, period);
        }
      })
  }


  @Builder
  private buildDesktopCardSmall() {
    Column() {
      Text('è‡ªé€‰è‚¡ï¼ˆå°å·å¡ç‰‡ï¼‰')
        .fontSize(10)
        .fontColor('#999999')
        .margin({ bottom: 4 })

      Text('300750 å®å¾·æ—¶ä»£')
        .fontSize(12)
        .fontColor(Color.White)

      Text('210.35  -1.25  -0.59%')
        .fontSize(11)
        .fontColor('#39D98A')
        .margin({ top: 4 })
    }
    .padding(10)
    .backgroundColor('#151515')
    .borderRadius(14)
    .width(140)
  }

  @Builder
  private buildDesktopCardLarge() {
    Column() {
      Row() {
        Text('å¤§ç›˜æŒ‡æ•°')
          .fontSize(12)
          .fontColor('#BBBBBB')
        Blank()
        Text('ä¸Šè¯')
          .fontSize(11)
          .fontColor('#888888')
      }

      Text('3050.32')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF4D4F')
        .margin({ top: 4 })

      Text('+12.34  +0.41%')
        .fontSize(11)
        .fontColor('#FF7875')
        .margin({ top: 2 })

      Row({ space: 2 }) {
        ForEach([16, 10, 18, 8, 20, 12, 14], (h: number, idx: number) => {
          Rect()
            .width(6)
            .height(h)
            .fill('#333333')
        }, (h: number, idx: number) => `${idx}-${h}`)
      }
      .margin({ top: 8 })
    }
    .padding(12)
    .backgroundColor('#151515')
    .borderRadius(14)
    .width(180)
  }

  // ====== Tab 2ï¼šè‡ªé€‰ï¼ˆåˆ†ç»„ç®¡ç† + ç»„å†…åˆ—è¡¨ï¼‰ ======
  @Builder
  private buildWatchlistTab() {
    Column() {
      this.buildGroupStrip()
      this.buildCreateGroupBar()

      if (this.watchlistMsg.length > 0) {
        Text(this.watchlistMsg)
          .fontSize(10)
          .fontColor('#777777')
          .margin({ left: 16, bottom: 8 })
      }

      if (this.activeGroupId < 0 || this.groups.length === 0) {
        Text('æš‚æ— åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç»„')
          .fontSize(12)
          .fontColor('#777777')
          .margin({ top: 24 })
          .width('100%')
          .textAlign(TextAlign.Center)
      } else {
        // ç»„å¤´ï¼ˆæ— å‚ Builderï¼šç›´æ¥ç”¨ activeGroupName + activeGroupIdï¼‰
        this.buildActiveGroupHeaderCurrent()

        // ç»Ÿè®¡ï¼ˆæ— å‚ Builderï¼šç”¨ activeGroupXXXTextï¼‰
        this.buildGroupStatsCard()

        // æ·»åŠ æ¡
        this.buildAddStockBar()

        if (this.getActiveGroupStocksList().length === 0) {
          Text('è¯¥åˆ†ç»„æš‚æ— è‚¡ç¥¨ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥ä»£ç æ·»åŠ ')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 12, left: 16 })
        } else {
          List() {
            ForEach(this.activeStocks, (s: StockRef) => {
              this.buildStockRefRow(this.activeGroupId, s)
            }, (s: StockRef) => {
              // key åªéœ€è¦ç¨³å®šå”¯ä¸€å³å¯ï¼Œä¸è¦æŠŠ ver æ”¾è¿™é‡Œä¹Ÿè¡Œ
              return `${this.activeGroupId}-${s.code}`
            })
          }
          .key(`${this.activeGroupId}-${this.activeStocksVer}`)  // âœ…å…³é”®ï¼šè®© List é‡æ–°åˆ›å»º
          .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .key(`watchlist-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }

  @Builder
  private buildActiveGroupHeaderCurrent() {
    Row({ space: 8 }) {
      Text(this.getActiveGroupNameText())
        .fontSize(14)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)

      Blank()

      Text('åˆ é™¤åˆ†ç»„')
        .fontSize(12)
        .fontColor('#FF7875')
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#1A1A1A')
        .borderRadius(10)
        .onClick(() => {
          this.deleteGroup(this.activeGroupId)
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 6 })
  }


  @Builder
  private buildGroupStrip() {
    Scroll() {
      Row({ space: 8 }) {
        ForEach(this.groups, (group: StockGroup) => {
          Column({ space: 2 }) {
            Text(group.name)
              .fontSize(12)
              .fontColor(this.activeGroupId === group.id ? '#FFFFFF' : '#DDDDDD')

            Text(this.getGroupAvgPctText(group.id))
              .fontSize(10)
              .fontColor(this.getGroupAvgPctColor(group.id))
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor(this.activeGroupId === group.id ? '#2A2A2A' : '#161616')
          .borderRadius(12)
          .onClick(async () => {
            this.activeGroupId = group.id

            this.syncActiveStocks()
            await this.preloadActiveGroupQuotes()
            this.syncActiveStocks()
          })
        }, (group: StockGroup) => group.id.toString())
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
    }
    .scrollable(ScrollDirection.Horizontal)
  }

  @Builder
  private buildCreateGroupBar() {
    Row({ space: 8 }) {
      TextInput({
        placeholder: 'æ–°å»ºåˆ†ç»„åï¼ˆå¦‚ ç§‘æŠ€è‚¡ï¼‰',
        text: this.newGroupName // âœ… å—æ§ï¼šUI ç»‘å®š state
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          this.newGroupName = v.trim();
        })

      Button('åˆ›å»º')
        .height(32)
        .onClick(async () => {
          const name: string = this.newGroupName.trim();
          if (name.length === 0) {
            this.watchlistMsg = 'è¯·è¾“å…¥åˆ†ç»„å';
            return;
          }
          await this.createGroup(name);

        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }


  @Builder
  private buildActiveGroupHeader(g: StockGroup) {
    Row({ space: 8 }) {
      Text(g.name)
        .fontSize(14)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)

      Blank()

      Text('åˆ é™¤åˆ†ç»„')
        .fontSize(12)
        .fontColor('#FF7875')
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor('#1A1A1A')
        .borderRadius(10)
        .onClick(() => {
          this.deleteGroup(g.id)
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 6 })
  }



  @Builder
  private buildGroupStatsCard() {
    Column() {
      Row({ space: 12 }) {

        Column({ space: 4 }) {
          Text('è‚¡ç¥¨æ•°').fontSize(10).fontColor('#777777')
          Text(this.activeStatStockCount).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('ä¸Šæ¶¨').fontSize(10).fontColor('#777777')
          Text(this.activeStatUp).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('ä¸‹è·Œ').fontSize(10).fontColor('#777777')
          Text(this.activeStatDown).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')

        Column({ space: 4 }) {
          Text('å‡æ¶¨è·Œ').fontSize(10).fontColor('#777777')
          Text(this.activeStatAvgPct).fontSize(14).fontColor('#FFFFFF').fontWeight(FontWeight.Medium)
        }.width('22%')
      }
      .width('100%')
      .padding(12)
      .margin({ left: 16, right: 16, bottom: 8 })
      .backgroundColor('#101010')
      .borderRadius(14)
    }
    // è¿™ä¸ª key ä½ ä¿ç•™å³å¯
    .key(`stats-${this.activeGroupId}-${this.activeStocksVer}-${this.quoteCacheVer}-${this.activeStatsVer}`)
  }


  @Builder
  private buildAddStockBar() {
    Row({ space: 8 }) {
      TextInput({
        placeholder: 'è¾“å…¥ 6 ä½è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 300750ï¼‰',
        text: this.addStockCodeInput
      })
        .width('68%')
        .height(32)
        .fontSize(13)
        .backgroundColor(Color.White)
        .fontColor(Color.Black)
        .onChange((v: string) => {
          this.addStockCodeInput = v.trim();
        })

      Button('æ·»åŠ ')
        .height(32)
        .onClick(async () => {
          const code: string = this.addStockCodeInput.trim();
          if (code.length !== 6) {
            this.watchlistMsg = 'è¯·è¾“å…¥ 6 ä½ä»£ç ';
            return;
          }

          // âœ… å…³é”®ï¼šæ°¸è¿œå–â€œå½“å‰ activeGroupIdâ€ï¼Œä¸å†ä¾èµ– Builder å‚æ•°é—­åŒ…
          const gid: number = this.activeGroupId;
          if (gid < 0) {
            this.watchlistMsg = 'å½“å‰æ²¡æœ‰å¯ç”¨åˆ†ç»„';
            return;
          }

          await this.addStocksToGroup(gid, [code]);
          this.watchlistMsg = `å·²å°è¯•æ·»åŠ ï¼š${code} -> group=${gid}`;
        })
    }
    .padding({ left: 16, right: 16, bottom: 8 })
  }



  @Builder
  private buildStockRefRow(groupId: number, s: StockRef) {
    ListItem() {
      Row() {
        Column({ space: 4 }) {
          Text(this.getStockRowName(s))
            .fontSize(14)
            .fontColor(Color.White)

          Text(s.code)
            .fontSize(11)
            .fontColor('#666666')
        }

        Blank()

        Column({ space: 4 }) {
          Text(this.getStockRowPriceText(s))
            .fontSize(14)
            .fontColor(this.getStockRowPriceColor(s))
            .textAlign(TextAlign.End)

          Text(this.getStockRowChangeText(s) + '  ' + this.getStockRowPctText(s))
            .fontSize(11)
            .fontColor(this.getStockRowSubColor(s))
            .textAlign(TextAlign.End)
        }

        Button('âœ•')
          .height(28)
          .width(28)
          .padding(0)
          .backgroundColor('#1A1A1A')
          .fontColor('#777777')
          .borderRadius(14)
          .onClick(() => {
            // åªåšåˆ é™¤ï¼Œä¸è¦ asyncï¼Œé¿å…æ‰‹åŠ¿é“¾è·¯æ›´å¤æ‚
            this.removeStocksFromGroup(groupId, [s.code])
          })
      }
      .padding({ left: 12, right: 12, top: 10, bottom: 10 })
      .backgroundColor('#101010')
      .borderRadius(12)
    }
    .margin({ bottom: 8 })
  }


  @Builder
  private buildWatchlistRow(s: StockQuote) {
    ListItem() {
      Row() {
        Column({ space: 4 }) {
          Text(s.name)
            .fontSize(14)
            .fontColor(Color.White)

          Text(s.code)
            .fontSize(11)
            .fontColor('#666666')
        }

        Blank()

        Column({ space: 4 }) {
          Text(s.price.toFixed(2))
            .fontSize(14)
            .fontColor(s.change >= 0 ? '#FF4D4F' : '#39D98A')
            .textAlign(TextAlign.End)

          Text(`${s.change.toFixed(2)}  ${s.changePercent.toFixed(2)}%`)
            .fontSize(11)
            .fontColor(s.change >= 0 ? '#FF7875' : '#6BE49B')
            .textAlign(TextAlign.End)
        }
      }
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#101010')
    }
    .margin({ bottom: 1 })
  }

  // ====== Tab 3ï¼šè¡Œæƒ…é€šçŸ¥ä¸­å¿ƒï¼ˆåªæ˜¯ UI åˆ—è¡¨ï¼‰ ======
  @Builder
  private buildNotificationTab() {
    Column() {
      Row() {
        Text('é€šçŸ¥è§„åˆ™').fontSize(14).fontColor(Color.White)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // âœ… æ–°å¢è§„åˆ™åŒº
      Column({ space: 8 }) {
        Column({space:8}){
          Row({ space: 6 }) {
            this.buildRuleTypeChip('è‚¡ç¥¨', 'stock')
            this.buildRuleTypeChip('æŒ‡æ•°', 'index')
          }
          Row({ space: 8 }) {
            // âœ… ç±»å‹é€‰æ‹©ï¼šè‚¡ç¥¨ / æŒ‡æ•°


            // âœ… ä»£ç è¾“å…¥
            TextInput({
              placeholder: this.ruleQuoteType === 'stock' ? 'è‚¡ç¥¨ä»£ç (6ä½)' : 'æŒ‡æ•°ä»£ç (6ä½)',
              text: this.ruleStockCodeInput
            })
              .width('28%')
              .height(32)
              .fontSize(13)
              .backgroundColor(Color.White)
              .fontColor(Color.Black)
              .onChange((v: string) => { this.ruleStockCodeInput = v.trim() })

            // âœ… æ“ä½œç¬¦
            Row({ space: 6 }) {
              Text('â‰¥')
                .fontSize(12)
                .fontColor(this.ruleOpIndex === 0 ? '#FFFFFF' : '#AAAAAA')
                .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                .backgroundColor(this.ruleOpIndex === 0 ? '#333333' : '#181818')
                .borderRadius(10)
                .onClick(() => { this.ruleOpIndex = 0 })

              Text('â‰¤')
                .fontSize(12)
                .fontColor(this.ruleOpIndex === 1 ? '#FFFFFF' : '#AAAAAA')
                .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                .backgroundColor(this.ruleOpIndex === 1 ? '#333333' : '#181818')
                .borderRadius(10)
                .onClick(() => { this.ruleOpIndex = 1 })
            }

            // âœ… é˜ˆå€¼
            TextInput({ placeholder: 'é˜ˆå€¼', text: this.rulePriceInput })
              .width('18%')
              .height(32)
              .fontSize(13)
              .backgroundColor(Color.White)
              .fontColor(Color.Black)
              .onChange((v: string) => { this.rulePriceInput = v.trim() })

            // âœ… æ·»åŠ 
            Button('æ·»åŠ ')
              .height(32)
              .onClick(async () => { await this.addNotifyRuleFromUI() })
          }
        }


        if (this.ruleMsg.length > 0) {
          Text(this.ruleMsg)
            .fontSize(10)
            .fontColor('#777777')
        }
      }
      .padding({ left: 16, right: 16, bottom: 10 })

      // âœ… è§„åˆ™åˆ—è¡¨
      List() {
        ForEach(this.notifyRules, (rule: NotifyRule) => {
          this.buildNotifyRuleItem(rule)
        }, (rule: NotifyRule) => rule.id.toString())
      }
      .key(`notifyRules-${this.notifyRulesVer}`)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }

  @Builder
  private buildNotifyRuleItem(rule: NotifyRule) {
    ListItem() {
      Row({ space: 10 }) {
        Column({ space: 4 }) {
          Row({ space: 6 }) {
            // âœ… ç±»å‹æ ‡è¯†
            Text(rule.quoteType === 'stock' ? 'è‚¡ç¥¨' : 'æŒ‡æ•°')
              .fontSize(10)
              .fontColor('#AAAAAA')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor('#1A1A1A')
              .borderRadius(6)

            Text(`${rule.stockName}ï¼ˆ${rule.stockCode}ï¼‰`)
              .fontSize(13)
              .fontColor(Color.White)
          }

          Text(rule.conditionText)
            .fontSize(11)
            .fontColor('#BBBBBB')
        }
        .layoutWeight(1)

        Button('åˆ é™¤')
          .height(28)
          .padding({ left: 10, right: 10 })
          .backgroundColor('#1A1A1A')
          .fontColor('#FF7875')
          .borderRadius(10)
          .onClick(async () => {
            await this.deleteRule(rule.id)
          })
      }
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .backgroundColor('#101010')
    }
    .margin({ bottom: 1 })
  }

  @Builder
  private buildRuleTypeChip(label: string, t: 'index' | 'stock') {
    Text(label)
      .fontSize(12)
      .fontColor(this.ruleQuoteType === t ? '#FFFFFF' : '#AAAAAA')
      .padding({ left: 10, right: 10, top: 6, bottom: 6 })
      .backgroundColor(this.ruleQuoteType === t ? '#333333' : '#181818')
      .borderRadius(10)
      .onClick(() => { this.ruleQuoteType = t })
  }
}
